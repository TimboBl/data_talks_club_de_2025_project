[0m12:14:46.592687 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10c16ea50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10c1cab10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10c1bacd0>]}


============================== 12:14:46.596419 | 5fc77d0f-3723-4985-9e81-9e560112f96f ==============================
[0m12:14:46.596419 [info ] [MainThread]: Running with dbt=1.9.3
[0m12:14:46.596855 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'profiles_dir': '/Users/timbo/.dbt', 'log_path': '/Users/timbo/Documents/DataTalks/project/src/logs', 'version_check': 'True', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'empty': 'None', 'quiet': 'False', 'no_print': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'invocation_command': 'dbt debug', 'log_format': 'default', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m12:14:46.609357 [info ] [MainThread]: dbt version: 1.9.3
[0m12:14:46.609704 [info ] [MainThread]: python version: 3.11.10
[0m12:14:46.609917 [info ] [MainThread]: python path: /Users/timbo/Documents/DataTalks/project/src/venv/bin/python3.11
[0m12:14:46.610203 [info ] [MainThread]: os info: macOS-15.3.2-arm64-arm-64bit
[0m12:14:46.612673 [info ] [MainThread]: Using profiles dir at /Users/timbo/.dbt
[0m12:14:46.612896 [info ] [MainThread]: Using profiles.yml file at /Users/timbo/.dbt/profiles.yml
[0m12:14:46.613075 [info ] [MainThread]: Using dbt_project.yml file at /Users/timbo/Documents/DataTalks/project/src/dbt_project.yml
[0m12:14:46.659332 [info ] [MainThread]: Configuration:
[0m12:14:46.659703 [info ] [MainThread]:   profiles.yml file [[31mERROR invalid[0m]
[0m12:14:46.659889 [info ] [MainThread]:   dbt_project.yml file [[32mOK found and valid[0m]
[0m12:14:46.660056 [info ] [MainThread]: Required dependencies:
[0m12:14:46.660289 [debug] [MainThread]: Executing "git --help"
[0m12:14:46.682798 [debug] [MainThread]: STDOUT: "b"usage: git [-v | --version] [-h | --help] [-C <path>] [-c <name>=<value>]\n           [--exec-path[=<path>]] [--html-path] [--man-path] [--info-path]\n           [-p | --paginate | -P | --no-pager] [--no-replace-objects] [--bare]\n           [--git-dir=<path>] [--work-tree=<path>] [--namespace=<name>]\n           [--super-prefix=<path>] [--config-env=<name>=<envvar>]\n           <command> [<args>]\n\nThese are common Git commands used in various situations:\n\nstart a working area (see also: git help tutorial)\n   clone     Clone a repository into a new directory\n   init      Create an empty Git repository or reinitialize an existing one\n\nwork on the current change (see also: git help everyday)\n   add       Add file contents to the index\n   mv        Move or rename a file, a directory, or a symlink\n   restore   Restore working tree files\n   rm        Remove files from the working tree and from the index\n\nexamine the history and state (see also: git help revisions)\n   bisect    Use binary search to find the commit that introduced a bug\n   diff      Show changes between commits, commit and working tree, etc\n   grep      Print lines matching a pattern\n   log       Show commit logs\n   show      Show various types of objects\n   status    Show the working tree status\n\ngrow, mark and tweak your common history\n   branch    List, create, or delete branches\n   commit    Record changes to the repository\n   merge     Join two or more development histories together\n   rebase    Reapply commits on top of another base tip\n   reset     Reset current HEAD to the specified state\n   switch    Switch branches\n   tag       Create, list, delete or verify a tag object signed with GPG\n\ncollaborate (see also: git help workflows)\n   fetch     Download objects and refs from another repository\n   pull      Fetch from and integrate with another repository or a local branch\n   push      Update remote refs along with associated objects\n\n'git help -a' and 'git help -g' list available subcommands and some\nconcept guides. See 'git help <command>' or 'git help <concept>'\nto read about a specific subcommand or concept.\nSee 'git help git' for an overview of the system.\n""
[0m12:14:46.683513 [debug] [MainThread]: STDERR: "b''"
[0m12:14:46.683756 [info ] [MainThread]:  - git [[32mOK found[0m]

[0m12:14:46.684018 [info ] [MainThread]: Connection test skipped since no profile was found
[0m12:14:46.684263 [info ] [MainThread]: [31m1 check failed:[0m
[0m12:14:46.684456 [info ] [MainThread]: Profile loading failed for the following reason:
Runtime Error
  Could not find profile named 'eu_emissions_project'


[0m12:14:46.822892 [debug] [MainThread]: Resource report: {"command_name": "debug", "command_success": false, "command_wall_clock_time": 0.27324793, "process_in_blocks": "0", "process_kernel_time": 0.160208, "process_mem_max_rss": "101744640", "process_out_blocks": "0", "process_user_time": 0.728461}
[0m12:14:46.823426 [debug] [MainThread]: Command `dbt debug` failed at 12:14:46.823358 after 0.27 seconds
[0m12:14:46.823807 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104ef5e90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104d98810>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104d98790>]}
[0m12:14:46.824138 [debug] [MainThread]: Flushing usage events
[0m12:14:47.302083 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m12:15:50.307639 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10656fe10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1065cb090>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1065cbd10>]}


============================== 12:15:50.310063 | 2a76d657-7f6a-4733-a9a9-e350159ec41d ==============================
[0m12:15:50.310063 [info ] [MainThread]: Running with dbt=1.9.3
[0m12:15:50.310434 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': '/Users/timbo/.dbt', 'debug': 'False', 'fail_fast': 'False', 'log_path': '/Users/timbo/Documents/DataTalks/project/src/logs', 'version_check': 'True', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'empty': 'None', 'quiet': 'False', 'no_print': 'None', 'log_format': 'default', 'introspect': 'True', 'invocation_command': 'dbt debug', 'static_parser': 'True', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m12:15:50.316779 [info ] [MainThread]: dbt version: 1.9.3
[0m12:15:50.317248 [info ] [MainThread]: python version: 3.11.10
[0m12:15:50.317496 [info ] [MainThread]: python path: /Users/timbo/Documents/DataTalks/project/src/venv/bin/python3.11
[0m12:15:50.317685 [info ] [MainThread]: os info: macOS-15.3.2-arm64-arm-64bit
[0m12:15:50.319977 [info ] [MainThread]: Using profiles dir at /Users/timbo/.dbt
[0m12:15:50.320205 [info ] [MainThread]: Using profiles.yml file at /Users/timbo/.dbt/profiles.yml
[0m12:15:50.320383 [info ] [MainThread]: Using dbt_project.yml file at /Users/timbo/Documents/DataTalks/project/src/dbt_project.yml
[0m12:15:50.365448 [info ] [MainThread]: Configuration:
[0m12:15:50.365852 [info ] [MainThread]:   profiles.yml file [[31mERROR invalid[0m]
[0m12:15:50.366079 [info ] [MainThread]:   dbt_project.yml file [[32mOK found and valid[0m]
[0m12:15:50.366278 [info ] [MainThread]: Required dependencies:
[0m12:15:50.366526 [debug] [MainThread]: Executing "git --help"
[0m12:15:50.384821 [debug] [MainThread]: STDOUT: "b"usage: git [-v | --version] [-h | --help] [-C <path>] [-c <name>=<value>]\n           [--exec-path[=<path>]] [--html-path] [--man-path] [--info-path]\n           [-p | --paginate | -P | --no-pager] [--no-replace-objects] [--bare]\n           [--git-dir=<path>] [--work-tree=<path>] [--namespace=<name>]\n           [--super-prefix=<path>] [--config-env=<name>=<envvar>]\n           <command> [<args>]\n\nThese are common Git commands used in various situations:\n\nstart a working area (see also: git help tutorial)\n   clone     Clone a repository into a new directory\n   init      Create an empty Git repository or reinitialize an existing one\n\nwork on the current change (see also: git help everyday)\n   add       Add file contents to the index\n   mv        Move or rename a file, a directory, or a symlink\n   restore   Restore working tree files\n   rm        Remove files from the working tree and from the index\n\nexamine the history and state (see also: git help revisions)\n   bisect    Use binary search to find the commit that introduced a bug\n   diff      Show changes between commits, commit and working tree, etc\n   grep      Print lines matching a pattern\n   log       Show commit logs\n   show      Show various types of objects\n   status    Show the working tree status\n\ngrow, mark and tweak your common history\n   branch    List, create, or delete branches\n   commit    Record changes to the repository\n   merge     Join two or more development histories together\n   rebase    Reapply commits on top of another base tip\n   reset     Reset current HEAD to the specified state\n   switch    Switch branches\n   tag       Create, list, delete or verify a tag object signed with GPG\n\ncollaborate (see also: git help workflows)\n   fetch     Download objects and refs from another repository\n   pull      Fetch from and integrate with another repository or a local branch\n   push      Update remote refs along with associated objects\n\n'git help -a' and 'git help -g' list available subcommands and some\nconcept guides. See 'git help <command>' or 'git help <concept>'\nto read about a specific subcommand or concept.\nSee 'git help git' for an overview of the system.\n""
[0m12:15:50.385477 [debug] [MainThread]: STDERR: "b''"
[0m12:15:50.385729 [info ] [MainThread]:  - git [[32mOK found[0m]

[0m12:15:50.385942 [info ] [MainThread]: Connection test skipped since no profile was found
[0m12:15:50.386124 [info ] [MainThread]: [31m1 check failed:[0m
[0m12:15:50.386299 [info ] [MainThread]: Profile loading failed for the following reason:
Runtime Error
  Could not find profile named 'eu_emissions_project'


[0m12:15:50.387454 [debug] [MainThread]: Resource report: {"command_name": "debug", "command_success": false, "command_wall_clock_time": 0.11527438, "process_in_blocks": "0", "process_kernel_time": 0.116839, "process_mem_max_rss": "103235584", "process_out_blocks": "0", "process_user_time": 0.688491}
[0m12:15:50.387744 [debug] [MainThread]: Command `dbt debug` failed at 12:15:50.387690 after 0.12 seconds
[0m12:15:50.388072 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x100c41f10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10637ce10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1066bb9d0>]}
[0m12:15:50.388366 [debug] [MainThread]: Flushing usage events
[0m12:15:50.846307 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m12:16:28.227691 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x106e6fd50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x106ecae10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x106ecba50>]}


============================== 12:16:28.230435 | 1dcd7e5c-28c1-4d39-a834-1e7f8b55e7c6 ==============================
[0m12:16:28.230435 [info ] [MainThread]: Running with dbt=1.9.3
[0m12:16:28.230834 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'profiles_dir': '/Users/timbo/.dbt', 'log_path': '/Users/timbo/Documents/DataTalks/project/src/logs', 'fail_fast': 'False', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'empty': 'None', 'quiet': 'False', 'no_print': 'None', 'log_format': 'default', 'static_parser': 'True', 'introspect': 'True', 'invocation_command': 'dbt debug', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m12:16:28.236618 [info ] [MainThread]: dbt version: 1.9.3
[0m12:16:28.236878 [info ] [MainThread]: python version: 3.11.10
[0m12:16:28.237081 [info ] [MainThread]: python path: /Users/timbo/Documents/DataTalks/project/src/venv/bin/python3.11
[0m12:16:28.237492 [info ] [MainThread]: os info: macOS-15.3.2-arm64-arm-64bit
[0m12:16:28.949812 [info ] [MainThread]: Using profiles dir at /Users/timbo/.dbt
[0m12:16:28.950191 [info ] [MainThread]: Using profiles.yml file at /Users/timbo/.dbt/profiles.yml
[0m12:16:28.950382 [info ] [MainThread]: Using dbt_project.yml file at /Users/timbo/Documents/DataTalks/project/src/dbt_project.yml
[0m12:16:28.950555 [info ] [MainThread]: adapter type: bigquery
[0m12:16:28.951003 [info ] [MainThread]: adapter version: 1.9.1
[0m12:16:28.998562 [info ] [MainThread]: Configuration:
[0m12:16:28.998935 [info ] [MainThread]:   profiles.yml file [[32mOK found and valid[0m]
[0m12:16:28.999123 [info ] [MainThread]:   dbt_project.yml file [[32mOK found and valid[0m]
[0m12:16:28.999294 [info ] [MainThread]: Required dependencies:
[0m12:16:28.999578 [debug] [MainThread]: Executing "git --help"
[0m12:16:29.023574 [debug] [MainThread]: STDOUT: "b"usage: git [-v | --version] [-h | --help] [-C <path>] [-c <name>=<value>]\n           [--exec-path[=<path>]] [--html-path] [--man-path] [--info-path]\n           [-p | --paginate | -P | --no-pager] [--no-replace-objects] [--bare]\n           [--git-dir=<path>] [--work-tree=<path>] [--namespace=<name>]\n           [--super-prefix=<path>] [--config-env=<name>=<envvar>]\n           <command> [<args>]\n\nThese are common Git commands used in various situations:\n\nstart a working area (see also: git help tutorial)\n   clone     Clone a repository into a new directory\n   init      Create an empty Git repository or reinitialize an existing one\n\nwork on the current change (see also: git help everyday)\n   add       Add file contents to the index\n   mv        Move or rename a file, a directory, or a symlink\n   restore   Restore working tree files\n   rm        Remove files from the working tree and from the index\n\nexamine the history and state (see also: git help revisions)\n   bisect    Use binary search to find the commit that introduced a bug\n   diff      Show changes between commits, commit and working tree, etc\n   grep      Print lines matching a pattern\n   log       Show commit logs\n   show      Show various types of objects\n   status    Show the working tree status\n\ngrow, mark and tweak your common history\n   branch    List, create, or delete branches\n   commit    Record changes to the repository\n   merge     Join two or more development histories together\n   rebase    Reapply commits on top of another base tip\n   reset     Reset current HEAD to the specified state\n   switch    Switch branches\n   tag       Create, list, delete or verify a tag object signed with GPG\n\ncollaborate (see also: git help workflows)\n   fetch     Download objects and refs from another repository\n   pull      Fetch from and integrate with another repository or a local branch\n   push      Update remote refs along with associated objects\n\n'git help -a' and 'git help -g' list available subcommands and some\nconcept guides. See 'git help <command>' or 'git help <concept>'\nto read about a specific subcommand or concept.\nSee 'git help git' for an overview of the system.\n""
[0m12:16:29.024336 [debug] [MainThread]: STDERR: "b''"
[0m12:16:29.024684 [info ] [MainThread]:  - git [[32mOK found[0m]

[0m12:16:29.024960 [info ] [MainThread]: Connection:
[0m12:16:29.025256 [info ] [MainThread]:   method: service-account
[0m12:16:29.025441 [info ] [MainThread]:   database: data-talk-clubs
[0m12:16:29.025706 [info ] [MainThread]:   execution_project: data-talk-clubs
[0m12:16:29.025982 [info ] [MainThread]:   schema: eu_emissions_project
[0m12:16:29.026163 [info ] [MainThread]:   location: EU
[0m12:16:29.026511 [info ] [MainThread]:   priority: None
[0m12:16:29.026724 [info ] [MainThread]:   maximum_bytes_billed: None
[0m12:16:29.026904 [info ] [MainThread]:   impersonate_service_account: None
[0m12:16:29.027071 [info ] [MainThread]:   job_retry_deadline_seconds: None
[0m12:16:29.027240 [info ] [MainThread]:   job_retries: 1
[0m12:16:29.027408 [info ] [MainThread]:   job_creation_timeout_seconds: None
[0m12:16:29.027568 [info ] [MainThread]:   job_execution_timeout_seconds: None
[0m12:16:29.027729 [info ] [MainThread]:   timeout_seconds: None
[0m12:16:29.027888 [info ] [MainThread]:   client_id: None
[0m12:16:29.028046 [info ] [MainThread]:   token_uri: None
[0m12:16:29.028208 [info ] [MainThread]:   dataproc_region: None
[0m12:16:29.028363 [info ] [MainThread]:   dataproc_cluster_name: None
[0m12:16:29.028519 [info ] [MainThread]:   gcs_bucket: None
[0m12:16:29.028675 [info ] [MainThread]:   dataproc_batch: None
[0m12:16:29.029095 [info ] [MainThread]: Registered adapter: bigquery=1.9.1
[0m12:16:29.269895 [debug] [MainThread]: Acquiring new bigquery connection 'debug'
[0m12:16:29.270338 [debug] [MainThread]: On debug: select 1 as id
[0m12:16:29.270563 [debug] [MainThread]: Opening a new connection, currently in state init
[0m12:16:29.793563 [error] [MainThread]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=data-talk-clubs&j=bq:EU:96d700aa-3ab5-4b82-a884-8c0fd9b7a213&page=queryresults
[0m12:16:29.794921 [info ] [MainThread]:   Connection test: [[31mERROR[0m]

[0m12:16:29.795179 [info ] [MainThread]: [31m1 check failed:[0m
[0m12:16:29.795369 [info ] [MainThread]: dbt was unable to connect to the specified database.
The database returned the following error:

  >Database Error
  Access Denied: Project data-talk-clubs: User does not have bigquery.jobs.create permission in project data-talk-clubs.

Check your database credentials and try again. For more information, visit:
https://docs.getdbt.com/docs/configure-your-profile


[0m12:16:29.798092 [debug] [MainThread]: Resource report: {"command_name": "debug", "command_success": false, "command_wall_clock_time": 1.607516, "process_in_blocks": "0", "process_kernel_time": 0.310172, "process_mem_max_rss": "198737920", "process_out_blocks": "0", "process_user_time": 1.166694}
[0m12:16:29.798527 [debug] [MainThread]: Command `dbt debug` failed at 12:16:29.798454 after 1.61 seconds
[0m12:16:29.798810 [debug] [MainThread]: Connection 'debug' was properly closed.
[0m12:16:29.799076 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x101092010>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x106eefd50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x106eefa50>]}
[0m12:16:29.799373 [debug] [MainThread]: Flushing usage events
[0m12:16:30.283075 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m12:17:06.225813 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11316f3d0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1131bba50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1131cbd50>]}


============================== 12:17:06.228412 | 8d188d45-cbce-4dcf-9c48-0df9ce3fcd67 ==============================
[0m12:17:06.228412 [info ] [MainThread]: Running with dbt=1.9.3
[0m12:17:06.228778 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': '/Users/timbo/.dbt', 'version_check': 'True', 'warn_error': 'None', 'log_path': '/Users/timbo/Documents/DataTalks/project/src/logs', 'fail_fast': 'False', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'empty': 'None', 'quiet': 'False', 'no_print': 'None', 'log_format': 'default', 'introspect': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt debug', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m12:17:06.236053 [info ] [MainThread]: dbt version: 1.9.3
[0m12:17:06.236349 [info ] [MainThread]: python version: 3.11.10
[0m12:17:06.236559 [info ] [MainThread]: python path: /Users/timbo/Documents/DataTalks/project/src/venv/bin/python3.11
[0m12:17:06.236744 [info ] [MainThread]: os info: macOS-15.3.2-arm64-arm-64bit
[0m12:17:06.671106 [info ] [MainThread]: Using profiles dir at /Users/timbo/.dbt
[0m12:17:06.671509 [info ] [MainThread]: Using profiles.yml file at /Users/timbo/.dbt/profiles.yml
[0m12:17:06.671707 [info ] [MainThread]: Using dbt_project.yml file at /Users/timbo/Documents/DataTalks/project/src/dbt_project.yml
[0m12:17:06.671892 [info ] [MainThread]: adapter type: bigquery
[0m12:17:06.672062 [info ] [MainThread]: adapter version: 1.9.1
[0m12:17:06.717763 [info ] [MainThread]: Configuration:
[0m12:17:06.718129 [info ] [MainThread]:   profiles.yml file [[32mOK found and valid[0m]
[0m12:17:06.718324 [info ] [MainThread]:   dbt_project.yml file [[32mOK found and valid[0m]
[0m12:17:06.718494 [info ] [MainThread]: Required dependencies:
[0m12:17:06.718717 [debug] [MainThread]: Executing "git --help"
[0m12:17:06.737497 [debug] [MainThread]: STDOUT: "b"usage: git [-v | --version] [-h | --help] [-C <path>] [-c <name>=<value>]\n           [--exec-path[=<path>]] [--html-path] [--man-path] [--info-path]\n           [-p | --paginate | -P | --no-pager] [--no-replace-objects] [--bare]\n           [--git-dir=<path>] [--work-tree=<path>] [--namespace=<name>]\n           [--super-prefix=<path>] [--config-env=<name>=<envvar>]\n           <command> [<args>]\n\nThese are common Git commands used in various situations:\n\nstart a working area (see also: git help tutorial)\n   clone     Clone a repository into a new directory\n   init      Create an empty Git repository or reinitialize an existing one\n\nwork on the current change (see also: git help everyday)\n   add       Add file contents to the index\n   mv        Move or rename a file, a directory, or a symlink\n   restore   Restore working tree files\n   rm        Remove files from the working tree and from the index\n\nexamine the history and state (see also: git help revisions)\n   bisect    Use binary search to find the commit that introduced a bug\n   diff      Show changes between commits, commit and working tree, etc\n   grep      Print lines matching a pattern\n   log       Show commit logs\n   show      Show various types of objects\n   status    Show the working tree status\n\ngrow, mark and tweak your common history\n   branch    List, create, or delete branches\n   commit    Record changes to the repository\n   merge     Join two or more development histories together\n   rebase    Reapply commits on top of another base tip\n   reset     Reset current HEAD to the specified state\n   switch    Switch branches\n   tag       Create, list, delete or verify a tag object signed with GPG\n\ncollaborate (see also: git help workflows)\n   fetch     Download objects and refs from another repository\n   pull      Fetch from and integrate with another repository or a local branch\n   push      Update remote refs along with associated objects\n\n'git help -a' and 'git help -g' list available subcommands and some\nconcept guides. See 'git help <command>' or 'git help <concept>'\nto read about a specific subcommand or concept.\nSee 'git help git' for an overview of the system.\n""
[0m12:17:06.738223 [debug] [MainThread]: STDERR: "b''"
[0m12:17:06.738470 [info ] [MainThread]:  - git [[32mOK found[0m]

[0m12:17:06.738731 [info ] [MainThread]: Connection:
[0m12:17:06.738984 [info ] [MainThread]:   method: service-account
[0m12:17:06.739156 [info ] [MainThread]:   database: data-talk-clubs
[0m12:17:06.739322 [info ] [MainThread]:   execution_project: data-talk-clubs
[0m12:17:06.739484 [info ] [MainThread]:   schema: eu_emissions_project
[0m12:17:06.739642 [info ] [MainThread]:   location: US
[0m12:17:06.739802 [info ] [MainThread]:   priority: None
[0m12:17:06.739965 [info ] [MainThread]:   maximum_bytes_billed: None
[0m12:17:06.740134 [info ] [MainThread]:   impersonate_service_account: None
[0m12:17:06.740293 [info ] [MainThread]:   job_retry_deadline_seconds: None
[0m12:17:06.740452 [info ] [MainThread]:   job_retries: 1
[0m12:17:06.740613 [info ] [MainThread]:   job_creation_timeout_seconds: None
[0m12:17:06.740771 [info ] [MainThread]:   job_execution_timeout_seconds: None
[0m12:17:06.740928 [info ] [MainThread]:   timeout_seconds: None
[0m12:17:06.741089 [info ] [MainThread]:   client_id: None
[0m12:17:06.741249 [info ] [MainThread]:   token_uri: None
[0m12:17:06.741402 [info ] [MainThread]:   dataproc_region: None
[0m12:17:06.741557 [info ] [MainThread]:   dataproc_cluster_name: None
[0m12:17:06.741711 [info ] [MainThread]:   gcs_bucket: None
[0m12:17:06.741863 [info ] [MainThread]:   dataproc_batch: None
[0m12:17:06.742216 [info ] [MainThread]: Registered adapter: bigquery=1.9.1
[0m12:17:06.826793 [debug] [MainThread]: Acquiring new bigquery connection 'debug'
[0m12:17:06.827243 [debug] [MainThread]: On debug: select 1 as id
[0m12:17:06.827473 [debug] [MainThread]: Opening a new connection, currently in state init
[0m12:17:07.367898 [error] [MainThread]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=data-talk-clubs&j=bq:US:979c135a-534e-4c36-8718-c0007b8f3fe4&page=queryresults
[0m12:17:07.368533 [info ] [MainThread]:   Connection test: [[31mERROR[0m]

[0m12:17:07.368737 [info ] [MainThread]: [31m1 check failed:[0m
[0m12:17:07.368924 [info ] [MainThread]: dbt was unable to connect to the specified database.
The database returned the following error:

  >Database Error
  Access Denied: Project data-talk-clubs: User does not have bigquery.jobs.create permission in project data-talk-clubs.

Check your database credentials and try again. For more information, visit:
https://docs.getdbt.com/docs/configure-your-profile


[0m12:17:07.370339 [debug] [MainThread]: Resource report: {"command_name": "debug", "command_success": false, "command_wall_clock_time": 1.1835401, "process_in_blocks": "0", "process_kernel_time": 0.249598, "process_mem_max_rss": "197115904", "process_out_blocks": "0", "process_user_time": 1.146142}
[0m12:17:07.370680 [debug] [MainThread]: Command `dbt debug` failed at 12:17:07.370622 after 1.18 seconds
[0m12:17:07.370913 [debug] [MainThread]: Connection 'debug' was properly closed.
[0m12:17:07.371146 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10526e010>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1131efe10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1131efdd0>]}
[0m12:17:07.371425 [debug] [MainThread]: Flushing usage events
[0m12:17:07.823712 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m12:19:10.465742 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10736d050>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1073be710>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1073cb810>]}


============================== 12:19:10.469454 | d536a495-a321-4139-b712-f342d3a681c1 ==============================
[0m12:19:10.469454 [info ] [MainThread]: Running with dbt=1.9.3
[0m12:19:10.469935 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'fail_fast': 'False', 'log_path': '/Users/timbo/Documents/DataTalks/project/src/logs', 'version_check': 'True', 'profiles_dir': '/Users/timbo/.dbt', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'empty': 'None', 'log_format': 'default', 'static_parser': 'True', 'invocation_command': 'dbt debug', 'introspect': 'True', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m12:19:10.483471 [info ] [MainThread]: dbt version: 1.9.3
[0m12:19:10.483817 [info ] [MainThread]: python version: 3.11.10
[0m12:19:10.484036 [info ] [MainThread]: python path: /Users/timbo/Documents/DataTalks/project/src/venv/bin/python3.11
[0m12:19:10.484218 [info ] [MainThread]: os info: macOS-15.3.2-arm64-arm-64bit
[0m12:19:11.189695 [info ] [MainThread]: Using profiles dir at /Users/timbo/.dbt
[0m12:19:11.190068 [info ] [MainThread]: Using profiles.yml file at /Users/timbo/.dbt/profiles.yml
[0m12:19:11.190391 [info ] [MainThread]: Using dbt_project.yml file at /Users/timbo/Documents/DataTalks/project/src/dbt_project.yml
[0m12:19:11.190683 [info ] [MainThread]: adapter type: bigquery
[0m12:19:11.190922 [info ] [MainThread]: adapter version: 1.9.1
[0m12:19:11.235689 [info ] [MainThread]: Configuration:
[0m12:19:11.236029 [info ] [MainThread]:   profiles.yml file [[32mOK found and valid[0m]
[0m12:19:11.236214 [info ] [MainThread]:   dbt_project.yml file [[32mOK found and valid[0m]
[0m12:19:11.236382 [info ] [MainThread]: Required dependencies:
[0m12:19:11.236605 [debug] [MainThread]: Executing "git --help"
[0m12:19:11.261693 [debug] [MainThread]: STDOUT: "b"usage: git [-v | --version] [-h | --help] [-C <path>] [-c <name>=<value>]\n           [--exec-path[=<path>]] [--html-path] [--man-path] [--info-path]\n           [-p | --paginate | -P | --no-pager] [--no-replace-objects] [--bare]\n           [--git-dir=<path>] [--work-tree=<path>] [--namespace=<name>]\n           [--super-prefix=<path>] [--config-env=<name>=<envvar>]\n           <command> [<args>]\n\nThese are common Git commands used in various situations:\n\nstart a working area (see also: git help tutorial)\n   clone     Clone a repository into a new directory\n   init      Create an empty Git repository or reinitialize an existing one\n\nwork on the current change (see also: git help everyday)\n   add       Add file contents to the index\n   mv        Move or rename a file, a directory, or a symlink\n   restore   Restore working tree files\n   rm        Remove files from the working tree and from the index\n\nexamine the history and state (see also: git help revisions)\n   bisect    Use binary search to find the commit that introduced a bug\n   diff      Show changes between commits, commit and working tree, etc\n   grep      Print lines matching a pattern\n   log       Show commit logs\n   show      Show various types of objects\n   status    Show the working tree status\n\ngrow, mark and tweak your common history\n   branch    List, create, or delete branches\n   commit    Record changes to the repository\n   merge     Join two or more development histories together\n   rebase    Reapply commits on top of another base tip\n   reset     Reset current HEAD to the specified state\n   switch    Switch branches\n   tag       Create, list, delete or verify a tag object signed with GPG\n\ncollaborate (see also: git help workflows)\n   fetch     Download objects and refs from another repository\n   pull      Fetch from and integrate with another repository or a local branch\n   push      Update remote refs along with associated objects\n\n'git help -a' and 'git help -g' list available subcommands and some\nconcept guides. See 'git help <command>' or 'git help <concept>'\nto read about a specific subcommand or concept.\nSee 'git help git' for an overview of the system.\n""
[0m12:19:11.262475 [debug] [MainThread]: STDERR: "b''"
[0m12:19:11.262862 [info ] [MainThread]:  - git [[32mOK found[0m]

[0m12:19:11.263259 [info ] [MainThread]: Connection:
[0m12:19:11.263557 [info ] [MainThread]:   method: service-account
[0m12:19:11.263738 [info ] [MainThread]:   database: data-talk-clubs
[0m12:19:11.263904 [info ] [MainThread]:   execution_project: data-talk-clubs
[0m12:19:11.264071 [info ] [MainThread]:   schema: eu_emissions_project
[0m12:19:11.264230 [info ] [MainThread]:   location: EU
[0m12:19:11.264390 [info ] [MainThread]:   priority: None
[0m12:19:11.264546 [info ] [MainThread]:   maximum_bytes_billed: None
[0m12:19:11.264708 [info ] [MainThread]:   impersonate_service_account: None
[0m12:19:11.264866 [info ] [MainThread]:   job_retry_deadline_seconds: None
[0m12:19:11.265025 [info ] [MainThread]:   job_retries: 1
[0m12:19:11.265186 [info ] [MainThread]:   job_creation_timeout_seconds: None
[0m12:19:11.265341 [info ] [MainThread]:   job_execution_timeout_seconds: None
[0m12:19:11.265499 [info ] [MainThread]:   timeout_seconds: None
[0m12:19:11.265655 [info ] [MainThread]:   client_id: None
[0m12:19:11.265811 [info ] [MainThread]:   token_uri: None
[0m12:19:11.265963 [info ] [MainThread]:   dataproc_region: None
[0m12:19:11.266118 [info ] [MainThread]:   dataproc_cluster_name: None
[0m12:19:11.266270 [info ] [MainThread]:   gcs_bucket: None
[0m12:19:11.266420 [info ] [MainThread]:   dataproc_batch: None
[0m12:19:11.266793 [info ] [MainThread]: Registered adapter: bigquery=1.9.1
[0m12:19:11.353650 [debug] [MainThread]: Acquiring new bigquery connection 'debug'
[0m12:19:11.354064 [debug] [MainThread]: On debug: select 1 as id
[0m12:19:11.354280 [debug] [MainThread]: Opening a new connection, currently in state init
[0m12:19:14.631034 [debug] [MainThread]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=data-talk-clubs&j=bq:EU:b1dab3f8-7f0e-4d07-8f21-561e6df66b43&page=queryresults
[0m12:19:15.324602 [info ] [MainThread]:   Connection test: [[32mOK connection ok[0m]

[0m12:19:15.324956 [info ] [MainThread]: [32mAll checks passed![0m
[0m12:19:15.326887 [debug] [MainThread]: Resource report: {"command_name": "debug", "command_success": true, "command_wall_clock_time": 4.9023237, "process_in_blocks": "0", "process_kernel_time": 0.359051, "process_mem_max_rss": "202866688", "process_out_blocks": "0", "process_user_time": 1.255429}
[0m12:19:15.327292 [debug] [MainThread]: Command `dbt debug` succeeded at 12:19:15.327208 after 4.90 seconds
[0m12:19:15.327588 [debug] [MainThread]: Connection 'debug' was properly closed.
[0m12:19:15.327937 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x102549f10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1073eff10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x127b320d0>]}
[0m12:19:15.328224 [debug] [MainThread]: Flushing usage events
[0m12:19:15.745878 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m12:31:19.521307 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11966ffd0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1196c9550>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1196cbcd0>]}


============================== 12:31:19.525071 | 8340a49e-8c61-4604-8f2c-01c913d899ed ==============================
[0m12:31:19.525071 [info ] [MainThread]: Running with dbt=1.9.3
[0m12:31:19.525528 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'version_check': 'True', 'profiles_dir': '/Users/timbo/.dbt', 'log_path': '/Users/timbo/Documents/DataTalks/project/src/logs', 'fail_fast': 'False', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'empty': 'None', 'quiet': 'False', 'no_print': 'None', 'log_format': 'default', 'static_parser': 'True', 'introspect': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'target_path': 'None', 'invocation_command': 'dbt debug', 'send_anonymous_usage_stats': 'True'}
[0m12:31:19.536628 [info ] [MainThread]: dbt version: 1.9.3
[0m12:31:19.536948 [info ] [MainThread]: python version: 3.11.10
[0m12:31:19.537152 [info ] [MainThread]: python path: /Users/timbo/Documents/DataTalks/project/src/venv/bin/python3.11
[0m12:31:19.537335 [info ] [MainThread]: os info: macOS-15.3.2-arm64-arm-64bit
[0m12:31:20.259093 [info ] [MainThread]: Using profiles dir at /Users/timbo/.dbt
[0m12:31:20.259498 [info ] [MainThread]: Using profiles.yml file at /Users/timbo/.dbt/profiles.yml
[0m12:31:20.259696 [info ] [MainThread]: Using dbt_project.yml file at /Users/timbo/Documents/DataTalks/project/src/dbt_project.yml
[0m12:31:20.259881 [info ] [MainThread]: adapter type: bigquery
[0m12:31:20.260048 [info ] [MainThread]: adapter version: 1.9.1
[0m12:31:20.306328 [info ] [MainThread]: Configuration:
[0m12:31:20.306808 [info ] [MainThread]:   profiles.yml file [[32mOK found and valid[0m]
[0m12:31:20.307054 [info ] [MainThread]:   dbt_project.yml file [[32mOK found and valid[0m]
[0m12:31:20.307237 [info ] [MainThread]: Required dependencies:
[0m12:31:20.307474 [debug] [MainThread]: Executing "git --help"
[0m12:31:20.328266 [debug] [MainThread]: STDOUT: "b"usage: git [-v | --version] [-h | --help] [-C <path>] [-c <name>=<value>]\n           [--exec-path[=<path>]] [--html-path] [--man-path] [--info-path]\n           [-p | --paginate | -P | --no-pager] [--no-replace-objects] [--bare]\n           [--git-dir=<path>] [--work-tree=<path>] [--namespace=<name>]\n           [--super-prefix=<path>] [--config-env=<name>=<envvar>]\n           <command> [<args>]\n\nThese are common Git commands used in various situations:\n\nstart a working area (see also: git help tutorial)\n   clone     Clone a repository into a new directory\n   init      Create an empty Git repository or reinitialize an existing one\n\nwork on the current change (see also: git help everyday)\n   add       Add file contents to the index\n   mv        Move or rename a file, a directory, or a symlink\n   restore   Restore working tree files\n   rm        Remove files from the working tree and from the index\n\nexamine the history and state (see also: git help revisions)\n   bisect    Use binary search to find the commit that introduced a bug\n   diff      Show changes between commits, commit and working tree, etc\n   grep      Print lines matching a pattern\n   log       Show commit logs\n   show      Show various types of objects\n   status    Show the working tree status\n\ngrow, mark and tweak your common history\n   branch    List, create, or delete branches\n   commit    Record changes to the repository\n   merge     Join two or more development histories together\n   rebase    Reapply commits on top of another base tip\n   reset     Reset current HEAD to the specified state\n   switch    Switch branches\n   tag       Create, list, delete or verify a tag object signed with GPG\n\ncollaborate (see also: git help workflows)\n   fetch     Download objects and refs from another repository\n   pull      Fetch from and integrate with another repository or a local branch\n   push      Update remote refs along with associated objects\n\n'git help -a' and 'git help -g' list available subcommands and some\nconcept guides. See 'git help <command>' or 'git help <concept>'\nto read about a specific subcommand or concept.\nSee 'git help git' for an overview of the system.\n""
[0m12:31:20.328980 [debug] [MainThread]: STDERR: "b''"
[0m12:31:20.329239 [info ] [MainThread]:  - git [[32mOK found[0m]

[0m12:31:20.329459 [info ] [MainThread]: Connection:
[0m12:31:20.329751 [info ] [MainThread]:   method: service-account
[0m12:31:20.329925 [info ] [MainThread]:   database: data-talk-clubs
[0m12:31:20.330092 [info ] [MainThread]:   execution_project: data-talk-clubs
[0m12:31:20.330254 [info ] [MainThread]:   schema: eu_emissions_project
[0m12:31:20.330415 [info ] [MainThread]:   location: EU
[0m12:31:20.330576 [info ] [MainThread]:   priority: None
[0m12:31:20.330737 [info ] [MainThread]:   maximum_bytes_billed: None
[0m12:31:20.330898 [info ] [MainThread]:   impersonate_service_account: None
[0m12:31:20.331056 [info ] [MainThread]:   job_retry_deadline_seconds: None
[0m12:31:20.331216 [info ] [MainThread]:   job_retries: 1
[0m12:31:20.331379 [info ] [MainThread]:   job_creation_timeout_seconds: None
[0m12:31:20.331536 [info ] [MainThread]:   job_execution_timeout_seconds: None
[0m12:31:20.331696 [info ] [MainThread]:   timeout_seconds: None
[0m12:31:20.331859 [info ] [MainThread]:   client_id: None
[0m12:31:20.332018 [info ] [MainThread]:   token_uri: None
[0m12:31:20.332175 [info ] [MainThread]:   dataproc_region: None
[0m12:31:20.332329 [info ] [MainThread]:   dataproc_cluster_name: None
[0m12:31:20.332486 [info ] [MainThread]:   gcs_bucket: None
[0m12:31:20.332647 [info ] [MainThread]:   dataproc_batch: None
[0m12:31:20.333051 [info ] [MainThread]: Registered adapter: bigquery=1.9.1
[0m12:31:20.422933 [debug] [MainThread]: Acquiring new bigquery connection 'debug'
[0m12:31:20.423362 [debug] [MainThread]: On debug: select 1 as id
[0m12:31:20.423576 [debug] [MainThread]: Opening a new connection, currently in state init
[0m12:31:21.009826 [debug] [MainThread]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=data-talk-clubs&j=bq:EU:5aedb65a-0777-4d1a-b08e-6efc19ad0019&page=queryresults
[0m12:31:21.339781 [info ] [MainThread]:   Connection test: [[32mOK connection ok[0m]

[0m12:31:21.340152 [info ] [MainThread]: [32mAll checks passed![0m
[0m12:31:21.342953 [debug] [MainThread]: Resource report: {"command_name": "debug", "command_success": true, "command_wall_clock_time": 1.8619457, "process_in_blocks": "0", "process_kernel_time": 0.363851, "process_mem_max_rss": "202964992", "process_out_blocks": "0", "process_user_time": 1.275912}
[0m12:31:21.343289 [debug] [MainThread]: Command `dbt debug` succeeded at 12:31:21.343243 after 1.86 seconds
[0m12:31:21.343513 [debug] [MainThread]: Connection 'debug' was properly closed.
[0m12:31:21.343744 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11929abd0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104769ed0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x12f02e710>]}
[0m12:31:21.343991 [debug] [MainThread]: Flushing usage events
[0m12:31:21.833887 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m12:35:31.041095 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10706ef90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1070cb450>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1070c2cd0>]}


============================== 12:35:31.044925 | ac157ace-e792-4364-9399-6198a3326ca3 ==============================
[0m12:35:31.044925 [info ] [MainThread]: Running with dbt=1.9.3
[0m12:35:31.045393 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': '/Users/timbo/.dbt', 'version_check': 'True', 'warn_error': 'None', 'log_path': '/Users/timbo/Documents/DataTalks/project/src/logs', 'debug': 'False', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'empty': 'False', 'quiet': 'False', 'no_print': 'None', 'log_format': 'default', 'static_parser': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt run', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m12:35:31.797253 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'ac157ace-e792-4364-9399-6198a3326ca3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107a95b90>]}
[0m12:35:31.825777 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'ac157ace-e792-4364-9399-6198a3326ca3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10409a050>]}
[0m12:35:31.826350 [info ] [MainThread]: Registered adapter: bigquery=1.9.1
[0m12:35:31.922302 [debug] [MainThread]: checksum: 5671c00892cdbcef29c3b00cc5ba7510c3d18a35c883caeb9ab9ee266dc29c8f, vars: {}, profile: , target: , version: 1.9.3
[0m12:35:31.922856 [info ] [MainThread]: Unable to do partial parsing because saved manifest not found. Starting full parse.
[0m12:35:31.923097 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'partial_parser', 'label': 'ac157ace-e792-4364-9399-6198a3326ca3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11fb0b190>]}
[0m12:35:32.554659 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'ac157ace-e792-4364-9399-6198a3326ca3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11fb0b7d0>]}
[0m12:35:32.591943 [debug] [MainThread]: Wrote artifact WritableManifest to /Users/timbo/Documents/DataTalks/project/src/target/manifest.json
[0m12:35:32.594126 [debug] [MainThread]: Wrote artifact SemanticManifest to /Users/timbo/Documents/DataTalks/project/src/target/semantic_manifest.json
[0m12:35:32.609842 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'ac157ace-e792-4364-9399-6198a3326ca3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x12da55990>]}
[0m12:35:32.610216 [info ] [MainThread]: Found 4 models, 1 source, 491 macros
[0m12:35:32.610429 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'ac157ace-e792-4364-9399-6198a3326ca3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x12d87f1d0>]}
[0m12:35:32.611431 [info ] [MainThread]: 
[0m12:35:32.611658 [info ] [MainThread]: Concurrency: 8 threads (target='dev')
[0m12:35:32.611830 [info ] [MainThread]: 
[0m12:35:32.612100 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m12:35:32.614282 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_data-talk-clubs'
[0m12:35:32.614574 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m12:35:32.651404 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_data-talk-clubs'
[0m12:35:32.651852 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_data-talk-clubs'
[0m12:35:32.652285 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m12:35:32.652574 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m12:35:33.089203 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_data-talk-clubs, now create_data-talk-clubs_eu_emissions_project_staging)
[0m12:35:33.089539 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_data-talk-clubs, now create_data-talk-clubs_eu_emissions_project_intermediate)
[0m12:35:33.089821 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_data-talk-clubs, now create_data-talk-clubs_eu_emissions_project_marts)
[0m12:35:33.090179 [debug] [ThreadPool]: Creating schema "database: "data-talk-clubs"
schema: "eu_emissions_project_staging"
"
[0m12:35:33.090450 [debug] [ThreadPool]: Creating schema "database: "data-talk-clubs"
schema: "eu_emissions_project_intermediate"
"
[0m12:35:33.090681 [debug] [ThreadPool]: Creating schema "database: "data-talk-clubs"
schema: "eu_emissions_project_marts"
"
[0m12:35:33.095245 [debug] [ThreadPool]: On create_data-talk-clubs_eu_emissions_project_staging: /* {"app": "dbt", "dbt_version": "1.9.3", "profile_name": "big-query", "target_name": "dev", "connection_name": "create_data-talk-clubs_eu_emissions_project_staging"} */
create schema if not exists `data-talk-clubs`.`eu_emissions_project_staging`
  
[0m12:35:33.096355 [debug] [ThreadPool]: On create_data-talk-clubs_eu_emissions_project_intermediate: /* {"app": "dbt", "dbt_version": "1.9.3", "profile_name": "big-query", "target_name": "dev", "connection_name": "create_data-talk-clubs_eu_emissions_project_intermediate"} */
create schema if not exists `data-talk-clubs`.`eu_emissions_project_intermediate`
  
[0m12:35:33.097372 [debug] [ThreadPool]: On create_data-talk-clubs_eu_emissions_project_marts: /* {"app": "dbt", "dbt_version": "1.9.3", "profile_name": "big-query", "target_name": "dev", "connection_name": "create_data-talk-clubs_eu_emissions_project_marts"} */
create schema if not exists `data-talk-clubs`.`eu_emissions_project_marts`
  
[0m12:35:33.097711 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m12:35:33.098035 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m12:35:33.098263 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m12:35:33.612686 [debug] [ThreadPool]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=data-talk-clubs&j=bq:EU:e13867f0-3cfa-46d2-933a-7cea3a028961&page=queryresults
[0m12:35:33.706570 [debug] [ThreadPool]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=data-talk-clubs&j=bq:EU:57185509-013d-42c0-9d28-2386888217ef&page=queryresults
[0m12:35:33.709613 [debug] [ThreadPool]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=data-talk-clubs&j=bq:EU:7ee13fff-752e-46c2-a107-8d1622f16671&page=queryresults
[0m12:35:35.666817 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly create_data-talk-clubs_eu_emissions_project_marts, now list_data-talk-clubs_eu_emissions_project_staging)
[0m12:35:35.667229 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly create_data-talk-clubs_eu_emissions_project_intermediate, now list_data-talk-clubs_eu_emissions_project_intermediate)
[0m12:35:35.667523 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly create_data-talk-clubs_eu_emissions_project_staging, now list_data-talk-clubs_eu_emissions_project_marts)
[0m12:35:35.667775 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m12:35:35.668108 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m12:35:35.668343 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m12:35:36.006220 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'ac157ace-e792-4364-9399-6198a3326ca3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11fb69990>]}
[0m12:35:36.006668 [debug] [MainThread]: Opening a new connection, currently in state init
[0m12:35:36.011524 [debug] [Thread-1 (]: Began running node model.eu_emissions_project.stg_emissions_data
[0m12:35:36.011926 [info ] [Thread-1 (]: 1 of 4 START sql view model eu_emissions_project_staging.stg_emissions_data .... [RUN]
[0m12:35:36.012222 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_data-talk-clubs_eu_emissions_project_staging, now model.eu_emissions_project.stg_emissions_data)
[0m12:35:36.012445 [debug] [Thread-1 (]: Began compiling node model.eu_emissions_project.stg_emissions_data
[0m12:35:36.017924 [debug] [Thread-1 (]: Writing injected SQL for node "model.eu_emissions_project.stg_emissions_data"
[0m12:35:36.018640 [debug] [Thread-1 (]: Began executing node model.eu_emissions_project.stg_emissions_data
[0m12:35:36.033379 [debug] [Thread-1 (]: Writing runtime sql for node "model.eu_emissions_project.stg_emissions_data"
[0m12:35:36.035577 [debug] [Thread-1 (]: On model.eu_emissions_project.stg_emissions_data: /* {"app": "dbt", "dbt_version": "1.9.3", "profile_name": "big-query", "target_name": "dev", "node_id": "model.eu_emissions_project.stg_emissions_data"} */


  create or replace view `data-talk-clubs`.`eu_emissions_project_staging`.`stg_emissions_data`
  OPTIONS()
  as 

WITH source AS (
    SELECT 
        *
    FROM `data-talk-clubs`.`eu_emissions_project`.`nitrogen_dioxide_data`
),

parsed AS (
    SELECT 
        -- Split the first column which contains metadata
        SPLIT(geo_time_period, '\\t')[OFFSET(0)] AS metadata,
        -- Extract all the measurement columns (monthly data from 2018-01 to 2025-02)
        
            CAST(NULLIF(TRIM(`1`), ':') AS FLOAT64) AS measurement_1,
        
            CAST(NULLIF(TRIM(`2`), ':') AS FLOAT64) AS measurement_2,
        
            CAST(NULLIF(TRIM(`3`), ':') AS FLOAT64) AS measurement_3,
        
            CAST(NULLIF(TRIM(`4`), ':') AS FLOAT64) AS measurement_4,
        
            CAST(NULLIF(TRIM(`5`), ':') AS FLOAT64) AS measurement_5,
        
            CAST(NULLIF(TRIM(`6`), ':') AS FLOAT64) AS measurement_6,
        
            CAST(NULLIF(TRIM(`7`), ':') AS FLOAT64) AS measurement_7,
        
            CAST(NULLIF(TRIM(`8`), ':') AS FLOAT64) AS measurement_8,
        
            CAST(NULLIF(TRIM(`9`), ':') AS FLOAT64) AS measurement_9,
        
            CAST(NULLIF(TRIM(`10`), ':') AS FLOAT64) AS measurement_10,
        
            CAST(NULLIF(TRIM(`11`), ':') AS FLOAT64) AS measurement_11,
        
            CAST(NULLIF(TRIM(`12`), ':') AS FLOAT64) AS measurement_12,
        
            CAST(NULLIF(TRIM(`13`), ':') AS FLOAT64) AS measurement_13,
        
            CAST(NULLIF(TRIM(`14`), ':') AS FLOAT64) AS measurement_14,
        
            CAST(NULLIF(TRIM(`15`), ':') AS FLOAT64) AS measurement_15,
        
            CAST(NULLIF(TRIM(`16`), ':') AS FLOAT64) AS measurement_16,
        
            CAST(NULLIF(TRIM(`17`), ':') AS FLOAT64) AS measurement_17,
        
            CAST(NULLIF(TRIM(`18`), ':') AS FLOAT64) AS measurement_18,
        
            CAST(NULLIF(TRIM(`19`), ':') AS FLOAT64) AS measurement_19,
        
            CAST(NULLIF(TRIM(`20`), ':') AS FLOAT64) AS measurement_20,
        
            CAST(NULLIF(TRIM(`21`), ':') AS FLOAT64) AS measurement_21,
        
            CAST(NULLIF(TRIM(`22`), ':') AS FLOAT64) AS measurement_22,
        
            CAST(NULLIF(TRIM(`23`), ':') AS FLOAT64) AS measurement_23,
        
            CAST(NULLIF(TRIM(`24`), ':') AS FLOAT64) AS measurement_24,
        
            CAST(NULLIF(TRIM(`25`), ':') AS FLOAT64) AS measurement_25,
        
            CAST(NULLIF(TRIM(`26`), ':') AS FLOAT64) AS measurement_26,
        
            CAST(NULLIF(TRIM(`27`), ':') AS FLOAT64) AS measurement_27,
        
            CAST(NULLIF(TRIM(`28`), ':') AS FLOAT64) AS measurement_28,
        
            CAST(NULLIF(TRIM(`29`), ':') AS FLOAT64) AS measurement_29,
        
            CAST(NULLIF(TRIM(`30`), ':') AS FLOAT64) AS measurement_30,
        
            CAST(NULLIF(TRIM(`31`), ':') AS FLOAT64) AS measurement_31,
        
            CAST(NULLIF(TRIM(`32`), ':') AS FLOAT64) AS measurement_32,
        
            CAST(NULLIF(TRIM(`33`), ':') AS FLOAT64) AS measurement_33,
        
            CAST(NULLIF(TRIM(`34`), ':') AS FLOAT64) AS measurement_34,
        
            CAST(NULLIF(TRIM(`35`), ':') AS FLOAT64) AS measurement_35,
        
            CAST(NULLIF(TRIM(`36`), ':') AS FLOAT64) AS measurement_36,
        
            CAST(NULLIF(TRIM(`37`), ':') AS FLOAT64) AS measurement_37,
        
            CAST(NULLIF(TRIM(`38`), ':') AS FLOAT64) AS measurement_38,
        
            CAST(NULLIF(TRIM(`39`), ':') AS FLOAT64) AS measurement_39,
        
            CAST(NULLIF(TRIM(`40`), ':') AS FLOAT64) AS measurement_40,
        
            CAST(NULLIF(TRIM(`41`), ':') AS FLOAT64) AS measurement_41,
        
            CAST(NULLIF(TRIM(`42`), ':') AS FLOAT64) AS measurement_42,
        
            CAST(NULLIF(TRIM(`43`), ':') AS FLOAT64) AS measurement_43,
        
            CAST(NULLIF(TRIM(`44`), ':') AS FLOAT64) AS measurement_44,
        
            CAST(NULLIF(TRIM(`45`), ':') AS FLOAT64) AS measurement_45,
        
            CAST(NULLIF(TRIM(`46`), ':') AS FLOAT64) AS measurement_46,
        
            CAST(NULLIF(TRIM(`47`), ':') AS FLOAT64) AS measurement_47,
        
            CAST(NULLIF(TRIM(`48`), ':') AS FLOAT64) AS measurement_48,
        
            CAST(NULLIF(TRIM(`49`), ':') AS FLOAT64) AS measurement_49,
        
            CAST(NULLIF(TRIM(`50`), ':') AS FLOAT64) AS measurement_50,
        
            CAST(NULLIF(TRIM(`51`), ':') AS FLOAT64) AS measurement_51,
        
            CAST(NULLIF(TRIM(`52`), ':') AS FLOAT64) AS measurement_52,
        
            CAST(NULLIF(TRIM(`53`), ':') AS FLOAT64) AS measurement_53,
        
            CAST(NULLIF(TRIM(`54`), ':') AS FLOAT64) AS measurement_54,
        
            CAST(NULLIF(TRIM(`55`), ':') AS FLOAT64) AS measurement_55,
        
            CAST(NULLIF(TRIM(`56`), ':') AS FLOAT64) AS measurement_56,
        
            CAST(NULLIF(TRIM(`57`), ':') AS FLOAT64) AS measurement_57,
        
            CAST(NULLIF(TRIM(`58`), ':') AS FLOAT64) AS measurement_58,
        
            CAST(NULLIF(TRIM(`59`), ':') AS FLOAT64) AS measurement_59,
        
            CAST(NULLIF(TRIM(`60`), ':') AS FLOAT64) AS measurement_60,
        
            CAST(NULLIF(TRIM(`61`), ':') AS FLOAT64) AS measurement_61,
        
            CAST(NULLIF(TRIM(`62`), ':') AS FLOAT64) AS measurement_62,
        
            CAST(NULLIF(TRIM(`63`), ':') AS FLOAT64) AS measurement_63,
        
            CAST(NULLIF(TRIM(`64`), ':') AS FLOAT64) AS measurement_64,
        
            CAST(NULLIF(TRIM(`65`), ':') AS FLOAT64) AS measurement_65,
        
            CAST(NULLIF(TRIM(`66`), ':') AS FLOAT64) AS measurement_66,
        
            CAST(NULLIF(TRIM(`67`), ':') AS FLOAT64) AS measurement_67,
        
            CAST(NULLIF(TRIM(`68`), ':') AS FLOAT64) AS measurement_68,
        
            CAST(NULLIF(TRIM(`69`), ':') AS FLOAT64) AS measurement_69,
        
            CAST(NULLIF(TRIM(`70`), ':') AS FLOAT64) AS measurement_70,
        
            CAST(NULLIF(TRIM(`71`), ':') AS FLOAT64) AS measurement_71,
        
            CAST(NULLIF(TRIM(`72`), ':') AS FLOAT64) AS measurement_72,
        
            CAST(NULLIF(TRIM(`73`), ':') AS FLOAT64) AS measurement_73,
        
            CAST(NULLIF(TRIM(`74`), ':') AS FLOAT64) AS measurement_74,
        
            CAST(NULLIF(TRIM(`75`), ':') AS FLOAT64) AS measurement_75,
        
            CAST(NULLIF(TRIM(`76`), ':') AS FLOAT64) AS measurement_76,
        
            CAST(NULLIF(TRIM(`77`), ':') AS FLOAT64) AS measurement_77,
        
            CAST(NULLIF(TRIM(`78`), ':') AS FLOAT64) AS measurement_78,
        
            CAST(NULLIF(TRIM(`79`), ':') AS FLOAT64) AS measurement_79,
        
            CAST(NULLIF(TRIM(`80`), ':') AS FLOAT64) AS measurement_80,
        
            CAST(NULLIF(TRIM(`81`), ':') AS FLOAT64) AS measurement_81,
        
            CAST(NULLIF(TRIM(`82`), ':') AS FLOAT64) AS measurement_82,
        
            CAST(NULLIF(TRIM(`83`), ':') AS FLOAT64) AS measurement_83,
        
            CAST(NULLIF(TRIM(`84`), ':') AS FLOAT64) AS measurement_84,
        
            CAST(NULLIF(TRIM(`85`), ':') AS FLOAT64) AS measurement_85,
        
        CURRENT_TIMESTAMP() AS load_timestamp
    FROM source
),

metadata_extracted AS (
    SELECT
        -- Extract metadata components
        SPLIT(metadata, ',')[OFFSET(0)] AS frequency,
        SPLIT(metadata, ',')[OFFSET(1)] AS airpol,
        SPLIT(metadata, ',')[OFFSET(2)] AS unit,
        SPLIT(metadata, ',')[OFFSET(3)] AS geo_code,
        -- Include all measurement columns
        
            measurement_1,
        
            measurement_2,
        
            measurement_3,
        
            measurement_4,
        
            measurement_5,
        
            measurement_6,
        
            measurement_7,
        
            measurement_8,
        
            measurement_9,
        
            measurement_10,
        
            measurement_11,
        
            measurement_12,
        
            measurement_13,
        
            measurement_14,
        
            measurement_15,
        
            measurement_16,
        
            measurement_17,
        
            measurement_18,
        
            measurement_19,
        
            measurement_20,
        
            measurement_21,
        
            measurement_22,
        
            measurement_23,
        
            measurement_24,
        
            measurement_25,
        
            measurement_26,
        
            measurement_27,
        
            measurement_28,
        
            measurement_29,
        
            measurement_30,
        
            measurement_31,
        
            measurement_32,
        
            measurement_33,
        
            measurement_34,
        
            measurement_35,
        
            measurement_36,
        
            measurement_37,
        
            measurement_38,
        
            measurement_39,
        
            measurement_40,
        
            measurement_41,
        
            measurement_42,
        
            measurement_43,
        
            measurement_44,
        
            measurement_45,
        
            measurement_46,
        
            measurement_47,
        
            measurement_48,
        
            measurement_49,
        
            measurement_50,
        
            measurement_51,
        
            measurement_52,
        
            measurement_53,
        
            measurement_54,
        
            measurement_55,
        
            measurement_56,
        
            measurement_57,
        
            measurement_58,
        
            measurement_59,
        
            measurement_60,
        
            measurement_61,
        
            measurement_62,
        
            measurement_63,
        
            measurement_64,
        
            measurement_65,
        
            measurement_66,
        
            measurement_67,
        
            measurement_68,
        
            measurement_69,
        
            measurement_70,
        
            measurement_71,
        
            measurement_72,
        
            measurement_73,
        
            measurement_74,
        
            measurement_75,
        
            measurement_76,
        
            measurement_77,
        
            measurement_78,
        
            measurement_79,
        
            measurement_80,
        
            measurement_81,
        
            measurement_82,
        
            measurement_83,
        
            measurement_84,
        
            measurement_85,
        
        load_timestamp
    FROM parsed
)

SELECT 
    -- Generate a unique ID
    ROW_NUMBER() OVER() AS id,
    frequency,
    airpol,
    unit,
    geo_code,
    -- Create a mapping of time periods to measurements
    
        
            STRUCT('2018-01' AS time_period, measurement_1 AS value),
        
    
        
            STRUCT('2018-02' AS time_period, measurement_2 AS value),
        
    
        
            STRUCT('2018-03' AS time_period, measurement_3 AS value),
        
    
        
            -- Continue the pattern for all months
            STRUCT(FORMAT('20%s-%s', 
                CAST(FLOOR(18 + ((4-1) / 12)) AS STRING), 
                LPAD(CAST(MOD(4-1, 12) + 1 AS STRING), 2, '0')
            ) AS time_period, measurement_4 AS value),
        
    
        
            -- Continue the pattern for all months
            STRUCT(FORMAT('20%s-%s', 
                CAST(FLOOR(18 + ((5-1) / 12)) AS STRING), 
                LPAD(CAST(MOD(5-1, 12) + 1 AS STRING), 2, '0')
            ) AS time_period, measurement_5 AS value),
        
    
        
            -- Continue the pattern for all months
            STRUCT(FORMAT('20%s-%s', 
                CAST(FLOOR(18 + ((6-1) / 12)) AS STRING), 
                LPAD(CAST(MOD(6-1, 12) + 1 AS STRING), 2, '0')
            ) AS time_period, measurement_6 AS value),
        
    
        
            -- Continue the pattern for all months
            STRUCT(FORMAT('20%s-%s', 
                CAST(FLOOR(18 + ((7-1) / 12)) AS STRING), 
                LPAD(CAST(MOD(7-1, 12) + 1 AS STRING), 2, '0')
            ) AS time_period, measurement_7 AS value),
        
    
        
            -- Continue the pattern for all months
            STRUCT(FORMAT('20%s-%s', 
                CAST(FLOOR(18 + ((8-1) / 12)) AS STRING), 
                LPAD(CAST(MOD(8-1, 12) + 1 AS STRING), 2, '0')
            ) AS time_period, measurement_8 AS value),
        
    
        
            -- Continue the pattern for all months
            STRUCT(FORMAT('20%s-%s', 
                CAST(FLOOR(18 + ((9-1) / 12)) AS STRING), 
                LPAD(CAST(MOD(9-1, 12) + 1 AS STRING), 2, '0')
            ) AS time_period, measurement_9 AS value),
        
    
        
            -- Continue the pattern for all months
            STRUCT(FORMAT('20%s-%s', 
                CAST(FLOOR(18 + ((10-1) / 12)) AS STRING), 
                LPAD(CAST(MOD(10-1, 12) + 1 AS STRING), 2, '0')
            ) AS time_period, measurement_10 AS value),
        
    
        
            -- Continue the pattern for all months
            STRUCT(FORMAT('20%s-%s', 
                CAST(FLOOR(18 + ((11-1) / 12)) AS STRING), 
                LPAD(CAST(MOD(11-1, 12) + 1 AS STRING), 2, '0')
            ) AS time_period, measurement_11 AS value),
        
    
        
            -- Continue the pattern for all months
            STRUCT(FORMAT('20%s-%s', 
                CAST(FLOOR(18 + ((12-1) / 12)) AS STRING), 
                LPAD(CAST(MOD(12-1, 12) + 1 AS STRING), 2, '0')
            ) AS time_period, measurement_12 AS value),
        
    
        
            -- Continue the pattern for all months
            STRUCT(FORMAT('20%s-%s', 
                CAST(FLOOR(18 + ((13-1) / 12)) AS STRING), 
                LPAD(CAST(MOD(13-1, 12) + 1 AS STRING), 2, '0')
            ) AS time_period, measurement_13 AS value),
        
    
        
            -- Continue the pattern for all months
            STRUCT(FORMAT('20%s-%s', 
                CAST(FLOOR(18 + ((14-1) / 12)) AS STRING), 
                LPAD(CAST(MOD(14-1, 12) + 1 AS STRING), 2, '0')
            ) AS time_period, measurement_14 AS value),
        
    
        
            -- Continue the pattern for all months
            STRUCT(FORMAT('20%s-%s', 
                CAST(FLOOR(18 + ((15-1) / 12)) AS STRING), 
                LPAD(CAST(MOD(15-1, 12) + 1 AS STRING), 2, '0')
            ) AS time_period, measurement_15 AS value),
        
    
        
            -- Continue the pattern for all months
            STRUCT(FORMAT('20%s-%s', 
                CAST(FLOOR(18 + ((16-1) / 12)) AS STRING), 
                LPAD(CAST(MOD(16-1, 12) + 1 AS STRING), 2, '0')
            ) AS time_period, measurement_16 AS value),
        
    
        
            -- Continue the pattern for all months
            STRUCT(FORMAT('20%s-%s', 
                CAST(FLOOR(18 + ((17-1) / 12)) AS STRING), 
                LPAD(CAST(MOD(17-1, 12) + 1 AS STRING), 2, '0')
            ) AS time_period, measurement_17 AS value),
        
    
        
            -- Continue the pattern for all months
            STRUCT(FORMAT('20%s-%s', 
                CAST(FLOOR(18 + ((18-1) / 12)) AS STRING), 
                LPAD(CAST(MOD(18-1, 12) + 1 AS STRING), 2, '0')
            ) AS time_period, measurement_18 AS value),
        
    
        
            -- Continue the pattern for all months
            STRUCT(FORMAT('20%s-%s', 
                CAST(FLOOR(18 + ((19-1) / 12)) AS STRING), 
                LPAD(CAST(MOD(19-1, 12) + 1 AS STRING), 2, '0')
            ) AS time_period, measurement_19 AS value),
        
    
        
            -- Continue the pattern for all months
            STRUCT(FORMAT('20%s-%s', 
                CAST(FLOOR(18 + ((20-1) / 12)) AS STRING), 
                LPAD(CAST(MOD(20-1, 12) + 1 AS STRING), 2, '0')
            ) AS time_period, measurement_20 AS value),
        
    
        
            -- Continue the pattern for all months
            STRUCT(FORMAT('20%s-%s', 
                CAST(FLOOR(18 + ((21-1) / 12)) AS STRING), 
                LPAD(CAST(MOD(21-1, 12) + 1 AS STRING), 2, '0')
            ) AS time_period, measurement_21 AS value),
        
    
        
            -- Continue the pattern for all months
            STRUCT(FORMAT('20%s-%s', 
                CAST(FLOOR(18 + ((22-1) / 12)) AS STRING), 
                LPAD(CAST(MOD(22-1, 12) + 1 AS STRING), 2, '0')
            ) AS time_period, measurement_22 AS value),
        
    
        
            -- Continue the pattern for all months
            STRUCT(FORMAT('20%s-%s', 
                CAST(FLOOR(18 + ((23-1) / 12)) AS STRING), 
                LPAD(CAST(MOD(23-1, 12) + 1 AS STRING), 2, '0')
            ) AS time_period, measurement_23 AS value),
        
    
        
            -- Continue the pattern for all months
            STRUCT(FORMAT('20%s-%s', 
                CAST(FLOOR(18 + ((24-1) / 12)) AS STRING), 
                LPAD(CAST(MOD(24-1, 12) + 1 AS STRING), 2, '0')
            ) AS time_period, measurement_24 AS value),
        
    
        
            -- Continue the pattern for all months
            STRUCT(FORMAT('20%s-%s', 
                CAST(FLOOR(18 + ((25-1) / 12)) AS STRING), 
                LPAD(CAST(MOD(25-1, 12) + 1 AS STRING), 2, '0')
            ) AS time_period, measurement_25 AS value),
        
    
        
            -- Continue the pattern for all months
            STRUCT(FORMAT('20%s-%s', 
                CAST(FLOOR(18 + ((26-1) / 12)) AS STRING), 
                LPAD(CAST(MOD(26-1, 12) + 1 AS STRING), 2, '0')
            ) AS time_period, measurement_26 AS value),
        
    
        
            -- Continue the pattern for all months
            STRUCT(FORMAT('20%s-%s', 
                CAST(FLOOR(18 + ((27-1) / 12)) AS STRING), 
                LPAD(CAST(MOD(27-1, 12) + 1 AS STRING), 2, '0')
            ) AS time_period, measurement_27 AS value),
        
    
        
            -- Continue the pattern for all months
            STRUCT(FORMAT('20%s-%s', 
                CAST(FLOOR(18 + ((28-1) / 12)) AS STRING), 
                LPAD(CAST(MOD(28-1, 12) + 1 AS STRING), 2, '0')
            ) AS time_period, measurement_28 AS value),
        
    
        
            -- Continue the pattern for all months
            STRUCT(FORMAT('20%s-%s', 
                CAST(FLOOR(18 + ((29-1) / 12)) AS STRING), 
                LPAD(CAST(MOD(29-1, 12) + 1 AS STRING), 2, '0')
            ) AS time_period, measurement_29 AS value),
        
    
        
            -- Continue the pattern for all months
            STRUCT(FORMAT('20%s-%s', 
                CAST(FLOOR(18 + ((30-1) / 12)) AS STRING), 
                LPAD(CAST(MOD(30-1, 12) + 1 AS STRING), 2, '0')
            ) AS time_period, measurement_30 AS value),
        
    
        
            -- Continue the pattern for all months
            STRUCT(FORMAT('20%s-%s', 
                CAST(FLOOR(18 + ((31-1) / 12)) AS STRING), 
                LPAD(CAST(MOD(31-1, 12) + 1 AS STRING), 2, '0')
            ) AS time_period, measurement_31 AS value),
        
    
        
            -- Continue the pattern for all months
            STRUCT(FORMAT('20%s-%s', 
                CAST(FLOOR(18 + ((32-1) / 12)) AS STRING), 
                LPAD(CAST(MOD(32-1, 12) + 1 AS STRING), 2, '0')
            ) AS time_period, measurement_32 AS value),
        
    
        
            -- Continue the pattern for all months
            STRUCT(FORMAT('20%s-%s', 
                CAST(FLOOR(18 + ((33-1) / 12)) AS STRING), 
                LPAD(CAST(MOD(33-1, 12) + 1 AS STRING), 2, '0')
            ) AS time_period, measurement_33 AS value),
        
    
        
            -- Continue the pattern for all months
            STRUCT(FORMAT('20%s-%s', 
                CAST(FLOOR(18 + ((34-1) / 12)) AS STRING), 
                LPAD(CAST(MOD(34-1, 12) + 1 AS STRING), 2, '0')
            ) AS time_period, measurement_34 AS value),
        
    
        
            -- Continue the pattern for all months
            STRUCT(FORMAT('20%s-%s', 
                CAST(FLOOR(18 + ((35-1) / 12)) AS STRING), 
                LPAD(CAST(MOD(35-1, 12) + 1 AS STRING), 2, '0')
            ) AS time_period, measurement_35 AS value),
        
    
        
            -- Continue the pattern for all months
            STRUCT(FORMAT('20%s-%s', 
                CAST(FLOOR(18 + ((36-1) / 12)) AS STRING), 
                LPAD(CAST(MOD(36-1, 12) + 1 AS STRING), 2, '0')
            ) AS time_period, measurement_36 AS value),
        
    
        
            -- Continue the pattern for all months
            STRUCT(FORMAT('20%s-%s', 
                CAST(FLOOR(18 + ((37-1) / 12)) AS STRING), 
                LPAD(CAST(MOD(37-1, 12) + 1 AS STRING), 2, '0')
            ) AS time_period, measurement_37 AS value),
        
    
        
            -- Continue the pattern for all months
            STRUCT(FORMAT('20%s-%s', 
                CAST(FLOOR(18 + ((38-1) / 12)) AS STRING), 
                LPAD(CAST(MOD(38-1, 12) + 1 AS STRING), 2, '0')
            ) AS time_period, measurement_38 AS value),
        
    
        
            -- Continue the pattern for all months
            STRUCT(FORMAT('20%s-%s', 
                CAST(FLOOR(18 + ((39-1) / 12)) AS STRING), 
                LPAD(CAST(MOD(39-1, 12) + 1 AS STRING), 2, '0')
            ) AS time_period, measurement_39 AS value),
        
    
        
            -- Continue the pattern for all months
            STRUCT(FORMAT('20%s-%s', 
                CAST(FLOOR(18 + ((40-1) / 12)) AS STRING), 
                LPAD(CAST(MOD(40-1, 12) + 1 AS STRING), 2, '0')
            ) AS time_period, measurement_40 AS value),
        
    
        
            -- Continue the pattern for all months
            STRUCT(FORMAT('20%s-%s', 
                CAST(FLOOR(18 + ((41-1) / 12)) AS STRING), 
                LPAD(CAST(MOD(41-1, 12) + 1 AS STRING), 2, '0')
            ) AS time_period, measurement_41 AS value),
        
    
        
            -- Continue the pattern for all months
            STRUCT(FORMAT('20%s-%s', 
                CAST(FLOOR(18 + ((42-1) / 12)) AS STRING), 
                LPAD(CAST(MOD(42-1, 12) + 1 AS STRING), 2, '0')
            ) AS time_period, measurement_42 AS value),
        
    
        
            -- Continue the pattern for all months
            STRUCT(FORMAT('20%s-%s', 
                CAST(FLOOR(18 + ((43-1) / 12)) AS STRING), 
                LPAD(CAST(MOD(43-1, 12) + 1 AS STRING), 2, '0')
            ) AS time_period, measurement_43 AS value),
        
    
        
            -- Continue the pattern for all months
            STRUCT(FORMAT('20%s-%s', 
                CAST(FLOOR(18 + ((44-1) / 12)) AS STRING), 
                LPAD(CAST(MOD(44-1, 12) + 1 AS STRING), 2, '0')
            ) AS time_period, measurement_44 AS value),
        
    
        
            -- Continue the pattern for all months
            STRUCT(FORMAT('20%s-%s', 
                CAST(FLOOR(18 + ((45-1) / 12)) AS STRING), 
                LPAD(CAST(MOD(45-1, 12) + 1 AS STRING), 2, '0')
            ) AS time_period, measurement_45 AS value),
        
    
        
            -- Continue the pattern for all months
            STRUCT(FORMAT('20%s-%s', 
                CAST(FLOOR(18 + ((46-1) / 12)) AS STRING), 
                LPAD(CAST(MOD(46-1, 12) + 1 AS STRING), 2, '0')
            ) AS time_period, measurement_46 AS value),
        
    
        
            -- Continue the pattern for all months
            STRUCT(FORMAT('20%s-%s', 
                CAST(FLOOR(18 + ((47-1) / 12)) AS STRING), 
                LPAD(CAST(MOD(47-1, 12) + 1 AS STRING), 2, '0')
            ) AS time_period, measurement_47 AS value),
        
    
        
            -- Continue the pattern for all months
            STRUCT(FORMAT('20%s-%s', 
                CAST(FLOOR(18 + ((48-1) / 12)) AS STRING), 
                LPAD(CAST(MOD(48-1, 12) + 1 AS STRING), 2, '0')
            ) AS time_period, measurement_48 AS value),
        
    
        
            -- Continue the pattern for all months
            STRUCT(FORMAT('20%s-%s', 
                CAST(FLOOR(18 + ((49-1) / 12)) AS STRING), 
                LPAD(CAST(MOD(49-1, 12) + 1 AS STRING), 2, '0')
            ) AS time_period, measurement_49 AS value),
        
    
        
            -- Continue the pattern for all months
            STRUCT(FORMAT('20%s-%s', 
                CAST(FLOOR(18 + ((50-1) / 12)) AS STRING), 
                LPAD(CAST(MOD(50-1, 12) + 1 AS STRING), 2, '0')
            ) AS time_period, measurement_50 AS value),
        
    
        
            -- Continue the pattern for all months
            STRUCT(FORMAT('20%s-%s', 
                CAST(FLOOR(18 + ((51-1) / 12)) AS STRING), 
                LPAD(CAST(MOD(51-1, 12) + 1 AS STRING), 2, '0')
            ) AS time_period, measurement_51 AS value),
        
    
        
            -- Continue the pattern for all months
            STRUCT(FORMAT('20%s-%s', 
                CAST(FLOOR(18 + ((52-1) / 12)) AS STRING), 
                LPAD(CAST(MOD(52-1, 12) + 1 AS STRING), 2, '0')
            ) AS time_period, measurement_52 AS value),
        
    
        
            -- Continue the pattern for all months
            STRUCT(FORMAT('20%s-%s', 
                CAST(FLOOR(18 + ((53-1) / 12)) AS STRING), 
                LPAD(CAST(MOD(53-1, 12) + 1 AS STRING), 2, '0')
            ) AS time_period, measurement_53 AS value),
        
    
        
            -- Continue the pattern for all months
            STRUCT(FORMAT('20%s-%s', 
                CAST(FLOOR(18 + ((54-1) / 12)) AS STRING), 
                LPAD(CAST(MOD(54-1, 12) + 1 AS STRING), 2, '0')
            ) AS time_period, measurement_54 AS value),
        
    
        
            -- Continue the pattern for all months
            STRUCT(FORMAT('20%s-%s', 
                CAST(FLOOR(18 + ((55-1) / 12)) AS STRING), 
                LPAD(CAST(MOD(55-1, 12) + 1 AS STRING), 2, '0')
            ) AS time_period, measurement_55 AS value),
        
    
        
            -- Continue the pattern for all months
            STRUCT(FORMAT('20%s-%s', 
                CAST(FLOOR(18 + ((56-1) / 12)) AS STRING), 
                LPAD(CAST(MOD(56-1, 12) + 1 AS STRING), 2, '0')
            ) AS time_period, measurement_56 AS value),
        
    
        
            -- Continue the pattern for all months
            STRUCT(FORMAT('20%s-%s', 
                CAST(FLOOR(18 + ((57-1) / 12)) AS STRING), 
                LPAD(CAST(MOD(57-1, 12) + 1 AS STRING), 2, '0')
            ) AS time_period, measurement_57 AS value),
        
    
        
            -- Continue the pattern for all months
            STRUCT(FORMAT('20%s-%s', 
                CAST(FLOOR(18 + ((58-1) / 12)) AS STRING), 
                LPAD(CAST(MOD(58-1, 12) + 1 AS STRING), 2, '0')
            ) AS time_period, measurement_58 AS value),
        
    
        
            -- Continue the pattern for all months
            STRUCT(FORMAT('20%s-%s', 
                CAST(FLOOR(18 + ((59-1) / 12)) AS STRING), 
                LPAD(CAST(MOD(59-1, 12) + 1 AS STRING), 2, '0')
            ) AS time_period, measurement_59 AS value),
        
    
        
            -- Continue the pattern for all months
            STRUCT(FORMAT('20%s-%s', 
                CAST(FLOOR(18 + ((60-1) / 12)) AS STRING), 
                LPAD(CAST(MOD(60-1, 12) + 1 AS STRING), 2, '0')
            ) AS time_period, measurement_60 AS value),
        
    
        
            -- Continue the pattern for all months
            STRUCT(FORMAT('20%s-%s', 
                CAST(FLOOR(18 + ((61-1) / 12)) AS STRING), 
                LPAD(CAST(MOD(61-1, 12) + 1 AS STRING), 2, '0')
            ) AS time_period, measurement_61 AS value),
        
    
        
            -- Continue the pattern for all months
            STRUCT(FORMAT('20%s-%s', 
                CAST(FLOOR(18 + ((62-1) / 12)) AS STRING), 
                LPAD(CAST(MOD(62-1, 12) + 1 AS STRING), 2, '0')
            ) AS time_period, measurement_62 AS value),
        
    
        
            -- Continue the pattern for all months
            STRUCT(FORMAT('20%s-%s', 
                CAST(FLOOR(18 + ((63-1) / 12)) AS STRING), 
                LPAD(CAST(MOD(63-1, 12) + 1 AS STRING), 2, '0')
            ) AS time_period, measurement_63 AS value),
        
    
        
            -- Continue the pattern for all months
            STRUCT(FORMAT('20%s-%s', 
                CAST(FLOOR(18 + ((64-1) / 12)) AS STRING), 
                LPAD(CAST(MOD(64-1, 12) + 1 AS STRING), 2, '0')
            ) AS time_period, measurement_64 AS value),
        
    
        
            -- Continue the pattern for all months
            STRUCT(FORMAT('20%s-%s', 
                CAST(FLOOR(18 + ((65-1) / 12)) AS STRING), 
                LPAD(CAST(MOD(65-1, 12) + 1 AS STRING), 2, '0')
            ) AS time_period, measurement_65 AS value),
        
    
        
            -- Continue the pattern for all months
            STRUCT(FORMAT('20%s-%s', 
                CAST(FLOOR(18 + ((66-1) / 12)) AS STRING), 
                LPAD(CAST(MOD(66-1, 12) + 1 AS STRING), 2, '0')
            ) AS time_period, measurement_66 AS value),
        
    
        
            -- Continue the pattern for all months
            STRUCT(FORMAT('20%s-%s', 
                CAST(FLOOR(18 + ((67-1) / 12)) AS STRING), 
                LPAD(CAST(MOD(67-1, 12) + 1 AS STRING), 2, '0')
            ) AS time_period, measurement_67 AS value),
        
    
        
            -- Continue the pattern for all months
            STRUCT(FORMAT('20%s-%s', 
                CAST(FLOOR(18 + ((68-1) / 12)) AS STRING), 
                LPAD(CAST(MOD(68-1, 12) + 1 AS STRING), 2, '0')
            ) AS time_period, measurement_68 AS value),
        
    
        
            -- Continue the pattern for all months
            STRUCT(FORMAT('20%s-%s', 
                CAST(FLOOR(18 + ((69-1) / 12)) AS STRING), 
                LPAD(CAST(MOD(69-1, 12) + 1 AS STRING), 2, '0')
            ) AS time_period, measurement_69 AS value),
        
    
        
            -- Continue the pattern for all months
            STRUCT(FORMAT('20%s-%s', 
                CAST(FLOOR(18 + ((70-1) / 12)) AS STRING), 
                LPAD(CAST(MOD(70-1, 12) + 1 AS STRING), 2, '0')
            ) AS time_period, measurement_70 AS value),
        
    
        
            -- Continue the pattern for all months
            STRUCT(FORMAT('20%s-%s', 
                CAST(FLOOR(18 + ((71-1) / 12)) AS STRING), 
                LPAD(CAST(MOD(71-1, 12) + 1 AS STRING), 2, '0')
            ) AS time_period, measurement_71 AS value),
        
    
        
            -- Continue the pattern for all months
            STRUCT(FORMAT('20%s-%s', 
                CAST(FLOOR(18 + ((72-1) / 12)) AS STRING), 
                LPAD(CAST(MOD(72-1, 12) + 1 AS STRING), 2, '0')
            ) AS time_period, measurement_72 AS value),
        
    
        
            -- Continue the pattern for all months
            STRUCT(FORMAT('20%s-%s', 
                CAST(FLOOR(18 + ((73-1) / 12)) AS STRING), 
                LPAD(CAST(MOD(73-1, 12) + 1 AS STRING), 2, '0')
            ) AS time_period, measurement_73 AS value),
        
    
        
            -- Continue the pattern for all months
            STRUCT(FORMAT('20%s-%s', 
                CAST(FLOOR(18 + ((74-1) / 12)) AS STRING), 
                LPAD(CAST(MOD(74-1, 12) + 1 AS STRING), 2, '0')
            ) AS time_period, measurement_74 AS value),
        
    
        
            -- Continue the pattern for all months
            STRUCT(FORMAT('20%s-%s', 
                CAST(FLOOR(18 + ((75-1) / 12)) AS STRING), 
                LPAD(CAST(MOD(75-1, 12) + 1 AS STRING), 2, '0')
            ) AS time_period, measurement_75 AS value),
        
    
        
            -- Continue the pattern for all months
            STRUCT(FORMAT('20%s-%s', 
                CAST(FLOOR(18 + ((76-1) / 12)) AS STRING), 
                LPAD(CAST(MOD(76-1, 12) + 1 AS STRING), 2, '0')
            ) AS time_period, measurement_76 AS value),
        
    
        
            -- Continue the pattern for all months
            STRUCT(FORMAT('20%s-%s', 
                CAST(FLOOR(18 + ((77-1) / 12)) AS STRING), 
                LPAD(CAST(MOD(77-1, 12) + 1 AS STRING), 2, '0')
            ) AS time_period, measurement_77 AS value),
        
    
        
            -- Continue the pattern for all months
            STRUCT(FORMAT('20%s-%s', 
                CAST(FLOOR(18 + ((78-1) / 12)) AS STRING), 
                LPAD(CAST(MOD(78-1, 12) + 1 AS STRING), 2, '0')
            ) AS time_period, measurement_78 AS value),
        
    
        
            -- Continue the pattern for all months
            STRUCT(FORMAT('20%s-%s', 
                CAST(FLOOR(18 + ((79-1) / 12)) AS STRING), 
                LPAD(CAST(MOD(79-1, 12) + 1 AS STRING), 2, '0')
            ) AS time_period, measurement_79 AS value),
        
    
        
            -- Continue the pattern for all months
            STRUCT(FORMAT('20%s-%s', 
                CAST(FLOOR(18 + ((80-1) / 12)) AS STRING), 
                LPAD(CAST(MOD(80-1, 12) + 1 AS STRING), 2, '0')
            ) AS time_period, measurement_80 AS value),
        
    
        
            -- Continue the pattern for all months
            STRUCT(FORMAT('20%s-%s', 
                CAST(FLOOR(18 + ((81-1) / 12)) AS STRING), 
                LPAD(CAST(MOD(81-1, 12) + 1 AS STRING), 2, '0')
            ) AS time_period, measurement_81 AS value),
        
    
        
            -- Continue the pattern for all months
            STRUCT(FORMAT('20%s-%s', 
                CAST(FLOOR(18 + ((82-1) / 12)) AS STRING), 
                LPAD(CAST(MOD(82-1, 12) + 1 AS STRING), 2, '0')
            ) AS time_period, measurement_82 AS value),
        
    
        
            -- Continue the pattern for all months
            STRUCT(FORMAT('20%s-%s', 
                CAST(FLOOR(18 + ((83-1) / 12)) AS STRING), 
                LPAD(CAST(MOD(83-1, 12) + 1 AS STRING), 2, '0')
            ) AS time_period, measurement_83 AS value),
        
    
        
            -- Continue the pattern for all months
            STRUCT(FORMAT('20%s-%s', 
                CAST(FLOOR(18 + ((84-1) / 12)) AS STRING), 
                LPAD(CAST(MOD(84-1, 12) + 1 AS STRING), 2, '0')
            ) AS time_period, measurement_84 AS value),
        
    
        
            -- Continue the pattern for all months
            STRUCT(FORMAT('20%s-%s', 
                CAST(FLOOR(18 + ((85-1) / 12)) AS STRING), 
                LPAD(CAST(MOD(85-1, 12) + 1 AS STRING), 2, '0')
            ) AS time_period, measurement_85 AS value),
        
    
    load_timestamp
FROM metadata_extracted;


[0m12:35:36.037643 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m12:35:36.505344 [debug] [Thread-1 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=data-talk-clubs&j=bq:EU:56e3d83d-5efd-46f0-89e1-aec98b44cb13&page=queryresults
[0m12:35:36.506168 [error] [Thread-1 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=data-talk-clubs&j=bq:EU:56e3d83d-5efd-46f0-89e1-aec98b44cb13&page=queryresults
[0m12:35:36.512949 [debug] [Thread-1 (]: Database Error in model stg_emissions_data (models/staging/stg_emissions_data.sql)
  Not found: Table data-talk-clubs:eu_emissions_project.nitrogen_dioxide_data was not found in location EU
  compiled code at target/run/eu_emissions_project/models/staging/stg_emissions_data.sql
[0m12:35:36.514321 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ac157ace-e792-4364-9399-6198a3326ca3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x12f5eca50>]}
[0m12:35:36.515005 [error] [Thread-1 (]: 1 of 4 ERROR creating sql view model eu_emissions_project_staging.stg_emissions_data  [[31mERROR[0m in 0.50s]
[0m12:35:36.515389 [debug] [Thread-1 (]: Finished running node model.eu_emissions_project.stg_emissions_data
[0m12:35:36.515788 [debug] [Thread-11 ]: Marking all children of 'model.eu_emissions_project.stg_emissions_data' to be skipped because of status 'error'.  Reason: Database Error in model stg_emissions_data (models/staging/stg_emissions_data.sql)
  Not found: Table data-talk-clubs:eu_emissions_project.nitrogen_dioxide_data was not found in location EU
  compiled code at target/run/eu_emissions_project/models/staging/stg_emissions_data.sql.
[0m12:35:36.516660 [debug] [Thread-3 (]: Began running node model.eu_emissions_project.int_emissions_cleaned
[0m12:35:36.517075 [debug] [Thread-4 (]: Began running node model.eu_emissions_project.int_emissions_unpivoted
[0m12:35:36.517430 [info ] [Thread-3 (]: 2 of 4 SKIP relation eu_emissions_project_intermediate.int_emissions_cleaned ... [[33mSKIP[0m]
[0m12:35:36.517801 [info ] [Thread-4 (]: 3 of 4 SKIP relation eu_emissions_project_intermediate.int_emissions_unpivoted . [[33mSKIP[0m]
[0m12:35:36.518175 [debug] [Thread-3 (]: Finished running node model.eu_emissions_project.int_emissions_cleaned
[0m12:35:36.518759 [debug] [Thread-4 (]: Finished running node model.eu_emissions_project.int_emissions_unpivoted
[0m12:35:36.519364 [debug] [Thread-6 (]: Began running node model.eu_emissions_project.emissions_analysis
[0m12:35:36.519732 [info ] [Thread-6 (]: 4 of 4 SKIP relation eu_emissions_project_marts.emissions_analysis ............. [[33mSKIP[0m]
[0m12:35:36.520056 [debug] [Thread-6 (]: Finished running node model.eu_emissions_project.emissions_analysis
[0m12:35:36.521037 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m12:35:36.522098 [debug] [MainThread]: Connection 'master' was properly closed.
[0m12:35:36.522327 [debug] [MainThread]: Connection 'model.eu_emissions_project.stg_emissions_data' was properly closed.
[0m12:35:36.522499 [debug] [MainThread]: Connection 'list_data-talk-clubs_eu_emissions_project_intermediate' was properly closed.
[0m12:35:36.522664 [debug] [MainThread]: Connection 'list_data-talk-clubs_eu_emissions_project_marts' was properly closed.
[0m12:35:36.522886 [info ] [MainThread]: 
[0m12:35:36.523082 [info ] [MainThread]: Finished running 2 table models, 2 view models in 0 hours 0 minutes and 3.91 seconds (3.91s).
[0m12:35:36.523470 [debug] [MainThread]: Command end result
[0m12:35:36.537377 [debug] [MainThread]: Wrote artifact WritableManifest to /Users/timbo/Documents/DataTalks/project/src/target/manifest.json
[0m12:35:36.538415 [debug] [MainThread]: Wrote artifact SemanticManifest to /Users/timbo/Documents/DataTalks/project/src/target/semantic_manifest.json
[0m12:35:36.541369 [debug] [MainThread]: Wrote artifact RunExecutionResult to /Users/timbo/Documents/DataTalks/project/src/target/run_results.json
[0m12:35:36.541580 [info ] [MainThread]: 
[0m12:35:36.541805 [info ] [MainThread]: [31mCompleted with 1 error, 0 partial successes, and 0 warnings:[0m
[0m12:35:36.541985 [info ] [MainThread]: 
[0m12:35:36.542200 [error] [MainThread]:   Database Error in model stg_emissions_data (models/staging/stg_emissions_data.sql)
  Not found: Table data-talk-clubs:eu_emissions_project.nitrogen_dioxide_data was not found in location EU
  compiled code at target/run/eu_emissions_project/models/staging/stg_emissions_data.sql
[0m12:35:36.542373 [info ] [MainThread]: 
[0m12:35:36.542554 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=3 TOTAL=4
[0m12:35:36.544425 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": false, "command_wall_clock_time": 5.542848, "process_in_blocks": "0", "process_kernel_time": 0.386351, "process_mem_max_rss": "216776704", "process_out_blocks": "0", "process_user_time": 2.301759}
[0m12:35:36.545026 [debug] [MainThread]: Command `dbt run` failed at 12:35:36.544923 after 5.54 seconds
[0m12:35:36.545398 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x100dbe010>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1070cbe10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x12daed0d0>]}
[0m12:35:36.545672 [debug] [MainThread]: Flushing usage events
[0m12:35:37.063260 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m12:38:32.699968 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x106a6e090>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x106acb390>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x106acbfd0>]}


============================== 12:38:32.703637 | 7647346b-828c-47b4-beb4-7303221e9e4b ==============================
[0m12:38:32.703637 [info ] [MainThread]: Running with dbt=1.9.3
[0m12:38:32.704050 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'profiles_dir': '/Users/timbo/.dbt', 'log_path': '/Users/timbo/Documents/DataTalks/project/src/logs', 'fail_fast': 'False', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'empty': 'False', 'quiet': 'False', 'no_print': 'None', 'log_format': 'default', 'static_parser': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt run', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m12:38:33.467067 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '7647346b-828c-47b4-beb4-7303221e9e4b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1155b0f50>]}
[0m12:38:33.494438 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '7647346b-828c-47b4-beb4-7303221e9e4b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1044a02d0>]}
[0m12:38:33.494982 [info ] [MainThread]: Registered adapter: bigquery=1.9.1
[0m12:38:33.586441 [debug] [MainThread]: checksum: 5671c00892cdbcef29c3b00cc5ba7510c3d18a35c883caeb9ab9ee266dc29c8f, vars: {}, profile: , target: , version: 1.9.3
[0m12:38:33.710502 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 3 files changed.
[0m12:38:33.711274 [debug] [MainThread]: Partial parsing: updated file: eu_emissions_project://models/staging/sources.yml
[0m12:38:33.711600 [debug] [MainThread]: Partial parsing: updated file: eu_emissions_project://models/staging/stg_emissions_data.sql
[0m12:38:33.711801 [debug] [MainThread]: Partial parsing: updated file: eu_emissions_project://models/intermediate/int_emissions_unpivoted.sql
[0m12:38:33.917862 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '7647346b-828c-47b4-beb4-7303221e9e4b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1165eb210>]}
[0m12:38:33.952155 [debug] [MainThread]: Wrote artifact WritableManifest to /Users/timbo/Documents/DataTalks/project/src/target/manifest.json
[0m12:38:33.954462 [debug] [MainThread]: Wrote artifact SemanticManifest to /Users/timbo/Documents/DataTalks/project/src/target/semantic_manifest.json
[0m12:38:33.967308 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '7647346b-828c-47b4-beb4-7303221e9e4b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11695d850>]}
[0m12:38:33.967678 [info ] [MainThread]: Found 4 models, 1 source, 491 macros
[0m12:38:33.967909 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '7647346b-828c-47b4-beb4-7303221e9e4b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11673a050>]}
[0m12:38:33.969006 [info ] [MainThread]: 
[0m12:38:33.969277 [info ] [MainThread]: Concurrency: 8 threads (target='dev')
[0m12:38:33.969466 [info ] [MainThread]: 
[0m12:38:33.969797 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m12:38:33.972008 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_data-talk-clubs'
[0m12:38:33.972324 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_data-talk-clubs'
[0m12:38:33.972582 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m12:38:33.972805 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_data-talk-clubs'
[0m12:38:33.973035 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m12:38:33.973303 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m12:38:34.728550 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_data-talk-clubs, now list_data-talk-clubs_eu_emissions_project_staging)
[0m12:38:34.728989 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_data-talk-clubs, now list_data-talk-clubs_eu_emissions_project_intermediate)
[0m12:38:34.729372 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_data-talk-clubs, now list_data-talk-clubs_eu_emissions_project_marts)
[0m12:38:34.729630 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m12:38:34.729879 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m12:38:34.730099 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m12:38:35.101937 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '7647346b-828c-47b4-beb4-7303221e9e4b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x115edc750>]}
[0m12:38:35.102413 [debug] [MainThread]: Opening a new connection, currently in state init
[0m12:38:35.106009 [debug] [Thread-1 (]: Began running node model.eu_emissions_project.stg_emissions_data
[0m12:38:35.106446 [info ] [Thread-1 (]: 1 of 4 START sql view model eu_emissions_project_staging.stg_emissions_data .... [RUN]
[0m12:38:35.106749 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_data-talk-clubs_eu_emissions_project_staging, now model.eu_emissions_project.stg_emissions_data)
[0m12:38:35.106966 [debug] [Thread-1 (]: Began compiling node model.eu_emissions_project.stg_emissions_data
[0m12:38:35.111707 [debug] [Thread-1 (]: Writing injected SQL for node "model.eu_emissions_project.stg_emissions_data"
[0m12:38:35.112301 [debug] [Thread-1 (]: Began executing node model.eu_emissions_project.stg_emissions_data
[0m12:38:35.128152 [debug] [Thread-1 (]: Writing runtime sql for node "model.eu_emissions_project.stg_emissions_data"
[0m12:38:35.129217 [debug] [Thread-1 (]: On model.eu_emissions_project.stg_emissions_data: /* {"app": "dbt", "dbt_version": "1.9.3", "profile_name": "big-query", "target_name": "dev", "node_id": "model.eu_emissions_project.stg_emissions_data"} */


  create or replace view `data-talk-clubs`.`eu_emissions_project_staging`.`stg_emissions_data`
  OPTIONS()
  as 

WITH source AS (
    SELECT 
        *
    FROM `data-talk-clubs`.`eu_emissions_project`.`nitrogen_dioxide_data`
),

parsed AS (
    SELECT 
        -- Split the first column which contains metadata
        SPLIT(geo_time_period, '\\t')[OFFSET(0)] AS metadata,
        -- Extract all the measurement columns (monthly data from 2018-01 to 2025-02)
        
            CAST(NULLIF(TRIM(`1`), ':') AS FLOAT64) AS measurement_1,
        
            CAST(NULLIF(TRIM(`2`), ':') AS FLOAT64) AS measurement_2,
        
            CAST(NULLIF(TRIM(`3`), ':') AS FLOAT64) AS measurement_3,
        
            CAST(NULLIF(TRIM(`4`), ':') AS FLOAT64) AS measurement_4,
        
            CAST(NULLIF(TRIM(`5`), ':') AS FLOAT64) AS measurement_5,
        
            CAST(NULLIF(TRIM(`6`), ':') AS FLOAT64) AS measurement_6,
        
            CAST(NULLIF(TRIM(`7`), ':') AS FLOAT64) AS measurement_7,
        
            CAST(NULLIF(TRIM(`8`), ':') AS FLOAT64) AS measurement_8,
        
            CAST(NULLIF(TRIM(`9`), ':') AS FLOAT64) AS measurement_9,
        
            CAST(NULLIF(TRIM(`10`), ':') AS FLOAT64) AS measurement_10,
        
            CAST(NULLIF(TRIM(`11`), ':') AS FLOAT64) AS measurement_11,
        
            CAST(NULLIF(TRIM(`12`), ':') AS FLOAT64) AS measurement_12,
        
            CAST(NULLIF(TRIM(`13`), ':') AS FLOAT64) AS measurement_13,
        
            CAST(NULLIF(TRIM(`14`), ':') AS FLOAT64) AS measurement_14,
        
            CAST(NULLIF(TRIM(`15`), ':') AS FLOAT64) AS measurement_15,
        
            CAST(NULLIF(TRIM(`16`), ':') AS FLOAT64) AS measurement_16,
        
            CAST(NULLIF(TRIM(`17`), ':') AS FLOAT64) AS measurement_17,
        
            CAST(NULLIF(TRIM(`18`), ':') AS FLOAT64) AS measurement_18,
        
            CAST(NULLIF(TRIM(`19`), ':') AS FLOAT64) AS measurement_19,
        
            CAST(NULLIF(TRIM(`20`), ':') AS FLOAT64) AS measurement_20,
        
            CAST(NULLIF(TRIM(`21`), ':') AS FLOAT64) AS measurement_21,
        
            CAST(NULLIF(TRIM(`22`), ':') AS FLOAT64) AS measurement_22,
        
            CAST(NULLIF(TRIM(`23`), ':') AS FLOAT64) AS measurement_23,
        
            CAST(NULLIF(TRIM(`24`), ':') AS FLOAT64) AS measurement_24,
        
            CAST(NULLIF(TRIM(`25`), ':') AS FLOAT64) AS measurement_25,
        
            CAST(NULLIF(TRIM(`26`), ':') AS FLOAT64) AS measurement_26,
        
            CAST(NULLIF(TRIM(`27`), ':') AS FLOAT64) AS measurement_27,
        
            CAST(NULLIF(TRIM(`28`), ':') AS FLOAT64) AS measurement_28,
        
            CAST(NULLIF(TRIM(`29`), ':') AS FLOAT64) AS measurement_29,
        
            CAST(NULLIF(TRIM(`30`), ':') AS FLOAT64) AS measurement_30,
        
            CAST(NULLIF(TRIM(`31`), ':') AS FLOAT64) AS measurement_31,
        
            CAST(NULLIF(TRIM(`32`), ':') AS FLOAT64) AS measurement_32,
        
            CAST(NULLIF(TRIM(`33`), ':') AS FLOAT64) AS measurement_33,
        
            CAST(NULLIF(TRIM(`34`), ':') AS FLOAT64) AS measurement_34,
        
            CAST(NULLIF(TRIM(`35`), ':') AS FLOAT64) AS measurement_35,
        
            CAST(NULLIF(TRIM(`36`), ':') AS FLOAT64) AS measurement_36,
        
            CAST(NULLIF(TRIM(`37`), ':') AS FLOAT64) AS measurement_37,
        
            CAST(NULLIF(TRIM(`38`), ':') AS FLOAT64) AS measurement_38,
        
            CAST(NULLIF(TRIM(`39`), ':') AS FLOAT64) AS measurement_39,
        
            CAST(NULLIF(TRIM(`40`), ':') AS FLOAT64) AS measurement_40,
        
            CAST(NULLIF(TRIM(`41`), ':') AS FLOAT64) AS measurement_41,
        
            CAST(NULLIF(TRIM(`42`), ':') AS FLOAT64) AS measurement_42,
        
            CAST(NULLIF(TRIM(`43`), ':') AS FLOAT64) AS measurement_43,
        
            CAST(NULLIF(TRIM(`44`), ':') AS FLOAT64) AS measurement_44,
        
            CAST(NULLIF(TRIM(`45`), ':') AS FLOAT64) AS measurement_45,
        
            CAST(NULLIF(TRIM(`46`), ':') AS FLOAT64) AS measurement_46,
        
            CAST(NULLIF(TRIM(`47`), ':') AS FLOAT64) AS measurement_47,
        
            CAST(NULLIF(TRIM(`48`), ':') AS FLOAT64) AS measurement_48,
        
            CAST(NULLIF(TRIM(`49`), ':') AS FLOAT64) AS measurement_49,
        
            CAST(NULLIF(TRIM(`50`), ':') AS FLOAT64) AS measurement_50,
        
            CAST(NULLIF(TRIM(`51`), ':') AS FLOAT64) AS measurement_51,
        
            CAST(NULLIF(TRIM(`52`), ':') AS FLOAT64) AS measurement_52,
        
            CAST(NULLIF(TRIM(`53`), ':') AS FLOAT64) AS measurement_53,
        
            CAST(NULLIF(TRIM(`54`), ':') AS FLOAT64) AS measurement_54,
        
            CAST(NULLIF(TRIM(`55`), ':') AS FLOAT64) AS measurement_55,
        
            CAST(NULLIF(TRIM(`56`), ':') AS FLOAT64) AS measurement_56,
        
            CAST(NULLIF(TRIM(`57`), ':') AS FLOAT64) AS measurement_57,
        
            CAST(NULLIF(TRIM(`58`), ':') AS FLOAT64) AS measurement_58,
        
            CAST(NULLIF(TRIM(`59`), ':') AS FLOAT64) AS measurement_59,
        
            CAST(NULLIF(TRIM(`60`), ':') AS FLOAT64) AS measurement_60,
        
            CAST(NULLIF(TRIM(`61`), ':') AS FLOAT64) AS measurement_61,
        
            CAST(NULLIF(TRIM(`62`), ':') AS FLOAT64) AS measurement_62,
        
            CAST(NULLIF(TRIM(`63`), ':') AS FLOAT64) AS measurement_63,
        
            CAST(NULLIF(TRIM(`64`), ':') AS FLOAT64) AS measurement_64,
        
            CAST(NULLIF(TRIM(`65`), ':') AS FLOAT64) AS measurement_65,
        
            CAST(NULLIF(TRIM(`66`), ':') AS FLOAT64) AS measurement_66,
        
            CAST(NULLIF(TRIM(`67`), ':') AS FLOAT64) AS measurement_67,
        
            CAST(NULLIF(TRIM(`68`), ':') AS FLOAT64) AS measurement_68,
        
            CAST(NULLIF(TRIM(`69`), ':') AS FLOAT64) AS measurement_69,
        
            CAST(NULLIF(TRIM(`70`), ':') AS FLOAT64) AS measurement_70,
        
            CAST(NULLIF(TRIM(`71`), ':') AS FLOAT64) AS measurement_71,
        
            CAST(NULLIF(TRIM(`72`), ':') AS FLOAT64) AS measurement_72,
        
            CAST(NULLIF(TRIM(`73`), ':') AS FLOAT64) AS measurement_73,
        
            CAST(NULLIF(TRIM(`74`), ':') AS FLOAT64) AS measurement_74,
        
            CAST(NULLIF(TRIM(`75`), ':') AS FLOAT64) AS measurement_75,
        
            CAST(NULLIF(TRIM(`76`), ':') AS FLOAT64) AS measurement_76,
        
            CAST(NULLIF(TRIM(`77`), ':') AS FLOAT64) AS measurement_77,
        
            CAST(NULLIF(TRIM(`78`), ':') AS FLOAT64) AS measurement_78,
        
            CAST(NULLIF(TRIM(`79`), ':') AS FLOAT64) AS measurement_79,
        
            CAST(NULLIF(TRIM(`80`), ':') AS FLOAT64) AS measurement_80,
        
            CAST(NULLIF(TRIM(`81`), ':') AS FLOAT64) AS measurement_81,
        
            CAST(NULLIF(TRIM(`82`), ':') AS FLOAT64) AS measurement_82,
        
            CAST(NULLIF(TRIM(`83`), ':') AS FLOAT64) AS measurement_83,
        
            CAST(NULLIF(TRIM(`84`), ':') AS FLOAT64) AS measurement_84,
        
            CAST(NULLIF(TRIM(`85`), ':') AS FLOAT64) AS measurement_85,
        
        CURRENT_TIMESTAMP() AS load_timestamp
    FROM source
),

metadata_extracted AS (
    SELECT
        -- Extract metadata components
        SPLIT(metadata, ',')[OFFSET(0)] AS frequency,
        SPLIT(metadata, ',')[OFFSET(1)] AS airpol,
        SPLIT(metadata, ',')[OFFSET(2)] AS unit,
        SPLIT(metadata, ',')[OFFSET(3)] AS geo_code,
        -- Include all measurement columns
        
            measurement_1,
        
            measurement_2,
        
            measurement_3,
        
            measurement_4,
        
            measurement_5,
        
            measurement_6,
        
            measurement_7,
        
            measurement_8,
        
            measurement_9,
        
            measurement_10,
        
            measurement_11,
        
            measurement_12,
        
            measurement_13,
        
            measurement_14,
        
            measurement_15,
        
            measurement_16,
        
            measurement_17,
        
            measurement_18,
        
            measurement_19,
        
            measurement_20,
        
            measurement_21,
        
            measurement_22,
        
            measurement_23,
        
            measurement_24,
        
            measurement_25,
        
            measurement_26,
        
            measurement_27,
        
            measurement_28,
        
            measurement_29,
        
            measurement_30,
        
            measurement_31,
        
            measurement_32,
        
            measurement_33,
        
            measurement_34,
        
            measurement_35,
        
            measurement_36,
        
            measurement_37,
        
            measurement_38,
        
            measurement_39,
        
            measurement_40,
        
            measurement_41,
        
            measurement_42,
        
            measurement_43,
        
            measurement_44,
        
            measurement_45,
        
            measurement_46,
        
            measurement_47,
        
            measurement_48,
        
            measurement_49,
        
            measurement_50,
        
            measurement_51,
        
            measurement_52,
        
            measurement_53,
        
            measurement_54,
        
            measurement_55,
        
            measurement_56,
        
            measurement_57,
        
            measurement_58,
        
            measurement_59,
        
            measurement_60,
        
            measurement_61,
        
            measurement_62,
        
            measurement_63,
        
            measurement_64,
        
            measurement_65,
        
            measurement_66,
        
            measurement_67,
        
            measurement_68,
        
            measurement_69,
        
            measurement_70,
        
            measurement_71,
        
            measurement_72,
        
            measurement_73,
        
            measurement_74,
        
            measurement_75,
        
            measurement_76,
        
            measurement_77,
        
            measurement_78,
        
            measurement_79,
        
            measurement_80,
        
            measurement_81,
        
            measurement_82,
        
            measurement_83,
        
            measurement_84,
        
            measurement_85,
        
        load_timestamp
    FROM parsed
)

SELECT 
    -- Generate a unique ID
    ROW_NUMBER() OVER() AS id,
    frequency,
    airpol,
    unit,
    geo_code,
    load_timestamp
FROM metadata_extracted;


[0m12:38:35.130107 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m12:38:35.516473 [debug] [Thread-1 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=data-talk-clubs&j=bq:EU:b54881f9-0332-4db6-81e2-d793156aceca&page=queryresults
[0m12:38:35.517021 [error] [Thread-1 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=data-talk-clubs&j=bq:EU:b54881f9-0332-4db6-81e2-d793156aceca&page=queryresults
[0m12:38:35.525361 [debug] [Thread-1 (]: Database Error in model stg_emissions_data (models/staging/stg_emissions_data.sql)
  Not found: Table data-talk-clubs:eu_emissions_project.nitrogen_dioxide_data was not found in location EU
  compiled code at target/run/eu_emissions_project/models/staging/stg_emissions_data.sql
[0m12:38:35.526852 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7647346b-828c-47b4-beb4-7303221e9e4b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1169fbc90>]}
[0m12:38:35.527424 [error] [Thread-1 (]: 1 of 4 ERROR creating sql view model eu_emissions_project_staging.stg_emissions_data  [[31mERROR[0m in 0.42s]
[0m12:38:35.527791 [debug] [Thread-1 (]: Finished running node model.eu_emissions_project.stg_emissions_data
[0m12:38:35.528144 [debug] [Thread-11 ]: Marking all children of 'model.eu_emissions_project.stg_emissions_data' to be skipped because of status 'error'.  Reason: Database Error in model stg_emissions_data (models/staging/stg_emissions_data.sql)
  Not found: Table data-talk-clubs:eu_emissions_project.nitrogen_dioxide_data was not found in location EU
  compiled code at target/run/eu_emissions_project/models/staging/stg_emissions_data.sql.
[0m12:38:35.529080 [debug] [Thread-3 (]: Began running node model.eu_emissions_project.int_emissions_cleaned
[0m12:38:35.529370 [debug] [Thread-4 (]: Began running node model.eu_emissions_project.int_emissions_unpivoted
[0m12:38:35.529717 [info ] [Thread-3 (]: 2 of 4 SKIP relation eu_emissions_project_intermediate.int_emissions_cleaned ... [[33mSKIP[0m]
[0m12:38:35.530040 [info ] [Thread-4 (]: 3 of 4 SKIP relation eu_emissions_project_intermediate.int_emissions_unpivoted . [[33mSKIP[0m]
[0m12:38:35.530357 [debug] [Thread-3 (]: Finished running node model.eu_emissions_project.int_emissions_cleaned
[0m12:38:35.530659 [debug] [Thread-4 (]: Finished running node model.eu_emissions_project.int_emissions_unpivoted
[0m12:38:35.531193 [debug] [Thread-6 (]: Began running node model.eu_emissions_project.emissions_analysis
[0m12:38:35.531524 [info ] [Thread-6 (]: 4 of 4 SKIP relation eu_emissions_project_marts.emissions_analysis ............. [[33mSKIP[0m]
[0m12:38:35.531770 [debug] [Thread-6 (]: Finished running node model.eu_emissions_project.emissions_analysis
[0m12:38:35.532632 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m12:38:35.533690 [debug] [MainThread]: Connection 'master' was properly closed.
[0m12:38:35.533911 [debug] [MainThread]: Connection 'model.eu_emissions_project.stg_emissions_data' was properly closed.
[0m12:38:35.534084 [debug] [MainThread]: Connection 'list_data-talk-clubs_eu_emissions_project_intermediate' was properly closed.
[0m12:38:35.534246 [debug] [MainThread]: Connection 'list_data-talk-clubs_eu_emissions_project_marts' was properly closed.
[0m12:38:35.534466 [info ] [MainThread]: 
[0m12:38:35.534658 [info ] [MainThread]: Finished running 2 table models, 2 view models in 0 hours 0 minutes and 1.56 seconds (1.56s).
[0m12:38:35.535027 [debug] [MainThread]: Command end result
[0m12:38:35.548893 [debug] [MainThread]: Wrote artifact WritableManifest to /Users/timbo/Documents/DataTalks/project/src/target/manifest.json
[0m12:38:35.550156 [debug] [MainThread]: Wrote artifact SemanticManifest to /Users/timbo/Documents/DataTalks/project/src/target/semantic_manifest.json
[0m12:38:35.553032 [debug] [MainThread]: Wrote artifact RunExecutionResult to /Users/timbo/Documents/DataTalks/project/src/target/run_results.json
[0m12:38:35.553241 [info ] [MainThread]: 
[0m12:38:35.553461 [info ] [MainThread]: [31mCompleted with 1 error, 0 partial successes, and 0 warnings:[0m
[0m12:38:35.553648 [info ] [MainThread]: 
[0m12:38:35.553869 [error] [MainThread]:   Database Error in model stg_emissions_data (models/staging/stg_emissions_data.sql)
  Not found: Table data-talk-clubs:eu_emissions_project.nitrogen_dioxide_data was not found in location EU
  compiled code at target/run/eu_emissions_project/models/staging/stg_emissions_data.sql
[0m12:38:35.554048 [info ] [MainThread]: 
[0m12:38:35.554230 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=3 TOTAL=4
[0m12:38:35.556166 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": false, "command_wall_clock_time": 2.8968759, "process_in_blocks": "0", "process_kernel_time": 0.350475, "process_mem_max_rss": "212434944", "process_out_blocks": "0", "process_user_time": 1.906951}
[0m12:38:35.556469 [debug] [MainThread]: Command `dbt run` failed at 12:38:35.556426 after 2.90 seconds
[0m12:38:35.556854 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x100e86010>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x106ac2ad0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x106ac3210>]}
[0m12:38:35.557111 [debug] [MainThread]: Flushing usage events
[0m12:38:36.036269 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m12:41:42.255243 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x113f6f850>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x113fc3210>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x113fcbf90>]}


============================== 12:41:42.258306 | 1e21a226-a768-4f8c-81ab-c6085e2672eb ==============================
[0m12:41:42.258306 [info ] [MainThread]: Running with dbt=1.9.3
[0m12:41:42.258750 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'fail_fast': 'False', 'profiles_dir': '/Users/timbo/.dbt', 'log_path': '/Users/timbo/Documents/DataTalks/project/src/logs', 'debug': 'False', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'empty': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt run', 'log_format': 'default', 'introspect': 'True', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m12:41:42.948101 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '1e21a226-a768-4f8c-81ab-c6085e2672eb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x12c356a10>]}
[0m12:41:42.974698 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '1e21a226-a768-4f8c-81ab-c6085e2672eb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1072a78d0>]}
[0m12:41:42.975191 [info ] [MainThread]: Registered adapter: bigquery=1.9.1
[0m12:41:43.068798 [debug] [MainThread]: checksum: 5671c00892cdbcef29c3b00cc5ba7510c3d18a35c883caeb9ab9ee266dc29c8f, vars: {}, profile: , target: , version: 1.9.3
[0m12:41:43.182341 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 2 files changed.
[0m12:41:43.182936 [debug] [MainThread]: Partial parsing: updated file: eu_emissions_project://models/staging/sources.yml
[0m12:41:43.183155 [debug] [MainThread]: Partial parsing: updated file: eu_emissions_project://models/staging/stg_emissions_data.sql
[0m12:41:43.387293 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '1e21a226-a768-4f8c-81ab-c6085e2672eb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x12d3b8dd0>]}
[0m12:41:43.420922 [debug] [MainThread]: Wrote artifact WritableManifest to /Users/timbo/Documents/DataTalks/project/src/target/manifest.json
[0m12:41:43.422947 [debug] [MainThread]: Wrote artifact SemanticManifest to /Users/timbo/Documents/DataTalks/project/src/target/semantic_manifest.json
[0m12:41:43.433980 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '1e21a226-a768-4f8c-81ab-c6085e2672eb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x12da66c10>]}
[0m12:41:43.434326 [info ] [MainThread]: Found 4 models, 1 source, 491 macros
[0m12:41:43.434547 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '1e21a226-a768-4f8c-81ab-c6085e2672eb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x12d978490>]}
[0m12:41:43.435651 [info ] [MainThread]: 
[0m12:41:43.435921 [info ] [MainThread]: Concurrency: 8 threads (target='dev')
[0m12:41:43.436108 [info ] [MainThread]: 
[0m12:41:43.436374 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m12:41:43.438461 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_data-talk-clubs'
[0m12:41:43.438849 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_data-talk-clubs'
[0m12:41:43.439091 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m12:41:43.439379 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_data-talk-clubs'
[0m12:41:43.439613 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m12:41:43.439879 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m12:41:43.965533 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_data-talk-clubs, now list_data-talk-clubs_eu_emissions_project_intermediate)
[0m12:41:43.965915 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_data-talk-clubs, now list_data-talk-clubs_eu_emissions_project_staging)
[0m12:41:43.966243 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_data-talk-clubs, now list_data-talk-clubs_eu_emissions_project_marts)
[0m12:41:43.966443 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m12:41:43.966656 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m12:41:43.966834 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m12:41:44.287464 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '1e21a226-a768-4f8c-81ab-c6085e2672eb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x12d984910>]}
[0m12:41:44.288027 [debug] [MainThread]: Opening a new connection, currently in state init
[0m12:41:44.290502 [debug] [Thread-1 (]: Began running node model.eu_emissions_project.stg_emissions_data
[0m12:41:44.290830 [info ] [Thread-1 (]: 1 of 4 START sql view model eu_emissions_project_staging.stg_emissions_data .... [RUN]
[0m12:41:44.291132 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_data-talk-clubs_eu_emissions_project_intermediate, now model.eu_emissions_project.stg_emissions_data)
[0m12:41:44.291372 [debug] [Thread-1 (]: Began compiling node model.eu_emissions_project.stg_emissions_data
[0m12:41:44.296640 [debug] [Thread-1 (]: Writing injected SQL for node "model.eu_emissions_project.stg_emissions_data"
[0m12:41:44.297205 [debug] [Thread-1 (]: Began executing node model.eu_emissions_project.stg_emissions_data
[0m12:41:44.311874 [debug] [Thread-1 (]: Writing runtime sql for node "model.eu_emissions_project.stg_emissions_data"
[0m12:41:44.312918 [debug] [Thread-1 (]: On model.eu_emissions_project.stg_emissions_data: /* {"app": "dbt", "dbt_version": "1.9.3", "profile_name": "big-query", "target_name": "dev", "node_id": "model.eu_emissions_project.stg_emissions_data"} */


  create or replace view `data-talk-clubs`.`eu_emissions_project_staging`.`stg_emissions_data`
  OPTIONS()
  as 

WITH source AS (
    SELECT 
        *
    FROM `data-talk-clubs`.`eu_emissions_project`.`nitrogen_dioxide_data`
),

parsed AS (
    SELECT 
        -- Split the first column which contains metadata
        REGEXP_EXTRACT(geo_time_period, r'^([^\t]+)') AS metadata,
        -- Extract all the measurement columns (monthly data from 2018-01 to 2025-02)
        
            CAST(NULLIF(TRIM(COALESCE(`1`, '')), ':') AS FLOAT64) AS measurement_1,
        
            CAST(NULLIF(TRIM(COALESCE(`2`, '')), ':') AS FLOAT64) AS measurement_2,
        
            CAST(NULLIF(TRIM(COALESCE(`3`, '')), ':') AS FLOAT64) AS measurement_3,
        
            CAST(NULLIF(TRIM(COALESCE(`4`, '')), ':') AS FLOAT64) AS measurement_4,
        
            CAST(NULLIF(TRIM(COALESCE(`5`, '')), ':') AS FLOAT64) AS measurement_5,
        
            CAST(NULLIF(TRIM(COALESCE(`6`, '')), ':') AS FLOAT64) AS measurement_6,
        
            CAST(NULLIF(TRIM(COALESCE(`7`, '')), ':') AS FLOAT64) AS measurement_7,
        
            CAST(NULLIF(TRIM(COALESCE(`8`, '')), ':') AS FLOAT64) AS measurement_8,
        
            CAST(NULLIF(TRIM(COALESCE(`9`, '')), ':') AS FLOAT64) AS measurement_9,
        
            CAST(NULLIF(TRIM(COALESCE(`10`, '')), ':') AS FLOAT64) AS measurement_10,
        
            CAST(NULLIF(TRIM(COALESCE(`11`, '')), ':') AS FLOAT64) AS measurement_11,
        
            CAST(NULLIF(TRIM(COALESCE(`12`, '')), ':') AS FLOAT64) AS measurement_12,
        
            CAST(NULLIF(TRIM(COALESCE(`13`, '')), ':') AS FLOAT64) AS measurement_13,
        
            CAST(NULLIF(TRIM(COALESCE(`14`, '')), ':') AS FLOAT64) AS measurement_14,
        
            CAST(NULLIF(TRIM(COALESCE(`15`, '')), ':') AS FLOAT64) AS measurement_15,
        
            CAST(NULLIF(TRIM(COALESCE(`16`, '')), ':') AS FLOAT64) AS measurement_16,
        
            CAST(NULLIF(TRIM(COALESCE(`17`, '')), ':') AS FLOAT64) AS measurement_17,
        
            CAST(NULLIF(TRIM(COALESCE(`18`, '')), ':') AS FLOAT64) AS measurement_18,
        
            CAST(NULLIF(TRIM(COALESCE(`19`, '')), ':') AS FLOAT64) AS measurement_19,
        
            CAST(NULLIF(TRIM(COALESCE(`20`, '')), ':') AS FLOAT64) AS measurement_20,
        
            CAST(NULLIF(TRIM(COALESCE(`21`, '')), ':') AS FLOAT64) AS measurement_21,
        
            CAST(NULLIF(TRIM(COALESCE(`22`, '')), ':') AS FLOAT64) AS measurement_22,
        
            CAST(NULLIF(TRIM(COALESCE(`23`, '')), ':') AS FLOAT64) AS measurement_23,
        
            CAST(NULLIF(TRIM(COALESCE(`24`, '')), ':') AS FLOAT64) AS measurement_24,
        
            CAST(NULLIF(TRIM(COALESCE(`25`, '')), ':') AS FLOAT64) AS measurement_25,
        
            CAST(NULLIF(TRIM(COALESCE(`26`, '')), ':') AS FLOAT64) AS measurement_26,
        
            CAST(NULLIF(TRIM(COALESCE(`27`, '')), ':') AS FLOAT64) AS measurement_27,
        
            CAST(NULLIF(TRIM(COALESCE(`28`, '')), ':') AS FLOAT64) AS measurement_28,
        
            CAST(NULLIF(TRIM(COALESCE(`29`, '')), ':') AS FLOAT64) AS measurement_29,
        
            CAST(NULLIF(TRIM(COALESCE(`30`, '')), ':') AS FLOAT64) AS measurement_30,
        
            CAST(NULLIF(TRIM(COALESCE(`31`, '')), ':') AS FLOAT64) AS measurement_31,
        
            CAST(NULLIF(TRIM(COALESCE(`32`, '')), ':') AS FLOAT64) AS measurement_32,
        
            CAST(NULLIF(TRIM(COALESCE(`33`, '')), ':') AS FLOAT64) AS measurement_33,
        
            CAST(NULLIF(TRIM(COALESCE(`34`, '')), ':') AS FLOAT64) AS measurement_34,
        
            CAST(NULLIF(TRIM(COALESCE(`35`, '')), ':') AS FLOAT64) AS measurement_35,
        
            CAST(NULLIF(TRIM(COALESCE(`36`, '')), ':') AS FLOAT64) AS measurement_36,
        
            CAST(NULLIF(TRIM(COALESCE(`37`, '')), ':') AS FLOAT64) AS measurement_37,
        
            CAST(NULLIF(TRIM(COALESCE(`38`, '')), ':') AS FLOAT64) AS measurement_38,
        
            CAST(NULLIF(TRIM(COALESCE(`39`, '')), ':') AS FLOAT64) AS measurement_39,
        
            CAST(NULLIF(TRIM(COALESCE(`40`, '')), ':') AS FLOAT64) AS measurement_40,
        
            CAST(NULLIF(TRIM(COALESCE(`41`, '')), ':') AS FLOAT64) AS measurement_41,
        
            CAST(NULLIF(TRIM(COALESCE(`42`, '')), ':') AS FLOAT64) AS measurement_42,
        
            CAST(NULLIF(TRIM(COALESCE(`43`, '')), ':') AS FLOAT64) AS measurement_43,
        
            CAST(NULLIF(TRIM(COALESCE(`44`, '')), ':') AS FLOAT64) AS measurement_44,
        
            CAST(NULLIF(TRIM(COALESCE(`45`, '')), ':') AS FLOAT64) AS measurement_45,
        
            CAST(NULLIF(TRIM(COALESCE(`46`, '')), ':') AS FLOAT64) AS measurement_46,
        
            CAST(NULLIF(TRIM(COALESCE(`47`, '')), ':') AS FLOAT64) AS measurement_47,
        
            CAST(NULLIF(TRIM(COALESCE(`48`, '')), ':') AS FLOAT64) AS measurement_48,
        
            CAST(NULLIF(TRIM(COALESCE(`49`, '')), ':') AS FLOAT64) AS measurement_49,
        
            CAST(NULLIF(TRIM(COALESCE(`50`, '')), ':') AS FLOAT64) AS measurement_50,
        
            CAST(NULLIF(TRIM(COALESCE(`51`, '')), ':') AS FLOAT64) AS measurement_51,
        
            CAST(NULLIF(TRIM(COALESCE(`52`, '')), ':') AS FLOAT64) AS measurement_52,
        
            CAST(NULLIF(TRIM(COALESCE(`53`, '')), ':') AS FLOAT64) AS measurement_53,
        
            CAST(NULLIF(TRIM(COALESCE(`54`, '')), ':') AS FLOAT64) AS measurement_54,
        
            CAST(NULLIF(TRIM(COALESCE(`55`, '')), ':') AS FLOAT64) AS measurement_55,
        
            CAST(NULLIF(TRIM(COALESCE(`56`, '')), ':') AS FLOAT64) AS measurement_56,
        
            CAST(NULLIF(TRIM(COALESCE(`57`, '')), ':') AS FLOAT64) AS measurement_57,
        
            CAST(NULLIF(TRIM(COALESCE(`58`, '')), ':') AS FLOAT64) AS measurement_58,
        
            CAST(NULLIF(TRIM(COALESCE(`59`, '')), ':') AS FLOAT64) AS measurement_59,
        
            CAST(NULLIF(TRIM(COALESCE(`60`, '')), ':') AS FLOAT64) AS measurement_60,
        
            CAST(NULLIF(TRIM(COALESCE(`61`, '')), ':') AS FLOAT64) AS measurement_61,
        
            CAST(NULLIF(TRIM(COALESCE(`62`, '')), ':') AS FLOAT64) AS measurement_62,
        
            CAST(NULLIF(TRIM(COALESCE(`63`, '')), ':') AS FLOAT64) AS measurement_63,
        
            CAST(NULLIF(TRIM(COALESCE(`64`, '')), ':') AS FLOAT64) AS measurement_64,
        
            CAST(NULLIF(TRIM(COALESCE(`65`, '')), ':') AS FLOAT64) AS measurement_65,
        
            CAST(NULLIF(TRIM(COALESCE(`66`, '')), ':') AS FLOAT64) AS measurement_66,
        
            CAST(NULLIF(TRIM(COALESCE(`67`, '')), ':') AS FLOAT64) AS measurement_67,
        
            CAST(NULLIF(TRIM(COALESCE(`68`, '')), ':') AS FLOAT64) AS measurement_68,
        
            CAST(NULLIF(TRIM(COALESCE(`69`, '')), ':') AS FLOAT64) AS measurement_69,
        
            CAST(NULLIF(TRIM(COALESCE(`70`, '')), ':') AS FLOAT64) AS measurement_70,
        
            CAST(NULLIF(TRIM(COALESCE(`71`, '')), ':') AS FLOAT64) AS measurement_71,
        
            CAST(NULLIF(TRIM(COALESCE(`72`, '')), ':') AS FLOAT64) AS measurement_72,
        
            CAST(NULLIF(TRIM(COALESCE(`73`, '')), ':') AS FLOAT64) AS measurement_73,
        
            CAST(NULLIF(TRIM(COALESCE(`74`, '')), ':') AS FLOAT64) AS measurement_74,
        
            CAST(NULLIF(TRIM(COALESCE(`75`, '')), ':') AS FLOAT64) AS measurement_75,
        
            CAST(NULLIF(TRIM(COALESCE(`76`, '')), ':') AS FLOAT64) AS measurement_76,
        
            CAST(NULLIF(TRIM(COALESCE(`77`, '')), ':') AS FLOAT64) AS measurement_77,
        
            CAST(NULLIF(TRIM(COALESCE(`78`, '')), ':') AS FLOAT64) AS measurement_78,
        
            CAST(NULLIF(TRIM(COALESCE(`79`, '')), ':') AS FLOAT64) AS measurement_79,
        
            CAST(NULLIF(TRIM(COALESCE(`80`, '')), ':') AS FLOAT64) AS measurement_80,
        
            CAST(NULLIF(TRIM(COALESCE(`81`, '')), ':') AS FLOAT64) AS measurement_81,
        
            CAST(NULLIF(TRIM(COALESCE(`82`, '')), ':') AS FLOAT64) AS measurement_82,
        
            CAST(NULLIF(TRIM(COALESCE(`83`, '')), ':') AS FLOAT64) AS measurement_83,
        
            CAST(NULLIF(TRIM(COALESCE(`84`, '')), ':') AS FLOAT64) AS measurement_84,
        
            CAST(NULLIF(TRIM(COALESCE(`85`, '')), ':') AS FLOAT64) AS measurement_85,
        
        CURRENT_TIMESTAMP() AS load_timestamp
    FROM source
),

metadata_extracted AS (
    SELECT
        -- Extract metadata components
        SPLIT(metadata, ',')[SAFE_OFFSET(0)] AS frequency,
        SPLIT(metadata, ',')[SAFE_OFFSET(1)] AS airpol,
        SPLIT(metadata, ',')[SAFE_OFFSET(2)] AS unit,
        SPLIT(metadata, ',')[SAFE_OFFSET(3)] AS geo_code,
        -- Include all measurement columns
        
            measurement_1,
        
            measurement_2,
        
            measurement_3,
        
            measurement_4,
        
            measurement_5,
        
            measurement_6,
        
            measurement_7,
        
            measurement_8,
        
            measurement_9,
        
            measurement_10,
        
            measurement_11,
        
            measurement_12,
        
            measurement_13,
        
            measurement_14,
        
            measurement_15,
        
            measurement_16,
        
            measurement_17,
        
            measurement_18,
        
            measurement_19,
        
            measurement_20,
        
            measurement_21,
        
            measurement_22,
        
            measurement_23,
        
            measurement_24,
        
            measurement_25,
        
            measurement_26,
        
            measurement_27,
        
            measurement_28,
        
            measurement_29,
        
            measurement_30,
        
            measurement_31,
        
            measurement_32,
        
            measurement_33,
        
            measurement_34,
        
            measurement_35,
        
            measurement_36,
        
            measurement_37,
        
            measurement_38,
        
            measurement_39,
        
            measurement_40,
        
            measurement_41,
        
            measurement_42,
        
            measurement_43,
        
            measurement_44,
        
            measurement_45,
        
            measurement_46,
        
            measurement_47,
        
            measurement_48,
        
            measurement_49,
        
            measurement_50,
        
            measurement_51,
        
            measurement_52,
        
            measurement_53,
        
            measurement_54,
        
            measurement_55,
        
            measurement_56,
        
            measurement_57,
        
            measurement_58,
        
            measurement_59,
        
            measurement_60,
        
            measurement_61,
        
            measurement_62,
        
            measurement_63,
        
            measurement_64,
        
            measurement_65,
        
            measurement_66,
        
            measurement_67,
        
            measurement_68,
        
            measurement_69,
        
            measurement_70,
        
            measurement_71,
        
            measurement_72,
        
            measurement_73,
        
            measurement_74,
        
            measurement_75,
        
            measurement_76,
        
            measurement_77,
        
            measurement_78,
        
            measurement_79,
        
            measurement_80,
        
            measurement_81,
        
            measurement_82,
        
            measurement_83,
        
            measurement_84,
        
            measurement_85,
        
        load_timestamp
    FROM parsed
)

SELECT 
    -- Generate a unique ID
    ROW_NUMBER() OVER() AS id,
    frequency,
    airpol,
    unit,
    geo_code,
    load_timestamp,
    
        measurement_1,
    
        measurement_2,
    
        measurement_3,
    
        measurement_4,
    
        measurement_5,
    
        measurement_6,
    
        measurement_7,
    
        measurement_8,
    
        measurement_9,
    
        measurement_10,
    
        measurement_11,
    
        measurement_12,
    
        measurement_13,
    
        measurement_14,
    
        measurement_15,
    
        measurement_16,
    
        measurement_17,
    
        measurement_18,
    
        measurement_19,
    
        measurement_20,
    
        measurement_21,
    
        measurement_22,
    
        measurement_23,
    
        measurement_24,
    
        measurement_25,
    
        measurement_26,
    
        measurement_27,
    
        measurement_28,
    
        measurement_29,
    
        measurement_30,
    
        measurement_31,
    
        measurement_32,
    
        measurement_33,
    
        measurement_34,
    
        measurement_35,
    
        measurement_36,
    
        measurement_37,
    
        measurement_38,
    
        measurement_39,
    
        measurement_40,
    
        measurement_41,
    
        measurement_42,
    
        measurement_43,
    
        measurement_44,
    
        measurement_45,
    
        measurement_46,
    
        measurement_47,
    
        measurement_48,
    
        measurement_49,
    
        measurement_50,
    
        measurement_51,
    
        measurement_52,
    
        measurement_53,
    
        measurement_54,
    
        measurement_55,
    
        measurement_56,
    
        measurement_57,
    
        measurement_58,
    
        measurement_59,
    
        measurement_60,
    
        measurement_61,
    
        measurement_62,
    
        measurement_63,
    
        measurement_64,
    
        measurement_65,
    
        measurement_66,
    
        measurement_67,
    
        measurement_68,
    
        measurement_69,
    
        measurement_70,
    
        measurement_71,
    
        measurement_72,
    
        measurement_73,
    
        measurement_74,
    
        measurement_75,
    
        measurement_76,
    
        measurement_77,
    
        measurement_78,
    
        measurement_79,
    
        measurement_80,
    
        measurement_81,
    
        measurement_82,
    
        measurement_83,
    
        measurement_84,
    
        measurement_85
    
FROM metadata_extracted;


[0m12:41:44.313630 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m12:41:45.025624 [debug] [Thread-1 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=data-talk-clubs&j=bq:EU:e1b80c1c-81d3-4a2e-99d9-cd7e3a7ddae2&page=queryresults
[0m12:41:45.186126 [error] [Thread-1 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=data-talk-clubs&j=bq:EU:e1b80c1c-81d3-4a2e-99d9-cd7e3a7ddae2&page=queryresults
[0m12:41:45.193619 [debug] [Thread-1 (]: Database Error in model stg_emissions_data (models/staging/stg_emissions_data.sql)
  Unrecognized name: geo_time_period at [17:24]
  compiled code at target/run/eu_emissions_project/models/staging/stg_emissions_data.sql
[0m12:41:45.194894 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '1e21a226-a768-4f8c-81ab-c6085e2672eb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x12d369890>]}
[0m12:41:45.195495 [error] [Thread-1 (]: 1 of 4 ERROR creating sql view model eu_emissions_project_staging.stg_emissions_data  [[31mERROR[0m in 0.90s]
[0m12:41:45.195875 [debug] [Thread-1 (]: Finished running node model.eu_emissions_project.stg_emissions_data
[0m12:41:45.196194 [debug] [Thread-11 ]: Marking all children of 'model.eu_emissions_project.stg_emissions_data' to be skipped because of status 'error'.  Reason: Database Error in model stg_emissions_data (models/staging/stg_emissions_data.sql)
  Unrecognized name: geo_time_period at [17:24]
  compiled code at target/run/eu_emissions_project/models/staging/stg_emissions_data.sql.
[0m12:41:45.196994 [debug] [Thread-3 (]: Began running node model.eu_emissions_project.int_emissions_cleaned
[0m12:41:45.197288 [debug] [Thread-4 (]: Began running node model.eu_emissions_project.int_emissions_unpivoted
[0m12:41:45.197594 [info ] [Thread-3 (]: 2 of 4 SKIP relation eu_emissions_project_intermediate.int_emissions_cleaned ... [[33mSKIP[0m]
[0m12:41:45.197879 [info ] [Thread-4 (]: 3 of 4 SKIP relation eu_emissions_project_intermediate.int_emissions_unpivoted . [[33mSKIP[0m]
[0m12:41:45.198188 [debug] [Thread-3 (]: Finished running node model.eu_emissions_project.int_emissions_cleaned
[0m12:41:45.198427 [debug] [Thread-4 (]: Finished running node model.eu_emissions_project.int_emissions_unpivoted
[0m12:41:45.198831 [debug] [Thread-6 (]: Began running node model.eu_emissions_project.emissions_analysis
[0m12:41:45.199112 [info ] [Thread-6 (]: 4 of 4 SKIP relation eu_emissions_project_marts.emissions_analysis ............. [[33mSKIP[0m]
[0m12:41:45.199371 [debug] [Thread-6 (]: Finished running node model.eu_emissions_project.emissions_analysis
[0m12:41:45.200177 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m12:41:45.201133 [debug] [MainThread]: Connection 'master' was properly closed.
[0m12:41:45.201331 [debug] [MainThread]: Connection 'model.eu_emissions_project.stg_emissions_data' was properly closed.
[0m12:41:45.201498 [debug] [MainThread]: Connection 'list_data-talk-clubs_eu_emissions_project_staging' was properly closed.
[0m12:41:45.201662 [debug] [MainThread]: Connection 'list_data-talk-clubs_eu_emissions_project_marts' was properly closed.
[0m12:41:45.201932 [info ] [MainThread]: 
[0m12:41:45.202205 [info ] [MainThread]: Finished running 2 table models, 2 view models in 0 hours 0 minutes and 1.77 seconds (1.77s).
[0m12:41:45.202607 [debug] [MainThread]: Command end result
[0m12:41:45.215818 [debug] [MainThread]: Wrote artifact WritableManifest to /Users/timbo/Documents/DataTalks/project/src/target/manifest.json
[0m12:41:45.216753 [debug] [MainThread]: Wrote artifact SemanticManifest to /Users/timbo/Documents/DataTalks/project/src/target/semantic_manifest.json
[0m12:41:45.219570 [debug] [MainThread]: Wrote artifact RunExecutionResult to /Users/timbo/Documents/DataTalks/project/src/target/run_results.json
[0m12:41:45.219912 [info ] [MainThread]: 
[0m12:41:45.220394 [info ] [MainThread]: [31mCompleted with 1 error, 0 partial successes, and 0 warnings:[0m
[0m12:41:45.220615 [info ] [MainThread]: 
[0m12:41:45.220846 [error] [MainThread]:   Database Error in model stg_emissions_data (models/staging/stg_emissions_data.sql)
  Unrecognized name: geo_time_period at [17:24]
  compiled code at target/run/eu_emissions_project/models/staging/stg_emissions_data.sql
[0m12:41:45.221034 [info ] [MainThread]: 
[0m12:41:45.221221 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=3 TOTAL=4
[0m12:41:45.222965 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": false, "command_wall_clock_time": 3.0032282, "process_in_blocks": "0", "process_kernel_time": 0.323193, "process_mem_max_rss": "212500480", "process_out_blocks": "0", "process_user_time": 1.770776}
[0m12:41:45.223297 [debug] [MainThread]: Command `dbt run` failed at 12:41:45.223253 after 3.00 seconds
[0m12:41:45.223573 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104b4ded0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x113fc3090>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x12d783450>]}
[0m12:41:45.223855 [debug] [MainThread]: Flushing usage events
[0m12:41:46.023098 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m13:07:21.755574 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11256e450>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1125c9d50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1125cbf90>]}


============================== 13:07:21.758930 | 88fa17da-f925-4fdd-89a7-3f0c955eff92 ==============================
[0m13:07:21.758930 [info ] [MainThread]: Running with dbt=1.9.3
[0m13:07:21.759332 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': '/Users/timbo/.dbt', 'fail_fast': 'False', 'version_check': 'True', 'log_path': '/Users/timbo/Documents/DataTalks/project/src/logs', 'warn_error': 'None', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'empty': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'invocation_command': 'dbt run', 'log_format': 'default', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m13:07:22.539902 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '88fa17da-f925-4fdd-89a7-3f0c955eff92', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1225cca10>]}
[0m13:07:22.568052 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '88fa17da-f925-4fdd-89a7-3f0c955eff92', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x106ba01d0>]}
[0m13:07:22.568629 [info ] [MainThread]: Registered adapter: bigquery=1.9.1
[0m13:07:22.666812 [debug] [MainThread]: checksum: 5671c00892cdbcef29c3b00cc5ba7510c3d18a35c883caeb9ab9ee266dc29c8f, vars: {}, profile: , target: , version: 1.9.3
[0m13:07:22.786611 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m13:07:22.787350 [debug] [MainThread]: Partial parsing: updated file: eu_emissions_project://models/staging/sources.yml
[0m13:07:23.014919 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '88fa17da-f925-4fdd-89a7-3f0c955eff92', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x123d581d0>]}
[0m13:07:23.051997 [debug] [MainThread]: Wrote artifact WritableManifest to /Users/timbo/Documents/DataTalks/project/src/target/manifest.json
[0m13:07:23.054369 [debug] [MainThread]: Wrote artifact SemanticManifest to /Users/timbo/Documents/DataTalks/project/src/target/semantic_manifest.json
[0m13:07:23.067970 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '88fa17da-f925-4fdd-89a7-3f0c955eff92', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x123cd3e50>]}
[0m13:07:23.068359 [info ] [MainThread]: Found 4 models, 1 source, 491 macros
[0m13:07:23.068588 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '88fa17da-f925-4fdd-89a7-3f0c955eff92', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x123c4bfd0>]}
[0m13:07:23.069591 [info ] [MainThread]: 
[0m13:07:23.069828 [info ] [MainThread]: Concurrency: 8 threads (target='dev')
[0m13:07:23.070002 [info ] [MainThread]: 
[0m13:07:23.070307 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m13:07:23.073139 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_data-talk-clubs'
[0m13:07:23.073450 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m13:07:23.111638 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_data-talk-clubs'
[0m13:07:23.112694 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_data-talk-clubs'
[0m13:07:23.112984 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m13:07:23.113311 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m13:07:23.601166 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_data-talk-clubs, now list_data-talk-clubs_eu_emissions_project_staging)
[0m13:07:23.601602 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_data-talk-clubs, now list_data-talk-clubs_eu_emissions_project_marts)
[0m13:07:23.601938 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_data-talk-clubs, now list_data-talk-clubs_eu_emissions_project_intermediate)
[0m13:07:23.602129 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m13:07:23.602341 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m13:07:23.602518 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m13:07:23.923380 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '88fa17da-f925-4fdd-89a7-3f0c955eff92', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x123c40350>]}
[0m13:07:23.923781 [debug] [MainThread]: Opening a new connection, currently in state init
[0m13:07:23.928093 [debug] [Thread-1 (]: Began running node model.eu_emissions_project.stg_emissions_data
[0m13:07:23.928482 [info ] [Thread-1 (]: 1 of 4 START sql view model eu_emissions_project_staging.stg_emissions_data .... [RUN]
[0m13:07:23.928783 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_data-talk-clubs_eu_emissions_project_staging, now model.eu_emissions_project.stg_emissions_data)
[0m13:07:23.929028 [debug] [Thread-1 (]: Began compiling node model.eu_emissions_project.stg_emissions_data
[0m13:07:23.934461 [debug] [Thread-1 (]: Writing injected SQL for node "model.eu_emissions_project.stg_emissions_data"
[0m13:07:23.935468 [debug] [Thread-1 (]: Began executing node model.eu_emissions_project.stg_emissions_data
[0m13:07:23.951088 [debug] [Thread-1 (]: Writing runtime sql for node "model.eu_emissions_project.stg_emissions_data"
[0m13:07:23.952189 [debug] [Thread-1 (]: On model.eu_emissions_project.stg_emissions_data: /* {"app": "dbt", "dbt_version": "1.9.3", "profile_name": "big-query", "target_name": "dev", "node_id": "model.eu_emissions_project.stg_emissions_data"} */


  create or replace view `data-talk-clubs`.`eu_emissions_project_staging`.`stg_emissions_data`
  OPTIONS()
  as 

WITH source AS (
    SELECT 
        *
    FROM `data-talk-clubs`.`eu_emissions_project`.`nitrogen_dioxide_data`
),

parsed AS (
    SELECT 
        -- Split the first column which contains metadata
        REGEXP_EXTRACT(geo_time_period, r'^([^\t]+)') AS metadata,
        -- Extract all the measurement columns (monthly data from 2018-01 to 2025-02)
        
            CAST(NULLIF(TRIM(COALESCE(`1`, '')), ':') AS FLOAT64) AS measurement_1,
        
            CAST(NULLIF(TRIM(COALESCE(`2`, '')), ':') AS FLOAT64) AS measurement_2,
        
            CAST(NULLIF(TRIM(COALESCE(`3`, '')), ':') AS FLOAT64) AS measurement_3,
        
            CAST(NULLIF(TRIM(COALESCE(`4`, '')), ':') AS FLOAT64) AS measurement_4,
        
            CAST(NULLIF(TRIM(COALESCE(`5`, '')), ':') AS FLOAT64) AS measurement_5,
        
            CAST(NULLIF(TRIM(COALESCE(`6`, '')), ':') AS FLOAT64) AS measurement_6,
        
            CAST(NULLIF(TRIM(COALESCE(`7`, '')), ':') AS FLOAT64) AS measurement_7,
        
            CAST(NULLIF(TRIM(COALESCE(`8`, '')), ':') AS FLOAT64) AS measurement_8,
        
            CAST(NULLIF(TRIM(COALESCE(`9`, '')), ':') AS FLOAT64) AS measurement_9,
        
            CAST(NULLIF(TRIM(COALESCE(`10`, '')), ':') AS FLOAT64) AS measurement_10,
        
            CAST(NULLIF(TRIM(COALESCE(`11`, '')), ':') AS FLOAT64) AS measurement_11,
        
            CAST(NULLIF(TRIM(COALESCE(`12`, '')), ':') AS FLOAT64) AS measurement_12,
        
            CAST(NULLIF(TRIM(COALESCE(`13`, '')), ':') AS FLOAT64) AS measurement_13,
        
            CAST(NULLIF(TRIM(COALESCE(`14`, '')), ':') AS FLOAT64) AS measurement_14,
        
            CAST(NULLIF(TRIM(COALESCE(`15`, '')), ':') AS FLOAT64) AS measurement_15,
        
            CAST(NULLIF(TRIM(COALESCE(`16`, '')), ':') AS FLOAT64) AS measurement_16,
        
            CAST(NULLIF(TRIM(COALESCE(`17`, '')), ':') AS FLOAT64) AS measurement_17,
        
            CAST(NULLIF(TRIM(COALESCE(`18`, '')), ':') AS FLOAT64) AS measurement_18,
        
            CAST(NULLIF(TRIM(COALESCE(`19`, '')), ':') AS FLOAT64) AS measurement_19,
        
            CAST(NULLIF(TRIM(COALESCE(`20`, '')), ':') AS FLOAT64) AS measurement_20,
        
            CAST(NULLIF(TRIM(COALESCE(`21`, '')), ':') AS FLOAT64) AS measurement_21,
        
            CAST(NULLIF(TRIM(COALESCE(`22`, '')), ':') AS FLOAT64) AS measurement_22,
        
            CAST(NULLIF(TRIM(COALESCE(`23`, '')), ':') AS FLOAT64) AS measurement_23,
        
            CAST(NULLIF(TRIM(COALESCE(`24`, '')), ':') AS FLOAT64) AS measurement_24,
        
            CAST(NULLIF(TRIM(COALESCE(`25`, '')), ':') AS FLOAT64) AS measurement_25,
        
            CAST(NULLIF(TRIM(COALESCE(`26`, '')), ':') AS FLOAT64) AS measurement_26,
        
            CAST(NULLIF(TRIM(COALESCE(`27`, '')), ':') AS FLOAT64) AS measurement_27,
        
            CAST(NULLIF(TRIM(COALESCE(`28`, '')), ':') AS FLOAT64) AS measurement_28,
        
            CAST(NULLIF(TRIM(COALESCE(`29`, '')), ':') AS FLOAT64) AS measurement_29,
        
            CAST(NULLIF(TRIM(COALESCE(`30`, '')), ':') AS FLOAT64) AS measurement_30,
        
            CAST(NULLIF(TRIM(COALESCE(`31`, '')), ':') AS FLOAT64) AS measurement_31,
        
            CAST(NULLIF(TRIM(COALESCE(`32`, '')), ':') AS FLOAT64) AS measurement_32,
        
            CAST(NULLIF(TRIM(COALESCE(`33`, '')), ':') AS FLOAT64) AS measurement_33,
        
            CAST(NULLIF(TRIM(COALESCE(`34`, '')), ':') AS FLOAT64) AS measurement_34,
        
            CAST(NULLIF(TRIM(COALESCE(`35`, '')), ':') AS FLOAT64) AS measurement_35,
        
            CAST(NULLIF(TRIM(COALESCE(`36`, '')), ':') AS FLOAT64) AS measurement_36,
        
            CAST(NULLIF(TRIM(COALESCE(`37`, '')), ':') AS FLOAT64) AS measurement_37,
        
            CAST(NULLIF(TRIM(COALESCE(`38`, '')), ':') AS FLOAT64) AS measurement_38,
        
            CAST(NULLIF(TRIM(COALESCE(`39`, '')), ':') AS FLOAT64) AS measurement_39,
        
            CAST(NULLIF(TRIM(COALESCE(`40`, '')), ':') AS FLOAT64) AS measurement_40,
        
            CAST(NULLIF(TRIM(COALESCE(`41`, '')), ':') AS FLOAT64) AS measurement_41,
        
            CAST(NULLIF(TRIM(COALESCE(`42`, '')), ':') AS FLOAT64) AS measurement_42,
        
            CAST(NULLIF(TRIM(COALESCE(`43`, '')), ':') AS FLOAT64) AS measurement_43,
        
            CAST(NULLIF(TRIM(COALESCE(`44`, '')), ':') AS FLOAT64) AS measurement_44,
        
            CAST(NULLIF(TRIM(COALESCE(`45`, '')), ':') AS FLOAT64) AS measurement_45,
        
            CAST(NULLIF(TRIM(COALESCE(`46`, '')), ':') AS FLOAT64) AS measurement_46,
        
            CAST(NULLIF(TRIM(COALESCE(`47`, '')), ':') AS FLOAT64) AS measurement_47,
        
            CAST(NULLIF(TRIM(COALESCE(`48`, '')), ':') AS FLOAT64) AS measurement_48,
        
            CAST(NULLIF(TRIM(COALESCE(`49`, '')), ':') AS FLOAT64) AS measurement_49,
        
            CAST(NULLIF(TRIM(COALESCE(`50`, '')), ':') AS FLOAT64) AS measurement_50,
        
            CAST(NULLIF(TRIM(COALESCE(`51`, '')), ':') AS FLOAT64) AS measurement_51,
        
            CAST(NULLIF(TRIM(COALESCE(`52`, '')), ':') AS FLOAT64) AS measurement_52,
        
            CAST(NULLIF(TRIM(COALESCE(`53`, '')), ':') AS FLOAT64) AS measurement_53,
        
            CAST(NULLIF(TRIM(COALESCE(`54`, '')), ':') AS FLOAT64) AS measurement_54,
        
            CAST(NULLIF(TRIM(COALESCE(`55`, '')), ':') AS FLOAT64) AS measurement_55,
        
            CAST(NULLIF(TRIM(COALESCE(`56`, '')), ':') AS FLOAT64) AS measurement_56,
        
            CAST(NULLIF(TRIM(COALESCE(`57`, '')), ':') AS FLOAT64) AS measurement_57,
        
            CAST(NULLIF(TRIM(COALESCE(`58`, '')), ':') AS FLOAT64) AS measurement_58,
        
            CAST(NULLIF(TRIM(COALESCE(`59`, '')), ':') AS FLOAT64) AS measurement_59,
        
            CAST(NULLIF(TRIM(COALESCE(`60`, '')), ':') AS FLOAT64) AS measurement_60,
        
            CAST(NULLIF(TRIM(COALESCE(`61`, '')), ':') AS FLOAT64) AS measurement_61,
        
            CAST(NULLIF(TRIM(COALESCE(`62`, '')), ':') AS FLOAT64) AS measurement_62,
        
            CAST(NULLIF(TRIM(COALESCE(`63`, '')), ':') AS FLOAT64) AS measurement_63,
        
            CAST(NULLIF(TRIM(COALESCE(`64`, '')), ':') AS FLOAT64) AS measurement_64,
        
            CAST(NULLIF(TRIM(COALESCE(`65`, '')), ':') AS FLOAT64) AS measurement_65,
        
            CAST(NULLIF(TRIM(COALESCE(`66`, '')), ':') AS FLOAT64) AS measurement_66,
        
            CAST(NULLIF(TRIM(COALESCE(`67`, '')), ':') AS FLOAT64) AS measurement_67,
        
            CAST(NULLIF(TRIM(COALESCE(`68`, '')), ':') AS FLOAT64) AS measurement_68,
        
            CAST(NULLIF(TRIM(COALESCE(`69`, '')), ':') AS FLOAT64) AS measurement_69,
        
            CAST(NULLIF(TRIM(COALESCE(`70`, '')), ':') AS FLOAT64) AS measurement_70,
        
            CAST(NULLIF(TRIM(COALESCE(`71`, '')), ':') AS FLOAT64) AS measurement_71,
        
            CAST(NULLIF(TRIM(COALESCE(`72`, '')), ':') AS FLOAT64) AS measurement_72,
        
            CAST(NULLIF(TRIM(COALESCE(`73`, '')), ':') AS FLOAT64) AS measurement_73,
        
            CAST(NULLIF(TRIM(COALESCE(`74`, '')), ':') AS FLOAT64) AS measurement_74,
        
            CAST(NULLIF(TRIM(COALESCE(`75`, '')), ':') AS FLOAT64) AS measurement_75,
        
            CAST(NULLIF(TRIM(COALESCE(`76`, '')), ':') AS FLOAT64) AS measurement_76,
        
            CAST(NULLIF(TRIM(COALESCE(`77`, '')), ':') AS FLOAT64) AS measurement_77,
        
            CAST(NULLIF(TRIM(COALESCE(`78`, '')), ':') AS FLOAT64) AS measurement_78,
        
            CAST(NULLIF(TRIM(COALESCE(`79`, '')), ':') AS FLOAT64) AS measurement_79,
        
            CAST(NULLIF(TRIM(COALESCE(`80`, '')), ':') AS FLOAT64) AS measurement_80,
        
            CAST(NULLIF(TRIM(COALESCE(`81`, '')), ':') AS FLOAT64) AS measurement_81,
        
            CAST(NULLIF(TRIM(COALESCE(`82`, '')), ':') AS FLOAT64) AS measurement_82,
        
            CAST(NULLIF(TRIM(COALESCE(`83`, '')), ':') AS FLOAT64) AS measurement_83,
        
            CAST(NULLIF(TRIM(COALESCE(`84`, '')), ':') AS FLOAT64) AS measurement_84,
        
            CAST(NULLIF(TRIM(COALESCE(`85`, '')), ':') AS FLOAT64) AS measurement_85,
        
        CURRENT_TIMESTAMP() AS load_timestamp
    FROM source
),

metadata_extracted AS (
    SELECT
        -- Extract metadata components
        SPLIT(metadata, ',')[SAFE_OFFSET(0)] AS frequency,
        SPLIT(metadata, ',')[SAFE_OFFSET(1)] AS airpol,
        SPLIT(metadata, ',')[SAFE_OFFSET(2)] AS unit,
        SPLIT(metadata, ',')[SAFE_OFFSET(3)] AS geo_code,
        -- Include all measurement columns
        
            measurement_1,
        
            measurement_2,
        
            measurement_3,
        
            measurement_4,
        
            measurement_5,
        
            measurement_6,
        
            measurement_7,
        
            measurement_8,
        
            measurement_9,
        
            measurement_10,
        
            measurement_11,
        
            measurement_12,
        
            measurement_13,
        
            measurement_14,
        
            measurement_15,
        
            measurement_16,
        
            measurement_17,
        
            measurement_18,
        
            measurement_19,
        
            measurement_20,
        
            measurement_21,
        
            measurement_22,
        
            measurement_23,
        
            measurement_24,
        
            measurement_25,
        
            measurement_26,
        
            measurement_27,
        
            measurement_28,
        
            measurement_29,
        
            measurement_30,
        
            measurement_31,
        
            measurement_32,
        
            measurement_33,
        
            measurement_34,
        
            measurement_35,
        
            measurement_36,
        
            measurement_37,
        
            measurement_38,
        
            measurement_39,
        
            measurement_40,
        
            measurement_41,
        
            measurement_42,
        
            measurement_43,
        
            measurement_44,
        
            measurement_45,
        
            measurement_46,
        
            measurement_47,
        
            measurement_48,
        
            measurement_49,
        
            measurement_50,
        
            measurement_51,
        
            measurement_52,
        
            measurement_53,
        
            measurement_54,
        
            measurement_55,
        
            measurement_56,
        
            measurement_57,
        
            measurement_58,
        
            measurement_59,
        
            measurement_60,
        
            measurement_61,
        
            measurement_62,
        
            measurement_63,
        
            measurement_64,
        
            measurement_65,
        
            measurement_66,
        
            measurement_67,
        
            measurement_68,
        
            measurement_69,
        
            measurement_70,
        
            measurement_71,
        
            measurement_72,
        
            measurement_73,
        
            measurement_74,
        
            measurement_75,
        
            measurement_76,
        
            measurement_77,
        
            measurement_78,
        
            measurement_79,
        
            measurement_80,
        
            measurement_81,
        
            measurement_82,
        
            measurement_83,
        
            measurement_84,
        
            measurement_85,
        
        load_timestamp
    FROM parsed
)

SELECT 
    -- Generate a unique ID
    ROW_NUMBER() OVER() AS id,
    frequency,
    airpol,
    unit,
    geo_code,
    load_timestamp,
    
        measurement_1,
    
        measurement_2,
    
        measurement_3,
    
        measurement_4,
    
        measurement_5,
    
        measurement_6,
    
        measurement_7,
    
        measurement_8,
    
        measurement_9,
    
        measurement_10,
    
        measurement_11,
    
        measurement_12,
    
        measurement_13,
    
        measurement_14,
    
        measurement_15,
    
        measurement_16,
    
        measurement_17,
    
        measurement_18,
    
        measurement_19,
    
        measurement_20,
    
        measurement_21,
    
        measurement_22,
    
        measurement_23,
    
        measurement_24,
    
        measurement_25,
    
        measurement_26,
    
        measurement_27,
    
        measurement_28,
    
        measurement_29,
    
        measurement_30,
    
        measurement_31,
    
        measurement_32,
    
        measurement_33,
    
        measurement_34,
    
        measurement_35,
    
        measurement_36,
    
        measurement_37,
    
        measurement_38,
    
        measurement_39,
    
        measurement_40,
    
        measurement_41,
    
        measurement_42,
    
        measurement_43,
    
        measurement_44,
    
        measurement_45,
    
        measurement_46,
    
        measurement_47,
    
        measurement_48,
    
        measurement_49,
    
        measurement_50,
    
        measurement_51,
    
        measurement_52,
    
        measurement_53,
    
        measurement_54,
    
        measurement_55,
    
        measurement_56,
    
        measurement_57,
    
        measurement_58,
    
        measurement_59,
    
        measurement_60,
    
        measurement_61,
    
        measurement_62,
    
        measurement_63,
    
        measurement_64,
    
        measurement_65,
    
        measurement_66,
    
        measurement_67,
    
        measurement_68,
    
        measurement_69,
    
        measurement_70,
    
        measurement_71,
    
        measurement_72,
    
        measurement_73,
    
        measurement_74,
    
        measurement_75,
    
        measurement_76,
    
        measurement_77,
    
        measurement_78,
    
        measurement_79,
    
        measurement_80,
    
        measurement_81,
    
        measurement_82,
    
        measurement_83,
    
        measurement_84,
    
        measurement_85
    
FROM metadata_extracted;


[0m13:07:23.952975 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m13:07:24.562190 [debug] [Thread-1 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=data-talk-clubs&j=bq:EU:43a9571b-cbd1-4560-871f-5c6b7d6df700&page=queryresults
[0m13:07:24.670637 [error] [Thread-1 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=data-talk-clubs&j=bq:EU:43a9571b-cbd1-4560-871f-5c6b7d6df700&page=queryresults
[0m13:07:24.677078 [debug] [Thread-1 (]: Database Error in model stg_emissions_data (models/staging/stg_emissions_data.sql)
  Unrecognized name: geo_time_period at [17:24]
  compiled code at target/run/eu_emissions_project/models/staging/stg_emissions_data.sql
[0m13:07:24.678478 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '88fa17da-f925-4fdd-89a7-3f0c955eff92', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x123f032d0>]}
[0m13:07:24.679050 [error] [Thread-1 (]: 1 of 4 ERROR creating sql view model eu_emissions_project_staging.stg_emissions_data  [[31mERROR[0m in 0.75s]
[0m13:07:24.679408 [debug] [Thread-1 (]: Finished running node model.eu_emissions_project.stg_emissions_data
[0m13:07:24.679743 [debug] [Thread-11 ]: Marking all children of 'model.eu_emissions_project.stg_emissions_data' to be skipped because of status 'error'.  Reason: Database Error in model stg_emissions_data (models/staging/stg_emissions_data.sql)
  Unrecognized name: geo_time_period at [17:24]
  compiled code at target/run/eu_emissions_project/models/staging/stg_emissions_data.sql.
[0m13:07:24.680602 [debug] [Thread-3 (]: Began running node model.eu_emissions_project.int_emissions_cleaned
[0m13:07:24.681153 [debug] [Thread-4 (]: Began running node model.eu_emissions_project.int_emissions_unpivoted
[0m13:07:24.681608 [info ] [Thread-3 (]: 2 of 4 SKIP relation eu_emissions_project_intermediate.int_emissions_cleaned ... [[33mSKIP[0m]
[0m13:07:24.682078 [info ] [Thread-4 (]: 3 of 4 SKIP relation eu_emissions_project_intermediate.int_emissions_unpivoted . [[33mSKIP[0m]
[0m13:07:24.682529 [debug] [Thread-3 (]: Finished running node model.eu_emissions_project.int_emissions_cleaned
[0m13:07:24.682836 [debug] [Thread-4 (]: Finished running node model.eu_emissions_project.int_emissions_unpivoted
[0m13:07:24.683570 [debug] [Thread-6 (]: Began running node model.eu_emissions_project.emissions_analysis
[0m13:07:24.683871 [info ] [Thread-6 (]: 4 of 4 SKIP relation eu_emissions_project_marts.emissions_analysis ............. [[33mSKIP[0m]
[0m13:07:24.684235 [debug] [Thread-6 (]: Finished running node model.eu_emissions_project.emissions_analysis
[0m13:07:24.685411 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m13:07:24.686411 [debug] [MainThread]: Connection 'master' was properly closed.
[0m13:07:24.686600 [debug] [MainThread]: Connection 'model.eu_emissions_project.stg_emissions_data' was properly closed.
[0m13:07:24.686773 [debug] [MainThread]: Connection 'list_data-talk-clubs_eu_emissions_project_marts' was properly closed.
[0m13:07:24.686935 [debug] [MainThread]: Connection 'list_data-talk-clubs_eu_emissions_project_intermediate' was properly closed.
[0m13:07:24.687156 [info ] [MainThread]: 
[0m13:07:24.687350 [info ] [MainThread]: Finished running 2 table models, 2 view models in 0 hours 0 minutes and 1.62 seconds (1.62s).
[0m13:07:24.687730 [debug] [MainThread]: Command end result
[0m13:07:24.702011 [debug] [MainThread]: Wrote artifact WritableManifest to /Users/timbo/Documents/DataTalks/project/src/target/manifest.json
[0m13:07:24.703033 [debug] [MainThread]: Wrote artifact SemanticManifest to /Users/timbo/Documents/DataTalks/project/src/target/semantic_manifest.json
[0m13:07:24.706455 [debug] [MainThread]: Wrote artifact RunExecutionResult to /Users/timbo/Documents/DataTalks/project/src/target/run_results.json
[0m13:07:24.706730 [info ] [MainThread]: 
[0m13:07:24.707044 [info ] [MainThread]: [31mCompleted with 1 error, 0 partial successes, and 0 warnings:[0m
[0m13:07:24.707266 [info ] [MainThread]: 
[0m13:07:24.707487 [error] [MainThread]:   Database Error in model stg_emissions_data (models/staging/stg_emissions_data.sql)
  Unrecognized name: geo_time_period at [17:24]
  compiled code at target/run/eu_emissions_project/models/staging/stg_emissions_data.sql
[0m13:07:24.707666 [info ] [MainThread]: 
[0m13:07:24.707851 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=3 TOTAL=4
[0m13:07:24.709521 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": false, "command_wall_clock_time": 2.9905074, "process_in_blocks": "0", "process_kernel_time": 0.393672, "process_mem_max_rss": "212205568", "process_out_blocks": "0", "process_user_time": 1.867646}
[0m13:07:24.709772 [debug] [MainThread]: Command `dbt run` failed at 13:07:24.709732 after 2.99 seconds
[0m13:07:24.710002 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x103556010>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1125cbe50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1125cbe90>]}
[0m13:07:24.710220 [debug] [MainThread]: Flushing usage events
[0m13:07:25.127244 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m13:07:55.954473 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104cc2ed0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104cc9a10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104ccbf90>]}


============================== 13:07:55.958113 | 6779bd67-c0c6-4afd-9a9d-2e01a1803940 ==============================
[0m13:07:55.958113 [info ] [MainThread]: Running with dbt=1.9.3
[0m13:07:55.958634 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': '/Users/timbo/.dbt', 'version_check': 'True', 'fail_fast': 'False', 'log_path': '/Users/timbo/Documents/DataTalks/project/src/logs', 'warn_error': 'None', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'empty': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt run', 'introspect': 'True', 'log_format': 'default', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m13:07:56.676137 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '6779bd67-c0c6-4afd-9a9d-2e01a1803940', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x121028f50>]}
[0m13:07:56.703168 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '6779bd67-c0c6-4afd-9a9d-2e01a1803940', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x102248cd0>]}
[0m13:07:56.703682 [info ] [MainThread]: Registered adapter: bigquery=1.9.1
[0m13:07:56.798610 [debug] [MainThread]: checksum: 5671c00892cdbcef29c3b00cc5ba7510c3d18a35c883caeb9ab9ee266dc29c8f, vars: {}, profile: , target: , version: 1.9.3
[0m13:07:56.913903 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m13:07:56.914381 [debug] [MainThread]: Partial parsing: updated file: eu_emissions_project://models/staging/stg_emissions_data.sql
[0m13:07:57.072643 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '6779bd67-c0c6-4afd-9a9d-2e01a1803940', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x121b6c5d0>]}
[0m13:07:57.112369 [debug] [MainThread]: Wrote artifact WritableManifest to /Users/timbo/Documents/DataTalks/project/src/target/manifest.json
[0m13:07:57.114976 [debug] [MainThread]: Wrote artifact SemanticManifest to /Users/timbo/Documents/DataTalks/project/src/target/semantic_manifest.json
[0m13:07:57.128337 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '6779bd67-c0c6-4afd-9a9d-2e01a1803940', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x121dfe010>]}
[0m13:07:57.128712 [info ] [MainThread]: Found 4 models, 1 source, 491 macros
[0m13:07:57.128934 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '6779bd67-c0c6-4afd-9a9d-2e01a1803940', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x125beae10>]}
[0m13:07:57.130065 [info ] [MainThread]: 
[0m13:07:57.130356 [info ] [MainThread]: Concurrency: 8 threads (target='dev')
[0m13:07:57.130538 [info ] [MainThread]: 
[0m13:07:57.130833 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m13:07:57.133074 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_data-talk-clubs'
[0m13:07:57.133441 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_data-talk-clubs'
[0m13:07:57.133732 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_data-talk-clubs'
[0m13:07:57.133961 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m13:07:57.134189 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m13:07:57.134437 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m13:07:57.616245 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_data-talk-clubs, now list_data-talk-clubs_eu_emissions_project_intermediate)
[0m13:07:57.616646 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_data-talk-clubs, now list_data-talk-clubs_eu_emissions_project_staging)
[0m13:07:57.616853 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m13:07:57.617098 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_data-talk-clubs, now list_data-talk-clubs_eu_emissions_project_marts)
[0m13:07:57.617339 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m13:07:57.617616 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m13:07:57.899594 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '6779bd67-c0c6-4afd-9a9d-2e01a1803940', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1218b4990>]}
[0m13:07:57.900054 [debug] [MainThread]: Opening a new connection, currently in state init
[0m13:07:57.903187 [debug] [Thread-1 (]: Began running node model.eu_emissions_project.stg_emissions_data
[0m13:07:57.903551 [info ] [Thread-1 (]: 1 of 4 START sql view model eu_emissions_project_staging.stg_emissions_data .... [RUN]
[0m13:07:57.903837 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_data-talk-clubs_eu_emissions_project_intermediate, now model.eu_emissions_project.stg_emissions_data)
[0m13:07:57.904045 [debug] [Thread-1 (]: Began compiling node model.eu_emissions_project.stg_emissions_data
[0m13:07:57.909236 [debug] [Thread-1 (]: Writing injected SQL for node "model.eu_emissions_project.stg_emissions_data"
[0m13:07:57.909809 [debug] [Thread-1 (]: Began executing node model.eu_emissions_project.stg_emissions_data
[0m13:07:57.925652 [debug] [Thread-1 (]: Writing runtime sql for node "model.eu_emissions_project.stg_emissions_data"
[0m13:07:57.926730 [debug] [Thread-1 (]: On model.eu_emissions_project.stg_emissions_data: /* {"app": "dbt", "dbt_version": "1.9.3", "profile_name": "big-query", "target_name": "dev", "node_id": "model.eu_emissions_project.stg_emissions_data"} */


  create or replace view `data-talk-clubs`.`eu_emissions_project_staging`.`stg_emissions_data`
  OPTIONS()
  as 

WITH source AS (
    SELECT 
        *
    FROM `data-talk-clubs`.`eu_emissions_project`.`nitrogen_dioxide_data`
),

parsed AS (
    SELECT 
        -- Split the first column which contains metadata
        REGEXP_EXTRACT(freq_airpol_unit_geo_TIME_PERIOD, r'^([^\t]+)') AS metadata,
        -- Extract all the measurement columns (monthly data from 2018-01 to 2025-02)
        
            CAST(NULLIF(TRIM(COALESCE(`1`, '')), ':') AS FLOAT64) AS measurement_1,
        
            CAST(NULLIF(TRIM(COALESCE(`2`, '')), ':') AS FLOAT64) AS measurement_2,
        
            CAST(NULLIF(TRIM(COALESCE(`3`, '')), ':') AS FLOAT64) AS measurement_3,
        
            CAST(NULLIF(TRIM(COALESCE(`4`, '')), ':') AS FLOAT64) AS measurement_4,
        
            CAST(NULLIF(TRIM(COALESCE(`5`, '')), ':') AS FLOAT64) AS measurement_5,
        
            CAST(NULLIF(TRIM(COALESCE(`6`, '')), ':') AS FLOAT64) AS measurement_6,
        
            CAST(NULLIF(TRIM(COALESCE(`7`, '')), ':') AS FLOAT64) AS measurement_7,
        
            CAST(NULLIF(TRIM(COALESCE(`8`, '')), ':') AS FLOAT64) AS measurement_8,
        
            CAST(NULLIF(TRIM(COALESCE(`9`, '')), ':') AS FLOAT64) AS measurement_9,
        
            CAST(NULLIF(TRIM(COALESCE(`10`, '')), ':') AS FLOAT64) AS measurement_10,
        
            CAST(NULLIF(TRIM(COALESCE(`11`, '')), ':') AS FLOAT64) AS measurement_11,
        
            CAST(NULLIF(TRIM(COALESCE(`12`, '')), ':') AS FLOAT64) AS measurement_12,
        
            CAST(NULLIF(TRIM(COALESCE(`13`, '')), ':') AS FLOAT64) AS measurement_13,
        
            CAST(NULLIF(TRIM(COALESCE(`14`, '')), ':') AS FLOAT64) AS measurement_14,
        
            CAST(NULLIF(TRIM(COALESCE(`15`, '')), ':') AS FLOAT64) AS measurement_15,
        
            CAST(NULLIF(TRIM(COALESCE(`16`, '')), ':') AS FLOAT64) AS measurement_16,
        
            CAST(NULLIF(TRIM(COALESCE(`17`, '')), ':') AS FLOAT64) AS measurement_17,
        
            CAST(NULLIF(TRIM(COALESCE(`18`, '')), ':') AS FLOAT64) AS measurement_18,
        
            CAST(NULLIF(TRIM(COALESCE(`19`, '')), ':') AS FLOAT64) AS measurement_19,
        
            CAST(NULLIF(TRIM(COALESCE(`20`, '')), ':') AS FLOAT64) AS measurement_20,
        
            CAST(NULLIF(TRIM(COALESCE(`21`, '')), ':') AS FLOAT64) AS measurement_21,
        
            CAST(NULLIF(TRIM(COALESCE(`22`, '')), ':') AS FLOAT64) AS measurement_22,
        
            CAST(NULLIF(TRIM(COALESCE(`23`, '')), ':') AS FLOAT64) AS measurement_23,
        
            CAST(NULLIF(TRIM(COALESCE(`24`, '')), ':') AS FLOAT64) AS measurement_24,
        
            CAST(NULLIF(TRIM(COALESCE(`25`, '')), ':') AS FLOAT64) AS measurement_25,
        
            CAST(NULLIF(TRIM(COALESCE(`26`, '')), ':') AS FLOAT64) AS measurement_26,
        
            CAST(NULLIF(TRIM(COALESCE(`27`, '')), ':') AS FLOAT64) AS measurement_27,
        
            CAST(NULLIF(TRIM(COALESCE(`28`, '')), ':') AS FLOAT64) AS measurement_28,
        
            CAST(NULLIF(TRIM(COALESCE(`29`, '')), ':') AS FLOAT64) AS measurement_29,
        
            CAST(NULLIF(TRIM(COALESCE(`30`, '')), ':') AS FLOAT64) AS measurement_30,
        
            CAST(NULLIF(TRIM(COALESCE(`31`, '')), ':') AS FLOAT64) AS measurement_31,
        
            CAST(NULLIF(TRIM(COALESCE(`32`, '')), ':') AS FLOAT64) AS measurement_32,
        
            CAST(NULLIF(TRIM(COALESCE(`33`, '')), ':') AS FLOAT64) AS measurement_33,
        
            CAST(NULLIF(TRIM(COALESCE(`34`, '')), ':') AS FLOAT64) AS measurement_34,
        
            CAST(NULLIF(TRIM(COALESCE(`35`, '')), ':') AS FLOAT64) AS measurement_35,
        
            CAST(NULLIF(TRIM(COALESCE(`36`, '')), ':') AS FLOAT64) AS measurement_36,
        
            CAST(NULLIF(TRIM(COALESCE(`37`, '')), ':') AS FLOAT64) AS measurement_37,
        
            CAST(NULLIF(TRIM(COALESCE(`38`, '')), ':') AS FLOAT64) AS measurement_38,
        
            CAST(NULLIF(TRIM(COALESCE(`39`, '')), ':') AS FLOAT64) AS measurement_39,
        
            CAST(NULLIF(TRIM(COALESCE(`40`, '')), ':') AS FLOAT64) AS measurement_40,
        
            CAST(NULLIF(TRIM(COALESCE(`41`, '')), ':') AS FLOAT64) AS measurement_41,
        
            CAST(NULLIF(TRIM(COALESCE(`42`, '')), ':') AS FLOAT64) AS measurement_42,
        
            CAST(NULLIF(TRIM(COALESCE(`43`, '')), ':') AS FLOAT64) AS measurement_43,
        
            CAST(NULLIF(TRIM(COALESCE(`44`, '')), ':') AS FLOAT64) AS measurement_44,
        
            CAST(NULLIF(TRIM(COALESCE(`45`, '')), ':') AS FLOAT64) AS measurement_45,
        
            CAST(NULLIF(TRIM(COALESCE(`46`, '')), ':') AS FLOAT64) AS measurement_46,
        
            CAST(NULLIF(TRIM(COALESCE(`47`, '')), ':') AS FLOAT64) AS measurement_47,
        
            CAST(NULLIF(TRIM(COALESCE(`48`, '')), ':') AS FLOAT64) AS measurement_48,
        
            CAST(NULLIF(TRIM(COALESCE(`49`, '')), ':') AS FLOAT64) AS measurement_49,
        
            CAST(NULLIF(TRIM(COALESCE(`50`, '')), ':') AS FLOAT64) AS measurement_50,
        
            CAST(NULLIF(TRIM(COALESCE(`51`, '')), ':') AS FLOAT64) AS measurement_51,
        
            CAST(NULLIF(TRIM(COALESCE(`52`, '')), ':') AS FLOAT64) AS measurement_52,
        
            CAST(NULLIF(TRIM(COALESCE(`53`, '')), ':') AS FLOAT64) AS measurement_53,
        
            CAST(NULLIF(TRIM(COALESCE(`54`, '')), ':') AS FLOAT64) AS measurement_54,
        
            CAST(NULLIF(TRIM(COALESCE(`55`, '')), ':') AS FLOAT64) AS measurement_55,
        
            CAST(NULLIF(TRIM(COALESCE(`56`, '')), ':') AS FLOAT64) AS measurement_56,
        
            CAST(NULLIF(TRIM(COALESCE(`57`, '')), ':') AS FLOAT64) AS measurement_57,
        
            CAST(NULLIF(TRIM(COALESCE(`58`, '')), ':') AS FLOAT64) AS measurement_58,
        
            CAST(NULLIF(TRIM(COALESCE(`59`, '')), ':') AS FLOAT64) AS measurement_59,
        
            CAST(NULLIF(TRIM(COALESCE(`60`, '')), ':') AS FLOAT64) AS measurement_60,
        
            CAST(NULLIF(TRIM(COALESCE(`61`, '')), ':') AS FLOAT64) AS measurement_61,
        
            CAST(NULLIF(TRIM(COALESCE(`62`, '')), ':') AS FLOAT64) AS measurement_62,
        
            CAST(NULLIF(TRIM(COALESCE(`63`, '')), ':') AS FLOAT64) AS measurement_63,
        
            CAST(NULLIF(TRIM(COALESCE(`64`, '')), ':') AS FLOAT64) AS measurement_64,
        
            CAST(NULLIF(TRIM(COALESCE(`65`, '')), ':') AS FLOAT64) AS measurement_65,
        
            CAST(NULLIF(TRIM(COALESCE(`66`, '')), ':') AS FLOAT64) AS measurement_66,
        
            CAST(NULLIF(TRIM(COALESCE(`67`, '')), ':') AS FLOAT64) AS measurement_67,
        
            CAST(NULLIF(TRIM(COALESCE(`68`, '')), ':') AS FLOAT64) AS measurement_68,
        
            CAST(NULLIF(TRIM(COALESCE(`69`, '')), ':') AS FLOAT64) AS measurement_69,
        
            CAST(NULLIF(TRIM(COALESCE(`70`, '')), ':') AS FLOAT64) AS measurement_70,
        
            CAST(NULLIF(TRIM(COALESCE(`71`, '')), ':') AS FLOAT64) AS measurement_71,
        
            CAST(NULLIF(TRIM(COALESCE(`72`, '')), ':') AS FLOAT64) AS measurement_72,
        
            CAST(NULLIF(TRIM(COALESCE(`73`, '')), ':') AS FLOAT64) AS measurement_73,
        
            CAST(NULLIF(TRIM(COALESCE(`74`, '')), ':') AS FLOAT64) AS measurement_74,
        
            CAST(NULLIF(TRIM(COALESCE(`75`, '')), ':') AS FLOAT64) AS measurement_75,
        
            CAST(NULLIF(TRIM(COALESCE(`76`, '')), ':') AS FLOAT64) AS measurement_76,
        
            CAST(NULLIF(TRIM(COALESCE(`77`, '')), ':') AS FLOAT64) AS measurement_77,
        
            CAST(NULLIF(TRIM(COALESCE(`78`, '')), ':') AS FLOAT64) AS measurement_78,
        
            CAST(NULLIF(TRIM(COALESCE(`79`, '')), ':') AS FLOAT64) AS measurement_79,
        
            CAST(NULLIF(TRIM(COALESCE(`80`, '')), ':') AS FLOAT64) AS measurement_80,
        
            CAST(NULLIF(TRIM(COALESCE(`81`, '')), ':') AS FLOAT64) AS measurement_81,
        
            CAST(NULLIF(TRIM(COALESCE(`82`, '')), ':') AS FLOAT64) AS measurement_82,
        
            CAST(NULLIF(TRIM(COALESCE(`83`, '')), ':') AS FLOAT64) AS measurement_83,
        
            CAST(NULLIF(TRIM(COALESCE(`84`, '')), ':') AS FLOAT64) AS measurement_84,
        
            CAST(NULLIF(TRIM(COALESCE(`85`, '')), ':') AS FLOAT64) AS measurement_85,
        
        CURRENT_TIMESTAMP() AS load_timestamp
    FROM source
),

metadata_extracted AS (
    SELECT
        -- Extract metadata components
        SPLIT(metadata, ',')[SAFE_OFFSET(0)] AS frequency,
        SPLIT(metadata, ',')[SAFE_OFFSET(1)] AS airpol,
        SPLIT(metadata, ',')[SAFE_OFFSET(2)] AS unit,
        SPLIT(metadata, ',')[SAFE_OFFSET(3)] AS geo_code,
        -- Include all measurement columns
        
            measurement_1,
        
            measurement_2,
        
            measurement_3,
        
            measurement_4,
        
            measurement_5,
        
            measurement_6,
        
            measurement_7,
        
            measurement_8,
        
            measurement_9,
        
            measurement_10,
        
            measurement_11,
        
            measurement_12,
        
            measurement_13,
        
            measurement_14,
        
            measurement_15,
        
            measurement_16,
        
            measurement_17,
        
            measurement_18,
        
            measurement_19,
        
            measurement_20,
        
            measurement_21,
        
            measurement_22,
        
            measurement_23,
        
            measurement_24,
        
            measurement_25,
        
            measurement_26,
        
            measurement_27,
        
            measurement_28,
        
            measurement_29,
        
            measurement_30,
        
            measurement_31,
        
            measurement_32,
        
            measurement_33,
        
            measurement_34,
        
            measurement_35,
        
            measurement_36,
        
            measurement_37,
        
            measurement_38,
        
            measurement_39,
        
            measurement_40,
        
            measurement_41,
        
            measurement_42,
        
            measurement_43,
        
            measurement_44,
        
            measurement_45,
        
            measurement_46,
        
            measurement_47,
        
            measurement_48,
        
            measurement_49,
        
            measurement_50,
        
            measurement_51,
        
            measurement_52,
        
            measurement_53,
        
            measurement_54,
        
            measurement_55,
        
            measurement_56,
        
            measurement_57,
        
            measurement_58,
        
            measurement_59,
        
            measurement_60,
        
            measurement_61,
        
            measurement_62,
        
            measurement_63,
        
            measurement_64,
        
            measurement_65,
        
            measurement_66,
        
            measurement_67,
        
            measurement_68,
        
            measurement_69,
        
            measurement_70,
        
            measurement_71,
        
            measurement_72,
        
            measurement_73,
        
            measurement_74,
        
            measurement_75,
        
            measurement_76,
        
            measurement_77,
        
            measurement_78,
        
            measurement_79,
        
            measurement_80,
        
            measurement_81,
        
            measurement_82,
        
            measurement_83,
        
            measurement_84,
        
            measurement_85,
        
        load_timestamp
    FROM parsed
)

SELECT 
    -- Generate a unique ID
    ROW_NUMBER() OVER() AS id,
    frequency,
    airpol,
    unit,
    geo_code,
    load_timestamp,
    
        measurement_1,
    
        measurement_2,
    
        measurement_3,
    
        measurement_4,
    
        measurement_5,
    
        measurement_6,
    
        measurement_7,
    
        measurement_8,
    
        measurement_9,
    
        measurement_10,
    
        measurement_11,
    
        measurement_12,
    
        measurement_13,
    
        measurement_14,
    
        measurement_15,
    
        measurement_16,
    
        measurement_17,
    
        measurement_18,
    
        measurement_19,
    
        measurement_20,
    
        measurement_21,
    
        measurement_22,
    
        measurement_23,
    
        measurement_24,
    
        measurement_25,
    
        measurement_26,
    
        measurement_27,
    
        measurement_28,
    
        measurement_29,
    
        measurement_30,
    
        measurement_31,
    
        measurement_32,
    
        measurement_33,
    
        measurement_34,
    
        measurement_35,
    
        measurement_36,
    
        measurement_37,
    
        measurement_38,
    
        measurement_39,
    
        measurement_40,
    
        measurement_41,
    
        measurement_42,
    
        measurement_43,
    
        measurement_44,
    
        measurement_45,
    
        measurement_46,
    
        measurement_47,
    
        measurement_48,
    
        measurement_49,
    
        measurement_50,
    
        measurement_51,
    
        measurement_52,
    
        measurement_53,
    
        measurement_54,
    
        measurement_55,
    
        measurement_56,
    
        measurement_57,
    
        measurement_58,
    
        measurement_59,
    
        measurement_60,
    
        measurement_61,
    
        measurement_62,
    
        measurement_63,
    
        measurement_64,
    
        measurement_65,
    
        measurement_66,
    
        measurement_67,
    
        measurement_68,
    
        measurement_69,
    
        measurement_70,
    
        measurement_71,
    
        measurement_72,
    
        measurement_73,
    
        measurement_74,
    
        measurement_75,
    
        measurement_76,
    
        measurement_77,
    
        measurement_78,
    
        measurement_79,
    
        measurement_80,
    
        measurement_81,
    
        measurement_82,
    
        measurement_83,
    
        measurement_84,
    
        measurement_85
    
FROM metadata_extracted;


[0m13:07:57.927507 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m13:07:58.535161 [debug] [Thread-1 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=data-talk-clubs&j=bq:EU:b1d236c3-cafa-42b1-9fd6-5b6991e11eb7&page=queryresults
[0m13:07:58.721516 [error] [Thread-1 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=data-talk-clubs&j=bq:EU:b1d236c3-cafa-42b1-9fd6-5b6991e11eb7&page=queryresults
[0m13:07:58.728984 [debug] [Thread-1 (]: Database Error in model stg_emissions_data (models/staging/stg_emissions_data.sql)
  Unrecognized name: `1` at [20:39]
  compiled code at target/run/eu_emissions_project/models/staging/stg_emissions_data.sql
[0m13:07:58.730190 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6779bd67-c0c6-4afd-9a9d-2e01a1803940', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x121dc9950>]}
[0m13:07:58.730642 [error] [Thread-1 (]: 1 of 4 ERROR creating sql view model eu_emissions_project_staging.stg_emissions_data  [[31mERROR[0m in 0.83s]
[0m13:07:58.730970 [debug] [Thread-1 (]: Finished running node model.eu_emissions_project.stg_emissions_data
[0m13:07:58.731273 [debug] [Thread-11 ]: Marking all children of 'model.eu_emissions_project.stg_emissions_data' to be skipped because of status 'error'.  Reason: Database Error in model stg_emissions_data (models/staging/stg_emissions_data.sql)
  Unrecognized name: `1` at [20:39]
  compiled code at target/run/eu_emissions_project/models/staging/stg_emissions_data.sql.
[0m13:07:58.731988 [debug] [Thread-3 (]: Began running node model.eu_emissions_project.int_emissions_cleaned
[0m13:07:58.732254 [debug] [Thread-4 (]: Began running node model.eu_emissions_project.int_emissions_unpivoted
[0m13:07:58.732536 [info ] [Thread-3 (]: 2 of 4 SKIP relation eu_emissions_project_intermediate.int_emissions_cleaned ... [[33mSKIP[0m]
[0m13:07:58.732845 [info ] [Thread-4 (]: 3 of 4 SKIP relation eu_emissions_project_intermediate.int_emissions_unpivoted . [[33mSKIP[0m]
[0m13:07:58.733097 [debug] [Thread-3 (]: Finished running node model.eu_emissions_project.int_emissions_cleaned
[0m13:07:58.733329 [debug] [Thread-4 (]: Finished running node model.eu_emissions_project.int_emissions_unpivoted
[0m13:07:58.733776 [debug] [Thread-6 (]: Began running node model.eu_emissions_project.emissions_analysis
[0m13:07:58.734078 [info ] [Thread-6 (]: 4 of 4 SKIP relation eu_emissions_project_marts.emissions_analysis ............. [[33mSKIP[0m]
[0m13:07:58.734322 [debug] [Thread-6 (]: Finished running node model.eu_emissions_project.emissions_analysis
[0m13:07:58.735123 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m13:07:58.736093 [debug] [MainThread]: Connection 'master' was properly closed.
[0m13:07:58.736297 [debug] [MainThread]: Connection 'model.eu_emissions_project.stg_emissions_data' was properly closed.
[0m13:07:58.736473 [debug] [MainThread]: Connection 'list_data-talk-clubs_eu_emissions_project_staging' was properly closed.
[0m13:07:58.736636 [debug] [MainThread]: Connection 'list_data-talk-clubs_eu_emissions_project_marts' was properly closed.
[0m13:07:58.736859 [info ] [MainThread]: 
[0m13:07:58.737055 [info ] [MainThread]: Finished running 2 table models, 2 view models in 0 hours 0 minutes and 1.61 seconds (1.61s).
[0m13:07:58.737431 [debug] [MainThread]: Command end result
[0m13:07:58.751123 [debug] [MainThread]: Wrote artifact WritableManifest to /Users/timbo/Documents/DataTalks/project/src/target/manifest.json
[0m13:07:58.752440 [debug] [MainThread]: Wrote artifact SemanticManifest to /Users/timbo/Documents/DataTalks/project/src/target/semantic_manifest.json
[0m13:07:58.756043 [debug] [MainThread]: Wrote artifact RunExecutionResult to /Users/timbo/Documents/DataTalks/project/src/target/run_results.json
[0m13:07:58.756361 [info ] [MainThread]: 
[0m13:07:58.756614 [info ] [MainThread]: [31mCompleted with 1 error, 0 partial successes, and 0 warnings:[0m
[0m13:07:58.756805 [info ] [MainThread]: 
[0m13:07:58.757017 [error] [MainThread]:   Database Error in model stg_emissions_data (models/staging/stg_emissions_data.sql)
  Unrecognized name: `1` at [20:39]
  compiled code at target/run/eu_emissions_project/models/staging/stg_emissions_data.sql
[0m13:07:58.757196 [info ] [MainThread]: 
[0m13:07:58.757378 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=3 TOTAL=4
[0m13:07:58.759199 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": false, "command_wall_clock_time": 2.8437958, "process_in_blocks": "0", "process_kernel_time": 0.336745, "process_mem_max_rss": "209240064", "process_out_blocks": "0", "process_user_time": 1.722043}
[0m13:07:58.759482 [debug] [MainThread]: Command `dbt run` failed at 13:07:58.759437 after 2.84 seconds
[0m13:07:58.759717 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x100382150>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104ccbd10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104ccb910>]}
[0m13:07:58.759934 [debug] [MainThread]: Flushing usage events
[0m13:07:59.275827 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m13:09:39.812620 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x106ae3610>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x106b3f550>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x106b3ffd0>]}


============================== 13:09:39.816278 | be48ea76-0b84-4a60-96e1-e120df635182 ==============================
[0m13:09:39.816278 [info ] [MainThread]: Running with dbt=1.9.3
[0m13:09:39.816800 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': '/Users/timbo/.dbt', 'version_check': 'True', 'fail_fast': 'False', 'log_path': '/Users/timbo/Documents/DataTalks/project/src/logs', 'warn_error': 'None', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'empty': 'False', 'log_format': 'default', 'introspect': 'True', 'static_parser': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'target_path': 'None', 'invocation_command': 'dbt run', 'send_anonymous_usage_stats': 'True'}
[0m13:09:40.607280 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'be48ea76-0b84-4a60-96e1-e120df635182', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x106aff650>]}
[0m13:09:40.633867 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'be48ea76-0b84-4a60-96e1-e120df635182', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10cd547d0>]}
[0m13:09:40.634339 [info ] [MainThread]: Registered adapter: bigquery=1.9.1
[0m13:09:40.742948 [debug] [MainThread]: checksum: 5671c00892cdbcef29c3b00cc5ba7510c3d18a35c883caeb9ab9ee266dc29c8f, vars: {}, profile: , target: , version: 1.9.3
[0m13:09:40.862852 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m13:09:40.863299 [debug] [MainThread]: Partial parsing: updated file: eu_emissions_project://models/staging/stg_emissions_data.sql
[0m13:09:41.019616 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'be48ea76-0b84-4a60-96e1-e120df635182', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10dd99a90>]}
[0m13:09:41.056107 [debug] [MainThread]: Wrote artifact WritableManifest to /Users/timbo/Documents/DataTalks/project/src/target/manifest.json
[0m13:09:41.058206 [debug] [MainThread]: Wrote artifact SemanticManifest to /Users/timbo/Documents/DataTalks/project/src/target/semantic_manifest.json
[0m13:09:41.072433 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'be48ea76-0b84-4a60-96e1-e120df635182', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10dfd9010>]}
[0m13:09:41.072825 [info ] [MainThread]: Found 4 models, 1 source, 491 macros
[0m13:09:41.073058 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'be48ea76-0b84-4a60-96e1-e120df635182', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10dbc0c10>]}
[0m13:09:41.074008 [info ] [MainThread]: 
[0m13:09:41.074296 [info ] [MainThread]: Concurrency: 8 threads (target='dev')
[0m13:09:41.074539 [info ] [MainThread]: 
[0m13:09:41.074828 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m13:09:41.076941 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_data-talk-clubs'
[0m13:09:41.077299 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_data-talk-clubs'
[0m13:09:41.077572 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m13:09:41.077791 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_data-talk-clubs'
[0m13:09:41.078005 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m13:09:41.078245 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m13:09:41.535417 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_data-talk-clubs, now list_data-talk-clubs_eu_emissions_project_staging)
[0m13:09:41.535773 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_data-talk-clubs, now list_data-talk-clubs_eu_emissions_project_intermediate)
[0m13:09:41.536027 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m13:09:41.536276 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_data-talk-clubs, now list_data-talk-clubs_eu_emissions_project_marts)
[0m13:09:41.536476 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m13:09:41.536740 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m13:09:41.827149 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'be48ea76-0b84-4a60-96e1-e120df635182', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d76b690>]}
[0m13:09:41.827575 [debug] [MainThread]: Opening a new connection, currently in state init
[0m13:09:41.830832 [debug] [Thread-1 (]: Began running node model.eu_emissions_project.stg_emissions_data
[0m13:09:41.831248 [info ] [Thread-1 (]: 1 of 4 START sql view model eu_emissions_project_staging.stg_emissions_data .... [RUN]
[0m13:09:41.831647 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_data-talk-clubs_eu_emissions_project_staging, now model.eu_emissions_project.stg_emissions_data)
[0m13:09:41.831894 [debug] [Thread-1 (]: Began compiling node model.eu_emissions_project.stg_emissions_data
[0m13:09:41.836688 [debug] [Thread-1 (]: Writing injected SQL for node "model.eu_emissions_project.stg_emissions_data"
[0m13:09:41.837488 [debug] [Thread-1 (]: Began executing node model.eu_emissions_project.stg_emissions_data
[0m13:09:41.852893 [debug] [Thread-1 (]: Writing runtime sql for node "model.eu_emissions_project.stg_emissions_data"
[0m13:09:41.854166 [debug] [Thread-1 (]: On model.eu_emissions_project.stg_emissions_data: /* {"app": "dbt", "dbt_version": "1.9.3", "profile_name": "big-query", "target_name": "dev", "node_id": "model.eu_emissions_project.stg_emissions_data"} */


  create or replace view `data-talk-clubs`.`eu_emissions_project_staging`.`stg_emissions_data`
  OPTIONS()
  as 

WITH source AS (
    SELECT 
        *
    FROM `data-talk-clubs`.`eu_emissions_project`.`nitrogen_dioxide_data`
),

parsed AS (
    SELECT 
        -- Split the first column which contains metadata
        freq_airpol_unit_geo_TIME_PERIOD AS metadata,
        -- Extract all the measurement columns (monthly data from 2018-01 to 2025-02)
        CAST(NULLIF(TRIM(_2018_01_), ':') AS FLOAT64) AS measurement_1,
        CAST(NULLIF(TRIM(_2018_02_), ':') AS FLOAT64) AS measurement_2,
        CAST(NULLIF(TRIM(_2018_03_), ':') AS FLOAT64) AS measurement_3,
        CAST(NULLIF(TRIM(_2018_04_), ':') AS FLOAT64) AS measurement_4,
        CAST(NULLIF(TRIM(_2018_05_), ':') AS FLOAT64) AS measurement_5,
        CAST(NULLIF(TRIM(_2018_06_), ':') AS FLOAT64) AS measurement_6,
        CAST(NULLIF(TRIM(_2018_07_), ':') AS FLOAT64) AS measurement_7,
        CAST(NULLIF(TRIM(_2018_08_), ':') AS FLOAT64) AS measurement_8,
        CAST(NULLIF(TRIM(_2018_09_), ':') AS FLOAT64) AS measurement_9,
        CAST(NULLIF(TRIM(_2018_10_), ':') AS FLOAT64) AS measurement_10,
        CAST(NULLIF(TRIM(_2018_11_), ':') AS FLOAT64) AS measurement_11,
        CAST(NULLIF(TRIM(_2018_12_), ':') AS FLOAT64) AS measurement_12,
        CAST(NULLIF(TRIM(_2019_01_), ':') AS FLOAT64) AS measurement_13,
        CAST(NULLIF(TRIM(_2019_02_), ':') AS FLOAT64) AS measurement_14,
        CAST(NULLIF(TRIM(_2019_03_), ':') AS FLOAT64) AS measurement_15,
        CAST(NULLIF(TRIM(_2019_04_), ':') AS FLOAT64) AS measurement_16,
        CAST(NULLIF(TRIM(_2019_05_), ':') AS FLOAT64) AS measurement_17,
        CAST(NULLIF(TRIM(_2019_06_), ':') AS FLOAT64) AS measurement_18,
        CAST(NULLIF(TRIM(_2019_07_), ':') AS FLOAT64) AS measurement_19,
        CAST(NULLIF(TRIM(_2019_08_), ':') AS FLOAT64) AS measurement_20,
        CAST(NULLIF(TRIM(_2019_09_), ':') AS FLOAT64) AS measurement_21,
        CAST(NULLIF(TRIM(_2019_10_), ':') AS FLOAT64) AS measurement_22,
        CAST(NULLIF(TRIM(_2019_11_), ':') AS FLOAT64) AS measurement_23,
        CAST(NULLIF(TRIM(_2019_12_), ':') AS FLOAT64) AS measurement_24,
        -- 2020
        CAST(NULLIF(TRIM(_2020_01_), ':') AS FLOAT64) AS measurement_25,
        CAST(NULLIF(TRIM(_2020_02_), ':') AS FLOAT64) AS measurement_26,
        CAST(NULLIF(TRIM(_2020_03_), ':') AS FLOAT64) AS measurement_27,
        CAST(NULLIF(TRIM(_2020_04_), ':') AS FLOAT64) AS measurement_28,
        CAST(NULLIF(TRIM(_2020_05_), ':') AS FLOAT64) AS measurement_29,
        CAST(NULLIF(TRIM(_2020_06_), ':') AS FLOAT64) AS measurement_30,
        CAST(NULLIF(TRIM(_2020_07_), ':') AS FLOAT64) AS measurement_31,
        CAST(NULLIF(TRIM(_2020_08_), ':') AS FLOAT64) AS measurement_32,
        CAST(NULLIF(TRIM(_2020_09_), ':') AS FLOAT64) AS measurement_33,
        CAST(NULLIF(TRIM(_2020_10_), ':') AS FLOAT64) AS measurement_34,
        CAST(NULLIF(TRIM(_2020_11_), ':') AS FLOAT64) AS measurement_35,
        CAST(NULLIF(TRIM(_2020_12_), ':') AS FLOAT64) AS measurement_36,
        -- 2021
        CAST(NULLIF(TRIM(_2021_01_), ':') AS FLOAT64) AS measurement_37,
        CAST(NULLIF(TRIM(_2021_02_), ':') AS FLOAT64) AS measurement_38,
        CAST(NULLIF(TRIM(_2021_03_), ':') AS FLOAT64) AS measurement_39,
        CAST(NULLIF(TRIM(_2021_04_), ':') AS FLOAT64) AS measurement_40,
        CAST(NULLIF(TRIM(_2021_05_), ':') AS FLOAT64) AS measurement_41,
        CAST(NULLIF(TRIM(_2021_06_), ':') AS FLOAT64) AS measurement_42,
        CAST(NULLIF(TRIM(_2021_07_), ':') AS FLOAT64) AS measurement_43,
        CAST(NULLIF(TRIM(_2021_08_), ':') AS FLOAT64) AS measurement_44,
        CAST(NULLIF(TRIM(_2021_09_), ':') AS FLOAT64) AS measurement_45,
        CAST(NULLIF(TRIM(_2021_10_), ':') AS FLOAT64) AS measurement_46,
        CAST(NULLIF(TRIM(_2021_11_), ':') AS FLOAT64) AS measurement_47,
        CAST(NULLIF(TRIM(_2021_12_), ':') AS FLOAT64) AS measurement_48,
        -- 2022
        CAST(NULLIF(TRIM(_2022_01_), ':') AS FLOAT64) AS measurement_49,
        CAST(NULLIF(TRIM(_2022_02_), ':') AS FLOAT64) AS measurement_50,
        CAST(NULLIF(TRIM(_2022_03_), ':') AS FLOAT64) AS measurement_51,
        CAST(NULLIF(TRIM(_2022_04_), ':') AS FLOAT64) AS measurement_52,
        CAST(NULLIF(TRIM(_2022_05_), ':') AS FLOAT64) AS measurement_53,
        CAST(NULLIF(TRIM(_2022_06_), ':') AS FLOAT64) AS measurement_54,
        CAST(NULLIF(TRIM(_2022_07_), ':') AS FLOAT64) AS measurement_55,
        CAST(NULLIF(TRIM(_2022_08_), ':') AS FLOAT64) AS measurement_56,
        CAST(NULLIF(TRIM(_2022_09_), ':') AS FLOAT64) AS measurement_57,
        CAST(NULLIF(TRIM(_2022_10_), ':') AS FLOAT64) AS measurement_58,
        CAST(NULLIF(TRIM(_2022_11_), ':') AS FLOAT64) AS measurement_59,
        CAST(NULLIF(TRIM(_2022_12_), ':') AS FLOAT64) AS measurement_60,
        -- 2023
        CAST(NULLIF(TRIM(_2023_01_), ':') AS FLOAT64) AS measurement_61,
        CAST(NULLIF(TRIM(_2023_02_), ':') AS FLOAT64) AS measurement_62,
        CAST(NULLIF(TRIM(_2023_03_), ':') AS FLOAT64) AS measurement_63,
        CAST(NULLIF(TRIM(_2023_04_), ':') AS FLOAT64) AS measurement_64,
        CAST(NULLIF(TRIM(_2023_05_), ':') AS FLOAT64) AS measurement_65,
        CAST(NULLIF(TRIM(_2023_06_), ':') AS FLOAT64) AS measurement_66,
        CAST(NULLIF(TRIM(_2023_07_), ':') AS FLOAT64) AS measurement_67,
        CAST(NULLIF(TRIM(_2023_08_), ':') AS FLOAT64) AS measurement_68,
        CAST(NULLIF(TRIM(_2023_09_), ':') AS FLOAT64) AS measurement_69,
        CAST(NULLIF(TRIM(_2023_10_), ':') AS FLOAT64) AS measurement_70,
        CAST(NULLIF(TRIM(_2023_11_), ':') AS FLOAT64) AS measurement_71,
        CAST(NULLIF(TRIM(_2023_12_), ':') AS FLOAT64) AS measurement_72,
        -- 2024
        CAST(NULLIF(TRIM(_2024_01_), ':') AS FLOAT64) AS measurement_73,
        CAST(NULLIF(TRIM(_2024_02_), ':') AS FLOAT64) AS measurement_74,
        CAST(NULLIF(TRIM(_2024_03_), ':') AS FLOAT64) AS measurement_75,
        CAST(NULLIF(TRIM(_2024_04_), ':') AS FLOAT64) AS measurement_76,
        CAST(NULLIF(TRIM(_2024_05_), ':') AS FLOAT64) AS measurement_77,
        CAST(NULLIF(TRIM(_2024_06_), ':') AS FLOAT64) AS measurement_78,
        CAST(NULLIF(TRIM(_2024_07_), ':') AS FLOAT64) AS measurement_79,
        CAST(NULLIF(TRIM(_2024_08_), ':') AS FLOAT64) AS measurement_80,
        CAST(NULLIF(TRIM(_2024_09_), ':') AS FLOAT64) AS measurement_81,
        CAST(NULLIF(TRIM(_2024_10_), ':') AS FLOAT64) AS measurement_82,
        CAST(NULLIF(TRIM(_2024_11_), ':') AS FLOAT64) AS measurement_83,
        CAST(NULLIF(TRIM(_2024_12_), ':') AS FLOAT64) AS measurement_84,
        -- 2025
        CAST(NULLIF(TRIM(_2025_01_), ':') AS FLOAT64) AS measurement_85,
        CAST(NULLIF(TRIM(_2025_02_), ':') AS FLOAT64) AS measurement_86,
        CURRENT_TIMESTAMP() AS load_timestamp
    FROM source
),

metadata_extracted AS (
    SELECT
        -- Extract metadata components
        SPLIT(metadata, ',')[SAFE_OFFSET(0)] AS frequency,
        SPLIT(metadata, ',')[SAFE_OFFSET(1)] AS airpol,
        SPLIT(metadata, ',')[SAFE_OFFSET(2)] AS unit,
        SPLIT(metadata, ',')[SAFE_OFFSET(3)] AS geo_code,
        -- Include all measurement columns
        measurement_1, measurement_2, measurement_3, measurement_4, measurement_5, measurement_6,
        measurement_7, measurement_8, measurement_9, measurement_10, measurement_11, measurement_12,
        measurement_13, measurement_14, measurement_15, measurement_16, measurement_17, measurement_18,
        measurement_19, measurement_20, measurement_21, measurement_22, measurement_23, measurement_24,
        measurement_25, measurement_26, measurement_27, measurement_28, measurement_29, measurement_30,
        measurement_31, measurement_32, measurement_33, measurement_34, measurement_35, measurement_36,
        measurement_37, measurement_38, measurement_39, measurement_40, measurement_41, measurement_42,
        measurement_43, measurement_44, measurement_45, measurement_46, measurement_47, measurement_48,
        measurement_49, measurement_50, measurement_51, measurement_52, measurement_53, measurement_54,
        measurement_55, measurement_56, measurement_57, measurement_58, measurement_59, measurement_60,
        measurement_61, measurement_62, measurement_63, measurement_64, measurement_65, measurement_66,
        measurement_67, measurement_68, measurement_69, measurement_70, measurement_71, measurement_72,
        measurement_73, measurement_74, measurement_75, measurement_76, measurement_77, measurement_78,
        measurement_79, measurement_80, measurement_81, measurement_82, measurement_83, measurement_84,
        measurement_85, measurement_86,
        load_timestamp
    FROM parsed
)

SELECT 
    -- Generate a unique ID
    ROW_NUMBER() OVER() AS id,
    frequency,
    airpol,
    unit,
    geo_code,
    load_timestamp,
    measurement_1, measurement_2, measurement_3, measurement_4, measurement_5, measurement_6,
    measurement_7, measurement_8, measurement_9, measurement_10, measurement_11, measurement_12,
    measurement_13, measurement_14, measurement_15, measurement_16, measurement_17, measurement_18,
    measurement_19, measurement_20, measurement_21, measurement_22, measurement_23, measurement_24,
    measurement_25, measurement_26, measurement_27, measurement_28, measurement_29, measurement_30,
    measurement_31, measurement_32, measurement_33, measurement_34, measurement_35, measurement_36,
    measurement_37, measurement_38, measurement_39, measurement_40, measurement_41, measurement_42,
    measurement_43, measurement_44, measurement_45, measurement_46, measurement_47, measurement_48,
    measurement_49, measurement_50, measurement_51, measurement_52, measurement_53, measurement_54,
    measurement_55, measurement_56, measurement_57, measurement_58, measurement_59, measurement_60,
    measurement_61, measurement_62, measurement_63, measurement_64, measurement_65, measurement_66,
    measurement_67, measurement_68, measurement_69, measurement_70, measurement_71, measurement_72,
    measurement_73, measurement_74, measurement_75, measurement_76, measurement_77, measurement_78,
    measurement_79, measurement_80, measurement_81, measurement_82, measurement_83, measurement_84,
    measurement_85, measurement_86
FROM metadata_extracted;


[0m13:09:41.854846 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m13:09:42.751438 [debug] [Thread-1 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=data-talk-clubs&j=bq:EU:0163dd3a-c787-47d7-a447-f3c52f402ab0&page=queryresults
[0m13:09:42.844401 [error] [Thread-1 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=data-talk-clubs&j=bq:EU:0163dd3a-c787-47d7-a447-f3c52f402ab0&page=queryresults
[0m13:09:42.852927 [debug] [Thread-1 (]: Database Error in model stg_emissions_data (models/staging/stg_emissions_data.sql)
  No matching signature for function TRIM
    Argument types: FLOAT64
    Signature: TRIM(STRING, [STRING])
      Argument 1: Unable to coerce type FLOAT64 to expected type STRING
    Signature: TRIM(BYTES, BYTES)
      Signature requires at least 2 arguments, found 1 argument at [19:21]
  compiled code at target/run/eu_emissions_project/models/staging/stg_emissions_data.sql
[0m13:09:42.854351 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'be48ea76-0b84-4a60-96e1-e120df635182', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10dda3ed0>]}
[0m13:09:42.854998 [error] [Thread-1 (]: 1 of 4 ERROR creating sql view model eu_emissions_project_staging.stg_emissions_data  [[31mERROR[0m in 1.02s]
[0m13:09:42.855337 [debug] [Thread-1 (]: Finished running node model.eu_emissions_project.stg_emissions_data
[0m13:09:42.855703 [debug] [Thread-11 ]: Marking all children of 'model.eu_emissions_project.stg_emissions_data' to be skipped because of status 'error'.  Reason: Database Error in model stg_emissions_data (models/staging/stg_emissions_data.sql)
  No matching signature for function TRIM
    Argument types: FLOAT64
    Signature: TRIM(STRING, [STRING])
      Argument 1: Unable to coerce type FLOAT64 to expected type STRING
    Signature: TRIM(BYTES, BYTES)
      Signature requires at least 2 arguments, found 1 argument at [19:21]
  compiled code at target/run/eu_emissions_project/models/staging/stg_emissions_data.sql.
[0m13:09:42.856518 [debug] [Thread-3 (]: Began running node model.eu_emissions_project.int_emissions_cleaned
[0m13:09:42.856787 [debug] [Thread-4 (]: Began running node model.eu_emissions_project.int_emissions_unpivoted
[0m13:09:42.857066 [info ] [Thread-3 (]: 2 of 4 SKIP relation eu_emissions_project_intermediate.int_emissions_cleaned ... [[33mSKIP[0m]
[0m13:09:42.857339 [info ] [Thread-4 (]: 3 of 4 SKIP relation eu_emissions_project_intermediate.int_emissions_unpivoted . [[33mSKIP[0m]
[0m13:09:42.857616 [debug] [Thread-3 (]: Finished running node model.eu_emissions_project.int_emissions_cleaned
[0m13:09:42.857841 [debug] [Thread-4 (]: Finished running node model.eu_emissions_project.int_emissions_unpivoted
[0m13:09:42.858248 [debug] [Thread-6 (]: Began running node model.eu_emissions_project.emissions_analysis
[0m13:09:42.858498 [info ] [Thread-6 (]: 4 of 4 SKIP relation eu_emissions_project_marts.emissions_analysis ............. [[33mSKIP[0m]
[0m13:09:42.858736 [debug] [Thread-6 (]: Finished running node model.eu_emissions_project.emissions_analysis
[0m13:09:42.859442 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m13:09:42.860467 [debug] [MainThread]: Connection 'master' was properly closed.
[0m13:09:42.860676 [debug] [MainThread]: Connection 'model.eu_emissions_project.stg_emissions_data' was properly closed.
[0m13:09:42.860848 [debug] [MainThread]: Connection 'list_data-talk-clubs_eu_emissions_project_intermediate' was properly closed.
[0m13:09:42.861015 [debug] [MainThread]: Connection 'list_data-talk-clubs_eu_emissions_project_marts' was properly closed.
[0m13:09:42.861236 [info ] [MainThread]: 
[0m13:09:42.861427 [info ] [MainThread]: Finished running 2 table models, 2 view models in 0 hours 0 minutes and 1.79 seconds (1.79s).
[0m13:09:42.861797 [debug] [MainThread]: Command end result
[0m13:09:42.875663 [debug] [MainThread]: Wrote artifact WritableManifest to /Users/timbo/Documents/DataTalks/project/src/target/manifest.json
[0m13:09:42.876600 [debug] [MainThread]: Wrote artifact SemanticManifest to /Users/timbo/Documents/DataTalks/project/src/target/semantic_manifest.json
[0m13:09:42.879722 [debug] [MainThread]: Wrote artifact RunExecutionResult to /Users/timbo/Documents/DataTalks/project/src/target/run_results.json
[0m13:09:42.880001 [info ] [MainThread]: 
[0m13:09:42.880234 [info ] [MainThread]: [31mCompleted with 1 error, 0 partial successes, and 0 warnings:[0m
[0m13:09:42.880423 [info ] [MainThread]: 
[0m13:09:42.880640 [error] [MainThread]:   Database Error in model stg_emissions_data (models/staging/stg_emissions_data.sql)
  No matching signature for function TRIM
    Argument types: FLOAT64
    Signature: TRIM(STRING, [STRING])
      Argument 1: Unable to coerce type FLOAT64 to expected type STRING
    Signature: TRIM(BYTES, BYTES)
      Signature requires at least 2 arguments, found 1 argument at [19:21]
  compiled code at target/run/eu_emissions_project/models/staging/stg_emissions_data.sql
[0m13:09:42.880829 [info ] [MainThread]: 
[0m13:09:42.881015 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=3 TOTAL=4
[0m13:09:42.882507 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": false, "command_wall_clock_time": 3.110508, "process_in_blocks": "0", "process_kernel_time": 0.375462, "process_mem_max_rss": "212140032", "process_out_blocks": "0", "process_user_time": 1.782967}
[0m13:09:42.882779 [debug] [MainThread]: Command `dbt run` failed at 13:09:42.882737 after 3.11 seconds
[0m13:09:42.883015 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x106b3f9d0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x102e7e150>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x102d208d0>]}
[0m13:09:42.883235 [debug] [MainThread]: Flushing usage events
[0m13:09:43.306704 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m13:11:01.820969 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11896f650>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1189cb550>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1189cbfd0>]}


============================== 13:11:01.824372 | 7c2560f5-5e19-4d08-a8e4-a5af7dbe0205 ==============================
[0m13:11:01.824372 [info ] [MainThread]: Running with dbt=1.9.3
[0m13:11:01.824748 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'fail_fast': 'False', 'debug': 'False', 'log_path': '/Users/timbo/Documents/DataTalks/project/src/logs', 'version_check': 'True', 'profiles_dir': '/Users/timbo/.dbt', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'empty': 'False', 'log_format': 'default', 'introspect': 'True', 'invocation_command': 'dbt run', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m13:11:02.581206 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '7c2560f5-5e19-4d08-a8e4-a5af7dbe0205', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x138e25990>]}
[0m13:11:02.609370 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '7c2560f5-5e19-4d08-a8e4-a5af7dbe0205', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1056a0790>]}
[0m13:11:02.609873 [info ] [MainThread]: Registered adapter: bigquery=1.9.1
[0m13:11:02.707665 [debug] [MainThread]: checksum: 5671c00892cdbcef29c3b00cc5ba7510c3d18a35c883caeb9ab9ee266dc29c8f, vars: {}, profile: , target: , version: 1.9.3
[0m13:11:02.826214 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m13:11:02.826673 [debug] [MainThread]: Partial parsing: updated file: eu_emissions_project://models/staging/stg_emissions_data.sql
[0m13:11:02.980411 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '7c2560f5-5e19-4d08-a8e4-a5af7dbe0205', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x13936f710>]}
[0m13:11:03.017502 [debug] [MainThread]: Wrote artifact WritableManifest to /Users/timbo/Documents/DataTalks/project/src/target/manifest.json
[0m13:11:03.020579 [debug] [MainThread]: Wrote artifact SemanticManifest to /Users/timbo/Documents/DataTalks/project/src/target/semantic_manifest.json
[0m13:11:03.035891 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '7c2560f5-5e19-4d08-a8e4-a5af7dbe0205', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1393ddcd0>]}
[0m13:11:03.036340 [info ] [MainThread]: Found 4 models, 1 source, 491 macros
[0m13:11:03.036585 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '7c2560f5-5e19-4d08-a8e4-a5af7dbe0205', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1392b1c90>]}
[0m13:11:03.037623 [info ] [MainThread]: 
[0m13:11:03.037850 [info ] [MainThread]: Concurrency: 8 threads (target='dev')
[0m13:11:03.038027 [info ] [MainThread]: 
[0m13:11:03.038317 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m13:11:03.040897 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_data-talk-clubs'
[0m13:11:03.041307 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_data-talk-clubs'
[0m13:11:03.041758 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_data-talk-clubs'
[0m13:11:03.042096 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m13:11:03.042401 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m13:11:03.042664 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m13:11:03.504352 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_data-talk-clubs, now list_data-talk-clubs_eu_emissions_project_marts)
[0m13:11:03.504755 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_data-talk-clubs, now list_data-talk-clubs_eu_emissions_project_staging)
[0m13:11:03.505187 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_data-talk-clubs, now list_data-talk-clubs_eu_emissions_project_intermediate)
[0m13:11:03.505482 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m13:11:03.505768 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m13:11:03.506006 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m13:11:03.820509 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '7c2560f5-5e19-4d08-a8e4-a5af7dbe0205', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x138ef0090>]}
[0m13:11:03.820926 [debug] [MainThread]: Opening a new connection, currently in state init
[0m13:11:03.824368 [debug] [Thread-1 (]: Began running node model.eu_emissions_project.stg_emissions_data
[0m13:11:03.824746 [info ] [Thread-1 (]: 1 of 4 START sql view model eu_emissions_project_staging.stg_emissions_data .... [RUN]
[0m13:11:03.825027 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_data-talk-clubs_eu_emissions_project_marts, now model.eu_emissions_project.stg_emissions_data)
[0m13:11:03.825230 [debug] [Thread-1 (]: Began compiling node model.eu_emissions_project.stg_emissions_data
[0m13:11:03.829873 [debug] [Thread-1 (]: Writing injected SQL for node "model.eu_emissions_project.stg_emissions_data"
[0m13:11:03.830442 [debug] [Thread-1 (]: Began executing node model.eu_emissions_project.stg_emissions_data
[0m13:11:03.845701 [debug] [Thread-1 (]: Writing runtime sql for node "model.eu_emissions_project.stg_emissions_data"
[0m13:11:03.846660 [debug] [Thread-1 (]: On model.eu_emissions_project.stg_emissions_data: /* {"app": "dbt", "dbt_version": "1.9.3", "profile_name": "big-query", "target_name": "dev", "node_id": "model.eu_emissions_project.stg_emissions_data"} */


  create or replace view `data-talk-clubs`.`eu_emissions_project_staging`.`stg_emissions_data`
  OPTIONS()
  as 

WITH source AS (
    SELECT 
        *
    FROM `data-talk-clubs`.`eu_emissions_project`.`nitrogen_dioxide_data`
),

parsed AS (
    SELECT 
        -- Split the first column which contains metadata
        freq_airpol_unit_geo_TIME_PERIOD AS metadata,
        -- Extract all the measurement columns (monthly data from 2018-01 to 2025-02)
        CAST(NULLIF(_2018_01_, ':') AS FLOAT64) AS measurement_1,
        CAST(NULLIF(_2018_02_, ':') AS FLOAT64) AS measurement_2,
        CAST(NULLIF(_2018_03_, ':') AS FLOAT64) AS measurement_3,
        CAST(NULLIF(_2018_04_, ':') AS FLOAT64) AS measurement_4,
        CAST(NULLIF(_2018_05_, ':') AS FLOAT64) AS measurement_5,
        CAST(NULLIF(_2018_06_, ':') AS FLOAT64) AS measurement_6,
        CAST(NULLIF(_2018_07_, ':') AS FLOAT64) AS measurement_7,
        CAST(NULLIF(_2018_08_, ':') AS FLOAT64) AS measurement_8,
        CAST(NULLIF(_2018_09_, ':') AS FLOAT64) AS measurement_9,
        CAST(NULLIF(_2018_10_, ':') AS FLOAT64) AS measurement_10,
        CAST(NULLIF(_2018_11_, ':') AS FLOAT64) AS measurement_11,
        CAST(NULLIF(_2018_12_, ':') AS FLOAT64) AS measurement_12,
        CAST(NULLIF(_2019_01_, ':') AS FLOAT64) AS measurement_13,
        CAST(NULLIF(_2019_02_, ':') AS FLOAT64) AS measurement_14,
        CAST(NULLIF(_2019_03_, ':') AS FLOAT64) AS measurement_15,
        CAST(NULLIF(_2019_04_, ':') AS FLOAT64) AS measurement_16,
        CAST(NULLIF(_2019_05_, ':') AS FLOAT64) AS measurement_17,
        CAST(NULLIF(_2019_06_, ':') AS FLOAT64) AS measurement_18,
        CAST(NULLIF(_2019_07_, ':') AS FLOAT64) AS measurement_19,
        CAST(NULLIF(_2019_08_, ':') AS FLOAT64) AS measurement_20,
        CAST(NULLIF(_2019_09_, ':') AS FLOAT64) AS measurement_21,
        CAST(NULLIF(_2019_10_, ':') AS FLOAT64) AS measurement_22,
        CAST(NULLIF(_2019_11_, ':') AS FLOAT64) AS measurement_23,
        CAST(NULLIF(_2019_12_, ':') AS FLOAT64) AS measurement_24,
        -- 2020
        CAST(NULLIF(_2020_01_, ':') AS FLOAT64) AS measurement_25,
        CAST(NULLIF(_2020_02_, ':') AS FLOAT64) AS measurement_26,
        CAST(NULLIF(_2020_03_, ':') AS FLOAT64) AS measurement_27,
        CAST(NULLIF(_2020_04_, ':') AS FLOAT64) AS measurement_28,
        CAST(NULLIF(_2020_05_, ':') AS FLOAT64) AS measurement_29,
        CAST(NULLIF(_2020_06_, ':') AS FLOAT64) AS measurement_30,
        CAST(NULLIF(_2020_07_, ':') AS FLOAT64) AS measurement_31,
        CAST(NULLIF(_2020_08_, ':') AS FLOAT64) AS measurement_32,
        CAST(NULLIF(_2020_09_, ':') AS FLOAT64) AS measurement_33,
        CAST(NULLIF(_2020_10_, ':') AS FLOAT64) AS measurement_34,
        CAST(NULLIF(_2020_11_, ':') AS FLOAT64) AS measurement_35,
        CAST(NULLIF(_2020_12_, ':') AS FLOAT64) AS measurement_36,
        -- 2021
        CAST(NULLIF(_2021_01_, ':') AS FLOAT64) AS measurement_37,
        CAST(NULLIF(_2021_02_, ':') AS FLOAT64) AS measurement_38,
        CAST(NULLIF(_2021_03_, ':') AS FLOAT64) AS measurement_39,
        CAST(NULLIF(_2021_04_, ':') AS FLOAT64) AS measurement_40,
        CAST(NULLIF(_2021_05_, ':') AS FLOAT64) AS measurement_41,
        CAST(NULLIF(_2021_06_, ':') AS FLOAT64) AS measurement_42,
        CAST(NULLIF(_2021_07_, ':') AS FLOAT64) AS measurement_43,
        CAST(NULLIF(_2021_08_, ':') AS FLOAT64) AS measurement_44,
        CAST(NULLIF(_2021_09_, ':') AS FLOAT64) AS measurement_45,
        CAST(NULLIF(_2021_10_, ':') AS FLOAT64) AS measurement_46,
        CAST(NULLIF(_2021_11_, ':') AS FLOAT64) AS measurement_47,
        CAST(NULLIF(_2021_12_, ':') AS FLOAT64) AS measurement_48,
        -- 2022
        CAST(NULLIF(_2022_01_, ':') AS FLOAT64) AS measurement_49,
        CAST(NULLIF(_2022_02_, ':') AS FLOAT64) AS measurement_50,
        CAST(NULLIF(_2022_03_, ':') AS FLOAT64) AS measurement_51,
        CAST(NULLIF(_2022_04_, ':') AS FLOAT64) AS measurement_52,
        CAST(NULLIF(_2022_05_, ':') AS FLOAT64) AS measurement_53,
        CAST(NULLIF(_2022_06_, ':') AS FLOAT64) AS measurement_54,
        CAST(NULLIF(_2022_07_, ':') AS FLOAT64) AS measurement_55,
        CAST(NULLIF(_2022_08_, ':') AS FLOAT64) AS measurement_56,
        CAST(NULLIF(_2022_09_, ':') AS FLOAT64) AS measurement_57,
        CAST(NULLIF(_2022_10_, ':') AS FLOAT64) AS measurement_58,
        CAST(NULLIF(_2022_11_, ':') AS FLOAT64) AS measurement_59,
        CAST(NULLIF(_2022_12_, ':') AS FLOAT64) AS measurement_60,
        -- 2023
        CAST(NULLIF(_2023_01_, ':') AS FLOAT64) AS measurement_61,
        CAST(NULLIF(_2023_02_, ':') AS FLOAT64) AS measurement_62,
        CAST(NULLIF(_2023_03_, ':') AS FLOAT64) AS measurement_63,
        CAST(NULLIF(_2023_04_, ':') AS FLOAT64) AS measurement_64,
        CAST(NULLIF(_2023_05_, ':') AS FLOAT64) AS measurement_65,
        CAST(NULLIF(_2023_06_, ':') AS FLOAT64) AS measurement_66,
        CAST(NULLIF(_2023_07_, ':') AS FLOAT64) AS measurement_67,
        CAST(NULLIF(_2023_08_, ':') AS FLOAT64) AS measurement_68,
        CAST(NULLIF(_2023_09_, ':') AS FLOAT64) AS measurement_69,
        CAST(NULLIF(_2023_10_, ':') AS FLOAT64) AS measurement_70,
        CAST(NULLIF(_2023_11_, ':') AS FLOAT64) AS measurement_71,
        CAST(NULLIF(_2023_12_, ':') AS FLOAT64) AS measurement_72,
        -- 2024
        CAST(NULLIF(_2024_01_, ':') AS FLOAT64) AS measurement_73,
        CAST(NULLIF(_2024_02_, ':') AS FLOAT64) AS measurement_74,
        CAST(NULLIF(_2024_03_, ':') AS FLOAT64) AS measurement_75,
        CAST(NULLIF(_2024_04_, ':') AS FLOAT64) AS measurement_76,
        CAST(NULLIF(_2024_05_, ':') AS FLOAT64) AS measurement_77,
        CAST(NULLIF(_2024_06_, ':') AS FLOAT64) AS measurement_78,
        CAST(NULLIF(_2024_07_, ':') AS FLOAT64) AS measurement_79,
        CAST(NULLIF(_2024_08_, ':') AS FLOAT64) AS measurement_80,
        CAST(NULLIF(_2024_09_, ':') AS FLOAT64) AS measurement_81,
        CAST(NULLIF(_2024_10_, ':') AS FLOAT64) AS measurement_82,
        CAST(NULLIF(_2024_11_, ':') AS FLOAT64) AS measurement_83,
        CAST(NULLIF(_2024_12_, ':') AS FLOAT64) AS measurement_84,
        -- 2025
        CAST(NULLIF(_2025_01_, ':') AS FLOAT64) AS measurement_85,
        CAST(NULLIF(_2025_02_, ':') AS FLOAT64) AS measurement_86,
        CURRENT_TIMESTAMP() AS load_timestamp
    FROM source
),

metadata_extracted AS (
    SELECT
        -- Extract metadata components
        SPLIT(metadata, ',')[SAFE_OFFSET(0)] AS frequency,
        SPLIT(metadata, ',')[SAFE_OFFSET(1)] AS airpol,
        SPLIT(metadata, ',')[SAFE_OFFSET(2)] AS unit,
        SPLIT(metadata, ',')[SAFE_OFFSET(3)] AS geo_code,
        -- Include all measurement columns
        measurement_1, measurement_2, measurement_3, measurement_4, measurement_5, measurement_6,
        measurement_7, measurement_8, measurement_9, measurement_10, measurement_11, measurement_12,
        measurement_13, measurement_14, measurement_15, measurement_16, measurement_17, measurement_18,
        measurement_19, measurement_20, measurement_21, measurement_22, measurement_23, measurement_24,
        measurement_25, measurement_26, measurement_27, measurement_28, measurement_29, measurement_30,
        measurement_31, measurement_32, measurement_33, measurement_34, measurement_35, measurement_36,
        measurement_37, measurement_38, measurement_39, measurement_40, measurement_41, measurement_42,
        measurement_43, measurement_44, measurement_45, measurement_46, measurement_47, measurement_48,
        measurement_49, measurement_50, measurement_51, measurement_52, measurement_53, measurement_54,
        measurement_55, measurement_56, measurement_57, measurement_58, measurement_59, measurement_60,
        measurement_61, measurement_62, measurement_63, measurement_64, measurement_65, measurement_66,
        measurement_67, measurement_68, measurement_69, measurement_70, measurement_71, measurement_72,
        measurement_73, measurement_74, measurement_75, measurement_76, measurement_77, measurement_78,
        measurement_79, measurement_80, measurement_81, measurement_82, measurement_83, measurement_84,
        measurement_85, measurement_86,
        load_timestamp
    FROM parsed
)

SELECT 
    -- Generate a unique ID
    ROW_NUMBER() OVER() AS id,
    frequency,
    airpol,
    unit,
    geo_code,
    load_timestamp,
    measurement_1, measurement_2, measurement_3, measurement_4, measurement_5, measurement_6,
    measurement_7, measurement_8, measurement_9, measurement_10, measurement_11, measurement_12,
    measurement_13, measurement_14, measurement_15, measurement_16, measurement_17, measurement_18,
    measurement_19, measurement_20, measurement_21, measurement_22, measurement_23, measurement_24,
    measurement_25, measurement_26, measurement_27, measurement_28, measurement_29, measurement_30,
    measurement_31, measurement_32, measurement_33, measurement_34, measurement_35, measurement_36,
    measurement_37, measurement_38, measurement_39, measurement_40, measurement_41, measurement_42,
    measurement_43, measurement_44, measurement_45, measurement_46, measurement_47, measurement_48,
    measurement_49, measurement_50, measurement_51, measurement_52, measurement_53, measurement_54,
    measurement_55, measurement_56, measurement_57, measurement_58, measurement_59, measurement_60,
    measurement_61, measurement_62, measurement_63, measurement_64, measurement_65, measurement_66,
    measurement_67, measurement_68, measurement_69, measurement_70, measurement_71, measurement_72,
    measurement_73, measurement_74, measurement_75, measurement_76, measurement_77, measurement_78,
    measurement_79, measurement_80, measurement_81, measurement_82, measurement_83, measurement_84,
    measurement_85, measurement_86
FROM metadata_extracted;


[0m13:11:03.847216 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m13:11:04.466969 [debug] [Thread-1 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=data-talk-clubs&j=bq:EU:229220a5-18b6-4d1c-adef-56d309298eae&page=queryresults
[0m13:11:04.559805 [error] [Thread-1 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=data-talk-clubs&j=bq:EU:229220a5-18b6-4d1c-adef-56d309298eae&page=queryresults
[0m13:11:04.566372 [debug] [Thread-1 (]: Database Error in model stg_emissions_data (models/staging/stg_emissions_data.sql)
  No matching signature for function NULLIF
    Argument types: FLOAT64, STRING
    Signature: NULLIF(T1, T1)
      Unable to find common supertype for templated argument <T1>
        Input types for <T1>: {DOUBLE, STRING} at [19:14]
  compiled code at target/run/eu_emissions_project/models/staging/stg_emissions_data.sql
[0m13:11:04.567813 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7c2560f5-5e19-4d08-a8e4-a5af7dbe0205', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x13986e7d0>]}
[0m13:11:04.568331 [error] [Thread-1 (]: 1 of 4 ERROR creating sql view model eu_emissions_project_staging.stg_emissions_data  [[31mERROR[0m in 0.74s]
[0m13:11:04.568673 [debug] [Thread-1 (]: Finished running node model.eu_emissions_project.stg_emissions_data
[0m13:11:04.569007 [debug] [Thread-11 ]: Marking all children of 'model.eu_emissions_project.stg_emissions_data' to be skipped because of status 'error'.  Reason: Database Error in model stg_emissions_data (models/staging/stg_emissions_data.sql)
  No matching signature for function NULLIF
    Argument types: FLOAT64, STRING
    Signature: NULLIF(T1, T1)
      Unable to find common supertype for templated argument <T1>
        Input types for <T1>: {DOUBLE, STRING} at [19:14]
  compiled code at target/run/eu_emissions_project/models/staging/stg_emissions_data.sql.
[0m13:11:04.569818 [debug] [Thread-3 (]: Began running node model.eu_emissions_project.int_emissions_cleaned
[0m13:11:04.570045 [debug] [Thread-4 (]: Began running node model.eu_emissions_project.int_emissions_unpivoted
[0m13:11:04.570317 [info ] [Thread-3 (]: 2 of 4 SKIP relation eu_emissions_project_intermediate.int_emissions_cleaned ... [[33mSKIP[0m]
[0m13:11:04.570559 [info ] [Thread-4 (]: 3 of 4 SKIP relation eu_emissions_project_intermediate.int_emissions_unpivoted . [[33mSKIP[0m]
[0m13:11:04.570830 [debug] [Thread-3 (]: Finished running node model.eu_emissions_project.int_emissions_cleaned
[0m13:11:04.571079 [debug] [Thread-4 (]: Finished running node model.eu_emissions_project.int_emissions_unpivoted
[0m13:11:04.571519 [debug] [Thread-6 (]: Began running node model.eu_emissions_project.emissions_analysis
[0m13:11:04.571865 [info ] [Thread-6 (]: 4 of 4 SKIP relation eu_emissions_project_marts.emissions_analysis ............. [[33mSKIP[0m]
[0m13:11:04.572182 [debug] [Thread-6 (]: Finished running node model.eu_emissions_project.emissions_analysis
[0m13:11:04.572979 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m13:11:04.573965 [debug] [MainThread]: Connection 'master' was properly closed.
[0m13:11:04.574189 [debug] [MainThread]: Connection 'model.eu_emissions_project.stg_emissions_data' was properly closed.
[0m13:11:04.574362 [debug] [MainThread]: Connection 'list_data-talk-clubs_eu_emissions_project_staging' was properly closed.
[0m13:11:04.574520 [debug] [MainThread]: Connection 'list_data-talk-clubs_eu_emissions_project_intermediate' was properly closed.
[0m13:11:04.574736 [info ] [MainThread]: 
[0m13:11:04.574927 [info ] [MainThread]: Finished running 2 table models, 2 view models in 0 hours 0 minutes and 1.54 seconds (1.54s).
[0m13:11:04.575304 [debug] [MainThread]: Command end result
[0m13:11:04.588403 [debug] [MainThread]: Wrote artifact WritableManifest to /Users/timbo/Documents/DataTalks/project/src/target/manifest.json
[0m13:11:04.589296 [debug] [MainThread]: Wrote artifact SemanticManifest to /Users/timbo/Documents/DataTalks/project/src/target/semantic_manifest.json
[0m13:11:04.591922 [debug] [MainThread]: Wrote artifact RunExecutionResult to /Users/timbo/Documents/DataTalks/project/src/target/run_results.json
[0m13:11:04.592117 [info ] [MainThread]: 
[0m13:11:04.592323 [info ] [MainThread]: [31mCompleted with 1 error, 0 partial successes, and 0 warnings:[0m
[0m13:11:04.592519 [info ] [MainThread]: 
[0m13:11:04.592744 [error] [MainThread]:   Database Error in model stg_emissions_data (models/staging/stg_emissions_data.sql)
  No matching signature for function NULLIF
    Argument types: FLOAT64, STRING
    Signature: NULLIF(T1, T1)
      Unable to find common supertype for templated argument <T1>
        Input types for <T1>: {DOUBLE, STRING} at [19:14]
  compiled code at target/run/eu_emissions_project/models/staging/stg_emissions_data.sql
[0m13:11:04.593103 [info ] [MainThread]: 
[0m13:11:04.593343 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=3 TOTAL=4
[0m13:11:04.594939 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": false, "command_wall_clock_time": 2.811743, "process_in_blocks": "0", "process_kernel_time": 0.378652, "process_mem_max_rss": "211025920", "process_out_blocks": "0", "process_user_time": 1.764277}
[0m13:11:04.595238 [debug] [MainThread]: Command `dbt run` failed at 13:11:04.595192 after 2.81 seconds
[0m13:11:04.595480 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x102f92150>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1189c3550>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1189c2ad0>]}
[0m13:11:04.595714 [debug] [MainThread]: Flushing usage events
[0m13:11:05.019693 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m13:33:16.435724 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10796dd90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1079c9950>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1079cbfd0>]}


============================== 13:33:16.439296 | e99477aa-e4ef-4496-92f5-3f689c991a3c ==============================
[0m13:33:16.439296 [info ] [MainThread]: Running with dbt=1.9.3
[0m13:33:16.439849 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'version_check': 'True', 'fail_fast': 'False', 'log_path': '/Users/timbo/Documents/DataTalks/project/src/logs', 'debug': 'False', 'profiles_dir': '/Users/timbo/.dbt', 'use_colors': 'True', 'use_experimental_parser': 'False', 'empty': 'False', 'quiet': 'False', 'no_print': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt run', 'static_parser': 'True', 'introspect': 'True', 'target_path': 'None', 'log_format': 'default', 'send_anonymous_usage_stats': 'True'}
[0m13:33:17.236157 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'e99477aa-e4ef-4496-92f5-3f689c991a3c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ecbc9d0>]}
[0m13:33:17.263665 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'e99477aa-e4ef-4496-92f5-3f689c991a3c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1050a0550>]}
[0m13:33:17.264166 [info ] [MainThread]: Registered adapter: bigquery=1.9.1
[0m13:33:17.363684 [debug] [MainThread]: checksum: 5671c00892cdbcef29c3b00cc5ba7510c3d18a35c883caeb9ab9ee266dc29c8f, vars: {}, profile: , target: , version: 1.9.3
[0m13:33:17.503045 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m13:33:17.503529 [debug] [MainThread]: Partial parsing: updated file: eu_emissions_project://models/staging/stg_emissions_data.sql
[0m13:33:17.668808 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'e99477aa-e4ef-4496-92f5-3f689c991a3c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10f71ddd0>]}
[0m13:33:17.713578 [debug] [MainThread]: Wrote artifact WritableManifest to /Users/timbo/Documents/DataTalks/project/src/target/manifest.json
[0m13:33:17.715821 [debug] [MainThread]: Wrote artifact SemanticManifest to /Users/timbo/Documents/DataTalks/project/src/target/semantic_manifest.json
[0m13:33:17.730404 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'e99477aa-e4ef-4496-92f5-3f689c991a3c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10fbfa4d0>]}
[0m13:33:17.730791 [info ] [MainThread]: Found 4 models, 1 source, 491 macros
[0m13:33:17.731020 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'e99477aa-e4ef-4496-92f5-3f689c991a3c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10fbdd3d0>]}
[0m13:33:17.731966 [info ] [MainThread]: 
[0m13:33:17.732188 [info ] [MainThread]: Concurrency: 8 threads (target='dev')
[0m13:33:17.732369 [info ] [MainThread]: 
[0m13:33:17.732649 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m13:33:17.734794 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_data-talk-clubs'
[0m13:33:17.735084 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_data-talk-clubs'
[0m13:33:17.735363 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_data-talk-clubs'
[0m13:33:17.736988 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m13:33:17.737183 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m13:33:17.737460 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m13:33:18.306388 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_data-talk-clubs, now list_data-talk-clubs_eu_emissions_project_staging)
[0m13:33:18.306896 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_data-talk-clubs, now list_data-talk-clubs_eu_emissions_project_marts)
[0m13:33:18.307207 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_data-talk-clubs, now list_data-talk-clubs_eu_emissions_project_intermediate)
[0m13:33:18.307449 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m13:33:18.307827 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m13:33:18.308046 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m13:33:18.698494 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'e99477aa-e4ef-4496-92f5-3f689c991a3c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10fc66750>]}
[0m13:33:18.699027 [debug] [MainThread]: Opening a new connection, currently in state init
[0m13:33:18.701536 [debug] [Thread-1 (]: Began running node model.eu_emissions_project.stg_emissions_data
[0m13:33:18.701980 [info ] [Thread-1 (]: 1 of 4 START sql view model eu_emissions_project_staging.stg_emissions_data .... [RUN]
[0m13:33:18.702342 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_data-talk-clubs_eu_emissions_project_staging, now model.eu_emissions_project.stg_emissions_data)
[0m13:33:18.702576 [debug] [Thread-1 (]: Began compiling node model.eu_emissions_project.stg_emissions_data
[0m13:33:18.706827 [debug] [Thread-1 (]: Writing injected SQL for node "model.eu_emissions_project.stg_emissions_data"
[0m13:33:18.707642 [debug] [Thread-1 (]: Began executing node model.eu_emissions_project.stg_emissions_data
[0m13:33:18.723026 [debug] [Thread-1 (]: Writing runtime sql for node "model.eu_emissions_project.stg_emissions_data"
[0m13:33:18.723739 [debug] [Thread-1 (]: On model.eu_emissions_project.stg_emissions_data: /* {"app": "dbt", "dbt_version": "1.9.3", "profile_name": "big-query", "target_name": "dev", "node_id": "model.eu_emissions_project.stg_emissions_data"} */


  create or replace view `data-talk-clubs`.`eu_emissions_project_staging`.`stg_emissions_data`
  OPTIONS()
  as 

WITH source AS (
    SELECT 
        *
    FROM `data-talk-clubs`.`eu_emissions_project`.`nitrogen_dioxide_data`
),

unpivoted AS (
    SELECT
        freq_airpol_unit_geo_TIME_PERIOD AS metadata,
        date_column,
        measurement_value
    FROM source
    UNPIVOT(
        measurement_value FOR date_column IN (
            _2018_01_, _2018_02_, _2018_03_, _2018_04_, _2018_05_, _2018_06_,
            _2018_07_, _2018_08_, _2018_09_, _2018_10_, _2018_11_, _2018_12_,
            _2019_01_, _2019_02_, _2019_03_, _2019_04_, _2019_05_, _2019_06_,
            _2019_07_, _2019_08_, _2019_09_, _2019_10_, _2019_11_, _2019_12_,
            _2020_01_, _2020_02_, _2020_03_, _2020_04_, _2020_05_, _2020_06_,
            _2020_07_, _2020_08_, _2020_09_, _2020_10_, _2020_11_, _2020_12_,
            _2021_01_, _2021_02_, _2021_03_, _2021_04_, _2021_05_, _2021_06_,
            _2021_07_, _2021_08_, _2021_09_, _2021_10_, _2021_11_, _2021_12_,
            _2022_01_, _2022_02_, _2022_03_, _2022_04_, _2022_05_, _2022_06_,
            _2022_07_, _2022_08_, _2022_09_, _2022_10_, _2022_11_, _2022_12_,
            _2023_01_, _2023_02_, _2023_03_, _2023_04_, _2023_05_, _2023_06_,
            _2023_07_, _2023_08_, _2023_09_, _2023_10_, _2023_11_, _2023_12_,
            _2024_01_, _2024_02_, _2024_03_, _2024_04_, _2024_05_, _2024_06_,
            _2024_07_, _2024_08_, _2024_09_, _2024_10_, _2024_11_, _2024_12_,
            _2025_01_, _2025_02_
        )
    )
),

date_transformed AS (
    SELECT
        metadata,
        -- Convert column name to date (remove leading/trailing underscores and convert to date)
        DATE(CONCAT(
            SUBSTR(REPLACE(date_column, '_', ''), 1, 4), '-',
            SUBSTR(REPLACE(date_column, '_', ''), 5, 2), '-01'
        )) AS measurement_date,
        CAST(measurement_value AS FLOAT64) AS measurement_value,
        CURRENT_TIMESTAMP() AS load_timestamp
    FROM unpivoted
    WHERE measurement_value IS NOT NULL AND measurement_value != ':'
),

metadata_extracted AS (
    SELECT
        -- Extract metadata components
        SPLIT(metadata, ',')[SAFE_OFFSET(0)] AS frequency,
        SPLIT(metadata, ',')[SAFE_OFFSET(1)] AS airpol,
        SPLIT(metadata, ',')[SAFE_OFFSET(2)] AS unit,
        SPLIT(metadata, ',')[SAFE_OFFSET(3)] AS geo_code,
        measurement_date,
        measurement_value,
        load_timestamp
    FROM date_transformed
)

SELECT
    ROW_NUMBER() OVER() AS id,
    frequency,
    airpol,
    unit,
    geo_code,
    measurement_date,
    measurement_value,
    load_timestamp
FROM metadata_extracted;


[0m13:33:18.724081 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m13:33:19.290908 [debug] [Thread-1 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=data-talk-clubs&j=bq:EU:9389e5fb-6f99-4f4d-b836-9f9349f06f2a&page=queryresults
[0m13:33:19.477509 [error] [Thread-1 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=data-talk-clubs&j=bq:EU:9389e5fb-6f99-4f4d-b836-9f9349f06f2a&page=queryresults
[0m13:33:19.486582 [debug] [Thread-1 (]: Database Error in model stg_emissions_data (models/staging/stg_emissions_data.sql)
  The datatype of column does not match with other datatypes in the IN clause. Expected FLOAT64, Found STRING at [22:57]
  compiled code at target/run/eu_emissions_project/models/staging/stg_emissions_data.sql
[0m13:33:19.488021 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e99477aa-e4ef-4496-92f5-3f689c991a3c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ff6ec90>]}
[0m13:33:19.488514 [error] [Thread-1 (]: 1 of 4 ERROR creating sql view model eu_emissions_project_staging.stg_emissions_data  [[31mERROR[0m in 0.78s]
[0m13:33:19.488857 [debug] [Thread-1 (]: Finished running node model.eu_emissions_project.stg_emissions_data
[0m13:33:19.489310 [debug] [Thread-11 ]: Marking all children of 'model.eu_emissions_project.stg_emissions_data' to be skipped because of status 'error'.  Reason: Database Error in model stg_emissions_data (models/staging/stg_emissions_data.sql)
  The datatype of column does not match with other datatypes in the IN clause. Expected FLOAT64, Found STRING at [22:57]
  compiled code at target/run/eu_emissions_project/models/staging/stg_emissions_data.sql.
[0m13:33:19.490214 [debug] [Thread-3 (]: Began running node model.eu_emissions_project.int_emissions_cleaned
[0m13:33:19.490686 [debug] [Thread-4 (]: Began running node model.eu_emissions_project.int_emissions_unpivoted
[0m13:33:19.490944 [info ] [Thread-3 (]: 2 of 4 SKIP relation eu_emissions_project_intermediate.int_emissions_cleaned ... [[33mSKIP[0m]
[0m13:33:19.491274 [info ] [Thread-4 (]: 3 of 4 SKIP relation eu_emissions_project_intermediate.int_emissions_unpivoted . [[33mSKIP[0m]
[0m13:33:19.491596 [debug] [Thread-3 (]: Finished running node model.eu_emissions_project.int_emissions_cleaned
[0m13:33:19.491899 [debug] [Thread-4 (]: Finished running node model.eu_emissions_project.int_emissions_unpivoted
[0m13:33:19.492437 [debug] [Thread-6 (]: Began running node model.eu_emissions_project.emissions_analysis
[0m13:33:19.492704 [info ] [Thread-6 (]: 4 of 4 SKIP relation eu_emissions_project_marts.emissions_analysis ............. [[33mSKIP[0m]
[0m13:33:19.492950 [debug] [Thread-6 (]: Finished running node model.eu_emissions_project.emissions_analysis
[0m13:33:19.494095 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m13:33:19.495083 [debug] [MainThread]: Connection 'master' was properly closed.
[0m13:33:19.495284 [debug] [MainThread]: Connection 'model.eu_emissions_project.stg_emissions_data' was properly closed.
[0m13:33:19.495455 [debug] [MainThread]: Connection 'list_data-talk-clubs_eu_emissions_project_marts' was properly closed.
[0m13:33:19.495615 [debug] [MainThread]: Connection 'list_data-talk-clubs_eu_emissions_project_intermediate' was properly closed.
[0m13:33:19.495838 [info ] [MainThread]: 
[0m13:33:19.496034 [info ] [MainThread]: Finished running 2 table models, 2 view models in 0 hours 0 minutes and 1.76 seconds (1.76s).
[0m13:33:19.496410 [debug] [MainThread]: Command end result
[0m13:33:19.510354 [debug] [MainThread]: Wrote artifact WritableManifest to /Users/timbo/Documents/DataTalks/project/src/target/manifest.json
[0m13:33:19.511414 [debug] [MainThread]: Wrote artifact SemanticManifest to /Users/timbo/Documents/DataTalks/project/src/target/semantic_manifest.json
[0m13:33:19.514122 [debug] [MainThread]: Wrote artifact RunExecutionResult to /Users/timbo/Documents/DataTalks/project/src/target/run_results.json
[0m13:33:19.514335 [info ] [MainThread]: 
[0m13:33:19.514557 [info ] [MainThread]: [31mCompleted with 1 error, 0 partial successes, and 0 warnings:[0m
[0m13:33:19.514740 [info ] [MainThread]: 
[0m13:33:19.514954 [error] [MainThread]:   Database Error in model stg_emissions_data (models/staging/stg_emissions_data.sql)
  The datatype of column does not match with other datatypes in the IN clause. Expected FLOAT64, Found STRING at [22:57]
  compiled code at target/run/eu_emissions_project/models/staging/stg_emissions_data.sql
[0m13:33:19.515136 [info ] [MainThread]: 
[0m13:33:19.515319 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=3 TOTAL=4
[0m13:33:19.517001 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": false, "command_wall_clock_time": 3.1203294, "process_in_blocks": "0", "process_kernel_time": 0.38841, "process_mem_max_rss": "211763200", "process_out_blocks": "0", "process_user_time": 1.799044}
[0m13:33:19.517333 [debug] [MainThread]: Command `dbt run` failed at 13:33:19.517289 after 3.12 seconds
[0m13:33:19.517573 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x102a4e010>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1079ca990>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1079cacd0>]}
[0m13:33:19.517792 [debug] [MainThread]: Flushing usage events
[0m13:33:19.933553 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m13:35:27.434492 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10496d910>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1049cb750>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1049cbf90>]}


============================== 13:35:27.437724 | 8569de2b-4074-4283-93bc-71eb92735fc2 ==============================
[0m13:35:27.437724 [info ] [MainThread]: Running with dbt=1.9.3
[0m13:35:27.438139 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'version_check': 'True', 'profiles_dir': '/Users/timbo/.dbt', 'log_path': '/Users/timbo/Documents/DataTalks/project/src/logs', 'fail_fast': 'False', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'empty': 'False', 'log_format': 'default', 'static_parser': 'True', 'introspect': 'True', 'invocation_command': 'dbt run', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m13:35:28.224529 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '8569de2b-4074-4283-93bc-71eb92735fc2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10c235750>]}
[0m13:35:28.252357 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '8569de2b-4074-4283-93bc-71eb92735fc2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x102408810>]}
[0m13:35:28.252868 [info ] [MainThread]: Registered adapter: bigquery=1.9.1
[0m13:35:28.349576 [debug] [MainThread]: checksum: 5671c00892cdbcef29c3b00cc5ba7510c3d18a35c883caeb9ab9ee266dc29c8f, vars: {}, profile: , target: , version: 1.9.3
[0m13:35:28.494557 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m13:35:28.495014 [debug] [MainThread]: Partial parsing: updated file: eu_emissions_project://models/staging/stg_emissions_data.sql
[0m13:35:28.654878 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '8569de2b-4074-4283-93bc-71eb92735fc2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10c798450>]}
[0m13:35:28.692079 [debug] [MainThread]: Wrote artifact WritableManifest to /Users/timbo/Documents/DataTalks/project/src/target/manifest.json
[0m13:35:28.694456 [debug] [MainThread]: Wrote artifact SemanticManifest to /Users/timbo/Documents/DataTalks/project/src/target/semantic_manifest.json
[0m13:35:28.709201 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '8569de2b-4074-4283-93bc-71eb92735fc2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10c7bbc90>]}
[0m13:35:28.709584 [info ] [MainThread]: Found 4 models, 1 source, 491 macros
[0m13:35:28.709801 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '8569de2b-4074-4283-93bc-71eb92735fc2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10c7faf50>]}
[0m13:35:28.710762 [info ] [MainThread]: 
[0m13:35:28.710971 [info ] [MainThread]: Concurrency: 8 threads (target='dev')
[0m13:35:28.711141 [info ] [MainThread]: 
[0m13:35:28.711421 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m13:35:28.713641 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_data-talk-clubs'
[0m13:35:28.714055 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_data-talk-clubs'
[0m13:35:28.714371 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m13:35:28.714665 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_data-talk-clubs'
[0m13:35:28.715006 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m13:35:28.751829 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m13:35:29.837224 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_data-talk-clubs, now list_data-talk-clubs_eu_emissions_project_intermediate)
[0m13:35:29.837728 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_data-talk-clubs, now list_data-talk-clubs_eu_emissions_project_marts)
[0m13:35:29.838175 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_data-talk-clubs, now list_data-talk-clubs_eu_emissions_project_staging)
[0m13:35:29.838442 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m13:35:29.838681 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m13:35:29.838924 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m13:35:30.872109 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '8569de2b-4074-4283-93bc-71eb92735fc2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x102411bd0>]}
[0m13:35:30.872587 [debug] [MainThread]: Opening a new connection, currently in state init
[0m13:35:30.875124 [debug] [Thread-1 (]: Began running node model.eu_emissions_project.stg_emissions_data
[0m13:35:30.875509 [info ] [Thread-1 (]: 1 of 4 START sql view model eu_emissions_project_staging.stg_emissions_data .... [RUN]
[0m13:35:30.875835 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_data-talk-clubs_eu_emissions_project_intermediate, now model.eu_emissions_project.stg_emissions_data)
[0m13:35:30.876063 [debug] [Thread-1 (]: Began compiling node model.eu_emissions_project.stg_emissions_data
[0m13:35:30.880603 [debug] [Thread-1 (]: Writing injected SQL for node "model.eu_emissions_project.stg_emissions_data"
[0m13:35:30.881435 [debug] [Thread-1 (]: Began executing node model.eu_emissions_project.stg_emissions_data
[0m13:35:30.896338 [debug] [Thread-1 (]: Writing runtime sql for node "model.eu_emissions_project.stg_emissions_data"
[0m13:35:30.897043 [debug] [Thread-1 (]: On model.eu_emissions_project.stg_emissions_data: /* {"app": "dbt", "dbt_version": "1.9.3", "profile_name": "big-query", "target_name": "dev", "node_id": "model.eu_emissions_project.stg_emissions_data"} */


  create or replace view `data-talk-clubs`.`eu_emissions_project_staging`.`stg_emissions_data`
  OPTIONS()
  as 

WITH source AS (
    SELECT 
        *
    FROM `data-talk-clubs`.`eu_emissions_project`.`nitrogen_dioxide_data`
),

unpivoted AS (
    SELECT
        freq_airpol_unit_geo_TIME_PERIOD AS metadata,
        date_column,
        measurement_value
    FROM source
    UNPIVOT(
        measurement_value FOR date_column IN (
            _2018_01_, _2018_02_, _2018_03_, _2018_04_, _2018_05_, _2018_06_,
            _2018_07_, _2018_08_, _2018_09_, _2018_10_, _2018_11_, _2018_12_,
            _2019_01_, _2019_02_, _2019_03_, _2019_04_, _2019_05_, _2019_06_,
            _2019_07_, _2019_08_, _2019_09_, _2019_10_, _2019_11_, _2019_12_,
            _2020_01_, _2020_02_, _2020_03_, _2020_04_, _2020_05_, _2020_06_,
            _2020_07_, _2020_08_, _2020_09_, _2020_10_, _2020_11_, _2020_12_,
            _2021_01_, _2021_02_, _2021_03_, _2021_04_, _2021_05_, _2021_06_,
            _2021_07_, _2021_08_, _2021_09_, _2021_10_, _2021_11_, _2021_12_,
            _2022_01_, _2022_02_, _2022_03_, _2022_04_, _2022_05_, _2022_06_,
            _2022_07_, _2022_08_, _2022_09_, _2022_10_, _2022_11_, _2022_12_,
            _2023_01_, _2023_02_, _2023_03_, _2023_04_, _2023_05_, _2023_06_,
            _2023_07_, _2023_08_, _2023_09_, _2023_10_, _2023_11_, _2023_12_,
            _2024_01_, _2024_02_, _2024_03_, _2024_04_, _2024_05_, _2024_06_,
            _2024_07_, _2024_08_, _2024_09_, _2024_10_, _2024_11_, _2024_12_,
            _2025_01_, _2025_02_
        )
    )
),

date_transformed AS (
    SELECT
        metadata,
        -- Convert column name to date (remove leading/trailing underscores and convert to date)
        DATE(CONCAT(
            SUBSTR(REPLACE(date_column, '_', ''), 1, 4), '-',
            SUBSTR(REPLACE(date_column, '_', ''), 5, 2), '-01'
        )) AS measurement_date,
        -- Handle colon values by converting them to NULL before casting to FLOAT64
        CASE 
            WHEN measurement_value = ':' THEN NULL
            ELSE SAFE_CAST(measurement_value AS FLOAT64)
        END AS measurement_value,
        CURRENT_TIMESTAMP() AS load_timestamp
    FROM unpivoted
    -- Filter out NULL values but keep rows where the value was a colon (now NULL)
    WHERE measurement_value IS NOT NULL OR measurement_value = ':'
),

metadata_extracted AS (
    SELECT
        -- Extract metadata components
        SPLIT(metadata, ',')[SAFE_OFFSET(0)] AS frequency,
        SPLIT(metadata, ',')[SAFE_OFFSET(1)] AS airpol,
        SPLIT(metadata, ',')[SAFE_OFFSET(2)] AS unit,
        SPLIT(metadata, ',')[SAFE_OFFSET(3)] AS geo_code,
        measurement_date,
        measurement_value,
        load_timestamp
    FROM date_transformed
)

SELECT
    ROW_NUMBER() OVER() AS id,
    frequency,
    airpol,
    unit,
    geo_code,
    measurement_date,
    measurement_value,
    load_timestamp
FROM metadata_extracted;


[0m13:35:30.897395 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m13:35:31.476601 [debug] [Thread-1 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=data-talk-clubs&j=bq:EU:9e678b1c-0b3d-4694-9529-f504ebea0e90&page=queryresults
[0m13:35:31.572713 [error] [Thread-1 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=data-talk-clubs&j=bq:EU:9e678b1c-0b3d-4694-9529-f504ebea0e90&page=queryresults
[0m13:35:31.583160 [debug] [Thread-1 (]: Database Error in model stg_emissions_data (models/staging/stg_emissions_data.sql)
  The datatype of column does not match with other datatypes in the IN clause. Expected FLOAT64, Found STRING at [22:57]
  compiled code at target/run/eu_emissions_project/models/staging/stg_emissions_data.sql
[0m13:35:31.584458 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '8569de2b-4074-4283-93bc-71eb92735fc2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10c7dff50>]}
[0m13:35:31.584895 [error] [Thread-1 (]: 1 of 4 ERROR creating sql view model eu_emissions_project_staging.stg_emissions_data  [[31mERROR[0m in 0.71s]
[0m13:35:31.585320 [debug] [Thread-1 (]: Finished running node model.eu_emissions_project.stg_emissions_data
[0m13:35:31.585721 [debug] [Thread-11 ]: Marking all children of 'model.eu_emissions_project.stg_emissions_data' to be skipped because of status 'error'.  Reason: Database Error in model stg_emissions_data (models/staging/stg_emissions_data.sql)
  The datatype of column does not match with other datatypes in the IN clause. Expected FLOAT64, Found STRING at [22:57]
  compiled code at target/run/eu_emissions_project/models/staging/stg_emissions_data.sql.
[0m13:35:31.586537 [debug] [Thread-3 (]: Began running node model.eu_emissions_project.int_emissions_cleaned
[0m13:35:31.586785 [debug] [Thread-4 (]: Began running node model.eu_emissions_project.int_emissions_unpivoted
[0m13:35:31.587073 [info ] [Thread-3 (]: 2 of 4 SKIP relation eu_emissions_project_intermediate.int_emissions_cleaned ... [[33mSKIP[0m]
[0m13:35:31.587358 [info ] [Thread-4 (]: 3 of 4 SKIP relation eu_emissions_project_intermediate.int_emissions_unpivoted . [[33mSKIP[0m]
[0m13:35:31.587644 [debug] [Thread-3 (]: Finished running node model.eu_emissions_project.int_emissions_cleaned
[0m13:35:31.587883 [debug] [Thread-4 (]: Finished running node model.eu_emissions_project.int_emissions_unpivoted
[0m13:35:31.588293 [debug] [Thread-6 (]: Began running node model.eu_emissions_project.emissions_analysis
[0m13:35:31.588543 [info ] [Thread-6 (]: 4 of 4 SKIP relation eu_emissions_project_marts.emissions_analysis ............. [[33mSKIP[0m]
[0m13:35:31.588778 [debug] [Thread-6 (]: Finished running node model.eu_emissions_project.emissions_analysis
[0m13:35:31.589545 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m13:35:31.590514 [debug] [MainThread]: Connection 'master' was properly closed.
[0m13:35:31.590744 [debug] [MainThread]: Connection 'model.eu_emissions_project.stg_emissions_data' was properly closed.
[0m13:35:31.590943 [debug] [MainThread]: Connection 'list_data-talk-clubs_eu_emissions_project_marts' was properly closed.
[0m13:35:31.591177 [debug] [MainThread]: Connection 'list_data-talk-clubs_eu_emissions_project_staging' was properly closed.
[0m13:35:31.591581 [info ] [MainThread]: 
[0m13:35:31.591809 [info ] [MainThread]: Finished running 2 table models, 2 view models in 0 hours 0 minutes and 2.88 seconds (2.88s).
[0m13:35:31.592205 [debug] [MainThread]: Command end result
[0m13:35:31.605763 [debug] [MainThread]: Wrote artifact WritableManifest to /Users/timbo/Documents/DataTalks/project/src/target/manifest.json
[0m13:35:31.606666 [debug] [MainThread]: Wrote artifact SemanticManifest to /Users/timbo/Documents/DataTalks/project/src/target/semantic_manifest.json
[0m13:35:31.609820 [debug] [MainThread]: Wrote artifact RunExecutionResult to /Users/timbo/Documents/DataTalks/project/src/target/run_results.json
[0m13:35:31.610090 [info ] [MainThread]: 
[0m13:35:31.610320 [info ] [MainThread]: [31mCompleted with 1 error, 0 partial successes, and 0 warnings:[0m
[0m13:35:31.610512 [info ] [MainThread]: 
[0m13:35:31.610795 [error] [MainThread]:   Database Error in model stg_emissions_data (models/staging/stg_emissions_data.sql)
  The datatype of column does not match with other datatypes in the IN clause. Expected FLOAT64, Found STRING at [22:57]
  compiled code at target/run/eu_emissions_project/models/staging/stg_emissions_data.sql
[0m13:35:31.611016 [info ] [MainThread]: 
[0m13:35:31.611209 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=3 TOTAL=4
[0m13:35:31.612800 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": false, "command_wall_clock_time": 4.217181, "process_in_blocks": "0", "process_kernel_time": 0.38407, "process_mem_max_rss": "211746816", "process_out_blocks": "0", "process_user_time": 1.803664}
[0m13:35:31.613134 [debug] [MainThread]: Command `dbt run` failed at 13:35:31.613090 after 4.22 seconds
[0m13:35:31.613398 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1049c2b10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1006fa150>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1049eff90>]}
[0m13:35:31.613665 [debug] [MainThread]: Flushing usage events
[0m13:35:32.045620 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m14:01:39.838832 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x12686ec90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1268caf10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1268cbd10>]}


============================== 14:01:39.842424 | 626655c7-38c5-48d9-af31-ca603ecbf99a ==============================
[0m14:01:39.842424 [info ] [MainThread]: Running with dbt=1.9.3
[0m14:01:39.842853 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': '/Users/timbo/.dbt', 'fail_fast': 'False', 'debug': 'False', 'log_path': '/Users/timbo/Documents/DataTalks/project/src/logs', 'version_check': 'True', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'empty': 'False', 'quiet': 'False', 'no_print': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'log_format': 'default', 'static_parser': 'True', 'target_path': 'None', 'invocation_command': 'dbt run', 'send_anonymous_usage_stats': 'True'}
[0m14:01:40.607343 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '626655c7-38c5-48d9-af31-ca603ecbf99a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x15d144690>]}
[0m14:01:40.634428 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '626655c7-38c5-48d9-af31-ca603ecbf99a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1202a0fd0>]}
[0m14:01:40.634897 [info ] [MainThread]: Registered adapter: bigquery=1.9.1
[0m14:01:40.729461 [debug] [MainThread]: checksum: 5671c00892cdbcef29c3b00cc5ba7510c3d18a35c883caeb9ab9ee266dc29c8f, vars: {}, profile: , target: , version: 1.9.3
[0m14:01:40.847434 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m14:01:40.847945 [debug] [MainThread]: Partial parsing: updated file: eu_emissions_project://models/staging/stg_emissions_data.sql
[0m14:01:41.004491 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '626655c7-38c5-48d9-af31-ca603ecbf99a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x160babc50>]}
[0m14:01:41.041702 [debug] [MainThread]: Wrote artifact WritableManifest to /Users/timbo/Documents/DataTalks/project/src/target/manifest.json
[0m14:01:41.044015 [debug] [MainThread]: Wrote artifact SemanticManifest to /Users/timbo/Documents/DataTalks/project/src/target/semantic_manifest.json
[0m14:01:41.056612 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '626655c7-38c5-48d9-af31-ca603ecbf99a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x160beea90>]}
[0m14:01:41.056992 [info ] [MainThread]: Found 4 models, 1 source, 491 macros
[0m14:01:41.057208 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '626655c7-38c5-48d9-af31-ca603ecbf99a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x160bbab10>]}
[0m14:01:41.058129 [info ] [MainThread]: 
[0m14:01:41.058354 [info ] [MainThread]: Concurrency: 8 threads (target='dev')
[0m14:01:41.058522 [info ] [MainThread]: 
[0m14:01:41.058799 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m14:01:41.060851 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_data-talk-clubs'
[0m14:01:41.061221 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_data-talk-clubs'
[0m14:01:41.061517 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m14:01:41.061857 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_data-talk-clubs'
[0m14:01:41.062123 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m14:01:41.062409 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m14:01:41.562389 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_data-talk-clubs, now list_data-talk-clubs_eu_emissions_project_marts)
[0m14:01:41.563305 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_data-talk-clubs, now list_data-talk-clubs_eu_emissions_project_staging)
[0m14:01:41.564136 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_data-talk-clubs, now list_data-talk-clubs_eu_emissions_project_intermediate)
[0m14:01:41.564585 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m14:01:41.564896 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m14:01:41.565103 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m14:01:41.851432 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '626655c7-38c5-48d9-af31-ca603ecbf99a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x15d5aef50>]}
[0m14:01:41.851881 [debug] [MainThread]: Opening a new connection, currently in state init
[0m14:01:41.854735 [debug] [Thread-1 (]: Began running node model.eu_emissions_project.stg_emissions_data
[0m14:01:41.855060 [info ] [Thread-1 (]: 1 of 4 START sql view model eu_emissions_project_staging.stg_emissions_data .... [RUN]
[0m14:01:41.855326 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_data-talk-clubs_eu_emissions_project_marts, now model.eu_emissions_project.stg_emissions_data)
[0m14:01:41.855541 [debug] [Thread-1 (]: Began compiling node model.eu_emissions_project.stg_emissions_data
[0m14:01:41.861558 [debug] [Thread-1 (]: Writing injected SQL for node "model.eu_emissions_project.stg_emissions_data"
[0m14:01:41.862725 [debug] [Thread-1 (]: Began executing node model.eu_emissions_project.stg_emissions_data
[0m14:01:41.877654 [debug] [Thread-1 (]: Writing runtime sql for node "model.eu_emissions_project.stg_emissions_data"
[0m14:01:41.879540 [debug] [Thread-1 (]: On model.eu_emissions_project.stg_emissions_data: /* {"app": "dbt", "dbt_version": "1.9.3", "profile_name": "big-query", "target_name": "dev", "node_id": "model.eu_emissions_project.stg_emissions_data"} */


  create or replace view `data-talk-clubs`.`eu_emissions_project_staging`.`stg_emissions_data`
  OPTIONS()
  as 

WITH source AS (
    SELECT 
        *
    FROM `data-talk-clubs`.`eu_emissions_project`.`nitrogen_dioxide_data`
),

-- First, prepare the data by converting all columns to the same type
preprocessed AS (
    SELECT
        freq_airpol_unit_geo_TIME_PERIOD AS metadata,
        -- Convert all measurement columns to FLOAT64 or NULL
        SAFE_CAST(NULLIF(_2018_01_, ':') AS FLOAT64) AS _2018_01_float,
        SAFE_CAST(NULLIF(_2018_02_, ':') AS FLOAT64) AS _2018_02_float,
        -- Continue with all other columns
        -- ...
    FROM source
)

unpivoted AS (
    SELECT
        metadata,
        'Jan 2018' AS date_label,
        _2018_01_float AS measurement_value,
        DATE '2018-01-01' AS measurement_date
    FROM preprocessed
    WHERE _2018_01_float IS NOT NULL
    
    UNION ALL
    
    SELECT
        metadata,
        'Feb 2018' AS date_label,
        _2018_02_float AS measurement_value,
        DATE '2018-02-01' AS measurement_date
    FROM preprocessed
    WHERE _2018_02_float IS NOT NULL
    
    UNION ALL
    
    SELECT
        metadata,
        'Mar 2018' AS date_label,
        _2018_03_float AS measurement_value,
        DATE '2018-03-01' AS measurement_date
    FROM preprocessed
    WHERE _2018_03_float IS NOT NULL
    
    UNION ALL
    
    SELECT
        metadata,
        'Apr 2018' AS date_label,
        _2018_04_float AS measurement_value,
        DATE '2018-04-01' AS measurement_date
    FROM preprocessed
    WHERE _2018_04_float IS NOT NULL
    
    UNION ALL
    
    SELECT
        metadata,
        'May 2018' AS date_label,
        _2018_05_float AS measurement_value,
        DATE '2018-05-01' AS measurement_date
    FROM preprocessed
    WHERE _2018_05_float IS NOT NULL
    
    UNION ALL
    
    SELECT
        metadata,
        'Jun 2018' AS date_label,
        _2018_06_float AS measurement_value,
        DATE '2018-06-01' AS measurement_date
    FROM preprocessed
    WHERE _2018_06_float IS NOT NULL
    
    UNION ALL
    
    SELECT
        metadata,
        'Jul 2018' AS date_label,
        _2018_07_float AS measurement_value,
        DATE '2018-07-01' AS measurement_date
    FROM preprocessed
    WHERE _2018_07_float IS NOT NULL
    
    UNION ALL
    
    SELECT
        metadata,
        'Aug 2018' AS date_label,
        _2018_08_float AS measurement_value,
        DATE '2018-08-01' AS measurement_date
    FROM preprocessed
    WHERE _2018_08_float IS NOT NULL
    
    UNION ALL
    
    SELECT
        metadata,
        'Sep 2018' AS date_label,
        _2018_09_float AS measurement_value,
        DATE '2018-09-01' AS measurement_date
    FROM preprocessed
    WHERE _2018_09_float IS NOT NULL
    
    UNION ALL
    
    SELECT
        metadata,
        'Oct 2018' AS date_label,
        _2018_10_float AS measurement_value,
        DATE '2018-10-01' AS measurement_date
    FROM preprocessed
    WHERE _2018_10_float IS NOT NULL
    
    UNION ALL
    
    SELECT
        metadata,
        'Nov 2018' AS date_label,
        _2018_11_float AS measurement_value,
        DATE '2018-11-01' AS measurement_date
    FROM preprocessed
    WHERE _2018_11_float IS NOT NULL
    
    UNION ALL
    
    SELECT
        metadata,
        'Dec 2018' AS date_label,
        _2018_12_float AS measurement_value,
        DATE '2018-12-01' AS measurement_date
    FROM preprocessed
    WHERE _2018_12_float IS NOT NULL
    
    UNION ALL
    
    SELECT
        metadata,
        'Jan 2019' AS date_label,
        _2019_01_float AS measurement_value,
        DATE '2019-01-01' AS measurement_date
    FROM preprocessed
    WHERE _2019_01_float IS NOT NULL
    
    UNION ALL
    
    SELECT
        metadata,
        'Feb 2019' AS date_label,
        _2019_02_float AS measurement_value,
        DATE '2019-02-01' AS measurement_date
    FROM preprocessed
    WHERE _2019_02_float IS NOT NULL
    
    UNION ALL
    
    SELECT
        metadata,
        'Mar 2019' AS date_label,
        _2019_03_float AS measurement_value,
        DATE '2019-03-01' AS measurement_date
    FROM preprocessed
    WHERE _2019_03_float IS NOT NULL
    
    UNION ALL
    
    SELECT
        metadata,
        'Apr 2019' AS date_label,
        _2019_04_float AS measurement_value,
        DATE '2019-04-01' AS measurement_date
    FROM preprocessed
    WHERE _2019_04_float IS NOT NULL
    
    UNION ALL
    
    SELECT
        metadata,
        'May 2019' AS date_label,
        _2019_05_float AS measurement_value,
        DATE '2019-05-01' AS measurement_date
    FROM preprocessed
    WHERE _2019_05_float IS NOT NULL
    
    UNION ALL
    
    SELECT
        metadata,
        'Jun 2019' AS date_label,
        _2019_06_float AS measurement_value,
        DATE '2019-06-01' AS measurement_date
    FROM preprocessed
    WHERE _2019_06_float IS NOT NULL
    
    UNION ALL
    
    SELECT
        metadata,
        'Jul 2019' AS date_label,
        _2019_07_float AS measurement_value,
        DATE '2019-07-01' AS measurement_date
    FROM preprocessed
    WHERE _2019_07_float IS NOT NULL
    
    UNION ALL
    
    SELECT
        metadata,
        'Aug 2019' AS date_label,
        _2019_08_float AS measurement_value,
        DATE '2019-08-01' AS measurement_date
    FROM preprocessed
    WHERE _2019_08_float IS NOT NULL
    
    UNION ALL
    
    SELECT
        metadata,
        'Sep 2019' AS date_label,
        _2019_09_float AS measurement_value,
        DATE '2019-09-01' AS measurement_date
    FROM preprocessed
    WHERE _2019_09_float IS NOT NULL
    
    UNION ALL
    
    SELECT
        metadata,
        'Oct 2019' AS date_label,
        _2019_10_float AS measurement_value,
        DATE '2019-10-01' AS measurement_date
    FROM preprocessed
    WHERE _2019_10_float IS NOT NULL
    
    UNION ALL
    
    SELECT
        metadata,
        'Nov 2019' AS date_label,
        _2019_11_float AS measurement_value,
        DATE '2019-11-01' AS measurement_date
    FROM preprocessed
    WHERE _2019_11_float IS NOT NULL
    
    UNION ALL
    
    SELECT
        metadata,
        'Dec 2019' AS date_label,
        _2019_12_float AS measurement_value,
        DATE '2019-12-01' AS measurement_date
    FROM preprocessed
    WHERE _2019_12_float IS NOT NULL
    
    UNION ALL
    
    SELECT
        metadata,
        'Jan 2020' AS date_label,
        _2020_01_float AS measurement_value,
        DATE '2020-01-01' AS measurement_date
    FROM preprocessed
    WHERE _2020_01_float IS NOT NULL
    
    UNION ALL
    
    SELECT
        metadata,
        'Feb 2020' AS date_label,
        _2020_02_float AS measurement_value,
        DATE '2020-02-01' AS measurement_date
    FROM preprocessed
    WHERE _2020_02_float IS NOT NULL
    
    UNION ALL
    
    SELECT
        metadata,
        'Mar 2020' AS date_label,
        _2020_03_float AS measurement_value,
        DATE '2020-03-01' AS measurement_date
    FROM preprocessed
    WHERE _2020_03_float IS NOT NULL
    
    UNION ALL
    
    SELECT
        metadata,
        'Apr 2020' AS date_label,
        _2020_04_float AS measurement_value,
        DATE '2020-04-01' AS measurement_date
    FROM preprocessed
    WHERE _2020_04_float IS NOT NULL
    
    UNION ALL
    
    SELECT
        metadata,
        'May 2020' AS date_label,
        _2020_05_float AS measurement_value,
        DATE '2020-05-01' AS measurement_date
    FROM preprocessed
    WHERE _2020_05_float IS NOT NULL
    
    UNION ALL
    
    SELECT
        metadata,
        'Jun 2020' AS date_label,
        _2020_06_float AS measurement_value,
        DATE '2020-06-01' AS measurement_date
    FROM preprocessed
    WHERE _2020_06_float IS NOT NULL
    
    UNION ALL
    
    SELECT
        metadata,
        'Jul 2020' AS date_label,
        _2020_07_float AS measurement_value,
        DATE '2020-07-01' AS measurement_date
    FROM preprocessed
    WHERE _2020_07_float IS NOT NULL
    
    UNION ALL
    
    SELECT
        metadata,
        'Aug 2020' AS date_label,
        _2020_08_float AS measurement_value,
        DATE '2020-08-01' AS measurement_date
    FROM preprocessed
    WHERE _2020_08_float IS NOT NULL
    
    UNION ALL
    
    SELECT
        metadata,
        'Sep 2020' AS date_label,
        _2020_09_float AS measurement_value,
        DATE '2020-09-01' AS measurement_date
    FROM preprocessed
    WHERE _2020_09_float IS NOT NULL
    
    UNION ALL
    
    SELECT
        metadata,
        'Oct 2020' AS date_label,
        _2020_10_float AS measurement_value,
        DATE '2020-10-01' AS measurement_date
    FROM preprocessed
    WHERE _2020_10_float IS NOT NULL
    
    UNION ALL
    
    SELECT
        metadata,
        'Nov 2020' AS date_label,
        _2020_11_float AS measurement_value,
        DATE '2020-11-01' AS measurement_date
    FROM preprocessed
    WHERE _2020_11_float IS NOT NULL
    
    UNION ALL
    
    SELECT
        metadata,
        'Dec 2020' AS date_label,
        _2020_12_float AS measurement_value,
        DATE '2020-12-01' AS measurement_date
    FROM preprocessed
    WHERE _2020_12_float IS NOT NULL
    
    UNION ALL
    
    SELECT
        metadata,
        'Jan 2021' AS date_label,
        _2021_01_float AS measurement_value,
        DATE '2021-01-01' AS measurement_date
    FROM preprocessed
    WHERE _2021_01_float IS NOT NULL
    
    UNION ALL
    
    SELECT
        metadata,
        'Feb 2021' AS date_label,
        _2021_02_float AS measurement_value,
        DATE '2021-02-01' AS measurement_date
    FROM preprocessed
    WHERE _2021_02_float IS NOT NULL
    
    UNION ALL
    
    SELECT
        metadata,
        'Mar 2021' AS date_label,
        _2021_03_float AS measurement_value,
        DATE '2021-03-01' AS measurement_date
    FROM preprocessed
    WHERE _2021_03_float IS NOT NULL
    
    UNION ALL
    
    SELECT
        metadata,
        'Apr 2021' AS date_label,
        _2021_04_float AS measurement_value,
        DATE '2021-04-01' AS measurement_date
    FROM preprocessed
    WHERE _2021_04_float IS NOT NULL
    
    UNION ALL
    
    SELECT
        metadata,
        'May 2021' AS date_label,
        _2021_05_float AS measurement_value,
        DATE '2021-05-01' AS measurement_date
    FROM preprocessed
    WHERE _2021_05_float IS NOT NULL
    
    UNION ALL
    
    SELECT
        metadata,
        'Jun 2021' AS date_label,
        _2021_06_float AS measurement_value,
        DATE '2021-06-01' AS measurement_date
    FROM preprocessed
    WHERE _2021_06_float IS NOT NULL
    
    UNION ALL
    
    SELECT
        metadata,
        'Jul 2021' AS date_label,
        _2021_07_float AS measurement_value,
        DATE '2021-07-01' AS measurement_date
    FROM preprocessed
    WHERE _2021_07_float IS NOT NULL
    
    UNION ALL
    
    SELECT
        metadata,
        'Aug 2021' AS date_label,
        _2021_08_float AS measurement_value,
        DATE '2021-08-01' AS measurement_date
    FROM preprocessed
    WHERE _2021_08_float IS NOT NULL
    
    UNION ALL
    
    SELECT
        metadata,
        'Sep 2021' AS date_label,
        _2021_09_float AS measurement_value,
        DATE '2021-09-01' AS measurement_date
    FROM preprocessed
    WHERE _2021_09_float IS NOT NULL
    
    UNION ALL
    
    SELECT
        metadata,
        'Oct 2021' AS date_label,
        _2021_10_float AS measurement_value,
        DATE '2021-10-01' AS measurement_date
    FROM preprocessed
    WHERE _2021_10_float IS NOT NULL
    
    UNION ALL
    
    SELECT
        metadata,
        'Nov 2021' AS date_label,
        _2021_11_float AS measurement_value,
        DATE '2021-11-01' AS measurement_date
    FROM preprocessed
    WHERE _2021_11_float IS NOT NULL
    
    UNION ALL
    
    SELECT
        metadata,
        'Dec 2021' AS date_label,
        _2021_12_float AS measurement_value,
        DATE '2021-12-01' AS measurement_date
    FROM preprocessed
    WHERE _2021_12_float IS NOT NULL
    
    UNION ALL
    
    SELECT
        metadata,
        'Jan 2022' AS date_label,
        _2022_01_float AS measurement_value,
        DATE '2022-01-01' AS measurement_date
    FROM preprocessed
    WHERE _2022_01_float IS NOT NULL
    
    UNION ALL
    
    SELECT
        metadata,
        'Feb 2022' AS date_label,
        _2022_02_float AS measurement_value,
        DATE '2022-02-01' AS measurement_date
    FROM preprocessed
    WHERE _2022_02_float IS NOT NULL
    
    UNION ALL
    
    SELECT
        metadata,
        'Mar 2022' AS date_label,
        _2022_03_float AS measurement_value,
        DATE '2022-03-01' AS measurement_date
    FROM preprocessed
    WHERE _2022_03_float IS NOT NULL
    
    UNION ALL
    
    SELECT
        metadata,
        'Apr 2022' AS date_label,
        _2022_04_float AS measurement_value,
        DATE '2022-04-01' AS measurement_date
    FROM preprocessed
    WHERE _2022_04_float IS NOT NULL
    
    UNION ALL
    
    SELECT
        metadata,
        'May 2022' AS date_label,
        _2022_05_float AS measurement_value,
        DATE '2022-05-01' AS measurement_date
    FROM preprocessed
    WHERE _2022_05_float IS NOT NULL
    
    UNION ALL
    
    SELECT
        metadata,
        'Jun 2022' AS date_label,
        _2022_06_float AS measurement_value,
        DATE '2022-06-01' AS measurement_date
    FROM preprocessed
    WHERE _2022_06_float IS NOT NULL
    
    UNION ALL
    
    SELECT
        metadata,
        'Jul 2022' AS date_label,
        _2022_07_float AS measurement_value,
        DATE '2022-07-01' AS measurement_date
    FROM preprocessed
    WHERE _2022_07_float IS NOT NULL
    
    UNION ALL
    
    SELECT
        metadata,
        'Aug 2022' AS date_label,
        _2022_08_float AS measurement_value,
        DATE '2022-08-01' AS measurement_date
    FROM preprocessed
    WHERE _2022_08_float IS NOT NULL
    
    UNION ALL
    
    SELECT
        metadata,
        'Sep 2022' AS date_label,
        _2022_09_float AS measurement_value,
        DATE '2022-09-01' AS measurement_date
    FROM preprocessed
    WHERE _2022_09_float IS NOT NULL
    
    UNION ALL
    
    SELECT
        metadata,
        'Oct 2022' AS date_label,
        _2022_10_float AS measurement_value,
        DATE '2022-10-01' AS measurement_date
    FROM preprocessed
    WHERE _2022_10_float IS NOT NULL
    
    UNION ALL
    
    SELECT
        metadata,
        'Nov 2022' AS date_label,
        _2022_11_float AS measurement_value,
        DATE '2022-11-01' AS measurement_date
    FROM preprocessed
    WHERE _2022_11_float IS NOT NULL
    
    UNION ALL
    
    SELECT
        metadata,
        'Dec 2022' AS date_label,
        _2022_12_float AS measurement_value,
        DATE '2022-12-01' AS measurement_date
    FROM preprocessed
    WHERE _2022_12_float IS NOT NULL
    
    UNION ALL
    
    SELECT
        metadata,
        'Jan 2023' AS date_label,
        _2023_01_float AS measurement_value,
        DATE '2023-01-01' AS measurement_date
    FROM preprocessed
    WHERE _2023_01_float IS NOT NULL
    
    UNION ALL
    
    SELECT
        metadata,
        'Feb 2023' AS date_label,
        _2023_02_float AS measurement_value,
        DATE '2023-02-01' AS measurement_date
    FROM preprocessed
    WHERE _2023_02_float IS NOT NULL
    
    UNION ALL
    
    SELECT
        metadata,
        'Mar 2023' AS date_label,
        _2023_03_float AS measurement_value,
        DATE '2023-03-01' AS measurement_date
    FROM preprocessed
    WHERE _2023_03_float IS NOT NULL
    
    UNION ALL
    
    SELECT
        metadata,
        'Apr 2023' AS date_label,
        _2023_04_float AS measurement_value,
        DATE '2023-04-01' AS measurement_date
    FROM preprocessed
    WHERE _2023_04_float IS NOT NULL
    
    UNION ALL
    
    SELECT
        metadata,
        'May 2023' AS date_label,
        _2023_05_float AS measurement_value,
        DATE '2023-05-01' AS measurement_date
    FROM preprocessed
    WHERE _2023_05_float IS NOT NULL
    
    UNION ALL
    
    SELECT
        metadata,
        'Jun 2023' AS date_label,
        _2023_06_float AS measurement_value,
        DATE '2023-06-01' AS measurement_date
    FROM preprocessed
    WHERE _2023_06_float IS NOT NULL
    
    UNION ALL
    
    SELECT
        metadata,
        'Jul 2023' AS date_label,
        _2023_07_float AS measurement_value,
        DATE '2023-07-01' AS measurement_date
    FROM preprocessed
    WHERE _2023_07_float IS NOT NULL
    
    UNION ALL
    
    SELECT
        metadata,
        'Aug 2023' AS date_label,
        _2023_08_float AS measurement_value,
        DATE '2023-08-01' AS measurement_date
    FROM preprocessed
    WHERE _2023_08_float IS NOT NULL
    
    UNION ALL
    
    SELECT
        metadata,
        'Sep 2023' AS date_label,
        _2023_09_float AS measurement_value,
        DATE '2023-09-01' AS measurement_date
    FROM preprocessed
    WHERE _2023_09_float IS NOT NULL
    
    UNION ALL
    
    SELECT
        metadata,
        'Oct 2023' AS date_label,
        _2023_10_float AS measurement_value,
        DATE '2023-10-01' AS measurement_date
    FROM preprocessed
    WHERE _2023_10_float IS NOT NULL
    
    UNION ALL
    
    SELECT
        metadata,
        'Nov 2023' AS date_label,
        _2023_11_float AS measurement_value,
        DATE '2023-11-01' AS measurement_date
    FROM preprocessed
    WHERE _2023_11_float IS NOT NULL
    
    UNION ALL
    
    SELECT
        metadata,
        'Dec 2023' AS date_label,
        _2023_12_float AS measurement_value,
        DATE '2023-12-01' AS measurement_date
    FROM preprocessed
    WHERE _2023_12_float IS NOT NULL
    
    UNION ALL
    
    SELECT
        metadata,
        'Jan 2024' AS date_label,
        _2024_01_float AS measurement_value,
        DATE '2024-01-01' AS measurement_date
    FROM preprocessed
    WHERE _2024_01_float IS NOT NULL
    
    UNION ALL
    
    SELECT
        metadata,
        'Feb 2024' AS date_label,
        _2024_02_float AS measurement_value,
        DATE '2024-02-01' AS measurement_date
    FROM preprocessed
    WHERE _2024_02_float IS NOT NULL
    
    UNION ALL
    
    SELECT
        metadata,
        'Mar 2024' AS date_label,
        _2024_03_float AS measurement_value,
        DATE '2024-03-01' AS measurement_date
    FROM preprocessed
    WHERE _2024_03_float IS NOT NULL
    
    UNION ALL
    
    SELECT
        metadata,
        'Apr 2024' AS date_label,
        _2024_04_float AS measurement_value,
        DATE '2024-04-01' AS measurement_date
    FROM preprocessed
    WHERE _2024_04_float IS NOT NULL
    
    UNION ALL
    
    SELECT
        metadata,
        'May 2024' AS date_label,
        _2024_05_float AS measurement_value,
        DATE '2024-05-01' AS measurement_date
    FROM preprocessed
    WHERE _2024_05_float IS NOT NULL
    
    UNION ALL
    
    SELECT
        metadata,
        'Jun 2024' AS date_label,
        _2024_06_float AS measurement_value,
        DATE '2024-06-01' AS measurement_date
    FROM preprocessed
    WHERE _2024_06_float IS NOT NULL
    
    UNION ALL
    
    SELECT
        metadata,
        'Jul 2024' AS date_label,
        _2024_07_float AS measurement_value,
        DATE '2024-07-01' AS measurement_date
    FROM preprocessed
    WHERE _2024_07_float IS NOT NULL
    
    UNION ALL
    
    SELECT
        metadata,
        'Aug 2024' AS date_label,
        _2024_08_float AS measurement_value,
        DATE '2024-08-01' AS measurement_date
    FROM preprocessed
    WHERE _2024_08_float IS NOT NULL
    
    UNION ALL
    
    SELECT
        metadata,
        'Sep 2024' AS date_label,
        _2024_09_float AS measurement_value,
        DATE '2024-09-01' AS measurement_date
    FROM preprocessed
    WHERE _2024_09_float IS NOT NULL
    
    UNION ALL
    
    SELECT
        metadata,
        'Oct 2024' AS date_label,
        _2024_10_float AS measurement_value,
        DATE '2024-10-01' AS measurement_date
    FROM preprocessed
    WHERE _2024_10_float IS NOT NULL
    
    UNION ALL
    
    SELECT
        metadata,
        'Nov 2024' AS date_label,
        _2024_11_float AS measurement_value,
        DATE '2024-11-01' AS measurement_date
    FROM preprocessed
    WHERE _2024_11_float IS NOT NULL
    
    UNION ALL
    
    SELECT
        metadata,
        'Dec 2024' AS date_label,
        _2024_12_float AS measurement_value,
        DATE '2024-12-01' AS measurement_date
    FROM preprocessed
    WHERE _2024_12_float IS NOT NULL
    
    UNION ALL
    
    SELECT
        metadata,
        'Jan 2025' AS date_label,
        _2025_01_float AS measurement_value,
        DATE '2025-01-01' AS measurement_date
    FROM preprocessed
    WHERE _2025_01_float IS NOT NULL
    
    UNION ALL
    
    SELECT
        metadata,
        'Feb 2025' AS date_label,
        _2025_02_float AS measurement_value,
        DATE '2025-02-01' AS measurement_date
    FROM preprocessed
    WHERE _2025_02_float IS NOT NULL
    
)


date_transformed AS (
    SELECT
        metadata,
        -- Convert column name to date (remove leading/trailing underscores and convert to date)
        DATE(CONCAT(
            SUBSTR(REPLACE(date_column, '_', ''), 1, 4), '-',
            SUBSTR(REPLACE(date_column, '_', ''), 5, 2), '-01'
        )) AS measurement_date,
        -- Handle colon values by converting them to NULL before casting to FLOAT64
        CASE 
            WHEN measurement_value = ':' THEN NULL
            ELSE SAFE_CAST(measurement_value AS FLOAT64)
        END AS measurement_value,
        CURRENT_TIMESTAMP() AS load_timestamp
    FROM unpivoted
    -- Filter out NULL values but keep rows where the value was a colon (now NULL)
    WHERE measurement_value IS NOT NULL OR measurement_value = ':'
),

metadata_extracted AS (
    SELECT
        -- Extract metadata components
        SPLIT(metadata, ',')[SAFE_OFFSET(0)] AS frequency,
        SPLIT(metadata, ',')[SAFE_OFFSET(1)] AS airpol,
        SPLIT(metadata, ',')[SAFE_OFFSET(2)] AS unit,
        SPLIT(metadata, ',')[SAFE_OFFSET(3)] AS geo_code,
        date_label,
        measurement_date,
        measurement_value,
        CURRENT_TIMESTAMP() AS load_timestamp
    FROM unpivoted
)

SELECT
    ROW_NUMBER() OVER() AS id,
    frequency,
    airpol,
    unit,
    geo_code,
    date_label,
    measurement_date,
    measurement_value,
    load_timestamp
FROM metadata_extracted
ORDER BY geo_code, measurement_date;


[0m14:01:41.880625 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m14:01:42.118721 [debug] [Thread-1 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=data-talk-clubs&j=bq:EU:7c3a7ce9-d515-4957-8b9e-cc2c4f42d729&page=queryresults
[0m14:01:42.119418 [error] [Thread-1 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=data-talk-clubs&j=bq:EU:7c3a7ce9-d515-4957-8b9e-cc2c4f42d729&page=queryresults
[0m14:01:42.126439 [debug] [Thread-1 (]: Database Error in model stg_emissions_data (models/staging/stg_emissions_data.sql)
  Syntax error: Unexpected identifier "unpivoted" at [26:1]
  compiled code at target/run/eu_emissions_project/models/staging/stg_emissions_data.sql
[0m14:01:42.127842 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '626655c7-38c5-48d9-af31-ca603ecbf99a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x166887910>]}
[0m14:01:42.128399 [error] [Thread-1 (]: 1 of 4 ERROR creating sql view model eu_emissions_project_staging.stg_emissions_data  [[31mERROR[0m in 0.27s]
[0m14:01:42.128739 [debug] [Thread-1 (]: Finished running node model.eu_emissions_project.stg_emissions_data
[0m14:01:42.129106 [debug] [Thread-11 ]: Marking all children of 'model.eu_emissions_project.stg_emissions_data' to be skipped because of status 'error'.  Reason: Database Error in model stg_emissions_data (models/staging/stg_emissions_data.sql)
  Syntax error: Unexpected identifier "unpivoted" at [26:1]
  compiled code at target/run/eu_emissions_project/models/staging/stg_emissions_data.sql.
[0m14:01:42.130569 [debug] [Thread-3 (]: Began running node model.eu_emissions_project.int_emissions_cleaned
[0m14:01:42.130863 [debug] [Thread-4 (]: Began running node model.eu_emissions_project.int_emissions_unpivoted
[0m14:01:42.131155 [info ] [Thread-3 (]: 2 of 4 SKIP relation eu_emissions_project_intermediate.int_emissions_cleaned ... [[33mSKIP[0m]
[0m14:01:42.131510 [info ] [Thread-4 (]: 3 of 4 SKIP relation eu_emissions_project_intermediate.int_emissions_unpivoted . [[33mSKIP[0m]
[0m14:01:42.131855 [debug] [Thread-3 (]: Finished running node model.eu_emissions_project.int_emissions_cleaned
[0m14:01:42.132122 [debug] [Thread-4 (]: Finished running node model.eu_emissions_project.int_emissions_unpivoted
[0m14:01:42.132611 [debug] [Thread-6 (]: Began running node model.eu_emissions_project.emissions_analysis
[0m14:01:42.132992 [info ] [Thread-6 (]: 4 of 4 SKIP relation eu_emissions_project_marts.emissions_analysis ............. [[33mSKIP[0m]
[0m14:01:42.133334 [debug] [Thread-6 (]: Finished running node model.eu_emissions_project.emissions_analysis
[0m14:01:42.134090 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m14:01:42.135081 [debug] [MainThread]: Connection 'master' was properly closed.
[0m14:01:42.135296 [debug] [MainThread]: Connection 'model.eu_emissions_project.stg_emissions_data' was properly closed.
[0m14:01:42.135467 [debug] [MainThread]: Connection 'list_data-talk-clubs_eu_emissions_project_staging' was properly closed.
[0m14:01:42.135626 [debug] [MainThread]: Connection 'list_data-talk-clubs_eu_emissions_project_intermediate' was properly closed.
[0m14:01:42.135847 [info ] [MainThread]: 
[0m14:01:42.136041 [info ] [MainThread]: Finished running 2 table models, 2 view models in 0 hours 0 minutes and 1.08 seconds (1.08s).
[0m14:01:42.136473 [debug] [MainThread]: Command end result
[0m14:01:42.149771 [debug] [MainThread]: Wrote artifact WritableManifest to /Users/timbo/Documents/DataTalks/project/src/target/manifest.json
[0m14:01:42.150662 [debug] [MainThread]: Wrote artifact SemanticManifest to /Users/timbo/Documents/DataTalks/project/src/target/semantic_manifest.json
[0m14:01:42.154009 [debug] [MainThread]: Wrote artifact RunExecutionResult to /Users/timbo/Documents/DataTalks/project/src/target/run_results.json
[0m14:01:42.154267 [info ] [MainThread]: 
[0m14:01:42.154486 [info ] [MainThread]: [31mCompleted with 1 error, 0 partial successes, and 0 warnings:[0m
[0m14:01:42.154680 [info ] [MainThread]: 
[0m14:01:42.154893 [error] [MainThread]:   Database Error in model stg_emissions_data (models/staging/stg_emissions_data.sql)
  Syntax error: Unexpected identifier "unpivoted" at [26:1]
  compiled code at target/run/eu_emissions_project/models/staging/stg_emissions_data.sql
[0m14:01:42.155070 [info ] [MainThread]: 
[0m14:01:42.155252 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=3 TOTAL=4
[0m14:01:42.157193 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": false, "command_wall_clock_time": 2.3576238, "process_in_blocks": "0", "process_kernel_time": 0.363718, "process_mem_max_rss": "210944000", "process_out_blocks": "0", "process_user_time": 1.745344}
[0m14:01:42.157555 [debug] [MainThread]: Command `dbt run` failed at 14:01:42.157507 after 2.36 seconds
[0m14:01:42.157801 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104861e90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1268efe90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1268efdd0>]}
[0m14:01:42.158030 [debug] [MainThread]: Flushing usage events
[0m14:01:42.611451 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m14:02:18.088274 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1062cead0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110ccb310>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110cc2cd0>]}


============================== 14:02:18.091691 | 3060e012-344a-442d-980f-e7f1868d1a82 ==============================
[0m14:02:18.091691 [info ] [MainThread]: Running with dbt=1.9.3
[0m14:02:18.092176 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': '/Users/timbo/.dbt', 'fail_fast': 'False', 'warn_error': 'None', 'log_path': '/Users/timbo/Documents/DataTalks/project/src/logs', 'debug': 'False', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'empty': 'False', 'quiet': 'False', 'no_print': 'None', 'log_format': 'default', 'invocation_command': 'dbt run', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m14:02:18.811448 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '3060e012-344a-442d-980f-e7f1868d1a82', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110c6fe50>]}
[0m14:02:18.838627 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '3060e012-344a-442d-980f-e7f1868d1a82', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1062e3410>]}
[0m14:02:18.839117 [info ] [MainThread]: Registered adapter: bigquery=1.9.1
[0m14:02:18.934379 [debug] [MainThread]: checksum: 5671c00892cdbcef29c3b00cc5ba7510c3d18a35c883caeb9ab9ee266dc29c8f, vars: {}, profile: , target: , version: 1.9.3
[0m14:02:19.049951 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m14:02:19.050458 [debug] [MainThread]: Partial parsing: updated file: eu_emissions_project://models/staging/stg_emissions_data.sql
[0m14:02:19.204492 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '3060e012-344a-442d-980f-e7f1868d1a82', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1357b3110>]}
[0m14:02:19.241392 [debug] [MainThread]: Wrote artifact WritableManifest to /Users/timbo/Documents/DataTalks/project/src/target/manifest.json
[0m14:02:19.243463 [debug] [MainThread]: Wrote artifact SemanticManifest to /Users/timbo/Documents/DataTalks/project/src/target/semantic_manifest.json
[0m14:02:19.254362 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '3060e012-344a-442d-980f-e7f1868d1a82', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1356f9210>]}
[0m14:02:19.254731 [info ] [MainThread]: Found 4 models, 1 source, 491 macros
[0m14:02:19.254980 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '3060e012-344a-442d-980f-e7f1868d1a82', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1352b7090>]}
[0m14:02:19.255953 [info ] [MainThread]: 
[0m14:02:19.256205 [info ] [MainThread]: Concurrency: 8 threads (target='dev')
[0m14:02:19.256396 [info ] [MainThread]: 
[0m14:02:19.256694 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m14:02:19.259002 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_data-talk-clubs'
[0m14:02:19.259284 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_data-talk-clubs'
[0m14:02:19.259560 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m14:02:19.259804 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_data-talk-clubs'
[0m14:02:19.260022 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m14:02:19.260265 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m14:02:19.734972 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_data-talk-clubs, now list_data-talk-clubs_eu_emissions_project_intermediate)
[0m14:02:19.735392 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_data-talk-clubs, now list_data-talk-clubs_eu_emissions_project_marts)
[0m14:02:19.735601 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m14:02:19.735871 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_data-talk-clubs, now list_data-talk-clubs_eu_emissions_project_staging)
[0m14:02:19.736098 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m14:02:19.737176 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m14:02:20.026301 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '3060e012-344a-442d-980f-e7f1868d1a82', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1357a3b50>]}
[0m14:02:20.026672 [debug] [MainThread]: Opening a new connection, currently in state init
[0m14:02:20.029727 [debug] [Thread-1 (]: Began running node model.eu_emissions_project.stg_emissions_data
[0m14:02:20.030126 [info ] [Thread-1 (]: 1 of 4 START sql view model eu_emissions_project_staging.stg_emissions_data .... [RUN]
[0m14:02:20.030419 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_data-talk-clubs_eu_emissions_project_intermediate, now model.eu_emissions_project.stg_emissions_data)
[0m14:02:20.030633 [debug] [Thread-1 (]: Began compiling node model.eu_emissions_project.stg_emissions_data
[0m14:02:20.036517 [debug] [Thread-1 (]: Writing injected SQL for node "model.eu_emissions_project.stg_emissions_data"
[0m14:02:20.037450 [debug] [Thread-1 (]: Began executing node model.eu_emissions_project.stg_emissions_data
[0m14:02:20.052748 [debug] [Thread-1 (]: Writing runtime sql for node "model.eu_emissions_project.stg_emissions_data"
[0m14:02:20.053968 [debug] [Thread-1 (]: On model.eu_emissions_project.stg_emissions_data: /* {"app": "dbt", "dbt_version": "1.9.3", "profile_name": "big-query", "target_name": "dev", "node_id": "model.eu_emissions_project.stg_emissions_data"} */


  create or replace view `data-talk-clubs`.`eu_emissions_project_staging`.`stg_emissions_data`
  OPTIONS()
  as 

WITH source AS (
    SELECT 
        *
    FROM `data-talk-clubs`.`eu_emissions_project`.`nitrogen_dioxide_data`
),

-- First, prepare the data by converting all columns to the same type
preprocessed AS (
    SELECT
        freq_airpol_unit_geo_TIME_PERIOD AS metadata,
        -- Convert all measurement columns to FLOAT64 or NULL
        SAFE_CAST(NULLIF(_2018_01_, ':') AS FLOAT64) AS _2018_01_float,
        SAFE_CAST(NULLIF(_2018_02_, ':') AS FLOAT64) AS _2018_02_float,
        -- Continue with all other columns
        -- ...
    FROM source
),

unpivoted AS (
    SELECT
        metadata,
        'Jan 2018' AS date_label,
        _2018_01_float AS measurement_value,
        DATE '2018-01-01' AS measurement_date
    FROM preprocessed
    WHERE _2018_01_float IS NOT NULL
    
    UNION ALL
    
    SELECT
        metadata,
        'Feb 2018' AS date_label,
        _2018_02_float AS measurement_value,
        DATE '2018-02-01' AS measurement_date
    FROM preprocessed
    WHERE _2018_02_float IS NOT NULL
    
    UNION ALL
    
    SELECT
        metadata,
        'Mar 2018' AS date_label,
        _2018_03_float AS measurement_value,
        DATE '2018-03-01' AS measurement_date
    FROM preprocessed
    WHERE _2018_03_float IS NOT NULL
    
    UNION ALL
    
    SELECT
        metadata,
        'Apr 2018' AS date_label,
        _2018_04_float AS measurement_value,
        DATE '2018-04-01' AS measurement_date
    FROM preprocessed
    WHERE _2018_04_float IS NOT NULL
    
    UNION ALL
    
    SELECT
        metadata,
        'May 2018' AS date_label,
        _2018_05_float AS measurement_value,
        DATE '2018-05-01' AS measurement_date
    FROM preprocessed
    WHERE _2018_05_float IS NOT NULL
    
    UNION ALL
    
    SELECT
        metadata,
        'Jun 2018' AS date_label,
        _2018_06_float AS measurement_value,
        DATE '2018-06-01' AS measurement_date
    FROM preprocessed
    WHERE _2018_06_float IS NOT NULL
    
    UNION ALL
    
    SELECT
        metadata,
        'Jul 2018' AS date_label,
        _2018_07_float AS measurement_value,
        DATE '2018-07-01' AS measurement_date
    FROM preprocessed
    WHERE _2018_07_float IS NOT NULL
    
    UNION ALL
    
    SELECT
        metadata,
        'Aug 2018' AS date_label,
        _2018_08_float AS measurement_value,
        DATE '2018-08-01' AS measurement_date
    FROM preprocessed
    WHERE _2018_08_float IS NOT NULL
    
    UNION ALL
    
    SELECT
        metadata,
        'Sep 2018' AS date_label,
        _2018_09_float AS measurement_value,
        DATE '2018-09-01' AS measurement_date
    FROM preprocessed
    WHERE _2018_09_float IS NOT NULL
    
    UNION ALL
    
    SELECT
        metadata,
        'Oct 2018' AS date_label,
        _2018_10_float AS measurement_value,
        DATE '2018-10-01' AS measurement_date
    FROM preprocessed
    WHERE _2018_10_float IS NOT NULL
    
    UNION ALL
    
    SELECT
        metadata,
        'Nov 2018' AS date_label,
        _2018_11_float AS measurement_value,
        DATE '2018-11-01' AS measurement_date
    FROM preprocessed
    WHERE _2018_11_float IS NOT NULL
    
    UNION ALL
    
    SELECT
        metadata,
        'Dec 2018' AS date_label,
        _2018_12_float AS measurement_value,
        DATE '2018-12-01' AS measurement_date
    FROM preprocessed
    WHERE _2018_12_float IS NOT NULL
    
    UNION ALL
    
    SELECT
        metadata,
        'Jan 2019' AS date_label,
        _2019_01_float AS measurement_value,
        DATE '2019-01-01' AS measurement_date
    FROM preprocessed
    WHERE _2019_01_float IS NOT NULL
    
    UNION ALL
    
    SELECT
        metadata,
        'Feb 2019' AS date_label,
        _2019_02_float AS measurement_value,
        DATE '2019-02-01' AS measurement_date
    FROM preprocessed
    WHERE _2019_02_float IS NOT NULL
    
    UNION ALL
    
    SELECT
        metadata,
        'Mar 2019' AS date_label,
        _2019_03_float AS measurement_value,
        DATE '2019-03-01' AS measurement_date
    FROM preprocessed
    WHERE _2019_03_float IS NOT NULL
    
    UNION ALL
    
    SELECT
        metadata,
        'Apr 2019' AS date_label,
        _2019_04_float AS measurement_value,
        DATE '2019-04-01' AS measurement_date
    FROM preprocessed
    WHERE _2019_04_float IS NOT NULL
    
    UNION ALL
    
    SELECT
        metadata,
        'May 2019' AS date_label,
        _2019_05_float AS measurement_value,
        DATE '2019-05-01' AS measurement_date
    FROM preprocessed
    WHERE _2019_05_float IS NOT NULL
    
    UNION ALL
    
    SELECT
        metadata,
        'Jun 2019' AS date_label,
        _2019_06_float AS measurement_value,
        DATE '2019-06-01' AS measurement_date
    FROM preprocessed
    WHERE _2019_06_float IS NOT NULL
    
    UNION ALL
    
    SELECT
        metadata,
        'Jul 2019' AS date_label,
        _2019_07_float AS measurement_value,
        DATE '2019-07-01' AS measurement_date
    FROM preprocessed
    WHERE _2019_07_float IS NOT NULL
    
    UNION ALL
    
    SELECT
        metadata,
        'Aug 2019' AS date_label,
        _2019_08_float AS measurement_value,
        DATE '2019-08-01' AS measurement_date
    FROM preprocessed
    WHERE _2019_08_float IS NOT NULL
    
    UNION ALL
    
    SELECT
        metadata,
        'Sep 2019' AS date_label,
        _2019_09_float AS measurement_value,
        DATE '2019-09-01' AS measurement_date
    FROM preprocessed
    WHERE _2019_09_float IS NOT NULL
    
    UNION ALL
    
    SELECT
        metadata,
        'Oct 2019' AS date_label,
        _2019_10_float AS measurement_value,
        DATE '2019-10-01' AS measurement_date
    FROM preprocessed
    WHERE _2019_10_float IS NOT NULL
    
    UNION ALL
    
    SELECT
        metadata,
        'Nov 2019' AS date_label,
        _2019_11_float AS measurement_value,
        DATE '2019-11-01' AS measurement_date
    FROM preprocessed
    WHERE _2019_11_float IS NOT NULL
    
    UNION ALL
    
    SELECT
        metadata,
        'Dec 2019' AS date_label,
        _2019_12_float AS measurement_value,
        DATE '2019-12-01' AS measurement_date
    FROM preprocessed
    WHERE _2019_12_float IS NOT NULL
    
    UNION ALL
    
    SELECT
        metadata,
        'Jan 2020' AS date_label,
        _2020_01_float AS measurement_value,
        DATE '2020-01-01' AS measurement_date
    FROM preprocessed
    WHERE _2020_01_float IS NOT NULL
    
    UNION ALL
    
    SELECT
        metadata,
        'Feb 2020' AS date_label,
        _2020_02_float AS measurement_value,
        DATE '2020-02-01' AS measurement_date
    FROM preprocessed
    WHERE _2020_02_float IS NOT NULL
    
    UNION ALL
    
    SELECT
        metadata,
        'Mar 2020' AS date_label,
        _2020_03_float AS measurement_value,
        DATE '2020-03-01' AS measurement_date
    FROM preprocessed
    WHERE _2020_03_float IS NOT NULL
    
    UNION ALL
    
    SELECT
        metadata,
        'Apr 2020' AS date_label,
        _2020_04_float AS measurement_value,
        DATE '2020-04-01' AS measurement_date
    FROM preprocessed
    WHERE _2020_04_float IS NOT NULL
    
    UNION ALL
    
    SELECT
        metadata,
        'May 2020' AS date_label,
        _2020_05_float AS measurement_value,
        DATE '2020-05-01' AS measurement_date
    FROM preprocessed
    WHERE _2020_05_float IS NOT NULL
    
    UNION ALL
    
    SELECT
        metadata,
        'Jun 2020' AS date_label,
        _2020_06_float AS measurement_value,
        DATE '2020-06-01' AS measurement_date
    FROM preprocessed
    WHERE _2020_06_float IS NOT NULL
    
    UNION ALL
    
    SELECT
        metadata,
        'Jul 2020' AS date_label,
        _2020_07_float AS measurement_value,
        DATE '2020-07-01' AS measurement_date
    FROM preprocessed
    WHERE _2020_07_float IS NOT NULL
    
    UNION ALL
    
    SELECT
        metadata,
        'Aug 2020' AS date_label,
        _2020_08_float AS measurement_value,
        DATE '2020-08-01' AS measurement_date
    FROM preprocessed
    WHERE _2020_08_float IS NOT NULL
    
    UNION ALL
    
    SELECT
        metadata,
        'Sep 2020' AS date_label,
        _2020_09_float AS measurement_value,
        DATE '2020-09-01' AS measurement_date
    FROM preprocessed
    WHERE _2020_09_float IS NOT NULL
    
    UNION ALL
    
    SELECT
        metadata,
        'Oct 2020' AS date_label,
        _2020_10_float AS measurement_value,
        DATE '2020-10-01' AS measurement_date
    FROM preprocessed
    WHERE _2020_10_float IS NOT NULL
    
    UNION ALL
    
    SELECT
        metadata,
        'Nov 2020' AS date_label,
        _2020_11_float AS measurement_value,
        DATE '2020-11-01' AS measurement_date
    FROM preprocessed
    WHERE _2020_11_float IS NOT NULL
    
    UNION ALL
    
    SELECT
        metadata,
        'Dec 2020' AS date_label,
        _2020_12_float AS measurement_value,
        DATE '2020-12-01' AS measurement_date
    FROM preprocessed
    WHERE _2020_12_float IS NOT NULL
    
    UNION ALL
    
    SELECT
        metadata,
        'Jan 2021' AS date_label,
        _2021_01_float AS measurement_value,
        DATE '2021-01-01' AS measurement_date
    FROM preprocessed
    WHERE _2021_01_float IS NOT NULL
    
    UNION ALL
    
    SELECT
        metadata,
        'Feb 2021' AS date_label,
        _2021_02_float AS measurement_value,
        DATE '2021-02-01' AS measurement_date
    FROM preprocessed
    WHERE _2021_02_float IS NOT NULL
    
    UNION ALL
    
    SELECT
        metadata,
        'Mar 2021' AS date_label,
        _2021_03_float AS measurement_value,
        DATE '2021-03-01' AS measurement_date
    FROM preprocessed
    WHERE _2021_03_float IS NOT NULL
    
    UNION ALL
    
    SELECT
        metadata,
        'Apr 2021' AS date_label,
        _2021_04_float AS measurement_value,
        DATE '2021-04-01' AS measurement_date
    FROM preprocessed
    WHERE _2021_04_float IS NOT NULL
    
    UNION ALL
    
    SELECT
        metadata,
        'May 2021' AS date_label,
        _2021_05_float AS measurement_value,
        DATE '2021-05-01' AS measurement_date
    FROM preprocessed
    WHERE _2021_05_float IS NOT NULL
    
    UNION ALL
    
    SELECT
        metadata,
        'Jun 2021' AS date_label,
        _2021_06_float AS measurement_value,
        DATE '2021-06-01' AS measurement_date
    FROM preprocessed
    WHERE _2021_06_float IS NOT NULL
    
    UNION ALL
    
    SELECT
        metadata,
        'Jul 2021' AS date_label,
        _2021_07_float AS measurement_value,
        DATE '2021-07-01' AS measurement_date
    FROM preprocessed
    WHERE _2021_07_float IS NOT NULL
    
    UNION ALL
    
    SELECT
        metadata,
        'Aug 2021' AS date_label,
        _2021_08_float AS measurement_value,
        DATE '2021-08-01' AS measurement_date
    FROM preprocessed
    WHERE _2021_08_float IS NOT NULL
    
    UNION ALL
    
    SELECT
        metadata,
        'Sep 2021' AS date_label,
        _2021_09_float AS measurement_value,
        DATE '2021-09-01' AS measurement_date
    FROM preprocessed
    WHERE _2021_09_float IS NOT NULL
    
    UNION ALL
    
    SELECT
        metadata,
        'Oct 2021' AS date_label,
        _2021_10_float AS measurement_value,
        DATE '2021-10-01' AS measurement_date
    FROM preprocessed
    WHERE _2021_10_float IS NOT NULL
    
    UNION ALL
    
    SELECT
        metadata,
        'Nov 2021' AS date_label,
        _2021_11_float AS measurement_value,
        DATE '2021-11-01' AS measurement_date
    FROM preprocessed
    WHERE _2021_11_float IS NOT NULL
    
    UNION ALL
    
    SELECT
        metadata,
        'Dec 2021' AS date_label,
        _2021_12_float AS measurement_value,
        DATE '2021-12-01' AS measurement_date
    FROM preprocessed
    WHERE _2021_12_float IS NOT NULL
    
    UNION ALL
    
    SELECT
        metadata,
        'Jan 2022' AS date_label,
        _2022_01_float AS measurement_value,
        DATE '2022-01-01' AS measurement_date
    FROM preprocessed
    WHERE _2022_01_float IS NOT NULL
    
    UNION ALL
    
    SELECT
        metadata,
        'Feb 2022' AS date_label,
        _2022_02_float AS measurement_value,
        DATE '2022-02-01' AS measurement_date
    FROM preprocessed
    WHERE _2022_02_float IS NOT NULL
    
    UNION ALL
    
    SELECT
        metadata,
        'Mar 2022' AS date_label,
        _2022_03_float AS measurement_value,
        DATE '2022-03-01' AS measurement_date
    FROM preprocessed
    WHERE _2022_03_float IS NOT NULL
    
    UNION ALL
    
    SELECT
        metadata,
        'Apr 2022' AS date_label,
        _2022_04_float AS measurement_value,
        DATE '2022-04-01' AS measurement_date
    FROM preprocessed
    WHERE _2022_04_float IS NOT NULL
    
    UNION ALL
    
    SELECT
        metadata,
        'May 2022' AS date_label,
        _2022_05_float AS measurement_value,
        DATE '2022-05-01' AS measurement_date
    FROM preprocessed
    WHERE _2022_05_float IS NOT NULL
    
    UNION ALL
    
    SELECT
        metadata,
        'Jun 2022' AS date_label,
        _2022_06_float AS measurement_value,
        DATE '2022-06-01' AS measurement_date
    FROM preprocessed
    WHERE _2022_06_float IS NOT NULL
    
    UNION ALL
    
    SELECT
        metadata,
        'Jul 2022' AS date_label,
        _2022_07_float AS measurement_value,
        DATE '2022-07-01' AS measurement_date
    FROM preprocessed
    WHERE _2022_07_float IS NOT NULL
    
    UNION ALL
    
    SELECT
        metadata,
        'Aug 2022' AS date_label,
        _2022_08_float AS measurement_value,
        DATE '2022-08-01' AS measurement_date
    FROM preprocessed
    WHERE _2022_08_float IS NOT NULL
    
    UNION ALL
    
    SELECT
        metadata,
        'Sep 2022' AS date_label,
        _2022_09_float AS measurement_value,
        DATE '2022-09-01' AS measurement_date
    FROM preprocessed
    WHERE _2022_09_float IS NOT NULL
    
    UNION ALL
    
    SELECT
        metadata,
        'Oct 2022' AS date_label,
        _2022_10_float AS measurement_value,
        DATE '2022-10-01' AS measurement_date
    FROM preprocessed
    WHERE _2022_10_float IS NOT NULL
    
    UNION ALL
    
    SELECT
        metadata,
        'Nov 2022' AS date_label,
        _2022_11_float AS measurement_value,
        DATE '2022-11-01' AS measurement_date
    FROM preprocessed
    WHERE _2022_11_float IS NOT NULL
    
    UNION ALL
    
    SELECT
        metadata,
        'Dec 2022' AS date_label,
        _2022_12_float AS measurement_value,
        DATE '2022-12-01' AS measurement_date
    FROM preprocessed
    WHERE _2022_12_float IS NOT NULL
    
    UNION ALL
    
    SELECT
        metadata,
        'Jan 2023' AS date_label,
        _2023_01_float AS measurement_value,
        DATE '2023-01-01' AS measurement_date
    FROM preprocessed
    WHERE _2023_01_float IS NOT NULL
    
    UNION ALL
    
    SELECT
        metadata,
        'Feb 2023' AS date_label,
        _2023_02_float AS measurement_value,
        DATE '2023-02-01' AS measurement_date
    FROM preprocessed
    WHERE _2023_02_float IS NOT NULL
    
    UNION ALL
    
    SELECT
        metadata,
        'Mar 2023' AS date_label,
        _2023_03_float AS measurement_value,
        DATE '2023-03-01' AS measurement_date
    FROM preprocessed
    WHERE _2023_03_float IS NOT NULL
    
    UNION ALL
    
    SELECT
        metadata,
        'Apr 2023' AS date_label,
        _2023_04_float AS measurement_value,
        DATE '2023-04-01' AS measurement_date
    FROM preprocessed
    WHERE _2023_04_float IS NOT NULL
    
    UNION ALL
    
    SELECT
        metadata,
        'May 2023' AS date_label,
        _2023_05_float AS measurement_value,
        DATE '2023-05-01' AS measurement_date
    FROM preprocessed
    WHERE _2023_05_float IS NOT NULL
    
    UNION ALL
    
    SELECT
        metadata,
        'Jun 2023' AS date_label,
        _2023_06_float AS measurement_value,
        DATE '2023-06-01' AS measurement_date
    FROM preprocessed
    WHERE _2023_06_float IS NOT NULL
    
    UNION ALL
    
    SELECT
        metadata,
        'Jul 2023' AS date_label,
        _2023_07_float AS measurement_value,
        DATE '2023-07-01' AS measurement_date
    FROM preprocessed
    WHERE _2023_07_float IS NOT NULL
    
    UNION ALL
    
    SELECT
        metadata,
        'Aug 2023' AS date_label,
        _2023_08_float AS measurement_value,
        DATE '2023-08-01' AS measurement_date
    FROM preprocessed
    WHERE _2023_08_float IS NOT NULL
    
    UNION ALL
    
    SELECT
        metadata,
        'Sep 2023' AS date_label,
        _2023_09_float AS measurement_value,
        DATE '2023-09-01' AS measurement_date
    FROM preprocessed
    WHERE _2023_09_float IS NOT NULL
    
    UNION ALL
    
    SELECT
        metadata,
        'Oct 2023' AS date_label,
        _2023_10_float AS measurement_value,
        DATE '2023-10-01' AS measurement_date
    FROM preprocessed
    WHERE _2023_10_float IS NOT NULL
    
    UNION ALL
    
    SELECT
        metadata,
        'Nov 2023' AS date_label,
        _2023_11_float AS measurement_value,
        DATE '2023-11-01' AS measurement_date
    FROM preprocessed
    WHERE _2023_11_float IS NOT NULL
    
    UNION ALL
    
    SELECT
        metadata,
        'Dec 2023' AS date_label,
        _2023_12_float AS measurement_value,
        DATE '2023-12-01' AS measurement_date
    FROM preprocessed
    WHERE _2023_12_float IS NOT NULL
    
    UNION ALL
    
    SELECT
        metadata,
        'Jan 2024' AS date_label,
        _2024_01_float AS measurement_value,
        DATE '2024-01-01' AS measurement_date
    FROM preprocessed
    WHERE _2024_01_float IS NOT NULL
    
    UNION ALL
    
    SELECT
        metadata,
        'Feb 2024' AS date_label,
        _2024_02_float AS measurement_value,
        DATE '2024-02-01' AS measurement_date
    FROM preprocessed
    WHERE _2024_02_float IS NOT NULL
    
    UNION ALL
    
    SELECT
        metadata,
        'Mar 2024' AS date_label,
        _2024_03_float AS measurement_value,
        DATE '2024-03-01' AS measurement_date
    FROM preprocessed
    WHERE _2024_03_float IS NOT NULL
    
    UNION ALL
    
    SELECT
        metadata,
        'Apr 2024' AS date_label,
        _2024_04_float AS measurement_value,
        DATE '2024-04-01' AS measurement_date
    FROM preprocessed
    WHERE _2024_04_float IS NOT NULL
    
    UNION ALL
    
    SELECT
        metadata,
        'May 2024' AS date_label,
        _2024_05_float AS measurement_value,
        DATE '2024-05-01' AS measurement_date
    FROM preprocessed
    WHERE _2024_05_float IS NOT NULL
    
    UNION ALL
    
    SELECT
        metadata,
        'Jun 2024' AS date_label,
        _2024_06_float AS measurement_value,
        DATE '2024-06-01' AS measurement_date
    FROM preprocessed
    WHERE _2024_06_float IS NOT NULL
    
    UNION ALL
    
    SELECT
        metadata,
        'Jul 2024' AS date_label,
        _2024_07_float AS measurement_value,
        DATE '2024-07-01' AS measurement_date
    FROM preprocessed
    WHERE _2024_07_float IS NOT NULL
    
    UNION ALL
    
    SELECT
        metadata,
        'Aug 2024' AS date_label,
        _2024_08_float AS measurement_value,
        DATE '2024-08-01' AS measurement_date
    FROM preprocessed
    WHERE _2024_08_float IS NOT NULL
    
    UNION ALL
    
    SELECT
        metadata,
        'Sep 2024' AS date_label,
        _2024_09_float AS measurement_value,
        DATE '2024-09-01' AS measurement_date
    FROM preprocessed
    WHERE _2024_09_float IS NOT NULL
    
    UNION ALL
    
    SELECT
        metadata,
        'Oct 2024' AS date_label,
        _2024_10_float AS measurement_value,
        DATE '2024-10-01' AS measurement_date
    FROM preprocessed
    WHERE _2024_10_float IS NOT NULL
    
    UNION ALL
    
    SELECT
        metadata,
        'Nov 2024' AS date_label,
        _2024_11_float AS measurement_value,
        DATE '2024-11-01' AS measurement_date
    FROM preprocessed
    WHERE _2024_11_float IS NOT NULL
    
    UNION ALL
    
    SELECT
        metadata,
        'Dec 2024' AS date_label,
        _2024_12_float AS measurement_value,
        DATE '2024-12-01' AS measurement_date
    FROM preprocessed
    WHERE _2024_12_float IS NOT NULL
    
    UNION ALL
    
    SELECT
        metadata,
        'Jan 2025' AS date_label,
        _2025_01_float AS measurement_value,
        DATE '2025-01-01' AS measurement_date
    FROM preprocessed
    WHERE _2025_01_float IS NOT NULL
    
    UNION ALL
    
    SELECT
        metadata,
        'Feb 2025' AS date_label,
        _2025_02_float AS measurement_value,
        DATE '2025-02-01' AS measurement_date
    FROM preprocessed
    WHERE _2025_02_float IS NOT NULL
    
),


date_transformed AS (
    SELECT
        metadata,
        -- Convert column name to date (remove leading/trailing underscores and convert to date)
        DATE(CONCAT(
            SUBSTR(REPLACE(date_column, '_', ''), 1, 4), '-',
            SUBSTR(REPLACE(date_column, '_', ''), 5, 2), '-01'
        )) AS measurement_date,
        -- Handle colon values by converting them to NULL before casting to FLOAT64
        CASE 
            WHEN measurement_value = ':' THEN NULL
            ELSE SAFE_CAST(measurement_value AS FLOAT64)
        END AS measurement_value,
        CURRENT_TIMESTAMP() AS load_timestamp
    FROM unpivoted
    -- Filter out NULL values but keep rows where the value was a colon (now NULL)
    WHERE measurement_value IS NOT NULL OR measurement_value = ':'
),

metadata_extracted AS (
    SELECT
        -- Extract metadata components
        SPLIT(metadata, ',')[SAFE_OFFSET(0)] AS frequency,
        SPLIT(metadata, ',')[SAFE_OFFSET(1)] AS airpol,
        SPLIT(metadata, ',')[SAFE_OFFSET(2)] AS unit,
        SPLIT(metadata, ',')[SAFE_OFFSET(3)] AS geo_code,
        date_label,
        measurement_date,
        measurement_value,
        CURRENT_TIMESTAMP() AS load_timestamp
    FROM unpivoted
)

SELECT
    ROW_NUMBER() OVER() AS id,
    frequency,
    airpol,
    unit,
    geo_code,
    date_label,
    measurement_date,
    measurement_value,
    load_timestamp
FROM metadata_extracted
ORDER BY geo_code, measurement_date;


[0m14:02:20.054960 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m14:02:20.629071 [debug] [Thread-1 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=data-talk-clubs&j=bq:EU:da1c1a37-da61-453e-a121-209a41a06a47&page=queryresults
[0m14:02:20.893061 [error] [Thread-1 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=data-talk-clubs&j=bq:EU:da1c1a37-da61-453e-a121-209a41a06a47&page=queryresults
[0m14:02:20.901758 [debug] [Thread-1 (]: Database Error in model stg_emissions_data (models/staging/stg_emissions_data.sql)
  No matching signature for function NULLIF
    Argument types: FLOAT64, STRING
    Signature: NULLIF(T1, T1)
      Unable to find common supertype for templated argument <T1>
        Input types for <T1>: {DOUBLE, STRING} at [19:19]
  compiled code at target/run/eu_emissions_project/models/staging/stg_emissions_data.sql
[0m14:02:20.903147 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3060e012-344a-442d-980f-e7f1868d1a82', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x136102450>]}
[0m14:02:20.903674 [error] [Thread-1 (]: 1 of 4 ERROR creating sql view model eu_emissions_project_staging.stg_emissions_data  [[31mERROR[0m in 0.87s]
[0m14:02:20.904015 [debug] [Thread-1 (]: Finished running node model.eu_emissions_project.stg_emissions_data
[0m14:02:20.904340 [debug] [Thread-11 ]: Marking all children of 'model.eu_emissions_project.stg_emissions_data' to be skipped because of status 'error'.  Reason: Database Error in model stg_emissions_data (models/staging/stg_emissions_data.sql)
  No matching signature for function NULLIF
    Argument types: FLOAT64, STRING
    Signature: NULLIF(T1, T1)
      Unable to find common supertype for templated argument <T1>
        Input types for <T1>: {DOUBLE, STRING} at [19:19]
  compiled code at target/run/eu_emissions_project/models/staging/stg_emissions_data.sql.
[0m14:02:20.905168 [debug] [Thread-3 (]: Began running node model.eu_emissions_project.int_emissions_cleaned
[0m14:02:20.905422 [debug] [Thread-4 (]: Began running node model.eu_emissions_project.int_emissions_unpivoted
[0m14:02:20.905741 [info ] [Thread-3 (]: 2 of 4 SKIP relation eu_emissions_project_intermediate.int_emissions_cleaned ... [[33mSKIP[0m]
[0m14:02:20.906025 [info ] [Thread-4 (]: 3 of 4 SKIP relation eu_emissions_project_intermediate.int_emissions_unpivoted . [[33mSKIP[0m]
[0m14:02:20.906285 [debug] [Thread-3 (]: Finished running node model.eu_emissions_project.int_emissions_cleaned
[0m14:02:20.906540 [debug] [Thread-4 (]: Finished running node model.eu_emissions_project.int_emissions_unpivoted
[0m14:02:20.907028 [debug] [Thread-6 (]: Began running node model.eu_emissions_project.emissions_analysis
[0m14:02:20.907300 [info ] [Thread-6 (]: 4 of 4 SKIP relation eu_emissions_project_marts.emissions_analysis ............. [[33mSKIP[0m]
[0m14:02:20.907642 [debug] [Thread-6 (]: Finished running node model.eu_emissions_project.emissions_analysis
[0m14:02:20.908391 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m14:02:20.909563 [debug] [MainThread]: Connection 'master' was properly closed.
[0m14:02:20.909899 [debug] [MainThread]: Connection 'model.eu_emissions_project.stg_emissions_data' was properly closed.
[0m14:02:20.910241 [debug] [MainThread]: Connection 'list_data-talk-clubs_eu_emissions_project_marts' was properly closed.
[0m14:02:20.910434 [debug] [MainThread]: Connection 'list_data-talk-clubs_eu_emissions_project_staging' was properly closed.
[0m14:02:20.910685 [info ] [MainThread]: 
[0m14:02:20.910891 [info ] [MainThread]: Finished running 2 table models, 2 view models in 0 hours 0 minutes and 1.65 seconds (1.65s).
[0m14:02:20.911288 [debug] [MainThread]: Command end result
[0m14:02:20.926617 [debug] [MainThread]: Wrote artifact WritableManifest to /Users/timbo/Documents/DataTalks/project/src/target/manifest.json
[0m14:02:20.927644 [debug] [MainThread]: Wrote artifact SemanticManifest to /Users/timbo/Documents/DataTalks/project/src/target/semantic_manifest.json
[0m14:02:20.930463 [debug] [MainThread]: Wrote artifact RunExecutionResult to /Users/timbo/Documents/DataTalks/project/src/target/run_results.json
[0m14:02:20.930661 [info ] [MainThread]: 
[0m14:02:20.930875 [info ] [MainThread]: [31mCompleted with 1 error, 0 partial successes, and 0 warnings:[0m
[0m14:02:20.931055 [info ] [MainThread]: 
[0m14:02:20.931277 [error] [MainThread]:   Database Error in model stg_emissions_data (models/staging/stg_emissions_data.sql)
  No matching signature for function NULLIF
    Argument types: FLOAT64, STRING
    Signature: NULLIF(T1, T1)
      Unable to find common supertype for templated argument <T1>
        Input types for <T1>: {DOUBLE, STRING} at [19:19]
  compiled code at target/run/eu_emissions_project/models/staging/stg_emissions_data.sql
[0m14:02:20.931462 [info ] [MainThread]: 
[0m14:02:20.931643 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=3 TOTAL=4
[0m14:02:20.933229 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": false, "command_wall_clock_time": 2.8817077, "process_in_blocks": "0", "process_kernel_time": 0.334415, "process_mem_max_rss": "212418560", "process_out_blocks": "0", "process_user_time": 1.739015}
[0m14:02:20.933582 [debug] [MainThread]: Command `dbt run` failed at 14:02:20.933534 after 2.88 seconds
[0m14:02:20.933865 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1045fa010>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110cc9c10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110ccbbd0>]}
[0m14:02:20.934096 [debug] [MainThread]: Flushing usage events
[0m14:02:21.367643 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m14:15:32.834197 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10686ebd0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1068cb590>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10657ced0>]}


============================== 14:15:32.837174 | eac59194-d696-45af-9c0a-6a8831e3f7e1 ==============================
[0m14:15:32.837174 [info ] [MainThread]: Running with dbt=1.9.3
[0m14:15:32.837548 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'fail_fast': 'False', 'debug': 'False', 'log_path': '/Users/timbo/Documents/DataTalks/project/src/logs', 'version_check': 'True', 'profiles_dir': '/Users/timbo/.dbt', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'empty': 'False', 'log_format': 'default', 'introspect': 'True', 'static_parser': 'True', 'invocation_command': 'dbt run', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m14:15:33.425749 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'eac59194-d696-45af-9c0a-6a8831e3f7e1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11539cf50>]}
[0m14:15:33.452525 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'eac59194-d696-45af-9c0a-6a8831e3f7e1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x102f9ba50>]}
[0m14:15:33.453029 [info ] [MainThread]: Registered adapter: bigquery=1.9.1
[0m14:15:33.542424 [debug] [MainThread]: checksum: 5671c00892cdbcef29c3b00cc5ba7510c3d18a35c883caeb9ab9ee266dc29c8f, vars: {}, profile: , target: , version: 1.9.3
[0m14:15:33.646673 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m14:15:33.647094 [debug] [MainThread]: Partial parsing: updated file: eu_emissions_project://models/staging/stg_emissions_data.sql
[0m14:15:33.800851 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'eac59194-d696-45af-9c0a-6a8831e3f7e1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11634cc10>]}
[0m14:15:33.836952 [debug] [MainThread]: Wrote artifact WritableManifest to /Users/timbo/Documents/DataTalks/project/src/target/manifest.json
[0m14:15:33.838681 [debug] [MainThread]: Wrote artifact SemanticManifest to /Users/timbo/Documents/DataTalks/project/src/target/semantic_manifest.json
[0m14:15:33.848780 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'eac59194-d696-45af-9c0a-6a8831e3f7e1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1166c4590>]}
[0m14:15:33.849091 [info ] [MainThread]: Found 4 models, 1 source, 491 macros
[0m14:15:33.849309 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'eac59194-d696-45af-9c0a-6a8831e3f7e1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11632bb10>]}
[0m14:15:33.850190 [info ] [MainThread]: 
[0m14:15:33.850402 [info ] [MainThread]: Concurrency: 8 threads (target='dev')
[0m14:15:33.850577 [info ] [MainThread]: 
[0m14:15:33.850851 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m14:15:33.852931 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_data-talk-clubs'
[0m14:15:33.853338 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_data-talk-clubs'
[0m14:15:33.853604 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m14:15:33.853909 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_data-talk-clubs'
[0m14:15:33.854163 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m14:15:33.854439 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m14:15:34.385687 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_data-talk-clubs, now list_data-talk-clubs_eu_emissions_project_intermediate)
[0m14:15:34.386473 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_data-talk-clubs, now list_data-talk-clubs_eu_emissions_project_marts)
[0m14:15:34.387169 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_data-talk-clubs, now list_data-talk-clubs_eu_emissions_project_staging)
[0m14:15:34.387475 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m14:15:34.387700 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m14:15:34.387890 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m14:15:34.678972 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'eac59194-d696-45af-9c0a-6a8831e3f7e1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x115ad5e50>]}
[0m14:15:34.679433 [debug] [MainThread]: Opening a new connection, currently in state init
[0m14:15:34.682495 [debug] [Thread-1 (]: Began running node model.eu_emissions_project.stg_emissions_data
[0m14:15:34.682797 [info ] [Thread-1 (]: 1 of 4 START sql view model eu_emissions_project_staging.stg_emissions_data .... [RUN]
[0m14:15:34.683052 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_data-talk-clubs_eu_emissions_project_intermediate, now model.eu_emissions_project.stg_emissions_data)
[0m14:15:34.683263 [debug] [Thread-1 (]: Began compiling node model.eu_emissions_project.stg_emissions_data
[0m14:15:34.687581 [debug] [Thread-1 (]: Writing injected SQL for node "model.eu_emissions_project.stg_emissions_data"
[0m14:15:34.688010 [debug] [Thread-1 (]: Began executing node model.eu_emissions_project.stg_emissions_data
[0m14:15:34.702868 [debug] [Thread-1 (]: Writing runtime sql for node "model.eu_emissions_project.stg_emissions_data"
[0m14:15:34.703540 [debug] [Thread-1 (]: On model.eu_emissions_project.stg_emissions_data: /* {"app": "dbt", "dbt_version": "1.9.3", "profile_name": "big-query", "target_name": "dev", "node_id": "model.eu_emissions_project.stg_emissions_data"} */


  create or replace view `data-talk-clubs`.`eu_emissions_project_staging`.`stg_emissions_data`
  OPTIONS()
  as 

WITH source AS (
    SELECT 
        *
    FROM `data-talk-clubs`.`eu_emissions_project`.`nitrogen_dioxide_data`
),

-- First, prepare the data by converting columns to the right format for unpivoting
preprocessed AS (
    SELECT
        freq_airpol_unit_geo_TIME_PERIOD AS metadata,
        -- All other columns are measurement data columns
        *
    FROM source
),

-- Use UNPIVOT to transform the wide format to long format
unpivoted AS (
    SELECT
        metadata,
        REPLACE(col_name, '_', '') AS date_column,
        CASE WHEN col_value = ':' THEN NULL ELSE SAFE_CAST(col_value AS FLOAT64) END AS measurement_value,
        -- Extract month and year from column name and create a proper date
        DATE(CONCAT(
            SUBSTR(REPLACE(col_name, '_', ''), 1, 4), '-',
            SUBSTR(REPLACE(col_name, '_', ''), 5, 2), '-01'
        )) AS measurement_date,
        -- Create a readable date label (e.g., 'Jan 2018')
        CONCAT(
            FORMAT_DATE('%b', DATE(CONCAT(
                SUBSTR(REPLACE(col_name, '_', ''), 1, 4), '-',
                SUBSTR(REPLACE(col_name, '_', ''), 5, 2), '-01'
            ))),
            ' ',
            SUBSTR(REPLACE(col_name, '_', ''), 1, 4)
        ) AS date_label
    FROM preprocessed
    UNPIVOT(
        col_value FOR col_name IN (
            _2018_01_, _2018_02_, _2018_03_, _2018_04_, _2018_05_, _2018_06_,
            _2018_07_, _2018_08_, _2018_09_, _2018_10_, _2018_11_, _2018_12_,
            _2019_01_, _2019_02_, _2019_03_, _2019_04_, _2019_05_, _2019_06_,
            _2019_07_, _2019_08_, _2019_09_, _2019_10_, _2019_11_, _2019_12_,
            _2020_01_, _2020_02_, _2020_03_, _2020_04_, _2020_05_, _2020_06_,
            _2020_07_, _2020_08_, _2020_09_, _2020_10_, _2020_11_, _2020_12_,
            _2021_01_, _2021_02_, _2021_03_, _2021_04_, _2021_05_, _2021_06_,
            _2021_07_, _2021_08_, _2021_09_, _2021_10_, _2021_11_, _2021_12_,
            _2022_01_, _2022_02_, _2022_03_, _2022_04_, _2022_05_, _2022_06_,
            _2022_07_, _2022_08_, _2022_09_, _2022_10_, _2022_11_, _2022_12_,
            _2023_01_, _2023_02_, _2023_03_, _2023_04_, _2023_05_, _2023_06_,
            _2023_07_, _2023_08_, _2023_09_, _2023_10_, _2023_11_, _2023_12_,
            _2024_01_, _2024_02_, _2024_03_, _2024_04_, _2024_05_, _2024_06_,
            _2024_07_, _2024_08_, _2024_09_, _2024_10_, _2024_11_, _2024_12_,
            _2025_01_, _2025_02_
        )
    )
    -- Filter out NULL values (which were originally ':' values)
    WHERE col_value != ':' AND col_value IS NOT NULL
),

metadata_extracted AS (
    SELECT
        -- Extract metadata components
        SPLIT(metadata, ',')[SAFE_OFFSET(0)] AS frequency,
        SPLIT(metadata, ',')[SAFE_OFFSET(1)] AS airpol,
        SPLIT(metadata, ',')[SAFE_OFFSET(2)] AS unit,
        SPLIT(metadata, ',')[SAFE_OFFSET(3)] AS geo_code,
        date_label,
        measurement_date,
        measurement_value,
        CURRENT_TIMESTAMP() AS load_timestamp
    FROM unpivoted
)

SELECT
    ROW_NUMBER() OVER() AS id,
    frequency,
    airpol,
    unit,
    geo_code,
    date_label,
    measurement_date,
    measurement_value,
    load_timestamp
FROM metadata_extracted
ORDER BY geo_code, measurement_date;


[0m14:15:34.703897 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m14:15:35.322612 [debug] [Thread-1 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=data-talk-clubs&j=bq:EU:bfbb14dd-6366-4724-9ec9-667d38b39834&page=queryresults
[0m14:15:35.434828 [error] [Thread-1 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=data-talk-clubs&j=bq:EU:bfbb14dd-6366-4724-9ec9-667d38b39834&page=queryresults
[0m14:15:35.442424 [debug] [Thread-1 (]: Database Error in model stg_emissions_data (models/staging/stg_emissions_data.sql)
  The datatype of column does not match with other datatypes in the IN clause. Expected FLOAT64, Found STRING at [46:57]
  compiled code at target/run/eu_emissions_project/models/staging/stg_emissions_data.sql
[0m14:15:35.443976 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'eac59194-d696-45af-9c0a-6a8831e3f7e1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1162dfc90>]}
[0m14:15:35.444839 [error] [Thread-1 (]: 1 of 4 ERROR creating sql view model eu_emissions_project_staging.stg_emissions_data  [[31mERROR[0m in 0.76s]
[0m14:15:35.445620 [debug] [Thread-1 (]: Finished running node model.eu_emissions_project.stg_emissions_data
[0m14:15:35.446173 [debug] [Thread-11 ]: Marking all children of 'model.eu_emissions_project.stg_emissions_data' to be skipped because of status 'error'.  Reason: Database Error in model stg_emissions_data (models/staging/stg_emissions_data.sql)
  The datatype of column does not match with other datatypes in the IN clause. Expected FLOAT64, Found STRING at [46:57]
  compiled code at target/run/eu_emissions_project/models/staging/stg_emissions_data.sql.
[0m14:15:35.447055 [debug] [Thread-3 (]: Began running node model.eu_emissions_project.int_emissions_cleaned
[0m14:15:35.447589 [info ] [Thread-3 (]: 2 of 4 SKIP relation eu_emissions_project_intermediate.int_emissions_cleaned ... [[33mSKIP[0m]
[0m14:15:35.447999 [debug] [Thread-4 (]: Began running node model.eu_emissions_project.int_emissions_unpivoted
[0m14:15:35.448378 [debug] [Thread-3 (]: Finished running node model.eu_emissions_project.int_emissions_cleaned
[0m14:15:35.448706 [info ] [Thread-4 (]: 3 of 4 SKIP relation eu_emissions_project_intermediate.int_emissions_unpivoted . [[33mSKIP[0m]
[0m14:15:35.449070 [debug] [Thread-4 (]: Finished running node model.eu_emissions_project.int_emissions_unpivoted
[0m14:15:35.449628 [debug] [Thread-6 (]: Began running node model.eu_emissions_project.emissions_analysis
[0m14:15:35.449920 [info ] [Thread-6 (]: 4 of 4 SKIP relation eu_emissions_project_marts.emissions_analysis ............. [[33mSKIP[0m]
[0m14:15:35.450162 [debug] [Thread-6 (]: Finished running node model.eu_emissions_project.emissions_analysis
[0m14:15:35.450895 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m14:15:35.451843 [debug] [MainThread]: Connection 'master' was properly closed.
[0m14:15:35.452062 [debug] [MainThread]: Connection 'model.eu_emissions_project.stg_emissions_data' was properly closed.
[0m14:15:35.452236 [debug] [MainThread]: Connection 'list_data-talk-clubs_eu_emissions_project_marts' was properly closed.
[0m14:15:35.452398 [debug] [MainThread]: Connection 'list_data-talk-clubs_eu_emissions_project_staging' was properly closed.
[0m14:15:35.452615 [info ] [MainThread]: 
[0m14:15:35.452819 [info ] [MainThread]: Finished running 2 table models, 2 view models in 0 hours 0 minutes and 1.60 seconds (1.60s).
[0m14:15:35.453201 [debug] [MainThread]: Command end result
[0m14:15:35.468041 [debug] [MainThread]: Wrote artifact WritableManifest to /Users/timbo/Documents/DataTalks/project/src/target/manifest.json
[0m14:15:35.469267 [debug] [MainThread]: Wrote artifact SemanticManifest to /Users/timbo/Documents/DataTalks/project/src/target/semantic_manifest.json
[0m14:15:35.472286 [debug] [MainThread]: Wrote artifact RunExecutionResult to /Users/timbo/Documents/DataTalks/project/src/target/run_results.json
[0m14:15:35.472568 [info ] [MainThread]: 
[0m14:15:35.472792 [info ] [MainThread]: [31mCompleted with 1 error, 0 partial successes, and 0 warnings:[0m
[0m14:15:35.472983 [info ] [MainThread]: 
[0m14:15:35.473198 [error] [MainThread]:   Database Error in model stg_emissions_data (models/staging/stg_emissions_data.sql)
  The datatype of column does not match with other datatypes in the IN clause. Expected FLOAT64, Found STRING at [46:57]
  compiled code at target/run/eu_emissions_project/models/staging/stg_emissions_data.sql
[0m14:15:35.473377 [info ] [MainThread]: 
[0m14:15:35.473559 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=3 TOTAL=4
[0m14:15:35.475113 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": false, "command_wall_clock_time": 2.6765006, "process_in_blocks": "0", "process_kernel_time": 0.306174, "process_mem_max_rss": "210780160", "process_out_blocks": "0", "process_user_time": 1.691232}
[0m14:15:35.475428 [debug] [MainThread]: Command `dbt run` failed at 14:15:35.475383 after 2.68 seconds
[0m14:15:35.475664 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1068c2f50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x100fbe090>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x100dd88d0>]}
[0m14:15:35.475875 [debug] [MainThread]: Flushing usage events
[0m14:15:35.909805 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m14:17:54.991301 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11036df90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1103a0510>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1102750d0>]}


============================== 14:17:54.993715 | 2b9bcbb3-d7a9-47c1-be3d-d732f8cc71a0 ==============================
[0m14:17:54.993715 [info ] [MainThread]: Running with dbt=1.9.3
[0m14:17:54.994071 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'fail_fast': 'False', 'log_path': '/Users/timbo/Documents/DataTalks/project/src/logs', 'version_check': 'True', 'profiles_dir': '/Users/timbo/.dbt', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'empty': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'static_parser': 'True', 'invocation_command': 'dbt run', 'target_path': 'None', 'log_format': 'default', 'send_anonymous_usage_stats': 'True'}
[0m14:17:55.448692 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '2b9bcbb3-d7a9-47c1-be3d-d732f8cc71a0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x116cc8f50>]}
[0m14:17:55.475633 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '2b9bcbb3-d7a9-47c1-be3d-d732f8cc71a0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105074450>]}
[0m14:17:55.476084 [info ] [MainThread]: Registered adapter: bigquery=1.9.1
[0m14:17:55.561964 [debug] [MainThread]: checksum: 5671c00892cdbcef29c3b00cc5ba7510c3d18a35c883caeb9ab9ee266dc29c8f, vars: {}, profile: , target: , version: 1.9.3
[0m14:17:55.668404 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m14:17:55.668833 [debug] [MainThread]: Partial parsing: updated file: eu_emissions_project://models/staging/stg_emissions_data.sql
[0m14:17:55.820974 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '2b9bcbb3-d7a9-47c1-be3d-d732f8cc71a0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x120df8450>]}
[0m14:17:55.857357 [debug] [MainThread]: Wrote artifact WritableManifest to /Users/timbo/Documents/DataTalks/project/src/target/manifest.json
[0m14:17:55.859085 [debug] [MainThread]: Wrote artifact SemanticManifest to /Users/timbo/Documents/DataTalks/project/src/target/semantic_manifest.json
[0m14:17:55.865346 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '2b9bcbb3-d7a9-47c1-be3d-d732f8cc71a0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x120ef5850>]}
[0m14:17:55.865644 [info ] [MainThread]: Found 4 models, 1 source, 491 macros
[0m14:17:55.865852 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '2b9bcbb3-d7a9-47c1-be3d-d732f8cc71a0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x120ec3a10>]}
[0m14:17:55.866739 [info ] [MainThread]: 
[0m14:17:55.866953 [info ] [MainThread]: Concurrency: 8 threads (target='dev')
[0m14:17:55.867123 [info ] [MainThread]: 
[0m14:17:55.867401 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m14:17:55.869416 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_data-talk-clubs'
[0m14:17:55.869812 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_data-talk-clubs'
[0m14:17:55.870127 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_data-talk-clubs'
[0m14:17:55.870362 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m14:17:55.870692 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m14:17:55.870933 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m14:17:56.350015 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_data-talk-clubs, now list_data-talk-clubs_eu_emissions_project_intermediate)
[0m14:17:56.350452 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_data-talk-clubs, now list_data-talk-clubs_eu_emissions_project_staging)
[0m14:17:56.350759 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m14:17:56.351019 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_data-talk-clubs, now list_data-talk-clubs_eu_emissions_project_marts)
[0m14:17:56.351257 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m14:17:56.351540 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m14:17:56.649768 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '2b9bcbb3-d7a9-47c1-be3d-d732f8cc71a0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1209f73d0>]}
[0m14:17:56.650202 [debug] [MainThread]: Opening a new connection, currently in state init
[0m14:17:56.652206 [debug] [Thread-1 (]: Began running node model.eu_emissions_project.stg_emissions_data
[0m14:17:56.652600 [info ] [Thread-1 (]: 1 of 4 START sql view model eu_emissions_project_staging.stg_emissions_data .... [RUN]
[0m14:17:56.652899 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_data-talk-clubs_eu_emissions_project_intermediate, now model.eu_emissions_project.stg_emissions_data)
[0m14:17:56.653106 [debug] [Thread-1 (]: Began compiling node model.eu_emissions_project.stg_emissions_data
[0m14:17:56.657569 [debug] [Thread-1 (]: Writing injected SQL for node "model.eu_emissions_project.stg_emissions_data"
[0m14:17:56.658032 [debug] [Thread-1 (]: Began executing node model.eu_emissions_project.stg_emissions_data
[0m14:17:56.672983 [debug] [Thread-1 (]: Writing runtime sql for node "model.eu_emissions_project.stg_emissions_data"
[0m14:17:56.673781 [debug] [Thread-1 (]: On model.eu_emissions_project.stg_emissions_data: /* {"app": "dbt", "dbt_version": "1.9.3", "profile_name": "big-query", "target_name": "dev", "node_id": "model.eu_emissions_project.stg_emissions_data"} */


  create or replace view `data-talk-clubs`.`eu_emissions_project_staging`.`stg_emissions_data`
  OPTIONS()
  as 

WITH source AS (
    SELECT 
        *
    FROM `data-talk-clubs`.`eu_emissions_project`.`nitrogen_dioxide_data`
),

-- First, prepare the data by converting columns to the right format for unpivoting
preprocessed AS (
    SELECT
        freq_airpol_unit_geo_TIME_PERIOD AS metadata,
        -- All other columns are measurement data columns
        *
    FROM source
),

-- Use UNPIVOT to transform the wide format to long format
unpivoted AS (
    SELECT
        metadata,
        col_name AS date_column,
        col_value AS measurement_value
    FROM preprocessed
    UNPIVOT(
        col_value FOR col_name IN (
            _2018_01_, _2018_02_, _2018_03_, _2018_04_, _2018_05_, _2018_06_,
            _2018_07_, _2018_08_, _2018_09_, _2018_10_, _2018_11_, _2018_12_,
            _2019_01_, _2019_02_, _2019_03_, _2019_04_, _2019_05_, _2019_06_,
            _2019_07_, _2019_08_, _2019_09_, _2019_10_, _2019_11_, _2019_12_,
            _2020_01_, _2020_02_, _2020_03_, _2020_04_, _2020_05_, _2020_06_,
            _2020_07_, _2020_08_, _2020_09_, _2020_10_, _2020_11_, _2020_12_,
            _2021_01_, _2021_02_, _2021_03_, _2021_04_, _2021_05_, _2021_06_,
            _2021_07_, _2021_08_, _2021_09_, _2021_10_, _2021_11_, _2021_12_,
            _2022_01_, _2022_02_, _2022_03_, _2022_04_, _2022_05_, _2022_06_,
            _2022_07_, _2022_08_, _2022_09_, _2022_10_, _2022_11_, _2022_12_,
            _2023_01_, _2023_02_, _2023_03_, _2023_04_, _2023_05_, _2023_06_,
            _2023_07_, _2023_08_, _2023_09_, _2023_10_, _2023_11_, _2023_12_,
            _2024_01_, _2024_02_, _2024_03_, _2024_04_, _2024_05_, _2024_06_,
            _2024_07_, _2024_08_, _2024_09_, _2024_10_, _2024_11_, _2024_12_,
            _2025_01_, _2025_02_
        )
    )
    -- Filter out colon values
    WHERE col_value != ':'
),

-- Process the date and value after unpivoting
processed_measurements AS (
    SELECT
        metadata,
        -- Clean up column name by removing underscores
        REPLACE(date_column, '_', '') AS clean_date_column,
        -- Keep measurement value as string for now
        measurement_value,
        -- Extract month and year from column name and create a proper date
        DATE(CONCAT(
            SUBSTR(REPLACE(date_column, '_', ''), 1, 4), '-',
            SUBSTR(REPLACE(date_column, '_', ''), 5, 2), '-01'
        )) AS measurement_date,
        -- Create a readable date label (e.g., 'Jan 2018')
        CONCAT(
            FORMAT_DATE('%b', DATE(CONCAT(
                SUBSTR(REPLACE(date_column, '_', ''), 1, 4), '-',
                SUBSTR(REPLACE(date_column, '_', ''), 5, 2), '-01'
            ))),
            ' ',
            SUBSTR(REPLACE(date_column, '_', ''), 1, 4)
        ) AS date_label
    FROM unpivoted
),

metadata_extracted AS (
    SELECT
        -- Extract metadata components
        SPLIT(metadata, ',')[SAFE_OFFSET(0)] AS frequency,
        SPLIT(metadata, ',')[SAFE_OFFSET(1)] AS airpol,
        SPLIT(metadata, ',')[SAFE_OFFSET(2)] AS unit,
        SPLIT(metadata, ',')[SAFE_OFFSET(3)] AS geo_code,
        date_label,
        measurement_date,
        -- Convert measurement value to FLOAT64 here, after unpivoting
        SAFE_CAST(measurement_value AS FLOAT64) AS measurement_value,
        CURRENT_TIMESTAMP() AS load_timestamp
    FROM processed_measurements
)

SELECT
    ROW_NUMBER() OVER() AS id,
    frequency,
    airpol,
    unit,
    geo_code,
    date_label,
    measurement_date,
    measurement_value,
    load_timestamp
FROM metadata_extracted
ORDER BY geo_code, measurement_date;


[0m14:17:56.674154 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m14:17:57.223325 [debug] [Thread-1 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=data-talk-clubs&j=bq:EU:e0762a10-093d-4116-894c-74e4937bd38c&page=queryresults
[0m14:17:57.321668 [error] [Thread-1 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=data-talk-clubs&j=bq:EU:e0762a10-093d-4116-894c-74e4937bd38c&page=queryresults
[0m14:17:57.326510 [debug] [Thread-1 (]: Database Error in model stg_emissions_data (models/staging/stg_emissions_data.sql)
  The datatype of column does not match with other datatypes in the IN clause. Expected FLOAT64, Found STRING at [32:57]
  compiled code at target/run/eu_emissions_project/models/staging/stg_emissions_data.sql
[0m14:17:57.327545 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '2b9bcbb3-d7a9-47c1-be3d-d732f8cc71a0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x120fb1050>]}
[0m14:17:57.328098 [error] [Thread-1 (]: 1 of 4 ERROR creating sql view model eu_emissions_project_staging.stg_emissions_data  [[31mERROR[0m in 0.67s]
[0m14:17:57.328424 [debug] [Thread-1 (]: Finished running node model.eu_emissions_project.stg_emissions_data
[0m14:17:57.328693 [debug] [Thread-11 ]: Marking all children of 'model.eu_emissions_project.stg_emissions_data' to be skipped because of status 'error'.  Reason: Database Error in model stg_emissions_data (models/staging/stg_emissions_data.sql)
  The datatype of column does not match with other datatypes in the IN clause. Expected FLOAT64, Found STRING at [32:57]
  compiled code at target/run/eu_emissions_project/models/staging/stg_emissions_data.sql.
[0m14:17:57.329478 [debug] [Thread-3 (]: Began running node model.eu_emissions_project.int_emissions_cleaned
[0m14:17:57.329824 [info ] [Thread-3 (]: 2 of 4 SKIP relation eu_emissions_project_intermediate.int_emissions_cleaned ... [[33mSKIP[0m]
[0m14:17:57.330100 [debug] [Thread-4 (]: Began running node model.eu_emissions_project.int_emissions_unpivoted
[0m14:17:57.330370 [debug] [Thread-3 (]: Finished running node model.eu_emissions_project.int_emissions_cleaned
[0m14:17:57.330603 [info ] [Thread-4 (]: 3 of 4 SKIP relation eu_emissions_project_intermediate.int_emissions_unpivoted . [[33mSKIP[0m]
[0m14:17:57.330895 [debug] [Thread-4 (]: Finished running node model.eu_emissions_project.int_emissions_unpivoted
[0m14:17:57.331214 [debug] [Thread-6 (]: Began running node model.eu_emissions_project.emissions_analysis
[0m14:17:57.331535 [info ] [Thread-6 (]: 4 of 4 SKIP relation eu_emissions_project_marts.emissions_analysis ............. [[33mSKIP[0m]
[0m14:17:57.331799 [debug] [Thread-6 (]: Finished running node model.eu_emissions_project.emissions_analysis
[0m14:17:57.332711 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m14:17:57.333892 [debug] [MainThread]: Connection 'master' was properly closed.
[0m14:17:57.334128 [debug] [MainThread]: Connection 'model.eu_emissions_project.stg_emissions_data' was properly closed.
[0m14:17:57.334297 [debug] [MainThread]: Connection 'list_data-talk-clubs_eu_emissions_project_staging' was properly closed.
[0m14:17:57.334461 [debug] [MainThread]: Connection 'list_data-talk-clubs_eu_emissions_project_marts' was properly closed.
[0m14:17:57.334681 [info ] [MainThread]: 
[0m14:17:57.334872 [info ] [MainThread]: Finished running 2 table models, 2 view models in 0 hours 0 minutes and 1.47 seconds (1.47s).
[0m14:17:57.335239 [debug] [MainThread]: Command end result
[0m14:17:57.347961 [debug] [MainThread]: Wrote artifact WritableManifest to /Users/timbo/Documents/DataTalks/project/src/target/manifest.json
[0m14:17:57.348841 [debug] [MainThread]: Wrote artifact SemanticManifest to /Users/timbo/Documents/DataTalks/project/src/target/semantic_manifest.json
[0m14:17:57.351525 [debug] [MainThread]: Wrote artifact RunExecutionResult to /Users/timbo/Documents/DataTalks/project/src/target/run_results.json
[0m14:17:57.351741 [info ] [MainThread]: 
[0m14:17:57.351959 [info ] [MainThread]: [31mCompleted with 1 error, 0 partial successes, and 0 warnings:[0m
[0m14:17:57.352277 [info ] [MainThread]: 
[0m14:17:57.352492 [error] [MainThread]:   Database Error in model stg_emissions_data (models/staging/stg_emissions_data.sql)
  The datatype of column does not match with other datatypes in the IN clause. Expected FLOAT64, Found STRING at [32:57]
  compiled code at target/run/eu_emissions_project/models/staging/stg_emissions_data.sql
[0m14:17:57.352900 [info ] [MainThread]: 
[0m14:17:57.353195 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=3 TOTAL=4
[0m14:17:57.354551 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": false, "command_wall_clock_time": 2.3977695, "process_in_blocks": "0", "process_kernel_time": 0.259778, "process_mem_max_rss": "211419136", "process_out_blocks": "0", "process_user_time": 1.699496}
[0m14:17:57.354843 [debug] [MainThread]: Command `dbt run` failed at 14:17:57.354797 after 2.40 seconds
[0m14:17:57.355097 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x102a4a090>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1103ed510>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1028ec790>]}
[0m14:17:57.355326 [debug] [MainThread]: Flushing usage events
[0m14:17:57.774640 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m14:26:25.013737 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111f6f8d0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111f6fb50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111fcbe10>]}


============================== 14:26:25.016758 | 01d6fb09-5ee7-4ae3-abd4-b9fb961f0ebc ==============================
[0m14:26:25.016758 [info ] [MainThread]: Running with dbt=1.9.3
[0m14:26:25.017167 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': '/Users/timbo/.dbt', 'fail_fast': 'False', 'debug': 'False', 'log_path': '/Users/timbo/Documents/DataTalks/project/src/logs', 'version_check': 'True', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'empty': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'log_format': 'default', 'invocation_command': 'dbt run -s stg_emissions_data', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m14:26:25.463298 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '01d6fb09-5ee7-4ae3-abd4-b9fb961f0ebc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x117c7e810>]}
[0m14:26:25.490235 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '01d6fb09-5ee7-4ae3-abd4-b9fb961f0ebc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1066a0290>]}
[0m14:26:25.490730 [info ] [MainThread]: Registered adapter: bigquery=1.9.1
[0m14:26:25.578052 [debug] [MainThread]: checksum: 5671c00892cdbcef29c3b00cc5ba7510c3d18a35c883caeb9ab9ee266dc29c8f, vars: {}, profile: , target: , version: 1.9.3
[0m14:26:25.683172 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m14:26:25.683621 [debug] [MainThread]: Partial parsing: updated file: eu_emissions_project://models/staging/stg_emissions_data.sql
[0m14:26:25.832654 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '01d6fb09-5ee7-4ae3-abd4-b9fb961f0ebc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1317c8bd0>]}
[0m14:26:25.869924 [debug] [MainThread]: Wrote artifact WritableManifest to /Users/timbo/Documents/DataTalks/project/src/target/manifest.json
[0m14:26:25.871649 [debug] [MainThread]: Wrote artifact SemanticManifest to /Users/timbo/Documents/DataTalks/project/src/target/semantic_manifest.json
[0m14:26:25.878751 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '01d6fb09-5ee7-4ae3-abd4-b9fb961f0ebc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1317fd690>]}
[0m14:26:25.879094 [info ] [MainThread]: Found 4 models, 1 source, 491 macros
[0m14:26:25.879316 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '01d6fb09-5ee7-4ae3-abd4-b9fb961f0ebc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107f2d690>]}
[0m14:26:25.880134 [info ] [MainThread]: 
[0m14:26:25.880366 [info ] [MainThread]: Concurrency: 8 threads (target='dev')
[0m14:26:25.880547 [info ] [MainThread]: 
[0m14:26:25.880831 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m14:26:25.881296 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_data-talk-clubs'
[0m14:26:25.881517 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m14:26:26.153665 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_data-talk-clubs, now list_data-talk-clubs_eu_emissions_project_staging)
[0m14:26:26.154129 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_data-talk-clubs_eu_emissions_project_intermediate'
[0m14:26:26.154405 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m14:26:26.154694 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_data-talk-clubs_eu_emissions_project_marts'
[0m14:26:26.154954 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m14:26:26.155245 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m14:26:26.442405 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '01d6fb09-5ee7-4ae3-abd4-b9fb961f0ebc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1318446d0>]}
[0m14:26:26.442948 [debug] [MainThread]: Opening a new connection, currently in state init
[0m14:26:26.445075 [debug] [Thread-1 (]: Began running node model.eu_emissions_project.stg_emissions_data
[0m14:26:26.445405 [info ] [Thread-1 (]: 1 of 1 START sql view model eu_emissions_project_staging.stg_emissions_data .... [RUN]
[0m14:26:26.445675 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_data-talk-clubs_eu_emissions_project_staging, now model.eu_emissions_project.stg_emissions_data)
[0m14:26:26.445884 [debug] [Thread-1 (]: Began compiling node model.eu_emissions_project.stg_emissions_data
[0m14:26:26.450329 [debug] [Thread-1 (]: Writing injected SQL for node "model.eu_emissions_project.stg_emissions_data"
[0m14:26:26.450851 [debug] [Thread-1 (]: Began executing node model.eu_emissions_project.stg_emissions_data
[0m14:26:26.465144 [debug] [Thread-1 (]: Writing runtime sql for node "model.eu_emissions_project.stg_emissions_data"
[0m14:26:26.465933 [debug] [Thread-1 (]: On model.eu_emissions_project.stg_emissions_data: /* {"app": "dbt", "dbt_version": "1.9.3", "profile_name": "big-query", "target_name": "dev", "node_id": "model.eu_emissions_project.stg_emissions_data"} */


  create or replace view `data-talk-clubs`.`eu_emissions_project_staging`.`stg_emissions_data`
  OPTIONS()
  as 

WITH source AS (
    SELECT 
        *
    FROM `data-talk-clubs`.`eu_emissions_project`.`nitrogen_dioxide_data`
),

-- First, prepare the data by converting columns to the right format for unpivoting
preprocessed AS (
    SELECT
        freq_airpol_unit_geo_TIME_PERIOD AS metadata,
        -- All other columns are measurement data columns
        *
    FROM source
),

-- Use UNPIVOT to transform the wide format to long format
unpivoted AS (
    SELECT
        metadata,
        col_name AS date_column,
        col_value AS measurement_value
    FROM preprocessed
    UNPIVOT(
        col_value FOR col_name IN (
            _2018_01_, _2018_02_, _2018_03_, _2018_04_, _2018_05_, _2018_06_,
            _2018_07_, _2018_08_, _2018_09_, _2018_10_, _2018_11_, _2018_12_,
            _2019_01_, _2019_02_, _2019_03_, _2019_04_, _2019_05_, _2019_06_,
            _2019_07_, _2019_08_, _2019_09_, _2019_10_, _2019_11_, _2019_12_,
            _2020_01_, _2020_02_, _2020_03_, _2020_04_, _2020_05_, _2020_06_,
            _2020_07_, _2020_08_, _2020_09_, _2020_10_, _2020_11_, _2020_12_,
            _2021_01_, _2021_02_, _2021_03_, _2021_04_, _2021_05_, _2021_06_,
            _2021_07_, _2021_08_, _2021_09_, _2021_10_, _2021_11_, _2021_12_,
            _2022_01_, _2022_02_, _2022_03_, _2022_04_, _2022_05_, _2022_06_,
            _2022_07_, _2022_08_, _2022_09_, _2022_10_, _2022_11_, _2022_12_,
            _2023_01_, _2023_02_, _2023_03_, _2023_04_, _2023_05_, _2023_06_,
            _2023_07_, _2023_08_, _2023_09_, _2023_10_, _2023_11_, _2023_12_,
            _2024_01_, _2024_02_, _2024_03_, _2024_04_, _2024_05_, _2024_06_,
            _2024_07_, _2024_08_, _2024_09_, _2024_10_, _2024_11_, _2024_12_,
            _2025_01_, _2025_02_
        )
    )
    -- Filter out colon values
    WHERE col_value != ':'
),

-- Process the date and value after unpivoting
processed_measurements AS (
    SELECT
        metadata,
        -- Clean up column name by removing underscores
        REPLACE(date_column, '_', '') AS clean_date_column,
        -- Keep measurement value as string for now
        measurement_value,
        -- Extract month and year from column name and create a proper date
        DATE(CONCAT(
            SUBSTR(REPLACE(date_column, '_', ''), 1, 4), '-',
            SUBSTR(REPLACE(date_column, '_', ''), 5, 2), '-01'
        )) AS measurement_date,
        -- Create a readable date label (e.g., 'Jan 2018')
        CONCAT(
            FORMAT_DATE('%b', DATE(CONCAT(
                SUBSTR(REPLACE(date_column, '_', ''), 1, 4), '-',
                SUBSTR(REPLACE(date_column, '_', ''), 5, 2), '-01'
            ))),
            ' ',
            SUBSTR(REPLACE(date_column, '_', ''), 1, 4)
        ) AS date_label
    FROM unpivoted
),

metadata_extracted AS (
    SELECT
        -- Extract metadata components
        SPLIT(metadata, ',')[SAFE_OFFSET(0)] AS frequency,
        SPLIT(metadata, ',')[SAFE_OFFSET(1)] AS airpol,
        SPLIT(metadata, ',')[SAFE_OFFSET(2)] AS unit,
        SPLIT(metadata, ',')[SAFE_OFFSET(3)] AS geo_code,
        date_label,
        measurement_date,
        -- Convert measurement value to FLOAT64 here, after unpivoting
        SAFE_CAST(measurement_value AS FLOAT64) AS measurement_value,
        CURRENT_TIMESTAMP() AS load_timestamp
    FROM processed_measurements
),

final AS (

SELECT
    ROW_NUMBER() OVER() AS id,
    frequency,
    airpol,
    unit,
    geo_code,
    date_label,
    measurement_date,
    measurement_value,
    load_timestamp
FROM metadata_extracted
ORDER BY geo_code, measurement_date
)

select * from unpivoted;


[0m14:26:26.466439 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m14:26:27.410179 [debug] [Thread-1 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=data-talk-clubs&j=bq:EU:236deabc-4363-4216-8fdb-21afcb9bc437&page=queryresults
[0m14:26:27.545222 [error] [Thread-1 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=data-talk-clubs&j=bq:EU:236deabc-4363-4216-8fdb-21afcb9bc437&page=queryresults
[0m14:26:27.548557 [debug] [Thread-1 (]: Database Error in model stg_emissions_data (models/staging/stg_emissions_data.sql)
  The datatype of column does not match with other datatypes in the IN clause. Expected FLOAT64, Found STRING at [32:57]
  compiled code at target/run/eu_emissions_project/models/staging/stg_emissions_data.sql
[0m14:26:27.549639 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '01d6fb09-5ee7-4ae3-abd4-b9fb961f0ebc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x131a6aad0>]}
[0m14:26:27.550087 [error] [Thread-1 (]: 1 of 1 ERROR creating sql view model eu_emissions_project_staging.stg_emissions_data  [[31mERROR[0m in 1.10s]
[0m14:26:27.550413 [debug] [Thread-1 (]: Finished running node model.eu_emissions_project.stg_emissions_data
[0m14:26:27.550906 [debug] [Thread-11 ]: Marking all children of 'model.eu_emissions_project.stg_emissions_data' to be skipped because of status 'error'.  Reason: Database Error in model stg_emissions_data (models/staging/stg_emissions_data.sql)
  The datatype of column does not match with other datatypes in the IN clause. Expected FLOAT64, Found STRING at [32:57]
  compiled code at target/run/eu_emissions_project/models/staging/stg_emissions_data.sql.
[0m14:26:27.552327 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m14:26:27.553265 [debug] [MainThread]: Connection 'master' was properly closed.
[0m14:26:27.553472 [debug] [MainThread]: Connection 'model.eu_emissions_project.stg_emissions_data' was properly closed.
[0m14:26:27.553643 [debug] [MainThread]: Connection 'list_data-talk-clubs_eu_emissions_project_intermediate' was properly closed.
[0m14:26:27.553806 [debug] [MainThread]: Connection 'list_data-talk-clubs_eu_emissions_project_marts' was properly closed.
[0m14:26:27.553986 [info ] [MainThread]: 
[0m14:26:27.554171 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 1.67 seconds (1.67s).
[0m14:26:27.554503 [debug] [MainThread]: Command end result
[0m14:26:27.567559 [debug] [MainThread]: Wrote artifact WritableManifest to /Users/timbo/Documents/DataTalks/project/src/target/manifest.json
[0m14:26:27.568619 [debug] [MainThread]: Wrote artifact SemanticManifest to /Users/timbo/Documents/DataTalks/project/src/target/semantic_manifest.json
[0m14:26:27.571303 [debug] [MainThread]: Wrote artifact RunExecutionResult to /Users/timbo/Documents/DataTalks/project/src/target/run_results.json
[0m14:26:27.571506 [info ] [MainThread]: 
[0m14:26:27.571751 [info ] [MainThread]: [31mCompleted with 1 error, 0 partial successes, and 0 warnings:[0m
[0m14:26:27.571945 [info ] [MainThread]: 
[0m14:26:27.572164 [error] [MainThread]:   Database Error in model stg_emissions_data (models/staging/stg_emissions_data.sql)
  The datatype of column does not match with other datatypes in the IN clause. Expected FLOAT64, Found STRING at [32:57]
  compiled code at target/run/eu_emissions_project/models/staging/stg_emissions_data.sql
[0m14:26:27.572612 [info ] [MainThread]: 
[0m14:26:27.572837 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m14:26:27.574167 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": false, "command_wall_clock_time": 2.5957694, "process_in_blocks": "0", "process_kernel_time": 0.249874, "process_mem_max_rss": "210747392", "process_out_blocks": "0", "process_user_time": 1.594135}
[0m14:26:27.574449 [debug] [MainThread]: Command `dbt run` failed at 14:26:27.574404 after 2.60 seconds
[0m14:26:27.574693 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10458a050>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111fef8d0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111d7d0d0>]}
[0m14:26:27.574927 [debug] [MainThread]: Flushing usage events
[0m14:26:28.002878 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m14:41:37.044378 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10606d890>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1060c3a50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1060cbfd0>]}


============================== 14:41:37.047014 | 9680ba64-3836-407b-b4e3-ad3704bdcfba ==============================
[0m14:41:37.047014 [info ] [MainThread]: Running with dbt=1.9.3
[0m14:41:37.047452 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'version_check': 'True', 'profiles_dir': '/Users/timbo/.dbt', 'log_path': '/Users/timbo/Documents/DataTalks/project/src/logs', 'debug': 'False', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'empty': 'False', 'quiet': 'False', 'no_print': 'None', 'log_format': 'default', 'static_parser': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt run -s stg_emissions_data', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m14:41:37.491390 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '9680ba64-3836-407b-b4e3-ad3704bdcfba', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1259c89d0>]}
[0m14:41:37.519515 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '9680ba64-3836-407b-b4e3-ad3704bdcfba', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x102d9c6d0>]}
[0m14:41:37.520054 [info ] [MainThread]: Registered adapter: bigquery=1.9.1
[0m14:41:37.610443 [debug] [MainThread]: checksum: 5671c00892cdbcef29c3b00cc5ba7510c3d18a35c883caeb9ab9ee266dc29c8f, vars: {}, profile: , target: , version: 1.9.3
[0m14:41:37.719875 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m14:41:37.720672 [debug] [MainThread]: Partial parsing: updated file: eu_emissions_project://models/staging/sources.yml
[0m14:41:37.930011 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '9680ba64-3836-407b-b4e3-ad3704bdcfba', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x12680d390>]}
[0m14:41:37.965316 [debug] [MainThread]: Wrote artifact WritableManifest to /Users/timbo/Documents/DataTalks/project/src/target/manifest.json
[0m14:41:37.968196 [debug] [MainThread]: Wrote artifact SemanticManifest to /Users/timbo/Documents/DataTalks/project/src/target/semantic_manifest.json
[0m14:41:37.975438 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '9680ba64-3836-407b-b4e3-ad3704bdcfba', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x126b082d0>]}
[0m14:41:37.975766 [info ] [MainThread]: Found 4 models, 1 source, 491 macros
[0m14:41:37.976047 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '9680ba64-3836-407b-b4e3-ad3704bdcfba', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1268faa50>]}
[0m14:41:37.976829 [info ] [MainThread]: 
[0m14:41:37.977043 [info ] [MainThread]: Concurrency: 8 threads (target='dev')
[0m14:41:37.977212 [info ] [MainThread]: 
[0m14:41:37.977472 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m14:41:37.977972 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_data-talk-clubs'
[0m14:41:37.978273 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m14:41:38.281462 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_data-talk-clubs, now list_data-talk-clubs_eu_emissions_project_staging)
[0m14:41:38.281882 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_data-talk-clubs_eu_emissions_project_marts'
[0m14:41:38.282186 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_data-talk-clubs_eu_emissions_project_intermediate'
[0m14:41:38.282446 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m14:41:38.282642 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m14:41:38.282842 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m14:41:38.592290 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '9680ba64-3836-407b-b4e3-ad3704bdcfba', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x126ab9c10>]}
[0m14:41:38.592733 [debug] [MainThread]: Opening a new connection, currently in state init
[0m14:41:38.594654 [debug] [Thread-1 (]: Began running node model.eu_emissions_project.stg_emissions_data
[0m14:41:38.594986 [info ] [Thread-1 (]: 1 of 1 START sql view model eu_emissions_project_staging.stg_emissions_data .... [RUN]
[0m14:41:38.595255 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_data-talk-clubs_eu_emissions_project_staging, now model.eu_emissions_project.stg_emissions_data)
[0m14:41:38.595470 [debug] [Thread-1 (]: Began compiling node model.eu_emissions_project.stg_emissions_data
[0m14:41:38.599912 [debug] [Thread-1 (]: Writing injected SQL for node "model.eu_emissions_project.stg_emissions_data"
[0m14:41:38.600437 [debug] [Thread-1 (]: Began executing node model.eu_emissions_project.stg_emissions_data
[0m14:41:38.616044 [debug] [Thread-1 (]: Writing runtime sql for node "model.eu_emissions_project.stg_emissions_data"
[0m14:41:38.616821 [debug] [Thread-1 (]: On model.eu_emissions_project.stg_emissions_data: /* {"app": "dbt", "dbt_version": "1.9.3", "profile_name": "big-query", "target_name": "dev", "node_id": "model.eu_emissions_project.stg_emissions_data"} */


  create or replace view `data-talk-clubs`.`eu_emissions_project_staging`.`stg_emissions_data`
  OPTIONS()
  as 

WITH source AS (
    SELECT 
        *
    FROM `data-talk-clubs`.`eu_emissions_project`.`nitrogen_dioxide_data`
),

-- First, prepare the data by converting columns to the right format for unpivoting
preprocessed AS (
    SELECT
        freq_airpol_unit_geo_TIME_PERIOD AS metadata,
        -- All other columns are measurement data columns
        *
    FROM source
),

-- Use UNPIVOT to transform the wide format to long format
unpivoted AS (
    SELECT
        metadata,
        col_name AS date_column,
        col_value AS measurement_value
    FROM preprocessed
    UNPIVOT(
        col_value FOR col_name IN (
            _2018_01_, _2018_02_, _2018_03_, _2018_04_, _2018_05_, _2018_06_,
            _2018_07_, _2018_08_, _2018_09_, _2018_10_, _2018_11_, _2018_12_,
            _2019_01_, _2019_02_, _2019_03_, _2019_04_, _2019_05_, _2019_06_,
            _2019_07_, _2019_08_, _2019_09_, _2019_10_, _2019_11_, _2019_12_,
            _2020_01_, _2020_02_, _2020_03_, _2020_04_, _2020_05_, _2020_06_,
            _2020_07_, _2020_08_, _2020_09_, _2020_10_, _2020_11_, _2020_12_,
            _2021_01_, _2021_02_, _2021_03_, _2021_04_, _2021_05_, _2021_06_,
            _2021_07_, _2021_08_, _2021_09_, _2021_10_, _2021_11_, _2021_12_,
            _2022_01_, _2022_02_, _2022_03_, _2022_04_, _2022_05_, _2022_06_,
            _2022_07_, _2022_08_, _2022_09_, _2022_10_, _2022_11_, _2022_12_,
            _2023_01_, _2023_02_, _2023_03_, _2023_04_, _2023_05_, _2023_06_,
            _2023_07_, _2023_08_, _2023_09_, _2023_10_, _2023_11_, _2023_12_,
            _2024_01_, _2024_02_, _2024_03_, _2024_04_, _2024_05_, _2024_06_,
            _2024_07_, _2024_08_, _2024_09_, _2024_10_, _2024_11_, _2024_12_,
            _2025_01_, _2025_02_
        )
    )
    -- Filter out colon values
    WHERE col_value != ':'
),

-- Process the date and value after unpivoting
processed_measurements AS (
    SELECT
        metadata,
        -- Clean up column name by removing underscores
        REPLACE(date_column, '_', '') AS clean_date_column,
        -- Keep measurement value as string for now
        measurement_value,
        -- Extract month and year from column name and create a proper date
        DATE(CONCAT(
            SUBSTR(REPLACE(date_column, '_', ''), 1, 4), '-',
            SUBSTR(REPLACE(date_column, '_', ''), 5, 2), '-01'
        )) AS measurement_date,
        -- Create a readable date label (e.g., 'Jan 2018')
        CONCAT(
            FORMAT_DATE('%b', DATE(CONCAT(
                SUBSTR(REPLACE(date_column, '_', ''), 1, 4), '-',
                SUBSTR(REPLACE(date_column, '_', ''), 5, 2), '-01'
            ))),
            ' ',
            SUBSTR(REPLACE(date_column, '_', ''), 1, 4)
        ) AS date_label
    FROM unpivoted
),

metadata_extracted AS (
    SELECT
        -- Extract metadata components
        SPLIT(metadata, ',')[SAFE_OFFSET(0)] AS frequency,
        SPLIT(metadata, ',')[SAFE_OFFSET(1)] AS airpol,
        SPLIT(metadata, ',')[SAFE_OFFSET(2)] AS unit,
        SPLIT(metadata, ',')[SAFE_OFFSET(3)] AS geo_code,
        date_label,
        measurement_date,
        -- Convert measurement value to FLOAT64 here, after unpivoting
        SAFE_CAST(measurement_value AS FLOAT64) AS measurement_value,
        CURRENT_TIMESTAMP() AS load_timestamp
    FROM processed_measurements
),

final AS (

SELECT
    ROW_NUMBER() OVER() AS id,
    frequency,
    airpol,
    unit,
    geo_code,
    date_label,
    measurement_date,
    measurement_value,
    load_timestamp
FROM metadata_extracted
ORDER BY geo_code, measurement_date
)

select * from unpivoted;


[0m14:41:38.617212 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m14:41:39.240198 [debug] [Thread-1 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=data-talk-clubs&j=bq:EU:4e7a973f-7a40-41b5-bb84-a1fbb1535cd7&page=queryresults
[0m14:41:39.343145 [error] [Thread-1 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=data-talk-clubs&j=bq:EU:4e7a973f-7a40-41b5-bb84-a1fbb1535cd7&page=queryresults
[0m14:41:39.347863 [debug] [Thread-1 (]: Database Error in model stg_emissions_data (models/staging/stg_emissions_data.sql)
  The datatype of column does not match with other datatypes in the IN clause. Expected FLOAT64, Found STRING at [32:57]
  compiled code at target/run/eu_emissions_project/models/staging/stg_emissions_data.sql
[0m14:41:39.348912 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9680ba64-3836-407b-b4e3-ad3704bdcfba', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x126e59bd0>]}
[0m14:41:39.349336 [error] [Thread-1 (]: 1 of 1 ERROR creating sql view model eu_emissions_project_staging.stg_emissions_data  [[31mERROR[0m in 0.75s]
[0m14:41:39.349869 [debug] [Thread-1 (]: Finished running node model.eu_emissions_project.stg_emissions_data
[0m14:41:39.350312 [debug] [Thread-11 ]: Marking all children of 'model.eu_emissions_project.stg_emissions_data' to be skipped because of status 'error'.  Reason: Database Error in model stg_emissions_data (models/staging/stg_emissions_data.sql)
  The datatype of column does not match with other datatypes in the IN clause. Expected FLOAT64, Found STRING at [32:57]
  compiled code at target/run/eu_emissions_project/models/staging/stg_emissions_data.sql.
[0m14:41:39.351674 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m14:41:39.352652 [debug] [MainThread]: Connection 'master' was properly closed.
[0m14:41:39.352852 [debug] [MainThread]: Connection 'model.eu_emissions_project.stg_emissions_data' was properly closed.
[0m14:41:39.353143 [debug] [MainThread]: Connection 'list_data-talk-clubs_eu_emissions_project_marts' was properly closed.
[0m14:41:39.353319 [debug] [MainThread]: Connection 'list_data-talk-clubs_eu_emissions_project_intermediate' was properly closed.
[0m14:41:39.353503 [info ] [MainThread]: 
[0m14:41:39.353699 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 1.38 seconds (1.38s).
[0m14:41:39.354028 [debug] [MainThread]: Command end result
[0m14:41:39.367235 [debug] [MainThread]: Wrote artifact WritableManifest to /Users/timbo/Documents/DataTalks/project/src/target/manifest.json
[0m14:41:39.368208 [debug] [MainThread]: Wrote artifact SemanticManifest to /Users/timbo/Documents/DataTalks/project/src/target/semantic_manifest.json
[0m14:41:39.371008 [debug] [MainThread]: Wrote artifact RunExecutionResult to /Users/timbo/Documents/DataTalks/project/src/target/run_results.json
[0m14:41:39.371214 [info ] [MainThread]: 
[0m14:41:39.371445 [info ] [MainThread]: [31mCompleted with 1 error, 0 partial successes, and 0 warnings:[0m
[0m14:41:39.371803 [info ] [MainThread]: 
[0m14:41:39.372055 [error] [MainThread]:   Database Error in model stg_emissions_data (models/staging/stg_emissions_data.sql)
  The datatype of column does not match with other datatypes in the IN clause. Expected FLOAT64, Found STRING at [32:57]
  compiled code at target/run/eu_emissions_project/models/staging/stg_emissions_data.sql
[0m14:41:39.372248 [info ] [MainThread]: 
[0m14:41:39.372438 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m14:41:39.373635 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": false, "command_wall_clock_time": 2.364389, "process_in_blocks": "0", "process_kernel_time": 0.257324, "process_mem_max_rss": "212271104", "process_out_blocks": "0", "process_user_time": 1.656035}
[0m14:41:39.373886 [debug] [MainThread]: Command `dbt run` failed at 14:41:39.373847 after 2.36 seconds
[0m14:41:39.374111 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1010fe110>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x100f48890>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x100fe90d0>]}
[0m14:41:39.374324 [debug] [MainThread]: Flushing usage events
[0m14:41:39.813703 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m14:42:07.676611 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11256f750>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1125cb4d0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1125cbf90>]}


============================== 14:42:07.678944 | 942e3bee-02b0-4007-b026-f52139ee58b6 ==============================
[0m14:42:07.678944 [info ] [MainThread]: Running with dbt=1.9.3
[0m14:42:07.679340 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'profiles_dir': '/Users/timbo/.dbt', 'log_path': '/Users/timbo/Documents/DataTalks/project/src/logs', 'version_check': 'True', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'empty': 'False', 'log_format': 'default', 'static_parser': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt run -s stg_emissions_data', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m14:42:08.135016 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '942e3bee-02b0-4007-b026-f52139ee58b6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1210b98d0>]}
[0m14:42:08.162087 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '942e3bee-02b0-4007-b026-f52139ee58b6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1072c4090>]}
[0m14:42:08.162593 [info ] [MainThread]: Registered adapter: bigquery=1.9.1
[0m14:42:08.251014 [debug] [MainThread]: checksum: 5671c00892cdbcef29c3b00cc5ba7510c3d18a35c883caeb9ab9ee266dc29c8f, vars: {}, profile: , target: , version: 1.9.3
[0m14:42:08.360640 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m14:42:08.361405 [debug] [MainThread]: Partial parsing: updated file: eu_emissions_project://models/staging/sources.yml
[0m14:42:08.568056 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '942e3bee-02b0-4007-b026-f52139ee58b6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x121932450>]}
[0m14:42:08.602626 [debug] [MainThread]: Wrote artifact WritableManifest to /Users/timbo/Documents/DataTalks/project/src/target/manifest.json
[0m14:42:08.604404 [debug] [MainThread]: Wrote artifact SemanticManifest to /Users/timbo/Documents/DataTalks/project/src/target/semantic_manifest.json
[0m14:42:08.612029 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '942e3bee-02b0-4007-b026-f52139ee58b6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x121f38c10>]}
[0m14:42:08.612362 [info ] [MainThread]: Found 4 models, 1 source, 491 macros
[0m14:42:08.612577 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '942e3bee-02b0-4007-b026-f52139ee58b6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x121eae010>]}
[0m14:42:08.613294 [info ] [MainThread]: 
[0m14:42:08.613499 [info ] [MainThread]: Concurrency: 8 threads (target='dev')
[0m14:42:08.613666 [info ] [MainThread]: 
[0m14:42:08.613925 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m14:42:08.614479 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_data-talk-clubs'
[0m14:42:08.614828 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m14:42:08.880270 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_data-talk-clubs, now list_data-talk-clubs_eu_emissions_project_marts)
[0m14:42:08.880817 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_data-talk-clubs_eu_emissions_project_intermediate'
[0m14:42:08.881322 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_data-talk-clubs_eu_emissions_project_staging'
[0m14:42:08.881522 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m14:42:08.881762 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m14:42:08.881940 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m14:42:09.174232 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '942e3bee-02b0-4007-b026-f52139ee58b6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1219b0b10>]}
[0m14:42:09.174905 [debug] [MainThread]: Opening a new connection, currently in state init
[0m14:42:09.177080 [debug] [Thread-1 (]: Began running node model.eu_emissions_project.stg_emissions_data
[0m14:42:09.177468 [info ] [Thread-1 (]: 1 of 1 START sql view model eu_emissions_project_staging.stg_emissions_data .... [RUN]
[0m14:42:09.177768 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_data-talk-clubs_eu_emissions_project_marts, now model.eu_emissions_project.stg_emissions_data)
[0m14:42:09.177992 [debug] [Thread-1 (]: Began compiling node model.eu_emissions_project.stg_emissions_data
[0m14:42:09.182530 [debug] [Thread-1 (]: Writing injected SQL for node "model.eu_emissions_project.stg_emissions_data"
[0m14:42:09.183002 [debug] [Thread-1 (]: Began executing node model.eu_emissions_project.stg_emissions_data
[0m14:42:09.197291 [debug] [Thread-1 (]: Writing runtime sql for node "model.eu_emissions_project.stg_emissions_data"
[0m14:42:09.197973 [debug] [Thread-1 (]: On model.eu_emissions_project.stg_emissions_data: /* {"app": "dbt", "dbt_version": "1.9.3", "profile_name": "big-query", "target_name": "dev", "node_id": "model.eu_emissions_project.stg_emissions_data"} */


  create or replace view `data-talk-clubs`.`eu_emissions_project_staging`.`stg_emissions_data`
  OPTIONS()
  as 

WITH source AS (
    SELECT 
        *
    FROM `data-talk-clubs`.`eu_emissions_project`.`nitrogen_dioxide_data`
),

-- First, prepare the data by converting columns to the right format for unpivoting
preprocessed AS (
    SELECT
        freq_airpol_unit_geo_TIME_PERIOD AS metadata,
        -- All other columns are measurement data columns
        *
    FROM source
),

-- Use UNPIVOT to transform the wide format to long format
unpivoted AS (
    SELECT
        metadata,
        col_name AS date_column,
        col_value AS measurement_value
    FROM preprocessed
    UNPIVOT(
        col_value FOR col_name IN (
            _2018_01_, _2018_02_, _2018_03_, _2018_04_, _2018_05_, _2018_06_,
            _2018_07_, _2018_08_, _2018_09_, _2018_10_, _2018_11_, _2018_12_,
            _2019_01_, _2019_02_, _2019_03_, _2019_04_, _2019_05_, _2019_06_,
            _2019_07_, _2019_08_, _2019_09_, _2019_10_, _2019_11_, _2019_12_,
            _2020_01_, _2020_02_, _2020_03_, _2020_04_, _2020_05_, _2020_06_,
            _2020_07_, _2020_08_, _2020_09_, _2020_10_, _2020_11_, _2020_12_,
            _2021_01_, _2021_02_, _2021_03_, _2021_04_, _2021_05_, _2021_06_,
            _2021_07_, _2021_08_, _2021_09_, _2021_10_, _2021_11_, _2021_12_,
            _2022_01_, _2022_02_, _2022_03_, _2022_04_, _2022_05_, _2022_06_,
            _2022_07_, _2022_08_, _2022_09_, _2022_10_, _2022_11_, _2022_12_,
            _2023_01_, _2023_02_, _2023_03_, _2023_04_, _2023_05_, _2023_06_,
            _2023_07_, _2023_08_, _2023_09_, _2023_10_, _2023_11_, _2023_12_,
            _2024_01_, _2024_02_, _2024_03_, _2024_04_, _2024_05_, _2024_06_,
            _2024_07_, _2024_08_, _2024_09_, _2024_10_, _2024_11_, _2024_12_,
            _2025_01_, _2025_02_
        )
    )
    -- Filter out colon values
    WHERE col_value != ':'
),

-- Process the date and value after unpivoting
processed_measurements AS (
    SELECT
        metadata,
        -- Clean up column name by removing underscores
        REPLACE(date_column, '_', '') AS clean_date_column,
        -- Keep measurement value as string for now
        measurement_value,
        -- Extract month and year from column name and create a proper date
        DATE(CONCAT(
            SUBSTR(REPLACE(date_column, '_', ''), 1, 4), '-',
            SUBSTR(REPLACE(date_column, '_', ''), 5, 2), '-01'
        )) AS measurement_date,
        -- Create a readable date label (e.g., 'Jan 2018')
        CONCAT(
            FORMAT_DATE('%b', DATE(CONCAT(
                SUBSTR(REPLACE(date_column, '_', ''), 1, 4), '-',
                SUBSTR(REPLACE(date_column, '_', ''), 5, 2), '-01'
            ))),
            ' ',
            SUBSTR(REPLACE(date_column, '_', ''), 1, 4)
        ) AS date_label
    FROM unpivoted
),

metadata_extracted AS (
    SELECT
        -- Extract metadata components
        SPLIT(metadata, ',')[SAFE_OFFSET(0)] AS frequency,
        SPLIT(metadata, ',')[SAFE_OFFSET(1)] AS airpol,
        SPLIT(metadata, ',')[SAFE_OFFSET(2)] AS unit,
        SPLIT(metadata, ',')[SAFE_OFFSET(3)] AS geo_code,
        date_label,
        measurement_date,
        -- Convert measurement value to FLOAT64 here, after unpivoting
        SAFE_CAST(measurement_value AS FLOAT64) AS measurement_value,
        CURRENT_TIMESTAMP() AS load_timestamp
    FROM processed_measurements
),

final AS (

SELECT
    ROW_NUMBER() OVER() AS id,
    frequency,
    airpol,
    unit,
    geo_code,
    date_label,
    measurement_date,
    measurement_value,
    load_timestamp
FROM metadata_extracted
ORDER BY geo_code, measurement_date
)

select * from unpivoted;


[0m14:42:09.198353 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m14:42:09.751864 [debug] [Thread-1 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=data-talk-clubs&j=bq:EU:13ec516c-7f32-431e-a246-63a2223190f4&page=queryresults
[0m14:42:09.845174 [error] [Thread-1 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=data-talk-clubs&j=bq:EU:13ec516c-7f32-431e-a246-63a2223190f4&page=queryresults
[0m14:42:09.850118 [debug] [Thread-1 (]: Database Error in model stg_emissions_data (models/staging/stg_emissions_data.sql)
  The datatype of column does not match with other datatypes in the IN clause. Expected FLOAT64, Found STRING at [32:57]
  compiled code at target/run/eu_emissions_project/models/staging/stg_emissions_data.sql
[0m14:42:09.851179 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '942e3bee-02b0-4007-b026-f52139ee58b6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x121f53390>]}
[0m14:42:09.851640 [error] [Thread-1 (]: 1 of 1 ERROR creating sql view model eu_emissions_project_staging.stg_emissions_data  [[31mERROR[0m in 0.67s]
[0m14:42:09.852055 [debug] [Thread-1 (]: Finished running node model.eu_emissions_project.stg_emissions_data
[0m14:42:09.852338 [debug] [Thread-11 ]: Marking all children of 'model.eu_emissions_project.stg_emissions_data' to be skipped because of status 'error'.  Reason: Database Error in model stg_emissions_data (models/staging/stg_emissions_data.sql)
  The datatype of column does not match with other datatypes in the IN clause. Expected FLOAT64, Found STRING at [32:57]
  compiled code at target/run/eu_emissions_project/models/staging/stg_emissions_data.sql.
[0m14:42:09.853446 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m14:42:09.854451 [debug] [MainThread]: Connection 'master' was properly closed.
[0m14:42:09.854829 [debug] [MainThread]: Connection 'model.eu_emissions_project.stg_emissions_data' was properly closed.
[0m14:42:09.855045 [debug] [MainThread]: Connection 'list_data-talk-clubs_eu_emissions_project_intermediate' was properly closed.
[0m14:42:09.855219 [debug] [MainThread]: Connection 'list_data-talk-clubs_eu_emissions_project_staging' was properly closed.
[0m14:42:09.855414 [info ] [MainThread]: 
[0m14:42:09.855605 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 1.24 seconds (1.24s).
[0m14:42:09.855948 [debug] [MainThread]: Command end result
[0m14:42:09.869312 [debug] [MainThread]: Wrote artifact WritableManifest to /Users/timbo/Documents/DataTalks/project/src/target/manifest.json
[0m14:42:09.870202 [debug] [MainThread]: Wrote artifact SemanticManifest to /Users/timbo/Documents/DataTalks/project/src/target/semantic_manifest.json
[0m14:42:09.872891 [debug] [MainThread]: Wrote artifact RunExecutionResult to /Users/timbo/Documents/DataTalks/project/src/target/run_results.json
[0m14:42:09.873102 [info ] [MainThread]: 
[0m14:42:09.873332 [info ] [MainThread]: [31mCompleted with 1 error, 0 partial successes, and 0 warnings:[0m
[0m14:42:09.873521 [info ] [MainThread]: 
[0m14:42:09.873733 [error] [MainThread]:   Database Error in model stg_emissions_data (models/staging/stg_emissions_data.sql)
  The datatype of column does not match with other datatypes in the IN clause. Expected FLOAT64, Found STRING at [32:57]
  compiled code at target/run/eu_emissions_project/models/staging/stg_emissions_data.sql
[0m14:42:09.873906 [info ] [MainThread]: 
[0m14:42:09.874094 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m14:42:09.875223 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": false, "command_wall_clock_time": 2.2324395, "process_in_blocks": "0", "process_kernel_time": 0.265098, "process_mem_max_rss": "212647936", "process_out_blocks": "0", "process_user_time": 1.649647}
[0m14:42:09.875455 [debug] [MainThread]: Command `dbt run` failed at 14:42:09.875418 after 2.23 seconds
[0m14:42:09.875676 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104422110>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1125c36d0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11217d190>]}
[0m14:42:09.875882 [debug] [MainThread]: Flushing usage events
[0m14:42:10.290436 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m14:45:54.003462 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10746f610>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10749ccd0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1074cbf90>]}


============================== 14:45:54.006716 | 4f41b3ec-4a8c-4b5c-b096-a31656f0ef7d ==============================
[0m14:45:54.006716 [info ] [MainThread]: Running with dbt=1.9.3
[0m14:45:54.007267 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': '/Users/timbo/.dbt', 'version_check': 'True', 'warn_error': 'None', 'log_path': '/Users/timbo/Documents/DataTalks/project/src/logs', 'fail_fast': 'False', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'empty': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'invocation_command': 'dbt run -s stg_emissions_data', 'log_format': 'default', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m14:45:54.490549 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '4f41b3ec-4a8c-4b5c-b096-a31656f0ef7d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10f060210>]}
[0m14:45:54.516987 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '4f41b3ec-4a8c-4b5c-b096-a31656f0ef7d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10489a410>]}
[0m14:45:54.517469 [info ] [MainThread]: Registered adapter: bigquery=1.9.1
[0m14:45:54.607718 [debug] [MainThread]: checksum: 5671c00892cdbcef29c3b00cc5ba7510c3d18a35c883caeb9ab9ee266dc29c8f, vars: {}, profile: , target: , version: 1.9.3
[0m14:45:54.716797 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m14:45:54.717302 [debug] [MainThread]: Partial parsing: updated file: eu_emissions_project://models/staging/stg_emissions_data.sql
[0m14:45:54.872834 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '4f41b3ec-4a8c-4b5c-b096-a31656f0ef7d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10f68ea10>]}
[0m14:45:54.909667 [debug] [MainThread]: Wrote artifact WritableManifest to /Users/timbo/Documents/DataTalks/project/src/target/manifest.json
[0m14:45:54.911648 [debug] [MainThread]: Wrote artifact SemanticManifest to /Users/timbo/Documents/DataTalks/project/src/target/semantic_manifest.json
[0m14:45:54.920030 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '4f41b3ec-4a8c-4b5c-b096-a31656f0ef7d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10f76bb90>]}
[0m14:45:54.920390 [info ] [MainThread]: Found 4 models, 1 source, 491 macros
[0m14:45:54.920610 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '4f41b3ec-4a8c-4b5c-b096-a31656f0ef7d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10f34e5d0>]}
[0m14:45:54.921388 [info ] [MainThread]: 
[0m14:45:54.921648 [info ] [MainThread]: Concurrency: 8 threads (target='dev')
[0m14:45:54.921944 [info ] [MainThread]: 
[0m14:45:54.922267 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m14:45:54.922741 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_data-talk-clubs'
[0m14:45:54.922950 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m14:45:55.350134 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_data-talk-clubs, now list_data-talk-clubs_eu_emissions_project_intermediate)
[0m14:45:55.350559 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_data-talk-clubs_eu_emissions_project_marts'
[0m14:45:55.350929 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_data-talk-clubs_eu_emissions_project_staging'
[0m14:45:55.351235 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m14:45:55.351465 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m14:45:55.351650 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m14:45:55.633053 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '4f41b3ec-4a8c-4b5c-b096-a31656f0ef7d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10f656190>]}
[0m14:45:55.633542 [debug] [MainThread]: Opening a new connection, currently in state init
[0m14:45:55.636147 [debug] [Thread-1 (]: Began running node model.eu_emissions_project.stg_emissions_data
[0m14:45:55.636585 [info ] [Thread-1 (]: 1 of 1 START sql view model eu_emissions_project_staging.stg_emissions_data .... [RUN]
[0m14:45:55.636860 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_data-talk-clubs_eu_emissions_project_intermediate, now model.eu_emissions_project.stg_emissions_data)
[0m14:45:55.637069 [debug] [Thread-1 (]: Began compiling node model.eu_emissions_project.stg_emissions_data
[0m14:45:55.641578 [debug] [Thread-1 (]: Writing injected SQL for node "model.eu_emissions_project.stg_emissions_data"
[0m14:45:55.642128 [debug] [Thread-1 (]: Began executing node model.eu_emissions_project.stg_emissions_data
[0m14:45:55.657690 [debug] [Thread-1 (]: Writing runtime sql for node "model.eu_emissions_project.stg_emissions_data"
[0m14:45:55.658434 [debug] [Thread-1 (]: On model.eu_emissions_project.stg_emissions_data: /* {"app": "dbt", "dbt_version": "1.9.3", "profile_name": "big-query", "target_name": "dev", "node_id": "model.eu_emissions_project.stg_emissions_data"} */


  create or replace view `data-talk-clubs`.`eu_emissions_project_staging`.`stg_emissions_data`
  OPTIONS()
  as 

WITH source AS (
    SELECT 
        *
    FROM `data-talk-clubs`.`eu_emissions_project`.`nitrogen_dioxide_data`
),

-- First, prepare the data by converting columns to the right format for unpivoting
preprocessed AS (
    SELECT
        freq_airpol_unit_geo_TIME_PERIOD AS metadata,
        -- All other columns are measurement data columns
        *
    FROM source
),

-- Use UNPIVOT to transform the wide format to long format
unpivoted AS (
    SELECT
        metadata,
        col_name AS date_column,
        col_value AS measurement_value
    FROM preprocessed
    UNPIVOT(
        CAST(col_value AS STRING) FOR col_name IN (
            _2018_01_, _2018_02_, _2018_03_, _2018_04_, _2018_05_, _2018_06_,
            _2018_07_, _2018_08_, _2018_09_, _2018_10_, _2018_11_, _2018_12_,
            _2019_01_, _2019_02_, _2019_03_, _2019_04_, _2019_05_, _2019_06_,
            _2019_07_, _2019_08_, _2019_09_, _2019_10_, _2019_11_, _2019_12_,
            _2020_01_, _2020_02_, _2020_03_, _2020_04_, _2020_05_, _2020_06_,
            _2020_07_, _2020_08_, _2020_09_, _2020_10_, _2020_11_, _2020_12_,
            _2021_01_, _2021_02_, _2021_03_, _2021_04_, _2021_05_, _2021_06_,
            _2021_07_, _2021_08_, _2021_09_, _2021_10_, _2021_11_, _2021_12_,
            _2022_01_, _2022_02_, _2022_03_, _2022_04_, _2022_05_, _2022_06_,
            _2022_07_, _2022_08_, _2022_09_, _2022_10_, _2022_11_, _2022_12_,
            _2023_01_, _2023_02_, _2023_03_, _2023_04_, _2023_05_, _2023_06_,
            _2023_07_, _2023_08_, _2023_09_, _2023_10_, _2023_11_, _2023_12_,
            _2024_01_, _2024_02_, _2024_03_, _2024_04_, _2024_05_, _2024_06_,
            _2024_07_, _2024_08_, _2024_09_, _2024_10_, _2024_11_, _2024_12_,
            _2025_01_, _2025_02_
        )
    )
    -- Filter out colon values
    WHERE col_value != ':'
),

-- Process the date and value after unpivoting
processed_measurements AS (
    SELECT
        metadata,
        -- Clean up column name by removing underscores
        REPLACE(date_column, '_', '') AS clean_date_column,
        -- Keep measurement value as string for now
        measurement_value,
        -- Extract month and year from column name and create a proper date
        DATE(CONCAT(
            SUBSTR(REPLACE(date_column, '_', ''), 1, 4), '-',
            SUBSTR(REPLACE(date_column, '_', ''), 5, 2), '-01'
        )) AS measurement_date,
        -- Create a readable date label (e.g., 'Jan 2018')
        CONCAT(
            FORMAT_DATE('%b', DATE(CONCAT(
                SUBSTR(REPLACE(date_column, '_', ''), 1, 4), '-',
                SUBSTR(REPLACE(date_column, '_', ''), 5, 2), '-01'
            ))),
            ' ',
            SUBSTR(REPLACE(date_column, '_', ''), 1, 4)
        ) AS date_label
    FROM unpivoted
),

metadata_extracted AS (
    SELECT
        -- Extract metadata components
        SPLIT(metadata, ',')[SAFE_OFFSET(0)] AS frequency,
        SPLIT(metadata, ',')[SAFE_OFFSET(1)] AS airpol,
        SPLIT(metadata, ',')[SAFE_OFFSET(2)] AS unit,
        SPLIT(metadata, ',')[SAFE_OFFSET(3)] AS geo_code,
        date_label,
        measurement_date,
        -- Convert measurement value to FLOAT64 here, after unpivoting
        SAFE_CAST(measurement_value AS FLOAT64) AS measurement_value,
        CURRENT_TIMESTAMP() AS load_timestamp
    FROM processed_measurements
),

final AS (

SELECT
    ROW_NUMBER() OVER() AS id,
    frequency,
    airpol,
    unit,
    geo_code,
    date_label,
    measurement_date,
    measurement_value,
    load_timestamp
FROM metadata_extracted
ORDER BY geo_code, measurement_date
)

select * from unpivoted;


[0m14:45:55.658873 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m14:45:55.976577 [debug] [Thread-1 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=data-talk-clubs&j=bq:EU:8b4ab660-fec1-46f3-9cb6-63b3ad7c3cd5&page=queryresults
[0m14:45:55.977044 [error] [Thread-1 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=data-talk-clubs&j=bq:EU:8b4ab660-fec1-46f3-9cb6-63b3ad7c3cd5&page=queryresults
[0m14:45:55.980049 [debug] [Thread-1 (]: Database Error in model stg_emissions_data (models/staging/stg_emissions_data.sql)
  Syntax error: Unexpected keyword CAST at [31:9]
  compiled code at target/run/eu_emissions_project/models/staging/stg_emissions_data.sql
[0m14:45:55.981022 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4f41b3ec-4a8c-4b5c-b096-a31656f0ef7d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10f886bd0>]}
[0m14:45:55.981440 [error] [Thread-1 (]: 1 of 1 ERROR creating sql view model eu_emissions_project_staging.stg_emissions_data  [[31mERROR[0m in 0.34s]
[0m14:45:55.981752 [debug] [Thread-1 (]: Finished running node model.eu_emissions_project.stg_emissions_data
[0m14:45:55.982102 [debug] [Thread-11 ]: Marking all children of 'model.eu_emissions_project.stg_emissions_data' to be skipped because of status 'error'.  Reason: Database Error in model stg_emissions_data (models/staging/stg_emissions_data.sql)
  Syntax error: Unexpected keyword CAST at [31:9]
  compiled code at target/run/eu_emissions_project/models/staging/stg_emissions_data.sql.
[0m14:45:55.983215 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m14:45:55.984273 [debug] [MainThread]: Connection 'master' was properly closed.
[0m14:45:55.984664 [debug] [MainThread]: Connection 'model.eu_emissions_project.stg_emissions_data' was properly closed.
[0m14:45:55.984920 [debug] [MainThread]: Connection 'list_data-talk-clubs_eu_emissions_project_marts' was properly closed.
[0m14:45:55.985152 [debug] [MainThread]: Connection 'list_data-talk-clubs_eu_emissions_project_staging' was properly closed.
[0m14:45:55.985414 [info ] [MainThread]: 
[0m14:45:55.985632 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 1.06 seconds (1.06s).
[0m14:45:55.986090 [debug] [MainThread]: Command end result
[0m14:45:56.000296 [debug] [MainThread]: Wrote artifact WritableManifest to /Users/timbo/Documents/DataTalks/project/src/target/manifest.json
[0m14:45:56.001339 [debug] [MainThread]: Wrote artifact SemanticManifest to /Users/timbo/Documents/DataTalks/project/src/target/semantic_manifest.json
[0m14:45:56.004640 [debug] [MainThread]: Wrote artifact RunExecutionResult to /Users/timbo/Documents/DataTalks/project/src/target/run_results.json
[0m14:45:56.004880 [info ] [MainThread]: 
[0m14:45:56.005122 [info ] [MainThread]: [31mCompleted with 1 error, 0 partial successes, and 0 warnings:[0m
[0m14:45:56.005359 [info ] [MainThread]: 
[0m14:45:56.005589 [error] [MainThread]:   Database Error in model stg_emissions_data (models/staging/stg_emissions_data.sql)
  Syntax error: Unexpected keyword CAST at [31:9]
  compiled code at target/run/eu_emissions_project/models/staging/stg_emissions_data.sql
[0m14:45:56.005779 [info ] [MainThread]: 
[0m14:45:56.005967 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m14:45:56.007533 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": false, "command_wall_clock_time": 2.0420194, "process_in_blocks": "0", "process_kernel_time": 0.297006, "process_mem_max_rss": "212221952", "process_out_blocks": "0", "process_user_time": 1.656483}
[0m14:45:56.007851 [debug] [MainThread]: Command `dbt run` failed at 14:45:56.007808 after 2.04 seconds
[0m14:45:56.008105 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1074efed0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x102b62110>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10749c9d0>]}
[0m14:45:56.008342 [debug] [MainThread]: Flushing usage events
[0m14:45:56.426158 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m14:47:23.051088 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a96e250>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a9c2590>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a9cbfd0>]}


============================== 14:47:23.053706 | 9d512d7d-4c9a-4a13-96d2-b8ad46ed2d33 ==============================
[0m14:47:23.053706 [info ] [MainThread]: Running with dbt=1.9.3
[0m14:47:23.054174 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'version_check': 'True', 'debug': 'False', 'log_path': '/Users/timbo/Documents/DataTalks/project/src/logs', 'fail_fast': 'False', 'profiles_dir': '/Users/timbo/.dbt', 'use_colors': 'True', 'use_experimental_parser': 'False', 'empty': 'False', 'quiet': 'False', 'no_print': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'invocation_command': 'dbt run -s stg_emissions_data', 'log_format': 'default', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m14:47:23.502000 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '9d512d7d-4c9a-4a13-96d2-b8ad46ed2d33', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10c4de4d0>]}
[0m14:47:23.530192 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '9d512d7d-4c9a-4a13-96d2-b8ad46ed2d33', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1082a0790>]}
[0m14:47:23.530686 [info ] [MainThread]: Registered adapter: bigquery=1.9.1
[0m14:47:23.620027 [debug] [MainThread]: checksum: 5671c00892cdbcef29c3b00cc5ba7510c3d18a35c883caeb9ab9ee266dc29c8f, vars: {}, profile: , target: , version: 1.9.3
[0m14:47:23.728145 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m14:47:23.728593 [debug] [MainThread]: Partial parsing: updated file: eu_emissions_project://models/staging/stg_emissions_data.sql
[0m14:47:23.883690 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '9d512d7d-4c9a-4a13-96d2-b8ad46ed2d33', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x12ab6f090>]}
[0m14:47:23.920949 [debug] [MainThread]: Wrote artifact WritableManifest to /Users/timbo/Documents/DataTalks/project/src/target/manifest.json
[0m14:47:23.922735 [debug] [MainThread]: Wrote artifact SemanticManifest to /Users/timbo/Documents/DataTalks/project/src/target/semantic_manifest.json
[0m14:47:23.930197 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '9d512d7d-4c9a-4a13-96d2-b8ad46ed2d33', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x12a6d4a50>]}
[0m14:47:23.930563 [info ] [MainThread]: Found 4 models, 1 source, 491 macros
[0m14:47:23.930775 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '9d512d7d-4c9a-4a13-96d2-b8ad46ed2d33', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x12ae10f90>]}
[0m14:47:23.931473 [info ] [MainThread]: 
[0m14:47:23.931676 [info ] [MainThread]: Concurrency: 8 threads (target='dev')
[0m14:47:23.931846 [info ] [MainThread]: 
[0m14:47:23.932114 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m14:47:23.932559 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_data-talk-clubs'
[0m14:47:23.932745 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m14:47:24.210713 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_data-talk-clubs, now list_data-talk-clubs_eu_emissions_project_intermediate)
[0m14:47:24.211092 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_data-talk-clubs_eu_emissions_project_marts'
[0m14:47:24.211405 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_data-talk-clubs_eu_emissions_project_staging'
[0m14:47:24.211619 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m14:47:24.211797 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m14:47:24.211960 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m14:47:24.514020 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '9d512d7d-4c9a-4a13-96d2-b8ad46ed2d33', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x12ad8f150>]}
[0m14:47:24.514435 [debug] [MainThread]: Opening a new connection, currently in state init
[0m14:47:24.516486 [debug] [Thread-1 (]: Began running node model.eu_emissions_project.stg_emissions_data
[0m14:47:24.516808 [info ] [Thread-1 (]: 1 of 1 START sql view model eu_emissions_project_staging.stg_emissions_data .... [RUN]
[0m14:47:24.517062 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_data-talk-clubs_eu_emissions_project_intermediate, now model.eu_emissions_project.stg_emissions_data)
[0m14:47:24.517270 [debug] [Thread-1 (]: Began compiling node model.eu_emissions_project.stg_emissions_data
[0m14:47:24.521408 [debug] [Thread-1 (]: Writing injected SQL for node "model.eu_emissions_project.stg_emissions_data"
[0m14:47:24.521824 [debug] [Thread-1 (]: Began executing node model.eu_emissions_project.stg_emissions_data
[0m14:47:24.536403 [debug] [Thread-1 (]: Writing runtime sql for node "model.eu_emissions_project.stg_emissions_data"
[0m14:47:24.537275 [debug] [Thread-1 (]: On model.eu_emissions_project.stg_emissions_data: /* {"app": "dbt", "dbt_version": "1.9.3", "profile_name": "big-query", "target_name": "dev", "node_id": "model.eu_emissions_project.stg_emissions_data"} */


  create or replace view `data-talk-clubs`.`eu_emissions_project_staging`.`stg_emissions_data`
  OPTIONS()
  as 

WITH source AS (
    SELECT 
        *
    FROM `data-talk-clubs`.`eu_emissions_project`.`nitrogen_dioxide_data`
),

-- First, prepare the data by converting columns to the right format for unpivoting
preprocessed AS (
    SELECT
        freq_airpol_unit_geo_TIME_PERIOD AS metadata,
        -- All other columns are measurement data columns
        *
    FROM source
),

-- Use UNPIVOT to transform the wide format to long format
unpivoted AS (
    SELECT
        metadata,
        col_name AS date_column,
        col_value::string AS measurement_value
    FROM preprocessed
    UNPIVOT(
        measurement_value FOR col_name IN (
            _2018_01_, _2018_02_, _2018_03_, _2018_04_, _2018_05_, _2018_06_,
            _2018_07_, _2018_08_, _2018_09_, _2018_10_, _2018_11_, _2018_12_,
            _2019_01_, _2019_02_, _2019_03_, _2019_04_, _2019_05_, _2019_06_,
            _2019_07_, _2019_08_, _2019_09_, _2019_10_, _2019_11_, _2019_12_,
            _2020_01_, _2020_02_, _2020_03_, _2020_04_, _2020_05_, _2020_06_,
            _2020_07_, _2020_08_, _2020_09_, _2020_10_, _2020_11_, _2020_12_,
            _2021_01_, _2021_02_, _2021_03_, _2021_04_, _2021_05_, _2021_06_,
            _2021_07_, _2021_08_, _2021_09_, _2021_10_, _2021_11_, _2021_12_,
            _2022_01_, _2022_02_, _2022_03_, _2022_04_, _2022_05_, _2022_06_,
            _2022_07_, _2022_08_, _2022_09_, _2022_10_, _2022_11_, _2022_12_,
            _2023_01_, _2023_02_, _2023_03_, _2023_04_, _2023_05_, _2023_06_,
            _2023_07_, _2023_08_, _2023_09_, _2023_10_, _2023_11_, _2023_12_,
            _2024_01_, _2024_02_, _2024_03_, _2024_04_, _2024_05_, _2024_06_,
            _2024_07_, _2024_08_, _2024_09_, _2024_10_, _2024_11_, _2024_12_,
            _2025_01_, _2025_02_
        )
    )
    -- Filter out colon values
    WHERE col_value != ':'
),

-- Process the date and value after unpivoting
processed_measurements AS (
    SELECT
        metadata,
        -- Clean up column name by removing underscores
        REPLACE(date_column, '_', '') AS clean_date_column,
        -- Keep measurement value as string for now
        measurement_value,
        -- Extract month and year from column name and create a proper date
        DATE(CONCAT(
            SUBSTR(REPLACE(date_column, '_', ''), 1, 4), '-',
            SUBSTR(REPLACE(date_column, '_', ''), 5, 2), '-01'
        )) AS measurement_date,
        -- Create a readable date label (e.g., 'Jan 2018')
        CONCAT(
            FORMAT_DATE('%b', DATE(CONCAT(
                SUBSTR(REPLACE(date_column, '_', ''), 1, 4), '-',
                SUBSTR(REPLACE(date_column, '_', ''), 5, 2), '-01'
            ))),
            ' ',
            SUBSTR(REPLACE(date_column, '_', ''), 1, 4)
        ) AS date_label
    FROM unpivoted
),

metadata_extracted AS (
    SELECT
        -- Extract metadata components
        SPLIT(metadata, ',')[SAFE_OFFSET(0)] AS frequency,
        SPLIT(metadata, ',')[SAFE_OFFSET(1)] AS airpol,
        SPLIT(metadata, ',')[SAFE_OFFSET(2)] AS unit,
        SPLIT(metadata, ',')[SAFE_OFFSET(3)] AS geo_code,
        date_label,
        measurement_date,
        -- Convert measurement value to FLOAT64 here, after unpivoting
        SAFE_CAST(measurement_value AS FLOAT64) AS measurement_value,
        CURRENT_TIMESTAMP() AS load_timestamp
    FROM processed_measurements
),

final AS (

SELECT
    ROW_NUMBER() OVER() AS id,
    frequency,
    airpol,
    unit,
    geo_code,
    date_label,
    measurement_date,
    measurement_value,
    load_timestamp
FROM metadata_extracted
ORDER BY geo_code, measurement_date
)

select * from unpivoted;


[0m14:47:24.537707 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m14:47:24.793854 [debug] [Thread-1 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=data-talk-clubs&j=bq:EU:e437d4f0-882c-4e6b-8fce-d0eca28168f1&page=queryresults
[0m14:47:24.794325 [error] [Thread-1 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=data-talk-clubs&j=bq:EU:e437d4f0-882c-4e6b-8fce-d0eca28168f1&page=queryresults
[0m14:47:24.797281 [debug] [Thread-1 (]: Database Error in model stg_emissions_data (models/staging/stg_emissions_data.sql)
  Syntax error: Expected ")" but got ":" at [28:18]
  compiled code at target/run/eu_emissions_project/models/staging/stg_emissions_data.sql
[0m14:47:24.798400 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9d512d7d-4c9a-4a13-96d2-b8ad46ed2d33', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a59aad0>]}
[0m14:47:24.798934 [error] [Thread-1 (]: 1 of 1 ERROR creating sql view model eu_emissions_project_staging.stg_emissions_data  [[31mERROR[0m in 0.28s]
[0m14:47:24.799277 [debug] [Thread-1 (]: Finished running node model.eu_emissions_project.stg_emissions_data
[0m14:47:24.799953 [debug] [Thread-11 ]: Marking all children of 'model.eu_emissions_project.stg_emissions_data' to be skipped because of status 'error'.  Reason: Database Error in model stg_emissions_data (models/staging/stg_emissions_data.sql)
  Syntax error: Expected ")" but got ":" at [28:18]
  compiled code at target/run/eu_emissions_project/models/staging/stg_emissions_data.sql.
[0m14:47:24.801706 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m14:47:24.802776 [debug] [MainThread]: Connection 'master' was properly closed.
[0m14:47:24.802989 [debug] [MainThread]: Connection 'model.eu_emissions_project.stg_emissions_data' was properly closed.
[0m14:47:24.803161 [debug] [MainThread]: Connection 'list_data-talk-clubs_eu_emissions_project_marts' was properly closed.
[0m14:47:24.803335 [debug] [MainThread]: Connection 'list_data-talk-clubs_eu_emissions_project_staging' was properly closed.
[0m14:47:24.803577 [info ] [MainThread]: 
[0m14:47:24.803815 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 0.87 seconds (0.87s).
[0m14:47:24.804263 [debug] [MainThread]: Command end result
[0m14:47:24.818476 [debug] [MainThread]: Wrote artifact WritableManifest to /Users/timbo/Documents/DataTalks/project/src/target/manifest.json
[0m14:47:24.819474 [debug] [MainThread]: Wrote artifact SemanticManifest to /Users/timbo/Documents/DataTalks/project/src/target/semantic_manifest.json
[0m14:47:24.822606 [debug] [MainThread]: Wrote artifact RunExecutionResult to /Users/timbo/Documents/DataTalks/project/src/target/run_results.json
[0m14:47:24.822912 [info ] [MainThread]: 
[0m14:47:24.823243 [info ] [MainThread]: [31mCompleted with 1 error, 0 partial successes, and 0 warnings:[0m
[0m14:47:24.823485 [info ] [MainThread]: 
[0m14:47:24.823728 [error] [MainThread]:   Database Error in model stg_emissions_data (models/staging/stg_emissions_data.sql)
  Syntax error: Expected ")" but got ":" at [28:18]
  compiled code at target/run/eu_emissions_project/models/staging/stg_emissions_data.sql
[0m14:47:24.823917 [info ] [MainThread]: 
[0m14:47:24.824105 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m14:47:24.825364 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": false, "command_wall_clock_time": 1.8093807, "process_in_blocks": "0", "process_kernel_time": 0.261121, "process_mem_max_rss": "212107264", "process_out_blocks": "0", "process_user_time": 1.610564}
[0m14:47:24.825653 [debug] [MainThread]: Command `dbt run` failed at 14:47:24.825610 after 1.81 seconds
[0m14:47:24.825899 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1052d2050>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105174350>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105174890>]}
[0m14:47:24.826125 [debug] [MainThread]: Flushing usage events
[0m14:47:25.243397 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m14:47:51.868900 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10516dc90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x101a1e310>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1051cbf10>]}


============================== 14:47:51.871560 | a7530396-fb74-4b4b-9d50-62d6bf6ca4ad ==============================
[0m14:47:51.871560 [info ] [MainThread]: Running with dbt=1.9.3
[0m14:47:51.872013 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': '/Users/timbo/.dbt', 'debug': 'False', 'fail_fast': 'False', 'log_path': '/Users/timbo/Documents/DataTalks/project/src/logs', 'warn_error': 'None', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'empty': 'False', 'log_format': 'default', 'introspect': 'True', 'invocation_command': 'dbt run -s stg_emissions_data', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m14:47:52.319951 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'a7530396-fb74-4b4b-9d50-62d6bf6ca4ad', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x102503290>]}
[0m14:47:52.346946 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'a7530396-fb74-4b4b-9d50-62d6bf6ca4ad', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1021cbe10>]}
[0m14:47:52.347481 [info ] [MainThread]: Registered adapter: bigquery=1.9.1
[0m14:47:52.436547 [debug] [MainThread]: checksum: 5671c00892cdbcef29c3b00cc5ba7510c3d18a35c883caeb9ab9ee266dc29c8f, vars: {}, profile: , target: , version: 1.9.3
[0m14:47:52.542309 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m14:47:52.542919 [debug] [MainThread]: Partial parsing: updated file: eu_emissions_project://models/staging/stg_emissions_data.sql
[0m14:47:52.694693 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'a7530396-fb74-4b4b-9d50-62d6bf6ca4ad', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10bf97090>]}
[0m14:47:52.730611 [debug] [MainThread]: Wrote artifact WritableManifest to /Users/timbo/Documents/DataTalks/project/src/target/manifest.json
[0m14:47:52.732319 [debug] [MainThread]: Wrote artifact SemanticManifest to /Users/timbo/Documents/DataTalks/project/src/target/semantic_manifest.json
[0m14:47:52.739832 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'a7530396-fb74-4b4b-9d50-62d6bf6ca4ad', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x12db60290>]}
[0m14:47:52.740173 [info ] [MainThread]: Found 4 models, 1 source, 491 macros
[0m14:47:52.740395 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'a7530396-fb74-4b4b-9d50-62d6bf6ca4ad', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x12d8ff310>]}
[0m14:47:52.741255 [info ] [MainThread]: 
[0m14:47:52.741532 [info ] [MainThread]: Concurrency: 8 threads (target='dev')
[0m14:47:52.741725 [info ] [MainThread]: 
[0m14:47:52.742030 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m14:47:52.742510 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_data-talk-clubs'
[0m14:47:52.742728 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m14:47:52.993601 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_data-talk-clubs, now list_data-talk-clubs_eu_emissions_project_marts)
[0m14:47:52.994004 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_data-talk-clubs_eu_emissions_project_staging'
[0m14:47:52.994344 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_data-talk-clubs_eu_emissions_project_intermediate'
[0m14:47:52.994610 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m14:47:52.994813 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m14:47:52.994991 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m14:47:53.338298 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'a7530396-fb74-4b4b-9d50-62d6bf6ca4ad', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10f7ea050>]}
[0m14:47:53.338748 [debug] [MainThread]: Opening a new connection, currently in state init
[0m14:47:53.340717 [debug] [Thread-1 (]: Began running node model.eu_emissions_project.stg_emissions_data
[0m14:47:53.341049 [info ] [Thread-1 (]: 1 of 1 START sql view model eu_emissions_project_staging.stg_emissions_data .... [RUN]
[0m14:47:53.341430 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_data-talk-clubs_eu_emissions_project_marts, now model.eu_emissions_project.stg_emissions_data)
[0m14:47:53.341665 [debug] [Thread-1 (]: Began compiling node model.eu_emissions_project.stg_emissions_data
[0m14:47:53.345936 [debug] [Thread-1 (]: Writing injected SQL for node "model.eu_emissions_project.stg_emissions_data"
[0m14:47:53.346395 [debug] [Thread-1 (]: Began executing node model.eu_emissions_project.stg_emissions_data
[0m14:47:53.361483 [debug] [Thread-1 (]: Writing runtime sql for node "model.eu_emissions_project.stg_emissions_data"
[0m14:47:53.362218 [debug] [Thread-1 (]: On model.eu_emissions_project.stg_emissions_data: /* {"app": "dbt", "dbt_version": "1.9.3", "profile_name": "big-query", "target_name": "dev", "node_id": "model.eu_emissions_project.stg_emissions_data"} */


  create or replace view `data-talk-clubs`.`eu_emissions_project_staging`.`stg_emissions_data`
  OPTIONS()
  as 

WITH source AS (
    SELECT 
        *
    FROM `data-talk-clubs`.`eu_emissions_project`.`nitrogen_dioxide_data`
),

-- First, prepare the data by converting columns to the right format for unpivoting
preprocessed AS (
    SELECT
        freq_airpol_unit_geo_TIME_PERIOD AS metadata,
        -- All other columns are measurement data columns
        *
    FROM source
),

-- Use UNPIVOT to transform the wide format to long format
unpivoted AS (
    SELECT
        metadata,
        col_name AS date_column,
        CAST(col_value AS STRING) AS measurement_value
    FROM preprocessed
    UNPIVOT(
        measurement_value FOR col_name IN (
            _2018_01_, _2018_02_, _2018_03_, _2018_04_, _2018_05_, _2018_06_,
            _2018_07_, _2018_08_, _2018_09_, _2018_10_, _2018_11_, _2018_12_,
            _2019_01_, _2019_02_, _2019_03_, _2019_04_, _2019_05_, _2019_06_,
            _2019_07_, _2019_08_, _2019_09_, _2019_10_, _2019_11_, _2019_12_,
            _2020_01_, _2020_02_, _2020_03_, _2020_04_, _2020_05_, _2020_06_,
            _2020_07_, _2020_08_, _2020_09_, _2020_10_, _2020_11_, _2020_12_,
            _2021_01_, _2021_02_, _2021_03_, _2021_04_, _2021_05_, _2021_06_,
            _2021_07_, _2021_08_, _2021_09_, _2021_10_, _2021_11_, _2021_12_,
            _2022_01_, _2022_02_, _2022_03_, _2022_04_, _2022_05_, _2022_06_,
            _2022_07_, _2022_08_, _2022_09_, _2022_10_, _2022_11_, _2022_12_,
            _2023_01_, _2023_02_, _2023_03_, _2023_04_, _2023_05_, _2023_06_,
            _2023_07_, _2023_08_, _2023_09_, _2023_10_, _2023_11_, _2023_12_,
            _2024_01_, _2024_02_, _2024_03_, _2024_04_, _2024_05_, _2024_06_,
            _2024_07_, _2024_08_, _2024_09_, _2024_10_, _2024_11_, _2024_12_,
            _2025_01_, _2025_02_
        )
    )
    -- Filter out colon values
    WHERE col_value != ':'
),

-- Process the date and value after unpivoting
processed_measurements AS (
    SELECT
        metadata,
        -- Clean up column name by removing underscores
        REPLACE(date_column, '_', '') AS clean_date_column,
        -- Keep measurement value as string for now
        measurement_value,
        -- Extract month and year from column name and create a proper date
        DATE(CONCAT(
            SUBSTR(REPLACE(date_column, '_', ''), 1, 4), '-',
            SUBSTR(REPLACE(date_column, '_', ''), 5, 2), '-01'
        )) AS measurement_date,
        -- Create a readable date label (e.g., 'Jan 2018')
        CONCAT(
            FORMAT_DATE('%b', DATE(CONCAT(
                SUBSTR(REPLACE(date_column, '_', ''), 1, 4), '-',
                SUBSTR(REPLACE(date_column, '_', ''), 5, 2), '-01'
            ))),
            ' ',
            SUBSTR(REPLACE(date_column, '_', ''), 1, 4)
        ) AS date_label
    FROM unpivoted
),

metadata_extracted AS (
    SELECT
        -- Extract metadata components
        SPLIT(metadata, ',')[SAFE_OFFSET(0)] AS frequency,
        SPLIT(metadata, ',')[SAFE_OFFSET(1)] AS airpol,
        SPLIT(metadata, ',')[SAFE_OFFSET(2)] AS unit,
        SPLIT(metadata, ',')[SAFE_OFFSET(3)] AS geo_code,
        date_label,
        measurement_date,
        -- Convert measurement value to FLOAT64 here, after unpivoting
        SAFE_CAST(measurement_value AS FLOAT64) AS measurement_value,
        CURRENT_TIMESTAMP() AS load_timestamp
    FROM processed_measurements
),

final AS (

SELECT
    ROW_NUMBER() OVER() AS id,
    frequency,
    airpol,
    unit,
    geo_code,
    date_label,
    measurement_date,
    measurement_value,
    load_timestamp
FROM metadata_extracted
ORDER BY geo_code, measurement_date
)

select * from unpivoted;


[0m14:47:53.362608 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m14:47:53.947028 [debug] [Thread-1 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=data-talk-clubs&j=bq:EU:d9b249c7-80fa-4145-83b4-dd20af8ecc4e&page=queryresults
[0m14:47:54.061015 [error] [Thread-1 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=data-talk-clubs&j=bq:EU:d9b249c7-80fa-4145-83b4-dd20af8ecc4e&page=queryresults
[0m14:47:54.064433 [debug] [Thread-1 (]: Database Error in model stg_emissions_data (models/staging/stg_emissions_data.sql)
  The datatype of column does not match with other datatypes in the IN clause. Expected FLOAT64, Found STRING at [32:57]
  compiled code at target/run/eu_emissions_project/models/staging/stg_emissions_data.sql
[0m14:47:54.065554 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a7530396-fb74-4b4b-9d50-62d6bf6ca4ad', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x12d8cb290>]}
[0m14:47:54.066086 [error] [Thread-1 (]: 1 of 1 ERROR creating sql view model eu_emissions_project_staging.stg_emissions_data  [[31mERROR[0m in 0.72s]
[0m14:47:54.066688 [debug] [Thread-1 (]: Finished running node model.eu_emissions_project.stg_emissions_data
[0m14:47:54.067147 [debug] [Thread-11 ]: Marking all children of 'model.eu_emissions_project.stg_emissions_data' to be skipped because of status 'error'.  Reason: Database Error in model stg_emissions_data (models/staging/stg_emissions_data.sql)
  The datatype of column does not match with other datatypes in the IN clause. Expected FLOAT64, Found STRING at [32:57]
  compiled code at target/run/eu_emissions_project/models/staging/stg_emissions_data.sql.
[0m14:47:54.068363 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m14:47:54.069535 [debug] [MainThread]: Connection 'master' was properly closed.
[0m14:47:54.069975 [debug] [MainThread]: Connection 'model.eu_emissions_project.stg_emissions_data' was properly closed.
[0m14:47:54.070210 [debug] [MainThread]: Connection 'list_data-talk-clubs_eu_emissions_project_staging' was properly closed.
[0m14:47:54.070447 [debug] [MainThread]: Connection 'list_data-talk-clubs_eu_emissions_project_intermediate' was properly closed.
[0m14:47:54.070661 [info ] [MainThread]: 
[0m14:47:54.070864 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 1.33 seconds (1.33s).
[0m14:47:54.071236 [debug] [MainThread]: Command end result
[0m14:47:54.085165 [debug] [MainThread]: Wrote artifact WritableManifest to /Users/timbo/Documents/DataTalks/project/src/target/manifest.json
[0m14:47:54.086242 [debug] [MainThread]: Wrote artifact SemanticManifest to /Users/timbo/Documents/DataTalks/project/src/target/semantic_manifest.json
[0m14:47:54.089228 [debug] [MainThread]: Wrote artifact RunExecutionResult to /Users/timbo/Documents/DataTalks/project/src/target/run_results.json
[0m14:47:54.089484 [info ] [MainThread]: 
[0m14:47:54.089845 [info ] [MainThread]: [31mCompleted with 1 error, 0 partial successes, and 0 warnings:[0m
[0m14:47:54.090083 [info ] [MainThread]: 
[0m14:47:54.090317 [error] [MainThread]:   Database Error in model stg_emissions_data (models/staging/stg_emissions_data.sql)
  The datatype of column does not match with other datatypes in the IN clause. Expected FLOAT64, Found STRING at [32:57]
  compiled code at target/run/eu_emissions_project/models/staging/stg_emissions_data.sql
[0m14:47:54.090689 [info ] [MainThread]: 
[0m14:47:54.090948 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m14:47:54.092204 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": false, "command_wall_clock_time": 2.2589552, "process_in_blocks": "0", "process_kernel_time": 0.244786, "process_mem_max_rss": "213303296", "process_out_blocks": "0", "process_user_time": 1.611098}
[0m14:47:54.092454 [debug] [MainThread]: Command `dbt run` failed at 14:47:54.092416 after 2.26 seconds
[0m14:47:54.092693 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1051bfdd0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x100516110>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x100458f90>]}
[0m14:47:54.092910 [debug] [MainThread]: Flushing usage events
[0m14:47:54.524015 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m14:50:02.314833 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x12056e250>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1205c9c10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1205cbf90>]}


============================== 14:50:02.317366 | 3cee70cb-6b87-4ce1-bab9-82f0c8b938d6 ==============================
[0m14:50:02.317366 [info ] [MainThread]: Running with dbt=1.9.3
[0m14:50:02.317741 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'fail_fast': 'False', 'version_check': 'True', 'log_path': '/Users/timbo/Documents/DataTalks/project/src/logs', 'debug': 'False', 'profiles_dir': '/Users/timbo/.dbt', 'use_colors': 'True', 'use_experimental_parser': 'False', 'empty': 'False', 'quiet': 'False', 'no_print': 'None', 'log_format': 'default', 'static_parser': 'True', 'invocation_command': 'dbt run -s stg_emissions_data', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m14:50:02.770390 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '3cee70cb-6b87-4ce1-bab9-82f0c8b938d6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x12045ad10>]}
[0m14:50:02.797746 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '3cee70cb-6b87-4ce1-bab9-82f0c8b938d6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x127c11d50>]}
[0m14:50:02.798282 [info ] [MainThread]: Registered adapter: bigquery=1.9.1
[0m14:50:02.885000 [debug] [MainThread]: checksum: 5671c00892cdbcef29c3b00cc5ba7510c3d18a35c883caeb9ab9ee266dc29c8f, vars: {}, profile: , target: , version: 1.9.3
[0m14:50:02.990421 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m14:50:02.990858 [debug] [MainThread]: Partial parsing: updated file: eu_emissions_project://models/staging/stg_emissions_data.sql
[0m14:50:03.142171 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '3cee70cb-6b87-4ce1-bab9-82f0c8b938d6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x137bf4f10>]}
[0m14:50:03.179072 [debug] [MainThread]: Wrote artifact WritableManifest to /Users/timbo/Documents/DataTalks/project/src/target/manifest.json
[0m14:50:03.180933 [debug] [MainThread]: Wrote artifact SemanticManifest to /Users/timbo/Documents/DataTalks/project/src/target/semantic_manifest.json
[0m14:50:03.187995 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '3cee70cb-6b87-4ce1-bab9-82f0c8b938d6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x137c60090>]}
[0m14:50:03.188320 [info ] [MainThread]: Found 4 models, 1 source, 491 macros
[0m14:50:03.188542 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '3cee70cb-6b87-4ce1-bab9-82f0c8b938d6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x137bf4610>]}
[0m14:50:03.189355 [info ] [MainThread]: 
[0m14:50:03.189653 [info ] [MainThread]: Concurrency: 8 threads (target='dev')
[0m14:50:03.189876 [info ] [MainThread]: 
[0m14:50:03.190169 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m14:50:03.190685 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_data-talk-clubs'
[0m14:50:03.190989 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m14:50:03.463733 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_data-talk-clubs, now list_data-talk-clubs_eu_emissions_project_intermediate)
[0m14:50:03.464163 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_data-talk-clubs_eu_emissions_project_marts'
[0m14:50:03.464433 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m14:50:03.464687 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_data-talk-clubs_eu_emissions_project_staging'
[0m14:50:03.464949 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m14:50:03.499575 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m14:50:03.773838 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '3cee70cb-6b87-4ce1-bab9-82f0c8b938d6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x137bf8210>]}
[0m14:50:03.774323 [debug] [MainThread]: Opening a new connection, currently in state init
[0m14:50:03.776298 [debug] [Thread-1 (]: Began running node model.eu_emissions_project.stg_emissions_data
[0m14:50:03.776606 [info ] [Thread-1 (]: 1 of 1 START sql view model eu_emissions_project_staging.stg_emissions_data .... [RUN]
[0m14:50:03.776885 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_data-talk-clubs_eu_emissions_project_intermediate, now model.eu_emissions_project.stg_emissions_data)
[0m14:50:03.777096 [debug] [Thread-1 (]: Began compiling node model.eu_emissions_project.stg_emissions_data
[0m14:50:03.781444 [debug] [Thread-1 (]: Writing injected SQL for node "model.eu_emissions_project.stg_emissions_data"
[0m14:50:03.781952 [debug] [Thread-1 (]: Began executing node model.eu_emissions_project.stg_emissions_data
[0m14:50:03.796556 [debug] [Thread-1 (]: Writing runtime sql for node "model.eu_emissions_project.stg_emissions_data"
[0m14:50:03.797337 [debug] [Thread-1 (]: On model.eu_emissions_project.stg_emissions_data: /* {"app": "dbt", "dbt_version": "1.9.3", "profile_name": "big-query", "target_name": "dev", "node_id": "model.eu_emissions_project.stg_emissions_data"} */


  create or replace view `data-talk-clubs`.`eu_emissions_project_staging`.`stg_emissions_data`
  OPTIONS()
  as 

WITH source AS (
    SELECT 
        *
    FROM `data-talk-clubs`.`eu_emissions_project`.`nitrogen_dioxide_data`
),

-- First, prepare the data by converting columns to the right format for unpivoting
preprocessed AS (
    SELECT
        freq_airpol_unit_geo_TIME_PERIOD AS metadata,
        -- All other columns are measurement data columns
        *
    FROM source
),

-- Use UNPIVOT to transform the wide format to long format
preprocessed_string AS (
    SELECT
        metadata,
        -- All other columns are measurement data columns
        *, 
        -- Make sure col_value is a string
        CAST(col_value AS STRING) AS col_value_string
    FROM preprocessed
),

unpivoted AS (
    SELECT
        metadata,
        col_name AS date_column,
        col_value_string AS measurement_value
    FROM preprocessed_string
    UNPIVOT(
        measurement_value FOR col_name IN (
            _2018_01_, _2018_02_, _2018_03_, _2018_04_, _2018_05_, _2018_06_,
            _2018_07_, _2018_08_, _2018_09_, _2018_10_, _2018_11_, _2018_12_,
            _2019_01_, _2019_02_, _2019_03_, _2019_04_, _2019_05_, _2019_06_,
            _2019_07_, _2019_08_, _2019_09_, _2019_10_, _2019_11_, _2019_12_,
            _2020_01_, _2020_02_, _2020_03_, _2020_04_, _2020_05_, _2020_06_,
            _2020_07_, _2020_08_, _2020_09_, _2020_10_, _2020_11_, _2020_12_,
            _2021_01_, _2021_02_, _2021_03_, _2021_04_, _2021_05_, _2021_06_,
            _2021_07_, _2021_08_, _2021_09_, _2021_10_, _2021_11_, _2021_12_,
            _2022_01_, _2022_02_, _2022_03_, _2022_04_, _2022_05_, _2022_06_,
            _2022_07_, _2022_08_, _2022_09_, _2022_10_, _2022_11_, _2022_12_,
            _2023_01_, _2023_02_, _2023_03_, _2023_04_, _2023_05_, _2023_06_,
            _2023_07_, _2023_08_, _2023_09_, _2023_10_, _2023_11_, _2023_12_,
            _2024_01_, _2024_02_, _2024_03_, _2024_04_, _2024_05_, _2024_06_,
            _2024_07_, _2024_08_, _2024_09_, _2024_10_, _2024_11_, _2024_12_,
            _2025_01_, _2025_02_
        )
    )
    -- Filter out colon values
    WHERE measurement_value != ':'
),

-- Process the date and value after unpivoting
processed_measurements AS (
    SELECT
        metadata,
        -- Clean up column name by removing underscores
        REPLACE(date_column, '_', '') AS clean_date_column,
        -- Keep measurement value as string for now
        measurement_value,
        -- Extract month and year from column name and create a proper date
        DATE(CONCAT(
            SUBSTR(REPLACE(date_column, '_', ''), 1, 4), '-',
            SUBSTR(REPLACE(date_column, '_', ''), 5, 2), '-01'
        )) AS measurement_date,
        -- Create a readable date label (e.g., 'Jan 2018')
        CONCAT(
            FORMAT_DATE('%b', DATE(CONCAT(
                SUBSTR(REPLACE(date_column, '_', ''), 1, 4), '-',
                SUBSTR(REPLACE(date_column, '_', ''), 5, 2), '-01'
            ))),
            ' ',
            SUBSTR(REPLACE(date_column, '_', ''), 1, 4)
        ) AS date_label
    FROM unpivoted
),

metadata_extracted AS (
    SELECT
        -- Extract metadata components
        SPLIT(metadata, ',')[SAFE_OFFSET(0)] AS frequency,
        SPLIT(metadata, ',')[SAFE_OFFSET(1)] AS airpol,
        SPLIT(metadata, ',')[SAFE_OFFSET(2)] AS unit,
        SPLIT(metadata, ',')[SAFE_OFFSET(3)] AS geo_code,
        date_label,
        measurement_date,
        -- Convert measurement value to FLOAT64 here, after unpivoting
        SAFE_CAST(measurement_value AS FLOAT64) AS measurement_value,
        CURRENT_TIMESTAMP() AS load_timestamp
    FROM processed_measurements
),

final AS (

SELECT
    ROW_NUMBER() OVER() AS id,
    frequency,
    airpol,
    unit,
    geo_code,
    date_label,
    measurement_date,
    measurement_value,
    load_timestamp
FROM metadata_extracted
ORDER BY geo_code, measurement_date
)

select * from unpivoted;


[0m14:50:03.797727 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m14:50:04.385739 [debug] [Thread-1 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=data-talk-clubs&j=bq:EU:0517d2b4-6e90-4db4-a964-13c8934b6783&page=queryresults
[0m14:50:04.497290 [error] [Thread-1 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=data-talk-clubs&j=bq:EU:0517d2b4-6e90-4db4-a964-13c8934b6783&page=queryresults
[0m14:50:04.500419 [debug] [Thread-1 (]: Database Error in model stg_emissions_data (models/staging/stg_emissions_data.sql)
  Unrecognized name: col_value at [30:14]
  compiled code at target/run/eu_emissions_project/models/staging/stg_emissions_data.sql
[0m14:50:04.501357 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3cee70cb-6b87-4ce1-bab9-82f0c8b938d6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x137a8cd50>]}
[0m14:50:04.501758 [error] [Thread-1 (]: 1 of 1 ERROR creating sql view model eu_emissions_project_staging.stg_emissions_data  [[31mERROR[0m in 0.72s]
[0m14:50:04.502079 [debug] [Thread-1 (]: Finished running node model.eu_emissions_project.stg_emissions_data
[0m14:50:04.502352 [debug] [Thread-11 ]: Marking all children of 'model.eu_emissions_project.stg_emissions_data' to be skipped because of status 'error'.  Reason: Database Error in model stg_emissions_data (models/staging/stg_emissions_data.sql)
  Unrecognized name: col_value at [30:14]
  compiled code at target/run/eu_emissions_project/models/staging/stg_emissions_data.sql.
[0m14:50:04.503571 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m14:50:04.504489 [debug] [MainThread]: Connection 'master' was properly closed.
[0m14:50:04.504672 [debug] [MainThread]: Connection 'model.eu_emissions_project.stg_emissions_data' was properly closed.
[0m14:50:04.504834 [debug] [MainThread]: Connection 'list_data-talk-clubs_eu_emissions_project_marts' was properly closed.
[0m14:50:04.504989 [debug] [MainThread]: Connection 'list_data-talk-clubs_eu_emissions_project_staging' was properly closed.
[0m14:50:04.505233 [info ] [MainThread]: 
[0m14:50:04.505429 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 1.32 seconds (1.32s).
[0m14:50:04.505787 [debug] [MainThread]: Command end result
[0m14:50:04.519126 [debug] [MainThread]: Wrote artifact WritableManifest to /Users/timbo/Documents/DataTalks/project/src/target/manifest.json
[0m14:50:04.520128 [debug] [MainThread]: Wrote artifact SemanticManifest to /Users/timbo/Documents/DataTalks/project/src/target/semantic_manifest.json
[0m14:50:04.523027 [debug] [MainThread]: Wrote artifact RunExecutionResult to /Users/timbo/Documents/DataTalks/project/src/target/run_results.json
[0m14:50:04.523283 [info ] [MainThread]: 
[0m14:50:04.523694 [info ] [MainThread]: [31mCompleted with 1 error, 0 partial successes, and 0 warnings:[0m
[0m14:50:04.523951 [info ] [MainThread]: 
[0m14:50:04.524195 [error] [MainThread]:   Database Error in model stg_emissions_data (models/staging/stg_emissions_data.sql)
  Unrecognized name: col_value at [30:14]
  compiled code at target/run/eu_emissions_project/models/staging/stg_emissions_data.sql
[0m14:50:04.524482 [info ] [MainThread]: 
[0m14:50:04.524679 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m14:50:04.526288 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": false, "command_wall_clock_time": 2.2470157, "process_in_blocks": "0", "process_kernel_time": 0.252239, "process_mem_max_rss": "209993728", "process_out_blocks": "0", "process_user_time": 1.585826}
[0m14:50:04.526576 [debug] [MainThread]: Command `dbt run` failed at 14:50:04.526536 after 2.25 seconds
[0m14:50:04.526811 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x102d9e050>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1205cb9d0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x102c40890>]}
[0m14:50:04.527032 [debug] [MainThread]: Flushing usage events
[0m14:50:04.943547 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m15:00:35.234475 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x106596b50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1065f2b10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1065f3f90>]}


============================== 15:00:35.237858 | 0f6d2864-b826-4948-a02d-7c5a65bf0451 ==============================
[0m15:00:35.237858 [info ] [MainThread]: Running with dbt=1.9.3
[0m15:00:35.238349 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': '/Users/timbo/.dbt', 'version_check': 'True', 'warn_error': 'None', 'log_path': '/Users/timbo/Documents/DataTalks/project/src/logs', 'debug': 'False', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'empty': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'introspect': 'True', 'invocation_command': 'dbt run -s stg_emissions_data', 'target_path': 'None', 'log_format': 'default', 'send_anonymous_usage_stats': 'True'}
[0m15:00:36.025781 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '0f6d2864-b826-4948-a02d-7c5a65bf0451', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x13088cdd0>]}
[0m15:00:36.052676 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '0f6d2864-b826-4948-a02d-7c5a65bf0451', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1045ac050>]}
[0m15:00:36.053136 [info ] [MainThread]: Registered adapter: bigquery=1.9.1
[0m15:00:36.149509 [debug] [MainThread]: checksum: 5671c00892cdbcef29c3b00cc5ba7510c3d18a35c883caeb9ab9ee266dc29c8f, vars: {}, profile: , target: , version: 1.9.3
[0m15:00:36.267599 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m15:00:36.268037 [debug] [MainThread]: Partial parsing: updated file: eu_emissions_project://models/staging/stg_emissions_data.sql
[0m15:00:36.422985 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '0f6d2864-b826-4948-a02d-7c5a65bf0451', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x130ca3190>]}
[0m15:00:36.459481 [debug] [MainThread]: Wrote artifact WritableManifest to /Users/timbo/Documents/DataTalks/project/src/target/manifest.json
[0m15:00:36.461716 [debug] [MainThread]: Wrote artifact SemanticManifest to /Users/timbo/Documents/DataTalks/project/src/target/semantic_manifest.json
[0m15:00:36.475036 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '0f6d2864-b826-4948-a02d-7c5a65bf0451', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x130a71890>]}
[0m15:00:36.475437 [info ] [MainThread]: Found 4 models, 1 source, 491 macros
[0m15:00:36.475665 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '0f6d2864-b826-4948-a02d-7c5a65bf0451', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x130cbda90>]}
[0m15:00:36.476457 [info ] [MainThread]: 
[0m15:00:36.476666 [info ] [MainThread]: Concurrency: 8 threads (target='dev')
[0m15:00:36.476834 [info ] [MainThread]: 
[0m15:00:36.477124 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m15:00:36.477647 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_data-talk-clubs'
[0m15:00:36.477911 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:00:36.768284 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_data-talk-clubs, now list_data-talk-clubs_eu_emissions_project_staging)
[0m15:00:36.768690 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_data-talk-clubs_eu_emissions_project_intermediate'
[0m15:00:36.768954 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m15:00:36.769212 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_data-talk-clubs_eu_emissions_project_marts'
[0m15:00:36.769397 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:00:36.769662 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:00:37.059985 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '0f6d2864-b826-4948-a02d-7c5a65bf0451', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1175eadd0>]}
[0m15:00:37.060408 [debug] [MainThread]: Opening a new connection, currently in state init
[0m15:00:37.062741 [debug] [Thread-1 (]: Began running node model.eu_emissions_project.stg_emissions_data
[0m15:00:37.063065 [info ] [Thread-1 (]: 1 of 1 START sql view model eu_emissions_project_staging.stg_emissions_data .... [RUN]
[0m15:00:37.063333 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_data-talk-clubs_eu_emissions_project_staging, now model.eu_emissions_project.stg_emissions_data)
[0m15:00:37.063546 [debug] [Thread-1 (]: Began compiling node model.eu_emissions_project.stg_emissions_data
[0m15:00:37.067973 [debug] [Thread-1 (]: Writing injected SQL for node "model.eu_emissions_project.stg_emissions_data"
[0m15:00:37.068480 [debug] [Thread-1 (]: Began executing node model.eu_emissions_project.stg_emissions_data
[0m15:00:37.082608 [debug] [Thread-1 (]: Writing runtime sql for node "model.eu_emissions_project.stg_emissions_data"
[0m15:00:37.083490 [debug] [Thread-1 (]: On model.eu_emissions_project.stg_emissions_data: /* {"app": "dbt", "dbt_version": "1.9.3", "profile_name": "big-query", "target_name": "dev", "node_id": "model.eu_emissions_project.stg_emissions_data"} */


  create or replace view `data-talk-clubs`.`eu_emissions_project_staging`.`stg_emissions_data`
  OPTIONS()
  as 

WITH source AS (
    SELECT 
        *
    FROM `data-talk-clubs`.`eu_emissions_project`.`nitrogen_dioxide_data`
),

-- First, prepare the data by converting columns to the right format for unpivoting
preprocessed AS (
    SELECT
        freq_airpol_unit_geo_TIME_PERIOD AS metadata,
        -- All other columns are measurement data columns
        *
    FROM source
),

-- Use UNPIVOT to transform the wide format to long format
unpivoted AS (
    SELECT
        metadata,
        col_name AS date_column,
        CAST(col_value AS STRING) AS measurement_value
    FROM preprocessed
    UNPIVOT(
        measurement_value FOR col_name IN (
            _2018_01_, _2018_02_, _2018_03_, _2018_04_, _2018_05_, _2018_06_,
            _2018_07_, _2018_08_, _2018_09_, _2018_10_, _2018_11_, _2018_12_,
            _2019_01_, _2019_02_, _2019_03_, _2019_04_, _2019_05_, _2019_06_,
            _2019_07_, _2019_08_, _2019_09_, _2019_10_, _2019_11_, _2019_12_,
            _2020_01_, _2020_02_, _2020_03_, _2020_04_, _2020_05_, _2020_06_,
            _2020_07_, _2020_08_, _2020_09_, _2020_10_, _2020_11_, _2020_12_,
            _2021_01_, _2021_02_, _2021_03_, _2021_04_, _2021_05_, _2021_06_,
            _2021_07_, _2021_08_, _2021_09_, _2021_10_, _2021_11_, _2021_12_,
            _2022_01_, _2022_02_, _2022_03_, _2022_04_, _2022_05_, _2022_06_,
            _2022_07_, _2022_08_, _2022_09_, _2022_10_, _2022_11_, _2022_12_,
            _2023_01_, _2023_02_, _2023_03_, _2023_04_, _2023_05_, _2023_06_,
            _2023_07_, _2023_08_, _2023_09_, _2023_10_, _2023_11_, _2023_12_,
            _2024_01_, _2024_02_, _2024_03_, _2024_04_, _2024_05_, _2024_06_,
            _2024_07_, _2024_08_, _2024_09_, _2024_10_, _2024_11_, _2024_12_,
            _2025_01_, _2025_02_
        )
    )
    -- Filter out colon values
    WHERE col_value != ':'
),

-- Process the date and value after unpivoting
processed_measurements AS (
    SELECT
        metadata,
        -- Clean up column name by removing underscores
        REPLACE(date_column, '_', '') AS clean_date_column,
        -- Keep measurement value as string for now
        measurement_value,
        -- Extract month and year from column name and create a proper date
        DATE(CONCAT(
            SUBSTR(REPLACE(date_column, '_', ''), 1, 4), '-',
            SUBSTR(REPLACE(date_column, '_', ''), 5, 2), '-01'
        )) AS measurement_date,
        -- Create a readable date label (e.g., 'Jan 2018')
        CONCAT(
            FORMAT_DATE('%b', DATE(CONCAT(
                SUBSTR(REPLACE(date_column, '_', ''), 1, 4), '-',
                SUBSTR(REPLACE(date_column, '_', ''), 5, 2), '-01'
            ))),
            ' ',
            SUBSTR(REPLACE(date_column, '_', ''), 1, 4)
        ) AS date_label
    FROM unpivoted
),

metadata_extracted AS (
    SELECT
        -- Extract metadata components
        SPLIT(metadata, ',')[SAFE_OFFSET(0)] AS frequency,
        SPLIT(metadata, ',')[SAFE_OFFSET(1)] AS airpol,
        SPLIT(metadata, ',')[SAFE_OFFSET(2)] AS unit,
        SPLIT(metadata, ',')[SAFE_OFFSET(3)] AS geo_code,
        date_label,
        measurement_date,
        -- Convert measurement value to FLOAT64 here, after unpivoting
        SAFE_CAST(measurement_value AS FLOAT64) AS measurement_value,
        CURRENT_TIMESTAMP() AS load_timestamp
    FROM processed_measurements
),

final AS (

SELECT
    ROW_NUMBER() OVER() AS id,
    frequency,
    airpol,
    unit,
    geo_code,
    date_label,
    measurement_date,
    measurement_value,
    load_timestamp
FROM metadata_extracted
ORDER BY geo_code, measurement_date
)

select * from unpivoted;


[0m15:00:37.083931 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m15:00:37.948430 [debug] [Thread-1 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=data-talk-clubs&j=bq:EU:f9593376-3eaa-480f-98de-671b9454f855&page=queryresults
[0m15:00:38.055271 [error] [Thread-1 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=data-talk-clubs&j=bq:EU:f9593376-3eaa-480f-98de-671b9454f855&page=queryresults
[0m15:00:38.062961 [debug] [Thread-1 (]: Database Error in model stg_emissions_data (models/staging/stg_emissions_data.sql)
  The datatype of column does not match with other datatypes in the IN clause. Expected FLOAT64, Found STRING at [32:57]
  compiled code at target/run/eu_emissions_project/models/staging/stg_emissions_data.sql
[0m15:00:38.064328 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0f6d2864-b826-4948-a02d-7c5a65bf0451', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x130f714d0>]}
[0m15:00:38.064836 [error] [Thread-1 (]: 1 of 1 ERROR creating sql view model eu_emissions_project_staging.stg_emissions_data  [[31mERROR[0m in 1.00s]
[0m15:00:38.065359 [debug] [Thread-1 (]: Finished running node model.eu_emissions_project.stg_emissions_data
[0m15:00:38.065711 [debug] [Thread-11 ]: Marking all children of 'model.eu_emissions_project.stg_emissions_data' to be skipped because of status 'error'.  Reason: Database Error in model stg_emissions_data (models/staging/stg_emissions_data.sql)
  The datatype of column does not match with other datatypes in the IN clause. Expected FLOAT64, Found STRING at [32:57]
  compiled code at target/run/eu_emissions_project/models/staging/stg_emissions_data.sql.
[0m15:00:38.067023 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m15:00:38.068141 [debug] [MainThread]: Connection 'master' was properly closed.
[0m15:00:38.068356 [debug] [MainThread]: Connection 'model.eu_emissions_project.stg_emissions_data' was properly closed.
[0m15:00:38.068528 [debug] [MainThread]: Connection 'list_data-talk-clubs_eu_emissions_project_intermediate' was properly closed.
[0m15:00:38.068690 [debug] [MainThread]: Connection 'list_data-talk-clubs_eu_emissions_project_marts' was properly closed.
[0m15:00:38.068879 [info ] [MainThread]: 
[0m15:00:38.069066 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 1.59 seconds (1.59s).
[0m15:00:38.069409 [debug] [MainThread]: Command end result
[0m15:00:38.082719 [debug] [MainThread]: Wrote artifact WritableManifest to /Users/timbo/Documents/DataTalks/project/src/target/manifest.json
[0m15:00:38.083659 [debug] [MainThread]: Wrote artifact SemanticManifest to /Users/timbo/Documents/DataTalks/project/src/target/semantic_manifest.json
[0m15:00:38.086300 [debug] [MainThread]: Wrote artifact RunExecutionResult to /Users/timbo/Documents/DataTalks/project/src/target/run_results.json
[0m15:00:38.086499 [info ] [MainThread]: 
[0m15:00:38.086734 [info ] [MainThread]: [31mCompleted with 1 error, 0 partial successes, and 0 warnings:[0m
[0m15:00:38.086932 [info ] [MainThread]: 
[0m15:00:38.087150 [error] [MainThread]:   Database Error in model stg_emissions_data (models/staging/stg_emissions_data.sql)
  The datatype of column does not match with other datatypes in the IN clause. Expected FLOAT64, Found STRING at [32:57]
  compiled code at target/run/eu_emissions_project/models/staging/stg_emissions_data.sql
[0m15:00:38.087328 [info ] [MainThread]: 
[0m15:00:38.087501 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m15:00:38.089111 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": false, "command_wall_clock_time": 2.892528, "process_in_blocks": "0", "process_kernel_time": 0.361005, "process_mem_max_rss": "210354176", "process_out_blocks": "0", "process_user_time": 1.645483}
[0m15:00:38.089464 [debug] [MainThread]: Command `dbt run` failed at 15:00:38.089415 after 2.89 seconds
[0m15:00:38.089713 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x102932050>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1065ebdd0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x106597d10>]}
[0m15:00:38.089941 [debug] [MainThread]: Flushing usage events
[0m15:00:38.517667 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m15:03:32.208268 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1081a1490>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1081fdb50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1081f6cd0>]}


============================== 15:03:32.211746 | db76adc4-e05a-4d74-abce-bd4925084d1d ==============================
[0m15:03:32.211746 [info ] [MainThread]: Running with dbt=1.9.3
[0m15:03:32.212183 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'profiles_dir': '/Users/timbo/.dbt', 'log_path': '/Users/timbo/Documents/DataTalks/project/src/logs', 'fail_fast': 'False', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'empty': 'False', 'quiet': 'False', 'no_print': 'None', 'log_format': 'default', 'introspect': 'True', 'static_parser': 'True', 'invocation_command': 'dbt run -s stg_emissions_data', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m15:03:32.964274 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'db76adc4-e05a-4d74-abce-bd4925084d1d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d4420d0>]}
[0m15:03:32.991368 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'db76adc4-e05a-4d74-abce-bd4925084d1d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1061b0b90>]}
[0m15:03:32.991865 [info ] [MainThread]: Registered adapter: bigquery=1.9.1
[0m15:03:33.087002 [debug] [MainThread]: checksum: 5671c00892cdbcef29c3b00cc5ba7510c3d18a35c883caeb9ab9ee266dc29c8f, vars: {}, profile: , target: , version: 1.9.3
[0m15:03:33.206741 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m15:03:33.207063 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m15:03:33.226215 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'db76adc4-e05a-4d74-abce-bd4925084d1d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1129d79d0>]}
[0m15:03:33.264464 [debug] [MainThread]: Wrote artifact WritableManifest to /Users/timbo/Documents/DataTalks/project/src/target/manifest.json
[0m15:03:33.266713 [debug] [MainThread]: Wrote artifact SemanticManifest to /Users/timbo/Documents/DataTalks/project/src/target/semantic_manifest.json
[0m15:03:33.279326 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'db76adc4-e05a-4d74-abce-bd4925084d1d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x112dea490>]}
[0m15:03:33.279714 [info ] [MainThread]: Found 4 models, 1 source, 491 macros
[0m15:03:33.279933 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'db76adc4-e05a-4d74-abce-bd4925084d1d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10740e650>]}
[0m15:03:33.280670 [info ] [MainThread]: 
[0m15:03:33.280874 [info ] [MainThread]: Concurrency: 8 threads (target='dev')
[0m15:03:33.281045 [info ] [MainThread]: 
[0m15:03:33.281348 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m15:03:33.281950 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_data-talk-clubs'
[0m15:03:33.282285 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:03:33.536173 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_data-talk-clubs, now list_data-talk-clubs_eu_emissions_project_intermediate)
[0m15:03:33.536584 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_data-talk-clubs_eu_emissions_project_staging'
[0m15:03:33.536880 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_data-talk-clubs_eu_emissions_project_marts'
[0m15:03:33.537169 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m15:03:33.537399 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:03:33.537585 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:03:33.817655 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'db76adc4-e05a-4d74-abce-bd4925084d1d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x112afef50>]}
[0m15:03:33.818059 [debug] [MainThread]: Opening a new connection, currently in state init
[0m15:03:33.821234 [debug] [Thread-1 (]: Began running node model.eu_emissions_project.stg_emissions_data
[0m15:03:33.821602 [info ] [Thread-1 (]: 1 of 1 START sql view model eu_emissions_project_staging.stg_emissions_data .... [RUN]
[0m15:03:33.821875 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_data-talk-clubs_eu_emissions_project_intermediate, now model.eu_emissions_project.stg_emissions_data)
[0m15:03:33.822081 [debug] [Thread-1 (]: Began compiling node model.eu_emissions_project.stg_emissions_data
[0m15:03:33.827101 [debug] [Thread-1 (]: Writing injected SQL for node "model.eu_emissions_project.stg_emissions_data"
[0m15:03:33.827567 [debug] [Thread-1 (]: Began executing node model.eu_emissions_project.stg_emissions_data
[0m15:03:33.842478 [debug] [Thread-1 (]: Writing runtime sql for node "model.eu_emissions_project.stg_emissions_data"
[0m15:03:33.843201 [debug] [Thread-1 (]: On model.eu_emissions_project.stg_emissions_data: /* {"app": "dbt", "dbt_version": "1.9.3", "profile_name": "big-query", "target_name": "dev", "node_id": "model.eu_emissions_project.stg_emissions_data"} */


  create or replace view `data-talk-clubs`.`eu_emissions_project_staging`.`stg_emissions_data`
  OPTIONS()
  as 

WITH source AS (
    SELECT 
        *
    FROM `data-talk-clubs`.`eu_emissions_project`.`nitrogen_dioxide_data`
),

-- First, prepare the data by converting columns to the right format for unpivoting
preprocessed AS (
    SELECT
        freq_airpol_unit_geo_TIME_PERIOD AS metadata,
        -- All other columns are measurement data columns
        *
    FROM source
),

-- Use UNPIVOT to transform the wide format to long format
unpivoted AS (
    SELECT
        metadata,
        col_name AS date_column,
        CAST(col_value AS STRING) AS measurement_value
    FROM preprocessed
    UNPIVOT(
        measurement_value FOR col_name IN (
            _2018_01_, _2018_02_, _2018_03_, _2018_04_, _2018_05_, _2018_06_,
            _2018_07_, _2018_08_, _2018_09_, _2018_10_, _2018_11_, _2018_12_,
            _2019_01_, _2019_02_, _2019_03_, _2019_04_, _2019_05_, _2019_06_,
            _2019_07_, _2019_08_, _2019_09_, _2019_10_, _2019_11_, _2019_12_,
            _2020_01_, _2020_02_, _2020_03_, _2020_04_, _2020_05_, _2020_06_,
            _2020_07_, _2020_08_, _2020_09_, _2020_10_, _2020_11_, _2020_12_,
            _2021_01_, _2021_02_, _2021_03_, _2021_04_, _2021_05_, _2021_06_,
            _2021_07_, _2021_08_, _2021_09_, _2021_10_, _2021_11_, _2021_12_,
            _2022_01_, _2022_02_, _2022_03_, _2022_04_, _2022_05_, _2022_06_,
            _2022_07_, _2022_08_, _2022_09_, _2022_10_, _2022_11_, _2022_12_,
            _2023_01_, _2023_02_, _2023_03_, _2023_04_, _2023_05_, _2023_06_,
            _2023_07_, _2023_08_, _2023_09_, _2023_10_, _2023_11_, _2023_12_,
            _2024_01_, _2024_02_, _2024_03_, _2024_04_, _2024_05_, _2024_06_,
            _2024_07_, _2024_08_, _2024_09_, _2024_10_, _2024_11_, _2024_12_,
            _2025_01_, _2025_02_
        )
    )
    -- Filter out colon values
    WHERE col_value != ':'
),

-- Process the date and value after unpivoting
processed_measurements AS (
    SELECT
        metadata,
        -- Clean up column name by removing underscores
        REPLACE(date_column, '_', '') AS clean_date_column,
        -- Keep measurement value as string for now
        measurement_value,
        -- Extract month and year from column name and create a proper date
        DATE(CONCAT(
            SUBSTR(REPLACE(date_column, '_', ''), 1, 4), '-',
            SUBSTR(REPLACE(date_column, '_', ''), 5, 2), '-01'
        )) AS measurement_date,
        -- Create a readable date label (e.g., 'Jan 2018')
        CONCAT(
            FORMAT_DATE('%b', DATE(CONCAT(
                SUBSTR(REPLACE(date_column, '_', ''), 1, 4), '-',
                SUBSTR(REPLACE(date_column, '_', ''), 5, 2), '-01'
            ))),
            ' ',
            SUBSTR(REPLACE(date_column, '_', ''), 1, 4)
        ) AS date_label
    FROM unpivoted
),

metadata_extracted AS (
    SELECT
        -- Extract metadata components
        SPLIT(metadata, ',')[SAFE_OFFSET(0)] AS frequency,
        SPLIT(metadata, ',')[SAFE_OFFSET(1)] AS airpol,
        SPLIT(metadata, ',')[SAFE_OFFSET(2)] AS unit,
        SPLIT(metadata, ',')[SAFE_OFFSET(3)] AS geo_code,
        date_label,
        measurement_date,
        -- Convert measurement value to FLOAT64 here, after unpivoting
        SAFE_CAST(measurement_value AS FLOAT64) AS measurement_value,
        CURRENT_TIMESTAMP() AS load_timestamp
    FROM processed_measurements
),

final AS (

SELECT
    ROW_NUMBER() OVER() AS id,
    frequency,
    airpol,
    unit,
    geo_code,
    date_label,
    measurement_date,
    measurement_value,
    load_timestamp
FROM metadata_extracted
ORDER BY geo_code, measurement_date
)

select * from unpivoted;


[0m15:03:33.843603 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m15:03:34.417643 [debug] [Thread-1 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=data-talk-clubs&j=bq:EU:32afb448-4f60-4c75-963f-7885aff47d80&page=queryresults
[0m15:03:34.537774 [error] [Thread-1 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=data-talk-clubs&j=bq:EU:32afb448-4f60-4c75-963f-7885aff47d80&page=queryresults
[0m15:03:34.546617 [debug] [Thread-1 (]: Database Error in model stg_emissions_data (models/staging/stg_emissions_data.sql)
  The datatype of column does not match with other datatypes in the IN clause. Expected FLOAT64, Found STRING at [32:57]
  compiled code at target/run/eu_emissions_project/models/staging/stg_emissions_data.sql
[0m15:03:34.548627 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'db76adc4-e05a-4d74-abce-bd4925084d1d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x112b7b350>]}
[0m15:03:34.549171 [error] [Thread-1 (]: 1 of 1 ERROR creating sql view model eu_emissions_project_staging.stg_emissions_data  [[31mERROR[0m in 0.73s]
[0m15:03:34.549514 [debug] [Thread-1 (]: Finished running node model.eu_emissions_project.stg_emissions_data
[0m15:03:34.549892 [debug] [Thread-11 ]: Marking all children of 'model.eu_emissions_project.stg_emissions_data' to be skipped because of status 'error'.  Reason: Database Error in model stg_emissions_data (models/staging/stg_emissions_data.sql)
  The datatype of column does not match with other datatypes in the IN clause. Expected FLOAT64, Found STRING at [32:57]
  compiled code at target/run/eu_emissions_project/models/staging/stg_emissions_data.sql.
[0m15:03:34.551157 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m15:03:34.552086 [debug] [MainThread]: Connection 'master' was properly closed.
[0m15:03:34.552276 [debug] [MainThread]: Connection 'model.eu_emissions_project.stg_emissions_data' was properly closed.
[0m15:03:34.552442 [debug] [MainThread]: Connection 'list_data-talk-clubs_eu_emissions_project_staging' was properly closed.
[0m15:03:34.552604 [debug] [MainThread]: Connection 'list_data-talk-clubs_eu_emissions_project_marts' was properly closed.
[0m15:03:34.552786 [info ] [MainThread]: 
[0m15:03:34.552975 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 1.27 seconds (1.27s).
[0m15:03:34.553309 [debug] [MainThread]: Command end result
[0m15:03:34.568062 [debug] [MainThread]: Wrote artifact WritableManifest to /Users/timbo/Documents/DataTalks/project/src/target/manifest.json
[0m15:03:34.569080 [debug] [MainThread]: Wrote artifact SemanticManifest to /Users/timbo/Documents/DataTalks/project/src/target/semantic_manifest.json
[0m15:03:34.581627 [debug] [MainThread]: Wrote artifact RunExecutionResult to /Users/timbo/Documents/DataTalks/project/src/target/run_results.json
[0m15:03:34.581967 [info ] [MainThread]: 
[0m15:03:34.582227 [info ] [MainThread]: [31mCompleted with 1 error, 0 partial successes, and 0 warnings:[0m
[0m15:03:34.582430 [info ] [MainThread]: 
[0m15:03:34.582661 [error] [MainThread]:   Database Error in model stg_emissions_data (models/staging/stg_emissions_data.sql)
  The datatype of column does not match with other datatypes in the IN clause. Expected FLOAT64, Found STRING at [32:57]
  compiled code at target/run/eu_emissions_project/models/staging/stg_emissions_data.sql
[0m15:03:34.582845 [info ] [MainThread]: 
[0m15:03:34.583038 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m15:03:34.585348 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": false, "command_wall_clock_time": 2.4177825, "process_in_blocks": "0", "process_kernel_time": 0.351284, "process_mem_max_rss": "205291520", "process_out_blocks": "0", "process_user_time": 1.506369}
[0m15:03:34.586180 [debug] [MainThread]: Command `dbt run` failed at 15:03:34.586040 after 2.42 seconds
[0m15:03:34.586498 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10451a050>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1043bc350>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x106197c90>]}
[0m15:03:34.586763 [debug] [MainThread]: Flushing usage events
[0m15:03:35.024871 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m15:04:45.672322 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10536db50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10536fa50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1053cbf90>]}


============================== 15:04:45.674793 | d2cc9ff7-788f-42da-823f-98c1266fd6d7 ==============================
[0m15:04:45.674793 [info ] [MainThread]: Running with dbt=1.9.3
[0m15:04:45.675161 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': '/Users/timbo/.dbt', 'fail_fast': 'False', 'debug': 'False', 'log_path': '/Users/timbo/Documents/DataTalks/project/src/logs', 'version_check': 'True', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'empty': 'False', 'quiet': 'False', 'no_print': 'None', 'log_format': 'default', 'introspect': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt run -s stg_emissions_data', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m15:04:46.194290 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'd2cc9ff7-788f-42da-823f-98c1266fd6d7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x115a2d690>]}
[0m15:04:46.221515 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'd2cc9ff7-788f-42da-823f-98c1266fd6d7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x102a54050>]}
[0m15:04:46.222034 [info ] [MainThread]: Registered adapter: bigquery=1.9.1
[0m15:04:46.316836 [debug] [MainThread]: checksum: 5671c00892cdbcef29c3b00cc5ba7510c3d18a35c883caeb9ab9ee266dc29c8f, vars: {}, profile: , target: , version: 1.9.3
[0m15:04:46.431927 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m15:04:46.432257 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m15:04:46.451446 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'd2cc9ff7-788f-42da-823f-98c1266fd6d7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x115211e10>]}
[0m15:04:46.488976 [debug] [MainThread]: Wrote artifact WritableManifest to /Users/timbo/Documents/DataTalks/project/src/target/manifest.json
[0m15:04:46.491069 [debug] [MainThread]: Wrote artifact SemanticManifest to /Users/timbo/Documents/DataTalks/project/src/target/semantic_manifest.json
[0m15:04:46.502459 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'd2cc9ff7-788f-42da-823f-98c1266fd6d7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10538a4d0>]}
[0m15:04:46.502841 [info ] [MainThread]: Found 4 models, 1 source, 491 macros
[0m15:04:46.503068 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'd2cc9ff7-788f-42da-823f-98c1266fd6d7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x115ead450>]}
[0m15:04:46.503847 [info ] [MainThread]: 
[0m15:04:46.504128 [info ] [MainThread]: Concurrency: 8 threads (target='dev')
[0m15:04:46.504325 [info ] [MainThread]: 
[0m15:04:46.504676 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m15:04:46.505224 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_data-talk-clubs'
[0m15:04:46.505481 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:04:46.749458 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_data-talk-clubs, now list_data-talk-clubs_eu_emissions_project_intermediate)
[0m15:04:46.749932 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_data-talk-clubs_eu_emissions_project_staging'
[0m15:04:46.750312 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_data-talk-clubs_eu_emissions_project_marts'
[0m15:04:46.750599 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m15:04:46.750809 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:04:46.751004 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:04:47.049419 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'd2cc9ff7-788f-42da-823f-98c1266fd6d7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x115984ad0>]}
[0m15:04:47.049956 [debug] [MainThread]: Opening a new connection, currently in state init
[0m15:04:47.053048 [debug] [Thread-1 (]: Began running node model.eu_emissions_project.stg_emissions_data
[0m15:04:47.053478 [info ] [Thread-1 (]: 1 of 1 START sql view model eu_emissions_project_staging.stg_emissions_data .... [RUN]
[0m15:04:47.053803 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_data-talk-clubs_eu_emissions_project_intermediate, now model.eu_emissions_project.stg_emissions_data)
[0m15:04:47.054051 [debug] [Thread-1 (]: Began compiling node model.eu_emissions_project.stg_emissions_data
[0m15:04:47.059435 [debug] [Thread-1 (]: Writing injected SQL for node "model.eu_emissions_project.stg_emissions_data"
[0m15:04:47.059869 [debug] [Thread-1 (]: Began executing node model.eu_emissions_project.stg_emissions_data
[0m15:04:47.075489 [debug] [Thread-1 (]: Writing runtime sql for node "model.eu_emissions_project.stg_emissions_data"
[0m15:04:47.076180 [debug] [Thread-1 (]: On model.eu_emissions_project.stg_emissions_data: /* {"app": "dbt", "dbt_version": "1.9.3", "profile_name": "big-query", "target_name": "dev", "node_id": "model.eu_emissions_project.stg_emissions_data"} */


  create or replace view `data-talk-clubs`.`eu_emissions_project_staging`.`stg_emissions_data`
  OPTIONS()
  as 

WITH source AS (
    SELECT 
        *
    FROM `data-talk-clubs`.`eu_emissions_project`.`nitrogen_dioxide_data`
),

-- First, prepare the data by converting columns to the right format for unpivoting
preprocessed AS (
    SELECT
        freq_airpol_unit_geo_TIME_PERIOD AS metadata,
        -- All other columns are measurement data columns
        *
    FROM source
),

-- Use UNPIVOT to transform the wide format to long format
unpivoted AS (
    SELECT
        metadata,
        col_name AS date_column,
        CAST(col_value AS STRING) AS measurement_value
    FROM preprocessed
    UNPIVOT(
        measurement_value FOR col_name IN (
            _2018_01_, _2018_02_, _2018_03_, _2018_04_, _2018_05_, _2018_06_,
            _2018_07_, _2018_08_, _2018_09_, _2018_10_, _2018_11_, _2018_12_,
            _2019_01_, _2019_02_, _2019_03_, _2019_04_, _2019_05_, _2019_06_,
            _2019_07_, _2019_08_, _2019_09_, _2019_10_, _2019_11_, _2019_12_,
            _2020_01_, _2020_02_, _2020_03_, _2020_04_, _2020_05_, _2020_06_,
            _2020_07_, _2020_08_, _2020_09_, _2020_10_, _2020_11_, _2020_12_,
            _2021_01_, _2021_02_, _2021_03_, _2021_04_, _2021_05_, _2021_06_,
            _2021_07_, _2021_08_, _2021_09_, _2021_10_, _2021_11_, _2021_12_,
            _2022_01_, _2022_02_, _2022_03_, _2022_04_, _2022_05_, _2022_06_,
            _2022_07_, _2022_08_, _2022_09_, _2022_10_, _2022_11_, _2022_12_,
            _2023_01_, _2023_02_, _2023_03_, _2023_04_, _2023_05_, _2023_06_,
            _2023_07_, _2023_08_, _2023_09_, _2023_10_, _2023_11_, _2023_12_,
            _2024_01_, _2024_02_, _2024_03_, _2024_04_, _2024_05_, _2024_06_,
            _2024_07_, _2024_08_, _2024_09_, _2024_10_, _2024_11_, _2024_12_,
            _2025_01_, _2025_02_
        )
    )
    -- Filter out colon values
    WHERE col_value != ':'
),

-- Process the date and value after unpivoting
processed_measurements AS (
    SELECT
        metadata,
        -- Clean up column name by removing underscores
        REPLACE(date_column, '_', '') AS clean_date_column,
        -- Keep measurement value as string for now
        measurement_value,
        -- Extract month and year from column name and create a proper date
        DATE(CONCAT(
            SUBSTR(REPLACE(date_column, '_', ''), 1, 4), '-',
            SUBSTR(REPLACE(date_column, '_', ''), 5, 2), '-01'
        )) AS measurement_date,
        -- Create a readable date label (e.g., 'Jan 2018')
        CONCAT(
            FORMAT_DATE('%b', DATE(CONCAT(
                SUBSTR(REPLACE(date_column, '_', ''), 1, 4), '-',
                SUBSTR(REPLACE(date_column, '_', ''), 5, 2), '-01'
            ))),
            ' ',
            SUBSTR(REPLACE(date_column, '_', ''), 1, 4)
        ) AS date_label
    FROM unpivoted
),

metadata_extracted AS (
    SELECT
        -- Extract metadata components
        SPLIT(metadata, ',')[SAFE_OFFSET(0)] AS frequency,
        SPLIT(metadata, ',')[SAFE_OFFSET(1)] AS airpol,
        SPLIT(metadata, ',')[SAFE_OFFSET(2)] AS unit,
        SPLIT(metadata, ',')[SAFE_OFFSET(3)] AS geo_code,
        date_label,
        measurement_date,
        -- Convert measurement value to FLOAT64 here, after unpivoting
        SAFE_CAST(measurement_value AS FLOAT64) AS measurement_value,
        CURRENT_TIMESTAMP() AS load_timestamp
    FROM processed_measurements
),

final AS (

SELECT
    ROW_NUMBER() OVER() AS id,
    frequency,
    airpol,
    unit,
    geo_code,
    date_label,
    measurement_date,
    measurement_value,
    load_timestamp
FROM metadata_extracted
ORDER BY geo_code, measurement_date
)

select * from unpivoted;


[0m15:04:47.076556 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m15:04:47.709750 [debug] [Thread-1 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=data-talk-clubs&j=bq:EU:e7bfc63f-48e4-4e91-915e-95182e59bf7e&page=queryresults
[0m15:04:47.798924 [error] [Thread-1 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=data-talk-clubs&j=bq:EU:e7bfc63f-48e4-4e91-915e-95182e59bf7e&page=queryresults
[0m15:04:47.807437 [debug] [Thread-1 (]: Database Error in model stg_emissions_data (models/staging/stg_emissions_data.sql)
  Unrecognized name: col_value; Did you mean col_name? at [50:11]
  compiled code at target/run/eu_emissions_project/models/staging/stg_emissions_data.sql
[0m15:04:47.808889 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd2cc9ff7-788f-42da-823f-98c1266fd6d7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x115d43810>]}
[0m15:04:47.809394 [error] [Thread-1 (]: 1 of 1 ERROR creating sql view model eu_emissions_project_staging.stg_emissions_data  [[31mERROR[0m in 0.75s]
[0m15:04:47.809811 [debug] [Thread-1 (]: Finished running node model.eu_emissions_project.stg_emissions_data
[0m15:04:47.810229 [debug] [Thread-11 ]: Marking all children of 'model.eu_emissions_project.stg_emissions_data' to be skipped because of status 'error'.  Reason: Database Error in model stg_emissions_data (models/staging/stg_emissions_data.sql)
  Unrecognized name: col_value; Did you mean col_name? at [50:11]
  compiled code at target/run/eu_emissions_project/models/staging/stg_emissions_data.sql.
[0m15:04:47.811426 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m15:04:47.812373 [debug] [MainThread]: Connection 'master' was properly closed.
[0m15:04:47.812573 [debug] [MainThread]: Connection 'model.eu_emissions_project.stg_emissions_data' was properly closed.
[0m15:04:47.812742 [debug] [MainThread]: Connection 'list_data-talk-clubs_eu_emissions_project_staging' was properly closed.
[0m15:04:47.812904 [debug] [MainThread]: Connection 'list_data-talk-clubs_eu_emissions_project_marts' was properly closed.
[0m15:04:47.813089 [info ] [MainThread]: 
[0m15:04:47.813280 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 1.31 seconds (1.31s).
[0m15:04:47.813615 [debug] [MainThread]: Command end result
[0m15:04:47.826512 [debug] [MainThread]: Wrote artifact WritableManifest to /Users/timbo/Documents/DataTalks/project/src/target/manifest.json
[0m15:04:47.827455 [debug] [MainThread]: Wrote artifact SemanticManifest to /Users/timbo/Documents/DataTalks/project/src/target/semantic_manifest.json
[0m15:04:47.830260 [debug] [MainThread]: Wrote artifact RunExecutionResult to /Users/timbo/Documents/DataTalks/project/src/target/run_results.json
[0m15:04:47.830461 [info ] [MainThread]: 
[0m15:04:47.830690 [info ] [MainThread]: [31mCompleted with 1 error, 0 partial successes, and 0 warnings:[0m
[0m15:04:47.830872 [info ] [MainThread]: 
[0m15:04:47.831085 [error] [MainThread]:   Database Error in model stg_emissions_data (models/staging/stg_emissions_data.sql)
  Unrecognized name: col_value; Did you mean col_name? at [50:11]
  compiled code at target/run/eu_emissions_project/models/staging/stg_emissions_data.sql
[0m15:04:47.831347 [info ] [MainThread]: 
[0m15:04:47.831713 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m15:04:47.833430 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": false, "command_wall_clock_time": 2.1959088, "process_in_blocks": "0", "process_kernel_time": 0.265717, "process_mem_max_rss": "205586432", "process_out_blocks": "0", "process_user_time": 1.481514}
[0m15:04:47.833741 [debug] [MainThread]: Command `dbt run` failed at 15:04:47.833696 after 2.20 seconds
[0m15:04:47.834003 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10040e110>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1053edf50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1053ee050>]}
[0m15:04:47.834232 [debug] [MainThread]: Flushing usage events
[0m15:04:51.324037 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m15:05:21.250959 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10556db10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1055cbb10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1055cbf90>]}


============================== 15:05:21.253519 | 514b203c-1dac-4961-9af2-ea10c9ae821c ==============================
[0m15:05:21.253519 [info ] [MainThread]: Running with dbt=1.9.3
[0m15:05:21.253899 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': '/Users/timbo/.dbt', 'debug': 'False', 'warn_error': 'None', 'log_path': '/Users/timbo/Documents/DataTalks/project/src/logs', 'version_check': 'True', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'empty': 'False', 'log_format': 'default', 'static_parser': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'target_path': 'None', 'invocation_command': 'dbt run -s stg_emissions_data', 'send_anonymous_usage_stats': 'True'}
[0m15:05:21.698301 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '514b203c-1dac-4961-9af2-ea10c9ae821c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105588d10>]}
[0m15:05:21.725476 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '514b203c-1dac-4961-9af2-ea10c9ae821c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x102344390>]}
[0m15:05:21.725985 [info ] [MainThread]: Registered adapter: bigquery=1.9.1
[0m15:05:21.818860 [debug] [MainThread]: checksum: 5671c00892cdbcef29c3b00cc5ba7510c3d18a35c883caeb9ab9ee266dc29c8f, vars: {}, profile: , target: , version: 1.9.3
[0m15:05:21.930988 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m15:05:21.931444 [debug] [MainThread]: Partial parsing: updated file: eu_emissions_project://models/staging/stg_emissions_data.sql
[0m15:05:22.085753 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '514b203c-1dac-4961-9af2-ea10c9ae821c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11ddc5ad0>]}
[0m15:05:22.122788 [debug] [MainThread]: Wrote artifact WritableManifest to /Users/timbo/Documents/DataTalks/project/src/target/manifest.json
[0m15:05:22.124631 [debug] [MainThread]: Wrote artifact SemanticManifest to /Users/timbo/Documents/DataTalks/project/src/target/semantic_manifest.json
[0m15:05:22.135556 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '514b203c-1dac-4961-9af2-ea10c9ae821c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11dd3bd50>]}
[0m15:05:22.135899 [info ] [MainThread]: Found 4 models, 1 source, 491 macros
[0m15:05:22.136113 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '514b203c-1dac-4961-9af2-ea10c9ae821c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11db8ab10>]}
[0m15:05:22.136826 [info ] [MainThread]: 
[0m15:05:22.137031 [info ] [MainThread]: Concurrency: 8 threads (target='dev')
[0m15:05:22.137197 [info ] [MainThread]: 
[0m15:05:22.137463 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m15:05:22.137901 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_data-talk-clubs'
[0m15:05:22.138093 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:05:22.368938 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_data-talk-clubs, now list_data-talk-clubs_eu_emissions_project_staging)
[0m15:05:22.369325 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_data-talk-clubs_eu_emissions_project_marts'
[0m15:05:22.369597 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m15:05:22.369825 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_data-talk-clubs_eu_emissions_project_intermediate'
[0m15:05:22.370033 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:05:22.370277 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:05:22.654216 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '514b203c-1dac-4961-9af2-ea10c9ae821c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11ddc4c10>]}
[0m15:05:22.654684 [debug] [MainThread]: Opening a new connection, currently in state init
[0m15:05:22.657909 [debug] [Thread-1 (]: Began running node model.eu_emissions_project.stg_emissions_data
[0m15:05:22.658290 [info ] [Thread-1 (]: 1 of 1 START sql view model eu_emissions_project_staging.stg_emissions_data .... [RUN]
[0m15:05:22.658576 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_data-talk-clubs_eu_emissions_project_staging, now model.eu_emissions_project.stg_emissions_data)
[0m15:05:22.658789 [debug] [Thread-1 (]: Began compiling node model.eu_emissions_project.stg_emissions_data
[0m15:05:22.663054 [debug] [Thread-1 (]: Writing injected SQL for node "model.eu_emissions_project.stg_emissions_data"
[0m15:05:22.663484 [debug] [Thread-1 (]: Began executing node model.eu_emissions_project.stg_emissions_data
[0m15:05:22.677784 [debug] [Thread-1 (]: Writing runtime sql for node "model.eu_emissions_project.stg_emissions_data"
[0m15:05:22.678593 [debug] [Thread-1 (]: On model.eu_emissions_project.stg_emissions_data: /* {"app": "dbt", "dbt_version": "1.9.3", "profile_name": "big-query", "target_name": "dev", "node_id": "model.eu_emissions_project.stg_emissions_data"} */


  create or replace view `data-talk-clubs`.`eu_emissions_project_staging`.`stg_emissions_data`
  OPTIONS()
  as 

WITH source AS (
    SELECT 
        *
    FROM `data-talk-clubs`.`eu_emissions_project`.`nitrogen_dioxide_data`
),

-- First, prepare the data by converting columns to the right format for unpivoting
preprocessed AS (
    SELECT
        freq_airpol_unit_geo_TIME_PERIOD AS metadata,
        -- All other columns are measurement data columns
        *
    FROM source
),

-- Use UNPIVOT to transform the wide format to long format
unpivoted AS (
    SELECT
        metadata,
        col_name AS date_column,
        CAST(col_value AS STRING) AS measurement_value
    FROM preprocessed
    UNPIVOT(
        measurement_value FOR col_name IN (
            _2018_01_, _2018_02_, _2018_03_, _2018_04_, _2018_05_, _2018_06_,
            _2018_07_, _2018_08_, _2018_09_, _2018_10_, _2018_11_, _2018_12_,
            _2019_01_, _2019_02_, _2019_03_, _2019_04_, _2019_05_, _2019_06_,
            _2019_07_, _2019_08_, _2019_09_, _2019_10_, _2019_11_, _2019_12_,
            _2020_01_, _2020_02_, _2020_03_, _2020_04_, _2020_05_, _2020_06_,
            _2020_07_, _2020_08_, _2020_09_, _2020_10_, _2020_11_, _2020_12_,
            _2021_01_, _2021_02_, _2021_03_, _2021_04_, _2021_05_, _2021_06_,
            _2021_07_, _2021_08_, _2021_09_, _2021_10_, _2021_11_, _2021_12_,
            _2022_01_, _2022_02_, _2022_03_, _2022_04_, _2022_05_, _2022_06_,
            _2022_07_, _2022_08_, _2022_09_, _2022_10_, _2022_11_, _2022_12_,
            _2023_01_, _2023_02_, _2023_03_, _2023_04_, _2023_05_, _2023_06_,
            _2023_07_, _2023_08_, _2023_09_, _2023_10_, _2023_11_, _2023_12_,
            _2024_01_, _2024_02_, _2024_03_, _2024_04_, _2024_05_, _2024_06_,
            _2024_07_, _2024_08_, _2024_09_, _2024_10_, _2024_11_, _2024_12_,
            _2025_01_, _2025_02_
        )
    )
    -- Filter out colon values
    WHERE measurement_value != ':'
),

-- Process the date and value after unpivoting
processed_measurements AS (
    SELECT
        metadata,
        -- Clean up column name by removing underscores
        REPLACE(date_column, '_', '') AS clean_date_column,
        -- Keep measurement value as string for now
        measurement_value,
        -- Extract month and year from column name and create a proper date
        DATE(CONCAT(
            SUBSTR(REPLACE(date_column, '_', ''), 1, 4), '-',
            SUBSTR(REPLACE(date_column, '_', ''), 5, 2), '-01'
        )) AS measurement_date,
        -- Create a readable date label (e.g., 'Jan 2018')
        CONCAT(
            FORMAT_DATE('%b', DATE(CONCAT(
                SUBSTR(REPLACE(date_column, '_', ''), 1, 4), '-',
                SUBSTR(REPLACE(date_column, '_', ''), 5, 2), '-01'
            ))),
            ' ',
            SUBSTR(REPLACE(date_column, '_', ''), 1, 4)
        ) AS date_label
    FROM unpivoted
),

metadata_extracted AS (
    SELECT
        -- Extract metadata components
        SPLIT(metadata, ',')[SAFE_OFFSET(0)] AS frequency,
        SPLIT(metadata, ',')[SAFE_OFFSET(1)] AS airpol,
        SPLIT(metadata, ',')[SAFE_OFFSET(2)] AS unit,
        SPLIT(metadata, ',')[SAFE_OFFSET(3)] AS geo_code,
        date_label,
        measurement_date,
        -- Convert measurement value to FLOAT64 here, after unpivoting
        SAFE_CAST(measurement_value AS FLOAT64) AS measurement_value,
        CURRENT_TIMESTAMP() AS load_timestamp
    FROM processed_measurements
),

final AS (

SELECT
    ROW_NUMBER() OVER() AS id,
    frequency,
    airpol,
    unit,
    geo_code,
    date_label,
    measurement_date,
    measurement_value,
    load_timestamp
FROM metadata_extracted
ORDER BY geo_code, measurement_date
)

select * from unpivoted;


[0m15:05:22.678969 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m15:05:23.049392 [debug] [Thread-1 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=data-talk-clubs&j=bq:EU:a78753a8-b731-4d6e-85ce-1dd0395fcef1&page=queryresults
[0m15:05:23.213486 [error] [Thread-1 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=data-talk-clubs&j=bq:EU:a78753a8-b731-4d6e-85ce-1dd0395fcef1&page=queryresults
[0m15:05:23.222363 [debug] [Thread-1 (]: Database Error in model stg_emissions_data (models/staging/stg_emissions_data.sql)
  No matching signature for operator != for argument types: FLOAT64, STRING
    Signature: T1 != T1
      Unable to find common supertype for templated argument <T1>
        Input types for <T1>: {DOUBLE, STRING} at [50:11]
  compiled code at target/run/eu_emissions_project/models/staging/stg_emissions_data.sql
[0m15:05:23.223912 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '514b203c-1dac-4961-9af2-ea10c9ae821c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11df84c10>]}
[0m15:05:23.224548 [error] [Thread-1 (]: 1 of 1 ERROR creating sql view model eu_emissions_project_staging.stg_emissions_data  [[31mERROR[0m in 0.56s]
[0m15:05:23.224898 [debug] [Thread-1 (]: Finished running node model.eu_emissions_project.stg_emissions_data
[0m15:05:23.225335 [debug] [Thread-11 ]: Marking all children of 'model.eu_emissions_project.stg_emissions_data' to be skipped because of status 'error'.  Reason: Database Error in model stg_emissions_data (models/staging/stg_emissions_data.sql)
  No matching signature for operator != for argument types: FLOAT64, STRING
    Signature: T1 != T1
      Unable to find common supertype for templated argument <T1>
        Input types for <T1>: {DOUBLE, STRING} at [50:11]
  compiled code at target/run/eu_emissions_project/models/staging/stg_emissions_data.sql.
[0m15:05:23.226807 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m15:05:23.227951 [debug] [MainThread]: Connection 'master' was properly closed.
[0m15:05:23.228206 [debug] [MainThread]: Connection 'model.eu_emissions_project.stg_emissions_data' was properly closed.
[0m15:05:23.228388 [debug] [MainThread]: Connection 'list_data-talk-clubs_eu_emissions_project_marts' was properly closed.
[0m15:05:23.228551 [debug] [MainThread]: Connection 'list_data-talk-clubs_eu_emissions_project_intermediate' was properly closed.
[0m15:05:23.228753 [info ] [MainThread]: 
[0m15:05:23.228958 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 1.09 seconds (1.09s).
[0m15:05:23.229335 [debug] [MainThread]: Command end result
[0m15:05:23.243957 [debug] [MainThread]: Wrote artifact WritableManifest to /Users/timbo/Documents/DataTalks/project/src/target/manifest.json
[0m15:05:23.245039 [debug] [MainThread]: Wrote artifact SemanticManifest to /Users/timbo/Documents/DataTalks/project/src/target/semantic_manifest.json
[0m15:05:23.248099 [debug] [MainThread]: Wrote artifact RunExecutionResult to /Users/timbo/Documents/DataTalks/project/src/target/run_results.json
[0m15:05:23.248352 [info ] [MainThread]: 
[0m15:05:23.248589 [info ] [MainThread]: [31mCompleted with 1 error, 0 partial successes, and 0 warnings:[0m
[0m15:05:23.248776 [info ] [MainThread]: 
[0m15:05:23.248993 [error] [MainThread]:   Database Error in model stg_emissions_data (models/staging/stg_emissions_data.sql)
  No matching signature for operator != for argument types: FLOAT64, STRING
    Signature: T1 != T1
      Unable to find common supertype for templated argument <T1>
        Input types for <T1>: {DOUBLE, STRING} at [50:11]
  compiled code at target/run/eu_emissions_project/models/staging/stg_emissions_data.sql
[0m15:05:23.249176 [info ] [MainThread]: 
[0m15:05:23.249364 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m15:05:23.250893 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": false, "command_wall_clock_time": 2.0356972, "process_in_blocks": "0", "process_kernel_time": 0.245282, "process_mem_max_rss": "211795968", "process_out_blocks": "0", "process_user_time": 1.602242}
[0m15:05:23.251220 [debug] [MainThread]: Command `dbt run` failed at 15:05:23.251177 after 2.04 seconds
[0m15:05:23.251456 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1006b5e50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1005583d0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10232bb50>]}
[0m15:05:23.251670 [debug] [MainThread]: Flushing usage events
[0m15:05:23.675485 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m15:07:01.282939 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x106f77a50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x106fd3950>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x106fd3f90>]}


============================== 15:07:01.285394 | 43753b7a-bc35-44a0-8c05-df7e401218f7 ==============================
[0m15:07:01.285394 [info ] [MainThread]: Running with dbt=1.9.3
[0m15:07:01.285758 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': '/Users/timbo/.dbt', 'debug': 'False', 'fail_fast': 'False', 'log_path': '/Users/timbo/Documents/DataTalks/project/src/logs', 'warn_error': 'None', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'empty': 'False', 'log_format': 'default', 'static_parser': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'target_path': 'None', 'invocation_command': 'dbt run -s stg_emissions_data', 'send_anonymous_usage_stats': 'True'}
[0m15:07:01.743356 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '43753b7a-bc35-44a0-8c05-df7e401218f7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x106ffb050>]}
[0m15:07:01.770596 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '43753b7a-bc35-44a0-8c05-df7e401218f7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104f748d0>]}
[0m15:07:01.771124 [info ] [MainThread]: Registered adapter: bigquery=1.9.1
[0m15:07:01.864987 [debug] [MainThread]: checksum: 5671c00892cdbcef29c3b00cc5ba7510c3d18a35c883caeb9ab9ee266dc29c8f, vars: {}, profile: , target: , version: 1.9.3
[0m15:07:01.977737 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m15:07:01.978181 [debug] [MainThread]: Partial parsing: updated file: eu_emissions_project://models/staging/stg_emissions_data.sql
[0m15:07:02.130940 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '43753b7a-bc35-44a0-8c05-df7e401218f7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10e811d50>]}
[0m15:07:02.167250 [debug] [MainThread]: Wrote artifact WritableManifest to /Users/timbo/Documents/DataTalks/project/src/target/manifest.json
[0m15:07:02.168939 [debug] [MainThread]: Wrote artifact SemanticManifest to /Users/timbo/Documents/DataTalks/project/src/target/semantic_manifest.json
[0m15:07:02.182350 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '43753b7a-bc35-44a0-8c05-df7e401218f7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ead81d0>]}
[0m15:07:02.182779 [info ] [MainThread]: Found 4 models, 1 source, 491 macros
[0m15:07:02.183298 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '43753b7a-bc35-44a0-8c05-df7e401218f7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10e64f150>]}
[0m15:07:02.184143 [info ] [MainThread]: 
[0m15:07:02.184393 [info ] [MainThread]: Concurrency: 8 threads (target='dev')
[0m15:07:02.184583 [info ] [MainThread]: 
[0m15:07:02.184890 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m15:07:02.185395 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_data-talk-clubs'
[0m15:07:02.185742 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:07:02.425822 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_data-talk-clubs, now list_data-talk-clubs_eu_emissions_project_staging)
[0m15:07:02.426237 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_data-talk-clubs_eu_emissions_project_intermediate'
[0m15:07:02.426516 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_data-talk-clubs_eu_emissions_project_marts'
[0m15:07:02.426763 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m15:07:02.426969 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:07:02.427138 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:07:02.697813 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '43753b7a-bc35-44a0-8c05-df7e401218f7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10e2d5990>]}
[0m15:07:02.698261 [debug] [MainThread]: Opening a new connection, currently in state init
[0m15:07:02.701658 [debug] [Thread-1 (]: Began running node model.eu_emissions_project.stg_emissions_data
[0m15:07:02.702020 [info ] [Thread-1 (]: 1 of 1 START sql view model eu_emissions_project_staging.stg_emissions_data .... [RUN]
[0m15:07:02.702299 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_data-talk-clubs_eu_emissions_project_staging, now model.eu_emissions_project.stg_emissions_data)
[0m15:07:02.702512 [debug] [Thread-1 (]: Began compiling node model.eu_emissions_project.stg_emissions_data
[0m15:07:02.707088 [debug] [Thread-1 (]: Writing injected SQL for node "model.eu_emissions_project.stg_emissions_data"
[0m15:07:02.707632 [debug] [Thread-1 (]: Began executing node model.eu_emissions_project.stg_emissions_data
[0m15:07:02.722925 [debug] [Thread-1 (]: Writing runtime sql for node "model.eu_emissions_project.stg_emissions_data"
[0m15:07:02.723625 [debug] [Thread-1 (]: On model.eu_emissions_project.stg_emissions_data: /* {"app": "dbt", "dbt_version": "1.9.3", "profile_name": "big-query", "target_name": "dev", "node_id": "model.eu_emissions_project.stg_emissions_data"} */


  create or replace view `data-talk-clubs`.`eu_emissions_project_staging`.`stg_emissions_data`
  OPTIONS()
  as 

WITH source AS (
    SELECT 
        *
    FROM `data-talk-clubs`.`eu_emissions_project`.`nitrogen_dioxide_data`
),

-- First, prepare the data by converting columns to the right format for unpivoting
preprocessed AS (
    SELECT
        freq_airpol_unit_geo_TIME_PERIOD AS metadata,
        -- All other columns are measurement data columns
        *
    FROM source
),

-- Use UNPIVOT to transform the wide format to long format
unpivoted AS (
    SELECT
        metadata,
        col_name AS date_column,
        CAST(col_value AS STRING) AS measurement_value
    FROM preprocessed
    UNPIVOT(
        col_value FOR col_name IN (
            _2018_01_, _2018_02_, _2018_03_, _2018_04_, _2018_05_, _2018_06_,
            _2018_07_, _2018_08_, _2018_09_, _2018_10_, _2018_11_, _2018_12_,
            _2019_01_, _2019_02_, _2019_03_, _2019_04_, _2019_05_, _2019_06_,
            _2019_07_, _2019_08_, _2019_09_, _2019_10_, _2019_11_, _2019_12_,
            _2020_01_, _2020_02_, _2020_03_, _2020_04_, _2020_05_, _2020_06_,
            _2020_07_, _2020_08_, _2020_09_, _2020_10_, _2020_11_, _2020_12_,
            _2021_01_, _2021_02_, _2021_03_, _2021_04_, _2021_05_, _2021_06_,
            _2021_07_, _2021_08_, _2021_09_, _2021_10_, _2021_11_, _2021_12_,
            _2022_01_, _2022_02_, _2022_03_, _2022_04_, _2022_05_, _2022_06_,
            _2022_07_, _2022_08_, _2022_09_, _2022_10_, _2022_11_, _2022_12_,
            _2023_01_, _2023_02_, _2023_03_, _2023_04_, _2023_05_, _2023_06_,
            _2023_07_, _2023_08_, _2023_09_, _2023_10_, _2023_11_, _2023_12_,
            _2024_01_, _2024_02_, _2024_03_, _2024_04_, _2024_05_, _2024_06_,
            _2024_07_, _2024_08_, _2024_09_, _2024_10_, _2024_11_, _2024_12_,
            _2025_01_, _2025_02_
        )
    )
    -- Filter out zero values that represent missing data
    -- WHERE measurement_value != '0.0'
),

-- Process the date and value after unpivoting
processed_measurements AS (
    SELECT
        metadata,
        -- Clean up column name by removing underscores
        REPLACE(date_column, '_', '') AS clean_date_column,
        -- Keep measurement value as string for now
        measurement_value,
        -- Extract month and year from column name and create a proper date
        DATE(CONCAT(
            SUBSTR(REPLACE(date_column, '_', ''), 1, 4), '-',
            SUBSTR(REPLACE(date_column, '_', ''), 5, 2), '-01'
        )) AS measurement_date,
        -- Create a readable date label (e.g., 'Jan 2018')
        CONCAT(
            FORMAT_DATE('%b', DATE(CONCAT(
                SUBSTR(REPLACE(date_column, '_', ''), 1, 4), '-',
                SUBSTR(REPLACE(date_column, '_', ''), 5, 2), '-01'
            ))),
            ' ',
            SUBSTR(REPLACE(date_column, '_', ''), 1, 4)
        ) AS date_label
    FROM unpivoted
),

metadata_extracted AS (
    SELECT
        -- Extract metadata components
        SPLIT(metadata, ',')[SAFE_OFFSET(0)] AS frequency,
        SPLIT(metadata, ',')[SAFE_OFFSET(1)] AS airpol,
        SPLIT(metadata, ',')[SAFE_OFFSET(2)] AS unit,
        SPLIT(metadata, ',')[SAFE_OFFSET(3)] AS geo_code,
        date_label,
        measurement_date,
        -- Convert measurement value to FLOAT64 here, after unpivoting
        SAFE_CAST(measurement_value AS FLOAT64) AS measurement_value,
        CURRENT_TIMESTAMP() AS load_timestamp
    FROM processed_measurements
),

final AS (

SELECT
    ROW_NUMBER() OVER() AS id,
    frequency,
    airpol,
    unit,
    geo_code,
    date_label,
    measurement_date,
    measurement_value,
    load_timestamp
FROM metadata_extracted
ORDER BY geo_code, measurement_date
)

select * from unpivoted;


[0m15:07:02.723983 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m15:07:03.287978 [debug] [Thread-1 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=data-talk-clubs&j=bq:EU:1cfa381c-4ade-44a6-a191-9649ba4cb07d&page=queryresults
[0m15:07:03.543766 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '43753b7a-bc35-44a0-8c05-df7e401218f7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10e693e90>]}
[0m15:07:03.544306 [info ] [Thread-1 (]: 1 of 1 OK created sql view model eu_emissions_project_staging.stg_emissions_data  [[32mCREATE VIEW (0 processed)[0m in 0.84s]
[0m15:07:03.544647 [debug] [Thread-1 (]: Finished running node model.eu_emissions_project.stg_emissions_data
[0m15:07:03.545448 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m15:07:03.546471 [debug] [MainThread]: Connection 'master' was properly closed.
[0m15:07:03.546683 [debug] [MainThread]: Connection 'model.eu_emissions_project.stg_emissions_data' was properly closed.
[0m15:07:03.546858 [debug] [MainThread]: Connection 'list_data-talk-clubs_eu_emissions_project_intermediate' was properly closed.
[0m15:07:03.547021 [debug] [MainThread]: Connection 'list_data-talk-clubs_eu_emissions_project_marts' was properly closed.
[0m15:07:03.547208 [info ] [MainThread]: 
[0m15:07:03.547403 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 1.36 seconds (1.36s).
[0m15:07:03.547838 [debug] [MainThread]: Command end result
[0m15:07:03.561071 [debug] [MainThread]: Wrote artifact WritableManifest to /Users/timbo/Documents/DataTalks/project/src/target/manifest.json
[0m15:07:03.562097 [debug] [MainThread]: Wrote artifact SemanticManifest to /Users/timbo/Documents/DataTalks/project/src/target/semantic_manifest.json
[0m15:07:03.564935 [debug] [MainThread]: Wrote artifact RunExecutionResult to /Users/timbo/Documents/DataTalks/project/src/target/run_results.json
[0m15:07:03.565178 [info ] [MainThread]: 
[0m15:07:03.565429 [info ] [MainThread]: [32mCompleted successfully[0m
[0m15:07:03.565614 [info ] [MainThread]: 
[0m15:07:03.565807 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m15:07:03.567375 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": true, "command_wall_clock_time": 2.3195617, "process_in_blocks": "0", "process_kernel_time": 0.290157, "process_mem_max_rss": "215351296", "process_out_blocks": "0", "process_user_time": 1.632224}
[0m15:07:03.567738 [debug] [MainThread]: Command `dbt run` succeeded at 15:07:03.567690 after 2.32 seconds
[0m15:07:03.567983 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10332a110>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1031348d0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x103124310>]}
[0m15:07:03.568217 [debug] [MainThread]: Flushing usage events
[0m15:07:03.993863 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m15:07:12.815558 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110a6db50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110acb690>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110acbf90>]}


============================== 15:07:12.817968 | ad073f55-91e2-43b0-8cd3-0488b4334894 ==============================
[0m15:07:12.817968 [info ] [MainThread]: Running with dbt=1.9.3
[0m15:07:12.818342 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'fail_fast': 'False', 'profiles_dir': '/Users/timbo/.dbt', 'log_path': '/Users/timbo/Documents/DataTalks/project/src/logs', 'version_check': 'True', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'empty': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt run -s stg_emissions_data', 'static_parser': 'True', 'log_format': 'default', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m15:07:13.252771 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'ad073f55-91e2-43b0-8cd3-0488b4334894', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1175209d0>]}
[0m15:07:13.279972 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'ad073f55-91e2-43b0-8cd3-0488b4334894', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105948050>]}
[0m15:07:13.280375 [info ] [MainThread]: Registered adapter: bigquery=1.9.1
[0m15:07:13.371419 [debug] [MainThread]: checksum: 5671c00892cdbcef29c3b00cc5ba7510c3d18a35c883caeb9ab9ee266dc29c8f, vars: {}, profile: , target: , version: 1.9.3
[0m15:07:13.482946 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m15:07:13.483353 [debug] [MainThread]: Partial parsing: updated file: eu_emissions_project://models/staging/stg_emissions_data.sql
[0m15:07:13.636068 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'ad073f55-91e2-43b0-8cd3-0488b4334894', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x117feb210>]}
[0m15:07:13.672731 [debug] [MainThread]: Wrote artifact WritableManifest to /Users/timbo/Documents/DataTalks/project/src/target/manifest.json
[0m15:07:13.674722 [debug] [MainThread]: Wrote artifact SemanticManifest to /Users/timbo/Documents/DataTalks/project/src/target/semantic_manifest.json
[0m15:07:13.686469 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'ad073f55-91e2-43b0-8cd3-0488b4334894', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x120a581d0>]}
[0m15:07:13.686850 [info ] [MainThread]: Found 4 models, 1 source, 491 macros
[0m15:07:13.687079 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'ad073f55-91e2-43b0-8cd3-0488b4334894', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1105e8450>]}
[0m15:07:13.687861 [info ] [MainThread]: 
[0m15:07:13.688070 [info ] [MainThread]: Concurrency: 8 threads (target='dev')
[0m15:07:13.688241 [info ] [MainThread]: 
[0m15:07:13.688524 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m15:07:13.689020 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_data-talk-clubs'
[0m15:07:13.689279 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:07:13.926469 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_data-talk-clubs, now list_data-talk-clubs_eu_emissions_project_intermediate)
[0m15:07:13.926949 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_data-talk-clubs_eu_emissions_project_marts'
[0m15:07:13.927288 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m15:07:13.927606 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_data-talk-clubs_eu_emissions_project_staging'
[0m15:07:13.927870 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:07:13.928174 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:07:14.253043 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'ad073f55-91e2-43b0-8cd3-0488b4334894', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x117bacd50>]}
[0m15:07:14.253630 [debug] [MainThread]: Opening a new connection, currently in state init
[0m15:07:14.256807 [debug] [Thread-1 (]: Began running node model.eu_emissions_project.stg_emissions_data
[0m15:07:14.257182 [info ] [Thread-1 (]: 1 of 1 START sql view model eu_emissions_project_staging.stg_emissions_data .... [RUN]
[0m15:07:14.257462 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_data-talk-clubs_eu_emissions_project_intermediate, now model.eu_emissions_project.stg_emissions_data)
[0m15:07:14.257677 [debug] [Thread-1 (]: Began compiling node model.eu_emissions_project.stg_emissions_data
[0m15:07:14.262285 [debug] [Thread-1 (]: Writing injected SQL for node "model.eu_emissions_project.stg_emissions_data"
[0m15:07:14.262692 [debug] [Thread-1 (]: Began executing node model.eu_emissions_project.stg_emissions_data
[0m15:07:14.276842 [debug] [Thread-1 (]: Writing runtime sql for node "model.eu_emissions_project.stg_emissions_data"
[0m15:07:14.277562 [debug] [Thread-1 (]: On model.eu_emissions_project.stg_emissions_data: /* {"app": "dbt", "dbt_version": "1.9.3", "profile_name": "big-query", "target_name": "dev", "node_id": "model.eu_emissions_project.stg_emissions_data"} */


  create or replace view `data-talk-clubs`.`eu_emissions_project_staging`.`stg_emissions_data`
  OPTIONS()
  as 

WITH source AS (
    SELECT 
        *
    FROM `data-talk-clubs`.`eu_emissions_project`.`nitrogen_dioxide_data`
),

-- First, prepare the data by converting columns to the right format for unpivoting
preprocessed AS (
    SELECT
        freq_airpol_unit_geo_TIME_PERIOD AS metadata,
        -- All other columns are measurement data columns
        *
    FROM source
),

-- Use UNPIVOT to transform the wide format to long format
unpivoted AS (
    SELECT
        metadata,
        col_name AS date_column,
        CAST(col_value AS STRING) AS measurement_value
    FROM preprocessed
    UNPIVOT(
        col_value FOR col_name IN (
            _2018_01_, _2018_02_, _2018_03_, _2018_04_, _2018_05_, _2018_06_,
            _2018_07_, _2018_08_, _2018_09_, _2018_10_, _2018_11_, _2018_12_,
            _2019_01_, _2019_02_, _2019_03_, _2019_04_, _2019_05_, _2019_06_,
            _2019_07_, _2019_08_, _2019_09_, _2019_10_, _2019_11_, _2019_12_,
            _2020_01_, _2020_02_, _2020_03_, _2020_04_, _2020_05_, _2020_06_,
            _2020_07_, _2020_08_, _2020_09_, _2020_10_, _2020_11_, _2020_12_,
            _2021_01_, _2021_02_, _2021_03_, _2021_04_, _2021_05_, _2021_06_,
            _2021_07_, _2021_08_, _2021_09_, _2021_10_, _2021_11_, _2021_12_,
            _2022_01_, _2022_02_, _2022_03_, _2022_04_, _2022_05_, _2022_06_,
            _2022_07_, _2022_08_, _2022_09_, _2022_10_, _2022_11_, _2022_12_,
            _2023_01_, _2023_02_, _2023_03_, _2023_04_, _2023_05_, _2023_06_,
            _2023_07_, _2023_08_, _2023_09_, _2023_10_, _2023_11_, _2023_12_,
            _2024_01_, _2024_02_, _2024_03_, _2024_04_, _2024_05_, _2024_06_,
            _2024_07_, _2024_08_, _2024_09_, _2024_10_, _2024_11_, _2024_12_,
            _2025_01_, _2025_02_
        )
    )
    -- Filter out zero values that represent missing data
    -- WHERE measurement_value != '0.0'
),

-- Process the date and value after unpivoting
processed_measurements AS (
    SELECT
        metadata,
        -- Clean up column name by removing underscores
        REPLACE(date_column, '_', '') AS clean_date_column,
        -- Keep measurement value as string for now
        measurement_value,
        -- Extract month and year from column name and create a proper date
        DATE(CONCAT(
            SUBSTR(REPLACE(date_column, '_', ''), 1, 4), '-',
            SUBSTR(REPLACE(date_column, '_', ''), 5, 2), '-01'
        )) AS measurement_date,
        -- Create a readable date label (e.g., 'Jan 2018')
        CONCAT(
            FORMAT_DATE('%b', DATE(CONCAT(
                SUBSTR(REPLACE(date_column, '_', ''), 1, 4), '-',
                SUBSTR(REPLACE(date_column, '_', ''), 5, 2), '-01'
            ))),
            ' ',
            SUBSTR(REPLACE(date_column, '_', ''), 1, 4)
        ) AS date_label
    FROM unpivoted
),

metadata_extracted AS (
    SELECT
        -- Extract metadata components
        SPLIT(metadata, ',')[SAFE_OFFSET(0)] AS frequency,
        SPLIT(metadata, ',')[SAFE_OFFSET(1)] AS airpol,
        SPLIT(metadata, ',')[SAFE_OFFSET(2)] AS unit,
        SPLIT(metadata, ',')[SAFE_OFFSET(3)] AS geo_code,
        date_label,
        measurement_date,
        -- Convert measurement value to FLOAT64 here, after unpivoting
        SAFE_CAST(measurement_value AS FLOAT64) AS measurement_value,
        CURRENT_TIMESTAMP() AS load_timestamp
    FROM processed_measurements
),

final AS (

SELECT
    ROW_NUMBER() OVER() AS id,
    frequency,
    airpol,
    unit,
    geo_code,
    date_label,
    measurement_date,
    measurement_value,
    load_timestamp
FROM metadata_extracted
ORDER BY geo_code, measurement_date
)

select * from final;


[0m15:07:14.278004 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m15:07:14.829815 [debug] [Thread-1 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=data-talk-clubs&j=bq:EU:058fca8f-cf64-48e3-9247-fb23f2f10042&page=queryresults
[0m15:07:15.150128 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ad073f55-91e2-43b0-8cd3-0488b4334894', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x120b62f50>]}
[0m15:07:15.150726 [info ] [Thread-1 (]: 1 of 1 OK created sql view model eu_emissions_project_staging.stg_emissions_data  [[32mCREATE VIEW (0 processed)[0m in 0.89s]
[0m15:07:15.151152 [debug] [Thread-1 (]: Finished running node model.eu_emissions_project.stg_emissions_data
[0m15:07:15.151975 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m15:07:15.152935 [debug] [MainThread]: Connection 'master' was properly closed.
[0m15:07:15.153163 [debug] [MainThread]: Connection 'model.eu_emissions_project.stg_emissions_data' was properly closed.
[0m15:07:15.153457 [debug] [MainThread]: Connection 'list_data-talk-clubs_eu_emissions_project_marts' was properly closed.
[0m15:07:15.153657 [debug] [MainThread]: Connection 'list_data-talk-clubs_eu_emissions_project_staging' was properly closed.
[0m15:07:15.153853 [info ] [MainThread]: 
[0m15:07:15.154048 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 1.47 seconds (1.47s).
[0m15:07:15.154385 [debug] [MainThread]: Command end result
[0m15:07:15.167343 [debug] [MainThread]: Wrote artifact WritableManifest to /Users/timbo/Documents/DataTalks/project/src/target/manifest.json
[0m15:07:15.168375 [debug] [MainThread]: Wrote artifact SemanticManifest to /Users/timbo/Documents/DataTalks/project/src/target/semantic_manifest.json
[0m15:07:15.171230 [debug] [MainThread]: Wrote artifact RunExecutionResult to /Users/timbo/Documents/DataTalks/project/src/target/run_results.json
[0m15:07:15.171464 [info ] [MainThread]: 
[0m15:07:15.171709 [info ] [MainThread]: [32mCompleted successfully[0m
[0m15:07:15.171890 [info ] [MainThread]: 
[0m15:07:15.172079 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m15:07:15.173655 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": true, "command_wall_clock_time": 2.3928082, "process_in_blocks": "0", "process_kernel_time": 0.240618, "process_mem_max_rss": "214073344", "process_out_blocks": "0", "process_user_time": 1.61534}
[0m15:07:15.173992 [debug] [MainThread]: Command `dbt run` succeeded at 15:07:15.173945 after 2.39 seconds
[0m15:07:15.174259 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x103186110>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110ac38d0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x103018310>]}
[0m15:07:15.174510 [debug] [MainThread]: Flushing usage events
[0m15:07:15.595802 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m15:09:09.048713 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10696f8d0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1069c9690>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1069cbf90>]}


============================== 15:09:09.051078 | 2eeee685-7cca-4646-b426-5c35c25c46b5 ==============================
[0m15:09:09.051078 [info ] [MainThread]: Running with dbt=1.9.3
[0m15:09:09.051442 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'fail_fast': 'False', 'profiles_dir': '/Users/timbo/.dbt', 'log_path': '/Users/timbo/Documents/DataTalks/project/src/logs', 'version_check': 'True', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'empty': 'False', 'log_format': 'default', 'invocation_command': 'dbt run -s stg_emissions_data', 'static_parser': 'True', 'introspect': 'True', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m15:09:09.541852 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '2eeee685-7cca-4646-b426-5c35c25c46b5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x12cb4a010>]}
[0m15:09:09.569734 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '2eeee685-7cca-4646-b426-5c35c25c46b5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1037a0fd0>]}
[0m15:09:09.570350 [info ] [MainThread]: Registered adapter: bigquery=1.9.1
[0m15:09:09.664956 [debug] [MainThread]: checksum: 5671c00892cdbcef29c3b00cc5ba7510c3d18a35c883caeb9ab9ee266dc29c8f, vars: {}, profile: , target: , version: 1.9.3
[0m15:09:09.781369 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m15:09:09.781874 [debug] [MainThread]: Partial parsing: updated file: eu_emissions_project://models/staging/stg_emissions_data.sql
[0m15:09:09.934641 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '2eeee685-7cca-4646-b426-5c35c25c46b5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x12e08f9d0>]}
[0m15:09:09.971628 [debug] [MainThread]: Wrote artifact WritableManifest to /Users/timbo/Documents/DataTalks/project/src/target/manifest.json
[0m15:09:09.973786 [debug] [MainThread]: Wrote artifact SemanticManifest to /Users/timbo/Documents/DataTalks/project/src/target/semantic_manifest.json
[0m15:09:09.985250 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '2eeee685-7cca-4646-b426-5c35c25c46b5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x12e14c7d0>]}
[0m15:09:09.985604 [info ] [MainThread]: Found 4 models, 1 source, 491 macros
[0m15:09:09.985823 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '2eeee685-7cca-4646-b426-5c35c25c46b5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x12e14d0d0>]}
[0m15:09:09.986553 [info ] [MainThread]: 
[0m15:09:09.986759 [info ] [MainThread]: Concurrency: 8 threads (target='dev')
[0m15:09:09.986929 [info ] [MainThread]: 
[0m15:09:09.987201 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m15:09:09.987665 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_data-talk-clubs'
[0m15:09:09.987914 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:09:10.246498 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_data-talk-clubs, now list_data-talk-clubs_eu_emissions_project_intermediate)
[0m15:09:10.246979 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_data-talk-clubs_eu_emissions_project_marts'
[0m15:09:10.247399 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_data-talk-clubs_eu_emissions_project_staging'
[0m15:09:10.247698 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m15:09:10.247936 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:09:10.248128 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:09:10.540384 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '2eeee685-7cca-4646-b426-5c35c25c46b5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x12d2b0d50>]}
[0m15:09:10.540804 [debug] [MainThread]: Opening a new connection, currently in state init
[0m15:09:10.543276 [debug] [Thread-1 (]: Began running node model.eu_emissions_project.stg_emissions_data
[0m15:09:10.543633 [info ] [Thread-1 (]: 1 of 1 START sql view model eu_emissions_project_staging.stg_emissions_data .... [RUN]
[0m15:09:10.543911 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_data-talk-clubs_eu_emissions_project_intermediate, now model.eu_emissions_project.stg_emissions_data)
[0m15:09:10.544126 [debug] [Thread-1 (]: Began compiling node model.eu_emissions_project.stg_emissions_data
[0m15:09:10.548562 [debug] [Thread-1 (]: Writing injected SQL for node "model.eu_emissions_project.stg_emissions_data"
[0m15:09:10.549085 [debug] [Thread-1 (]: Began executing node model.eu_emissions_project.stg_emissions_data
[0m15:09:10.563551 [debug] [Thread-1 (]: Writing runtime sql for node "model.eu_emissions_project.stg_emissions_data"
[0m15:09:10.564252 [debug] [Thread-1 (]: On model.eu_emissions_project.stg_emissions_data: /* {"app": "dbt", "dbt_version": "1.9.3", "profile_name": "big-query", "target_name": "dev", "node_id": "model.eu_emissions_project.stg_emissions_data"} */


  create or replace view `data-talk-clubs`.`eu_emissions_project_staging`.`stg_emissions_data`
  OPTIONS()
  as 

WITH source AS (
    SELECT 
        *
    FROM `data-talk-clubs`.`eu_emissions_project`.`nitrogen_dioxide_data`
),

-- First, prepare the data by converting columns to the right format for unpivoting
preprocessed AS (
    SELECT
        freq_airpol_unit_geo_TIME_PERIOD AS metadata,
        -- All other columns are measurement data columns
        *
    FROM source
),

-- Use UNPIVOT to transform the wide format to long format
unpivoted AS (
    SELECT
        metadata,
        col_name AS date_column,
        CAST(col_value AS STRING) AS measurement_value
    FROM preprocessed
    UNPIVOT(
        col_value FOR col_name IN (
            _2018_01_, _2018_02_, _2018_03_, _2018_04_, _2018_05_, _2018_06_,
            _2018_07_, _2018_08_, _2018_09_, _2018_10_, _2018_11_, _2018_12_,
            _2019_01_, _2019_02_, _2019_03_, _2019_04_, _2019_05_, _2019_06_,
            _2019_07_, _2019_08_, _2019_09_, _2019_10_, _2019_11_, _2019_12_,
            _2020_01_, _2020_02_, _2020_03_, _2020_04_, _2020_05_, _2020_06_,
            _2020_07_, _2020_08_, _2020_09_, _2020_10_, _2020_11_, _2020_12_,
            _2021_01_, _2021_02_, _2021_03_, _2021_04_, _2021_05_, _2021_06_,
            _2021_07_, _2021_08_, _2021_09_, _2021_10_, _2021_11_, _2021_12_,
            _2022_01_, _2022_02_, _2022_03_, _2022_04_, _2022_05_, _2022_06_,
            _2022_07_, _2022_08_, _2022_09_, _2022_10_, _2022_11_, _2022_12_,
            _2023_01_, _2023_02_, _2023_03_, _2023_04_, _2023_05_, _2023_06_,
            _2023_07_, _2023_08_, _2023_09_, _2023_10_, _2023_11_, _2023_12_,
            _2024_01_, _2024_02_, _2024_03_, _2024_04_, _2024_05_, _2024_06_,
            _2024_07_, _2024_08_, _2024_09_, _2024_10_, _2024_11_, _2024_12_,
            _2025_01_, _2025_02_
        )
    )
    -- Filter out zero values that represent missing data
    -- WHERE measurement_value != '0.0'
),

-- Process the date and value after unpivoting
processed_measurements AS (
    SELECT
        metadata,
        -- Clean up column name by removing underscores
        REPLACE(date_column, '_', '') AS clean_date_column,
        -- Keep measurement value as string for now
        IF(measurement_value = '0.0', NULL, measurement_value) AS measurement_value,
        -- Extract month and year from column name and create a proper date
        DATE(CONCAT(
            SUBSTR(REPLACE(date_column, '_', ''), 1, 4), '-',
            SUBSTR(REPLACE(date_column, '_', ''), 5, 2), '-01'
        )) AS measurement_date,
        -- Create a readable date label (e.g., 'Jan 2018')
        CONCAT(
            FORMAT_DATE('%b', DATE(CONCAT(
                SUBSTR(REPLACE(date_column, '_', ''), 1, 4), '-',
                SUBSTR(REPLACE(date_column, '_', ''), 5, 2), '-01'
            ))),
            ' ',
            SUBSTR(REPLACE(date_column, '_', ''), 1, 4)
        ) AS date_label
    FROM unpivoted
),

metadata_extracted AS (
    SELECT
        -- Extract metadata components
        SPLIT(metadata, ',')[SAFE_OFFSET(0)] AS frequency,
        SPLIT(metadata, ',')[SAFE_OFFSET(1)] AS airpol,
        SPLIT(metadata, ',')[SAFE_OFFSET(2)] AS unit,
        SPLIT(metadata, ',')[SAFE_OFFSET(3)] AS geo_code,
        date_label,
        measurement_date,
        -- Convert measurement value to FLOAT64 here, after unpivoting
        SAFE_CAST(measurement_value AS FLOAT64) AS measurement_value,
        CURRENT_TIMESTAMP() AS load_timestamp
    FROM processed_measurements
),

final AS (

SELECT
    ROW_NUMBER() OVER() AS id,
    frequency,
    airpol,
    unit,
    geo_code,
    date_label,
    measurement_date,
    measurement_value,
    load_timestamp
FROM metadata_extracted
ORDER BY geo_code, measurement_date
)

select * from final;


[0m15:09:10.564624 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m15:09:11.086189 [debug] [Thread-1 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=data-talk-clubs&j=bq:EU:6b66449f-7605-405f-8027-4c212482aaa7&page=queryresults
[0m15:09:11.337039 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '2eeee685-7cca-4646-b426-5c35c25c46b5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x12e203050>]}
[0m15:09:11.337645 [info ] [Thread-1 (]: 1 of 1 OK created sql view model eu_emissions_project_staging.stg_emissions_data  [[32mCREATE VIEW (0 processed)[0m in 0.79s]
[0m15:09:11.338000 [debug] [Thread-1 (]: Finished running node model.eu_emissions_project.stg_emissions_data
[0m15:09:11.338847 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m15:09:11.339957 [debug] [MainThread]: Connection 'master' was properly closed.
[0m15:09:11.340180 [debug] [MainThread]: Connection 'model.eu_emissions_project.stg_emissions_data' was properly closed.
[0m15:09:11.340362 [debug] [MainThread]: Connection 'list_data-talk-clubs_eu_emissions_project_marts' was properly closed.
[0m15:09:11.340609 [debug] [MainThread]: Connection 'list_data-talk-clubs_eu_emissions_project_staging' was properly closed.
[0m15:09:11.340832 [info ] [MainThread]: 
[0m15:09:11.341039 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 1.35 seconds (1.35s).
[0m15:09:11.341396 [debug] [MainThread]: Command end result
[0m15:09:11.355035 [debug] [MainThread]: Wrote artifact WritableManifest to /Users/timbo/Documents/DataTalks/project/src/target/manifest.json
[0m15:09:11.356043 [debug] [MainThread]: Wrote artifact SemanticManifest to /Users/timbo/Documents/DataTalks/project/src/target/semantic_manifest.json
[0m15:09:11.358686 [debug] [MainThread]: Wrote artifact RunExecutionResult to /Users/timbo/Documents/DataTalks/project/src/target/run_results.json
[0m15:09:11.358931 [info ] [MainThread]: 
[0m15:09:11.359185 [info ] [MainThread]: [32mCompleted successfully[0m
[0m15:09:11.359369 [info ] [MainThread]: 
[0m15:09:11.359560 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m15:09:11.361192 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": true, "command_wall_clock_time": 2.3474076, "process_in_blocks": "0", "process_kernel_time": 0.279729, "process_mem_max_rss": "215580672", "process_out_blocks": "0", "process_user_time": 1.627597}
[0m15:09:11.361536 [debug] [MainThread]: Command `dbt run` succeeded at 15:09:11.361491 after 2.35 seconds
[0m15:09:11.361780 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1069c3dd0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x101059fd0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x100eec310>]}
[0m15:09:11.362018 [debug] [MainThread]: Flushing usage events
[0m15:09:11.786075 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m15:56:41.062667 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11806ea90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1180c9bd0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1180c2cd0>]}


============================== 15:56:41.066557 | 0a3afb7c-a8b1-42fc-949c-50147de72b01 ==============================
[0m15:56:41.066557 [info ] [MainThread]: Running with dbt=1.9.3
[0m15:56:41.067093 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': '/Users/timbo/.dbt', 'debug': 'False', 'warn_error': 'None', 'log_path': '/Users/timbo/Documents/DataTalks/project/src/logs', 'version_check': 'True', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'empty': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'log_format': 'default', 'introspect': 'True', 'target_path': 'None', 'invocation_command': 'dbt run -s stg_emissions_data', 'send_anonymous_usage_stats': 'True'}
[0m15:56:41.855147 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '0a3afb7c-a8b1-42fc-949c-50147de72b01', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11ea4b490>]}
[0m15:56:41.886966 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '0a3afb7c-a8b1-42fc-949c-50147de72b01', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1056a0150>]}
[0m15:56:41.887612 [info ] [MainThread]: Registered adapter: bigquery=1.9.1
[0m15:56:41.985656 [debug] [MainThread]: checksum: 5671c00892cdbcef29c3b00cc5ba7510c3d18a35c883caeb9ab9ee266dc29c8f, vars: {}, profile: , target: , version: 1.9.3
[0m15:56:42.106719 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m15:56:42.107024 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m15:56:42.126126 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '0a3afb7c-a8b1-42fc-949c-50147de72b01', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11eaf36d0>]}
[0m15:56:42.167158 [debug] [MainThread]: Wrote artifact WritableManifest to /Users/timbo/Documents/DataTalks/project/src/target/manifest.json
[0m15:56:42.169496 [debug] [MainThread]: Wrote artifact SemanticManifest to /Users/timbo/Documents/DataTalks/project/src/target/semantic_manifest.json
[0m15:56:42.185315 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '0a3afb7c-a8b1-42fc-949c-50147de72b01', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11ea9ad50>]}
[0m15:56:42.185676 [info ] [MainThread]: Found 4 models, 1 source, 491 macros
[0m15:56:42.185894 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '0a3afb7c-a8b1-42fc-949c-50147de72b01', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11e9e4690>]}
[0m15:56:42.186616 [info ] [MainThread]: 
[0m15:56:42.186829 [info ] [MainThread]: Concurrency: 8 threads (target='dev')
[0m15:56:42.187002 [info ] [MainThread]: 
[0m15:56:42.187279 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m15:56:42.187871 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_data-talk-clubs'
[0m15:56:42.188232 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:56:42.460125 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_data-talk-clubs, now list_data-talk-clubs_eu_emissions_project_staging)
[0m15:56:42.460589 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_data-talk-clubs_eu_emissions_project_intermediate'
[0m15:56:42.460985 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_data-talk-clubs_eu_emissions_project_marts'
[0m15:56:42.461197 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m15:56:42.461401 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:56:42.461578 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:56:42.748758 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '0a3afb7c-a8b1-42fc-949c-50147de72b01', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11ea55b90>]}
[0m15:56:42.749164 [debug] [MainThread]: Opening a new connection, currently in state init
[0m15:56:42.752031 [debug] [Thread-1 (]: Began running node model.eu_emissions_project.stg_emissions_data
[0m15:56:42.752405 [info ] [Thread-1 (]: 1 of 1 START sql view model eu_emissions_project_staging.stg_emissions_data .... [RUN]
[0m15:56:42.752686 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_data-talk-clubs_eu_emissions_project_staging, now model.eu_emissions_project.stg_emissions_data)
[0m15:56:42.752902 [debug] [Thread-1 (]: Began compiling node model.eu_emissions_project.stg_emissions_data
[0m15:56:42.758008 [debug] [Thread-1 (]: Writing injected SQL for node "model.eu_emissions_project.stg_emissions_data"
[0m15:56:42.758516 [debug] [Thread-1 (]: Began executing node model.eu_emissions_project.stg_emissions_data
[0m15:56:42.774130 [debug] [Thread-1 (]: Writing runtime sql for node "model.eu_emissions_project.stg_emissions_data"
[0m15:56:42.774811 [debug] [Thread-1 (]: On model.eu_emissions_project.stg_emissions_data: /* {"app": "dbt", "dbt_version": "1.9.3", "profile_name": "big-query", "target_name": "dev", "node_id": "model.eu_emissions_project.stg_emissions_data"} */


  create or replace view `data-talk-clubs`.`eu_emissions_project_staging`.`stg_emissions_data`
  OPTIONS()
  as 

WITH source AS (
    SELECT 
        *
    FROM `data-talk-clubs`.`eu_emissions_project`.`nitrogen_dioxide_data`
),

-- First, prepare the data by converting columns to the right format for unpivoting
preprocessed AS (
    SELECT
        freq_airpol_unit_geo_TIME_PERIOD AS metadata,
        -- All other columns are measurement data columns
        *
    FROM source
),

-- Use UNPIVOT to transform the wide format to long format
unpivoted AS (
    SELECT
        metadata,
        col_name AS date_column,
        CAST(col_value AS STRING) AS measurement_value
    FROM preprocessed
    UNPIVOT(
        col_value FOR col_name IN (
            _2018_01_, _2018_02_, _2018_03_, _2018_04_, _2018_05_, _2018_06_,
            _2018_07_, _2018_08_, _2018_09_, _2018_10_, _2018_11_, _2018_12_,
            _2019_01_, _2019_02_, _2019_03_, _2019_04_, _2019_05_, _2019_06_,
            _2019_07_, _2019_08_, _2019_09_, _2019_10_, _2019_11_, _2019_12_,
            _2020_01_, _2020_02_, _2020_03_, _2020_04_, _2020_05_, _2020_06_,
            _2020_07_, _2020_08_, _2020_09_, _2020_10_, _2020_11_, _2020_12_,
            _2021_01_, _2021_02_, _2021_03_, _2021_04_, _2021_05_, _2021_06_,
            _2021_07_, _2021_08_, _2021_09_, _2021_10_, _2021_11_, _2021_12_,
            _2022_01_, _2022_02_, _2022_03_, _2022_04_, _2022_05_, _2022_06_,
            _2022_07_, _2022_08_, _2022_09_, _2022_10_, _2022_11_, _2022_12_,
            _2023_01_, _2023_02_, _2023_03_, _2023_04_, _2023_05_, _2023_06_,
            _2023_07_, _2023_08_, _2023_09_, _2023_10_, _2023_11_, _2023_12_,
            _2024_01_, _2024_02_, _2024_03_, _2024_04_, _2024_05_, _2024_06_,
            _2024_07_, _2024_08_, _2024_09_, _2024_10_, _2024_11_, _2024_12_,
            _2025_01_, _2025_02_
        )
    )
    -- Filter out zero values that represent missing data
    -- WHERE measurement_value != '0.0'
),

-- Process the date and value after unpivoting
processed_measurements AS (
    SELECT
        metadata,
        -- Clean up column name by removing underscores
        REPLACE(date_column, '_', '') AS clean_date_column,
        -- Keep measurement value as string for now
        IF(measurement_value = '0.0', NULL, measurement_value) AS measurement_value,
        -- Extract month and year from column name and create a proper date
        DATE(CONCAT(
            SUBSTR(REPLACE(date_column, '_', ''), 1, 4), '-',
            SUBSTR(REPLACE(date_column, '_', ''), 5, 2), '-01'
        )) AS measurement_date,
        -- Create a readable date label (e.g., 'Jan 2018')
        CONCAT(
            FORMAT_DATE('%b', DATE(CONCAT(
                SUBSTR(REPLACE(date_column, '_', ''), 1, 4), '-',
                SUBSTR(REPLACE(date_column, '_', ''), 5, 2), '-01'
            ))),
            ' ',
            SUBSTR(REPLACE(date_column, '_', ''), 1, 4)
        ) AS date_label
    FROM unpivoted
),

metadata_extracted AS (
    SELECT
        -- Extract metadata components
        SPLIT(metadata, ',')[SAFE_OFFSET(0)] AS frequency,
        SPLIT(metadata, ',')[SAFE_OFFSET(1)] AS airpol,
        SPLIT(metadata, ',')[SAFE_OFFSET(2)] AS unit,
        SPLIT(metadata, ',')[SAFE_OFFSET(3)] AS geo_code,
        date_label,
        measurement_date,
        -- Convert measurement value to FLOAT64 here, after unpivoting
        SAFE_CAST(measurement_value AS FLOAT64) AS measurement_value,
        CURRENT_TIMESTAMP() AS load_timestamp
    FROM processed_measurements
),

final AS (

SELECT
    ROW_NUMBER() OVER() AS id,
    frequency,
    airpol,
    unit,
    geo_code,
    date_label,
    measurement_date,
    measurement_value,
    load_timestamp
FROM metadata_extracted
ORDER BY geo_code, measurement_date
)

select * from final;


[0m15:56:42.775183 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m15:56:43.432187 [debug] [Thread-1 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=data-talk-clubs&j=bq:EU:3de4efbb-744e-46a8-8881-7d67b6381608&page=queryresults
[0m15:56:43.649634 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0a3afb7c-a8b1-42fc-949c-50147de72b01', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11ea4a3d0>]}
[0m15:56:43.650270 [info ] [Thread-1 (]: 1 of 1 OK created sql view model eu_emissions_project_staging.stg_emissions_data  [[32mCREATE VIEW (0 processed)[0m in 0.90s]
[0m15:56:43.650670 [debug] [Thread-1 (]: Finished running node model.eu_emissions_project.stg_emissions_data
[0m15:56:43.651526 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m15:56:43.652567 [debug] [MainThread]: Connection 'master' was properly closed.
[0m15:56:43.652777 [debug] [MainThread]: Connection 'model.eu_emissions_project.stg_emissions_data' was properly closed.
[0m15:56:43.652952 [debug] [MainThread]: Connection 'list_data-talk-clubs_eu_emissions_project_intermediate' was properly closed.
[0m15:56:43.653112 [debug] [MainThread]: Connection 'list_data-talk-clubs_eu_emissions_project_marts' was properly closed.
[0m15:56:43.653290 [info ] [MainThread]: 
[0m15:56:43.653485 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 1.47 seconds (1.47s).
[0m15:56:43.653828 [debug] [MainThread]: Command end result
[0m15:56:43.667265 [debug] [MainThread]: Wrote artifact WritableManifest to /Users/timbo/Documents/DataTalks/project/src/target/manifest.json
[0m15:56:43.668728 [debug] [MainThread]: Wrote artifact SemanticManifest to /Users/timbo/Documents/DataTalks/project/src/target/semantic_manifest.json
[0m15:56:43.671720 [debug] [MainThread]: Wrote artifact RunExecutionResult to /Users/timbo/Documents/DataTalks/project/src/target/run_results.json
[0m15:56:43.671935 [info ] [MainThread]: 
[0m15:56:43.672178 [info ] [MainThread]: [32mCompleted successfully[0m
[0m15:56:43.672363 [info ] [MainThread]: 
[0m15:56:43.672556 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m15:56:43.674450 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": true, "command_wall_clock_time": 2.656248, "process_in_blocks": "0", "process_kernel_time": 0.374576, "process_mem_max_rss": "210583552", "process_out_blocks": "0", "process_user_time": 1.562707}
[0m15:56:43.674832 [debug] [MainThread]: Command `dbt run` succeeded at 15:56:43.674776 after 2.66 seconds
[0m15:56:43.675087 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x103166050>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1180c2f50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x102f18310>]}
[0m15:56:43.675322 [debug] [MainThread]: Flushing usage events
[0m15:56:44.105908 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m16:07:37.295655 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10786d910>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1078c3a50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1078cbfd0>]}


============================== 16:07:37.299586 | f3079d61-ed01-4886-96f8-98c03361492e ==============================
[0m16:07:37.299586 [info ] [MainThread]: Running with dbt=1.9.3
[0m16:07:37.300012 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'version_check': 'True', 'profiles_dir': '/Users/timbo/.dbt', 'log_path': '/Users/timbo/Documents/DataTalks/project/src/logs', 'fail_fast': 'False', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'empty': 'False', 'quiet': 'False', 'no_print': 'None', 'log_format': 'default', 'invocation_command': 'dbt run -s stg_emissions_data', 'static_parser': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m16:07:38.116688 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'f3079d61-ed01-4886-96f8-98c03361492e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x127609f90>]}
[0m16:07:38.144626 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'f3079d61-ed01-4886-96f8-98c03361492e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104e43750>]}
[0m16:07:38.145118 [info ] [MainThread]: Registered adapter: bigquery=1.9.1
[0m16:07:38.240359 [debug] [MainThread]: checksum: 5671c00892cdbcef29c3b00cc5ba7510c3d18a35c883caeb9ab9ee266dc29c8f, vars: {}, profile: , target: , version: 1.9.3
[0m16:07:38.360185 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m16:07:38.360644 [debug] [MainThread]: Partial parsing: updated file: eu_emissions_project://models/staging/stg_emissions_data.sql
[0m16:07:38.519466 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'f3079d61-ed01-4886-96f8-98c03361492e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x127bc4410>]}
[0m16:07:38.557247 [debug] [MainThread]: Wrote artifact WritableManifest to /Users/timbo/Documents/DataTalks/project/src/target/manifest.json
[0m16:07:38.559409 [debug] [MainThread]: Wrote artifact SemanticManifest to /Users/timbo/Documents/DataTalks/project/src/target/semantic_manifest.json
[0m16:07:38.573648 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'f3079d61-ed01-4886-96f8-98c03361492e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x127ddd090>]}
[0m16:07:38.574080 [info ] [MainThread]: Found 4 models, 1 source, 491 macros
[0m16:07:38.574324 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'f3079d61-ed01-4886-96f8-98c03361492e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1276d3a50>]}
[0m16:07:38.575234 [info ] [MainThread]: 
[0m16:07:38.575513 [info ] [MainThread]: Concurrency: 8 threads (target='dev')
[0m16:07:38.575775 [info ] [MainThread]: 
[0m16:07:38.576098 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m16:07:38.576619 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_data-talk-clubs'
[0m16:07:38.576858 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:07:38.830138 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_data-talk-clubs, now list_data-talk-clubs_eu_emissions_project_staging)
[0m16:07:38.830651 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_data-talk-clubs_eu_emissions_project_intermediate'
[0m16:07:38.830889 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m16:07:38.831184 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_data-talk-clubs_eu_emissions_project_marts'
[0m16:07:38.831470 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:07:38.831804 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:07:39.174651 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'f3079d61-ed01-4886-96f8-98c03361492e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x127d54050>]}
[0m16:07:39.175074 [debug] [MainThread]: Opening a new connection, currently in state init
[0m16:07:39.178249 [debug] [Thread-1 (]: Began running node model.eu_emissions_project.stg_emissions_data
[0m16:07:39.178628 [info ] [Thread-1 (]: 1 of 1 START sql view model eu_emissions_project_staging.stg_emissions_data .... [RUN]
[0m16:07:39.178919 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_data-talk-clubs_eu_emissions_project_staging, now model.eu_emissions_project.stg_emissions_data)
[0m16:07:39.179129 [debug] [Thread-1 (]: Began compiling node model.eu_emissions_project.stg_emissions_data
[0m16:07:39.183404 [debug] [Thread-1 (]: Writing injected SQL for node "model.eu_emissions_project.stg_emissions_data"
[0m16:07:39.184104 [debug] [Thread-1 (]: Began executing node model.eu_emissions_project.stg_emissions_data
[0m16:07:39.199089 [debug] [Thread-1 (]: Writing runtime sql for node "model.eu_emissions_project.stg_emissions_data"
[0m16:07:39.199762 [debug] [Thread-1 (]: On model.eu_emissions_project.stg_emissions_data: /* {"app": "dbt", "dbt_version": "1.9.3", "profile_name": "big-query", "target_name": "dev", "node_id": "model.eu_emissions_project.stg_emissions_data"} */


  create or replace view `data-talk-clubs`.`eu_emissions_project_staging`.`stg_emissions_data`
  OPTIONS()
  as 

WITH source AS (
    SELECT 
        *
    FROM `data-talk-clubs`.`eu_emissions_project`.`nitrogen_dioxide_data`
),

-- First, prepare the data by converting columns to the right format for unpivoting
preprocessed AS (
    SELECT
        freq_airpol_unit_geo_TIME_PERIOD AS metadata,
        -- All other columns are measurement data columns
        *
    FROM source
),

-- Use UNPIVOT to transform the wide format to long format
unpivoted AS (
    SELECT
        metadata,
        col_name AS date_column,
        CAST(col_value AS STRING) AS measurement_value
    FROM preprocessed
    UNPIVOT(
        col_value FOR col_name IN (
            _2018_01_, _2018_02_, _2018_03_, _2018_04_, _2018_05_, _2018_06_,
            _2018_07_, _2018_08_, _2018_09_, _2018_10_, _2018_11_, _2018_12_,
            _2019_01_, _2019_02_, _2019_03_, _2019_04_, _2019_05_, _2019_06_,
            _2019_07_, _2019_08_, _2019_09_, _2019_10_, _2019_11_, _2019_12_,
            _2020_01_, _2020_02_, _2020_03_, _2020_04_, _2020_05_, _2020_06_,
            _2020_07_, _2020_08_, _2020_09_, _2020_10_, _2020_11_, _2020_12_,
            _2021_01_, _2021_02_, _2021_03_, _2021_04_, _2021_05_, _2021_06_,
            _2021_07_, _2021_08_, _2021_09_, _2021_10_, _2021_11_, _2021_12_,
            _2022_01_, _2022_02_, _2022_03_, _2022_04_, _2022_05_, _2022_06_,
            _2022_07_, _2022_08_, _2022_09_, _2022_10_, _2022_11_, _2022_12_,
            _2023_01_, _2023_02_, _2023_03_, _2023_04_, _2023_05_, _2023_06_,
            _2023_07_, _2023_08_, _2023_09_, _2023_10_, _2023_11_, _2023_12_,
            _2024_01_, _2024_02_, _2024_03_, _2024_04_, _2024_05_, _2024_06_,
            _2024_07_, _2024_08_, _2024_09_, _2024_10_, _2024_11_, _2024_12_,
            _2025_01_, _2025_02_
        )
    )
    -- Filter out zero values that represent missing data
    -- WHERE measurement_value != '0.0'
),

-- Process the date and value after unpivoting
processed_measurements AS (
    SELECT
        metadata,
        -- Clean up column name by removing underscores
        REPLACE(date_column, '_', '') AS clean_date_column,
        -- Keep measurement value as string for now
        measurement_value,
        -- Extract month and year from column name and create a proper date
        DATE(CONCAT(
            SUBSTR(REPLACE(date_column, '_', ''), 1, 4), '-',
            SUBSTR(REPLACE(date_column, '_', ''), 5, 2), '-01'
        )) AS measurement_date,
        -- Create a readable date label (e.g., 'Jan 2018')
        CONCAT(
            FORMAT_DATE('%b', DATE(CONCAT(
                SUBSTR(REPLACE(date_column, '_', ''), 1, 4), '-',
                SUBSTR(REPLACE(date_column, '_', ''), 5, 2), '-01'
            ))),
            ' ',
            SUBSTR(REPLACE(date_column, '_', ''), 1, 4)
        ) AS date_label
    FROM unpivoted
),

metadata_extracted AS (
    SELECT
        -- Extract metadata components
        SPLIT(metadata, ',')[SAFE_OFFSET(0)] AS frequency,
        SPLIT(metadata, ',')[SAFE_OFFSET(1)] AS airpol,
        SPLIT(metadata, ',')[SAFE_OFFSET(2)] AS unit,
        SPLIT(metadata, ',')[SAFE_OFFSET(3)] AS geo_code,
        date_label,
        measurement_date,
        -- Convert measurement value to FLOAT64 here, after unpivoting
        IF(measurement_value = '0.0', NULL, SAFE_CAST(measurement_value AS FLOAT64)) AS measurement_value,
        CURRENT_TIMESTAMP() AS load_timestamp
    FROM processed_measurements
),

final AS (

SELECT
    ROW_NUMBER() OVER() AS id,
    frequency,
    airpol,
    unit,
    geo_code,
    date_label,
    measurement_date,
    measurement_value,
    load_timestamp
FROM metadata_extracted
ORDER BY geo_code, measurement_date
)

select * from final;


[0m16:07:39.200123 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m16:07:39.824839 [debug] [Thread-1 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=data-talk-clubs&j=bq:EU:3e0a43be-1d30-460e-b6cc-d5bf932f72f0&page=queryresults
[0m16:07:40.088968 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f3079d61-ed01-4886-96f8-98c03361492e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x131214910>]}
[0m16:07:40.089586 [info ] [Thread-1 (]: 1 of 1 OK created sql view model eu_emissions_project_staging.stg_emissions_data  [[32mCREATE VIEW (0 processed)[0m in 0.91s]
[0m16:07:40.090029 [debug] [Thread-1 (]: Finished running node model.eu_emissions_project.stg_emissions_data
[0m16:07:40.090989 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m16:07:40.092034 [debug] [MainThread]: Connection 'master' was properly closed.
[0m16:07:40.092247 [debug] [MainThread]: Connection 'model.eu_emissions_project.stg_emissions_data' was properly closed.
[0m16:07:40.092433 [debug] [MainThread]: Connection 'list_data-talk-clubs_eu_emissions_project_intermediate' was properly closed.
[0m16:07:40.092602 [debug] [MainThread]: Connection 'list_data-talk-clubs_eu_emissions_project_marts' was properly closed.
[0m16:07:40.092793 [info ] [MainThread]: 
[0m16:07:40.093074 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 1.52 seconds (1.52s).
[0m16:07:40.093454 [debug] [MainThread]: Command end result
[0m16:07:40.106762 [debug] [MainThread]: Wrote artifact WritableManifest to /Users/timbo/Documents/DataTalks/project/src/target/manifest.json
[0m16:07:40.107967 [debug] [MainThread]: Wrote artifact SemanticManifest to /Users/timbo/Documents/DataTalks/project/src/target/semantic_manifest.json
[0m16:07:40.111083 [debug] [MainThread]: Wrote artifact RunExecutionResult to /Users/timbo/Documents/DataTalks/project/src/target/run_results.json
[0m16:07:40.111372 [info ] [MainThread]: 
[0m16:07:40.111625 [info ] [MainThread]: [32mCompleted successfully[0m
[0m16:07:40.111863 [info ] [MainThread]: 
[0m16:07:40.112098 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m16:07:40.113729 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": true, "command_wall_clock_time": 2.858931, "process_in_blocks": "0", "process_kernel_time": 0.390819, "process_mem_max_rss": "214630400", "process_out_blocks": "0", "process_user_time": 1.680613}
[0m16:07:40.114046 [debug] [MainThread]: Command `dbt run` succeeded at 16:07:40.114000 after 2.86 seconds
[0m16:07:40.114282 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1078efa50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x103106110>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x102f98310>]}
[0m16:07:40.114506 [debug] [MainThread]: Flushing usage events
[0m16:07:40.542719 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m16:09:10.688069 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a36fb10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109f9aa90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a3cb9d0>]}


============================== 16:09:10.691110 | ab4bccec-aa19-4f7a-bb11-c08869979067 ==============================
[0m16:09:10.691110 [info ] [MainThread]: Running with dbt=1.9.3
[0m16:09:10.691495 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': '/Users/timbo/.dbt', 'fail_fast': 'False', 'version_check': 'True', 'log_path': '/Users/timbo/Documents/DataTalks/project/src/logs', 'warn_error': 'None', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'empty': 'None', 'quiet': 'False', 'no_print': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'invocation_command': 'dbt run-operation run_query --args {"query": "SELECT measurement_value, COUNT(*) as count FROM eu_emissions_project_staging.stg_emissions_data GROUP BY measurement_value ORDER BY count DESC LIMIT 10"}', 'log_format': 'default', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m16:09:11.310558 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'ab4bccec-aa19-4f7a-bb11-c08869979067', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11ac95750>]}
[0m16:09:11.338150 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'ab4bccec-aa19-4f7a-bb11-c08869979067', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10727c290>]}
[0m16:09:11.338671 [info ] [MainThread]: Registered adapter: bigquery=1.9.1
[0m16:09:11.433264 [debug] [MainThread]: checksum: 5671c00892cdbcef29c3b00cc5ba7510c3d18a35c883caeb9ab9ee266dc29c8f, vars: {}, profile: , target: , version: 1.9.3
[0m16:09:11.547744 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m16:09:11.548075 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m16:09:11.567042 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'ab4bccec-aa19-4f7a-bb11-c08869979067', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11ac897d0>]}
[0m16:09:11.605876 [debug] [MainThread]: Wrote artifact WritableManifest to /Users/timbo/Documents/DataTalks/project/src/target/manifest.json
[0m16:09:11.608180 [debug] [MainThread]: Wrote artifact SemanticManifest to /Users/timbo/Documents/DataTalks/project/src/target/semantic_manifest.json
[0m16:09:11.617334 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'ab4bccec-aa19-4f7a-bb11-c08869979067', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11ae6e750>]}
[0m16:09:11.617674 [info ] [MainThread]: Found 4 models, 1 source, 491 macros
[0m16:09:11.617892 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'ab4bccec-aa19-4f7a-bb11-c08869979067', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11ac7e1d0>]}
[0m16:09:11.618222 [debug] [MainThread]: Acquiring new bigquery connection 'macro_run_query'
[0m16:09:11.621136 [debug] [MainThread]: BigQuery adapter: Unhandled error while running:
macro run_query
[0m16:09:11.621434 [debug] [MainThread]: BigQuery adapter: Compilation Error
  macro 'dbt_macro__run_query' takes no keyword argument 'query'
[0m16:09:11.621639 [debug] [MainThread]: Opening a new connection, currently in state init
[0m16:09:11.622836 [error] [MainThread]: Encountered an error while running operation: Compilation Error
  macro 'dbt_macro__run_query' takes no keyword argument 'query'
[0m16:09:11.625525 [debug] [MainThread]: Traceback (most recent call last):
  File "/Users/timbo/Documents/DataTalks/project/src/venv/lib/python3.11/site-packages/dbt_common/clients/jinja.py", line 412, in exception_handler
    yield
  File "/Users/timbo/Documents/DataTalks/project/src/venv/lib/python3.11/site-packages/dbt_common/clients/jinja.py", line 389, in call_macro
    return macro(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/timbo/Documents/DataTalks/project/src/venv/lib/python3.11/site-packages/jinja2/runtime.py", line 759, in __call__
    raise TypeError(
TypeError: macro 'dbt_macro__run_query' takes no keyword argument 'query'

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/timbo/Documents/DataTalks/project/src/venv/lib/python3.11/site-packages/dbt/task/run_operation.py", line 67, in run
    self._run_unsafe(package_name, macro_name)
  File "/Users/timbo/Documents/DataTalks/project/src/venv/lib/python3.11/site-packages/dbt/task/run_operation.py", line 48, in _run_unsafe
    res = adapter.execute_macro(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/timbo/Documents/DataTalks/project/src/venv/lib/python3.11/site-packages/dbt/adapters/base/impl.py", line 1268, in execute_macro
    result = macro_function(**kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/timbo/Documents/DataTalks/project/src/venv/lib/python3.11/site-packages/dbt_common/clients/jinja.py", line 421, in __call__
    return self.call_macro(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/timbo/Documents/DataTalks/project/src/venv/lib/python3.11/site-packages/dbt_common/clients/jinja.py", line 387, in call_macro
    with self.exception_handler():
  File "/opt/homebrew/Cellar/python@3.11/3.11.10/Frameworks/Python.framework/Versions/3.11/lib/python3.11/contextlib.py", line 158, in __exit__
    self.gen.throw(typ, value, traceback)
  File "/Users/timbo/Documents/DataTalks/project/src/venv/lib/python3.11/site-packages/dbt_common/clients/jinja.py", line 414, in exception_handler
    raise CaughtMacroErrorWithNodeError(exc=e, node=self.macro)
dbt_common.exceptions.macros.CaughtMacroErrorWithNodeError: Compilation Error
  macro 'dbt_macro__run_query' takes no keyword argument 'query'

[0m16:09:11.629063 [debug] [MainThread]: Wrote artifact RunResultsArtifact to /Users/timbo/Documents/DataTalks/project/src/target/run_results.json
[0m16:09:11.630964 [debug] [MainThread]: Resource report: {"command_name": "run-operation", "command_success": false, "command_wall_clock_time": 0.97892195, "process_in_blocks": "0", "process_kernel_time": 0.286596, "process_mem_max_rss": "203276288", "process_out_blocks": "0", "process_user_time": 1.273757}
[0m16:09:11.631337 [debug] [MainThread]: Command `dbt run-operation` failed at 16:09:11.631265 after 0.98 seconds
[0m16:09:11.631686 [debug] [MainThread]: Connection 'macro_run_query' was properly closed.
[0m16:09:11.631953 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104be2190>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11acbfa50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104940810>]}
[0m16:09:11.632201 [debug] [MainThread]: Flushing usage events
[0m16:09:12.059575 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m16:10:31.786962 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11096d1d0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1109c9f10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1109cbf90>]}


============================== 16:10:31.789729 | 015fc5fe-2f25-489a-9f18-9f37a797ff23 ==============================
[0m16:10:31.789729 [info ] [MainThread]: Running with dbt=1.9.3
[0m16:10:31.790093 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'fail_fast': 'False', 'profiles_dir': '/Users/timbo/.dbt', 'log_path': '/Users/timbo/Documents/DataTalks/project/src/logs', 'version_check': 'True', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'empty': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'invocation_command': 'dbt run -s stg_emissions_data', 'introspect': 'True', 'target_path': 'None', 'log_format': 'default', 'send_anonymous_usage_stats': 'True'}
[0m16:10:32.363679 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '015fc5fe-2f25-489a-9f18-9f37a797ff23', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1250d6910>]}
[0m16:10:32.390511 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '015fc5fe-2f25-489a-9f18-9f37a797ff23', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x106163850>]}
[0m16:10:32.391060 [info ] [MainThread]: Registered adapter: bigquery=1.9.1
[0m16:10:32.487589 [debug] [MainThread]: checksum: 5671c00892cdbcef29c3b00cc5ba7510c3d18a35c883caeb9ab9ee266dc29c8f, vars: {}, profile: , target: , version: 1.9.3
[0m16:10:32.603782 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m16:10:32.604251 [debug] [MainThread]: Partial parsing: updated file: eu_emissions_project://models/staging/stg_emissions_data.sql
[0m16:10:32.763374 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '015fc5fe-2f25-489a-9f18-9f37a797ff23', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x125393790>]}
[0m16:10:32.800633 [debug] [MainThread]: Wrote artifact WritableManifest to /Users/timbo/Documents/DataTalks/project/src/target/manifest.json
[0m16:10:32.805648 [debug] [MainThread]: Wrote artifact SemanticManifest to /Users/timbo/Documents/DataTalks/project/src/target/semantic_manifest.json
[0m16:10:32.817773 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '015fc5fe-2f25-489a-9f18-9f37a797ff23', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x12554e590>]}
[0m16:10:32.818135 [info ] [MainThread]: Found 4 models, 1 source, 491 macros
[0m16:10:32.818368 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '015fc5fe-2f25-489a-9f18-9f37a797ff23', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1255b32d0>]}
[0m16:10:32.819270 [info ] [MainThread]: 
[0m16:10:32.819501 [info ] [MainThread]: Concurrency: 8 threads (target='dev')
[0m16:10:32.819677 [info ] [MainThread]: 
[0m16:10:32.819955 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m16:10:32.820479 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_data-talk-clubs'
[0m16:10:32.820784 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:10:33.063257 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_data-talk-clubs, now list_data-talk-clubs_eu_emissions_project_marts)
[0m16:10:33.063647 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_data-talk-clubs_eu_emissions_project_staging'
[0m16:10:33.064055 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_data-talk-clubs_eu_emissions_project_intermediate'
[0m16:10:33.064342 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m16:10:33.064589 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:10:33.064769 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:10:33.358260 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '015fc5fe-2f25-489a-9f18-9f37a797ff23', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1250f0b90>]}
[0m16:10:33.358672 [debug] [MainThread]: Opening a new connection, currently in state init
[0m16:10:33.362190 [debug] [Thread-1 (]: Began running node model.eu_emissions_project.stg_emissions_data
[0m16:10:33.362560 [info ] [Thread-1 (]: 1 of 1 START sql view model eu_emissions_project_staging.stg_emissions_data .... [RUN]
[0m16:10:33.362842 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_data-talk-clubs_eu_emissions_project_marts, now model.eu_emissions_project.stg_emissions_data)
[0m16:10:33.363051 [debug] [Thread-1 (]: Began compiling node model.eu_emissions_project.stg_emissions_data
[0m16:10:33.367402 [debug] [Thread-1 (]: Writing injected SQL for node "model.eu_emissions_project.stg_emissions_data"
[0m16:10:33.368152 [debug] [Thread-1 (]: Began executing node model.eu_emissions_project.stg_emissions_data
[0m16:10:33.383133 [debug] [Thread-1 (]: Writing runtime sql for node "model.eu_emissions_project.stg_emissions_data"
[0m16:10:33.383833 [debug] [Thread-1 (]: On model.eu_emissions_project.stg_emissions_data: /* {"app": "dbt", "dbt_version": "1.9.3", "profile_name": "big-query", "target_name": "dev", "node_id": "model.eu_emissions_project.stg_emissions_data"} */


  create or replace view `data-talk-clubs`.`eu_emissions_project_staging`.`stg_emissions_data`
  OPTIONS()
  as 

WITH source AS (
    SELECT 
        *
    FROM `data-talk-clubs`.`eu_emissions_project`.`nitrogen_dioxide_data`
),

-- First, prepare the data by converting columns to the right format for unpivoting
preprocessed AS (
    SELECT
        freq_airpol_unit_geo_TIME_PERIOD AS metadata,
        -- All other columns are measurement data columns
        *
    FROM source
),

-- Use UNPIVOT to transform the wide format to long format
unpivoted AS (
    SELECT
        metadata,
        col_name AS date_column,
        CAST(col_value AS STRING) AS measurement_value
    FROM preprocessed
    UNPIVOT(
        col_value FOR col_name IN (
            _2018_01_, _2018_02_, _2018_03_, _2018_04_, _2018_05_, _2018_06_,
            _2018_07_, _2018_08_, _2018_09_, _2018_10_, _2018_11_, _2018_12_,
            _2019_01_, _2019_02_, _2019_03_, _2019_04_, _2019_05_, _2019_06_,
            _2019_07_, _2019_08_, _2019_09_, _2019_10_, _2019_11_, _2019_12_,
            _2020_01_, _2020_02_, _2020_03_, _2020_04_, _2020_05_, _2020_06_,
            _2020_07_, _2020_08_, _2020_09_, _2020_10_, _2020_11_, _2020_12_,
            _2021_01_, _2021_02_, _2021_03_, _2021_04_, _2021_05_, _2021_06_,
            _2021_07_, _2021_08_, _2021_09_, _2021_10_, _2021_11_, _2021_12_,
            _2022_01_, _2022_02_, _2022_03_, _2022_04_, _2022_05_, _2022_06_,
            _2022_07_, _2022_08_, _2022_09_, _2022_10_, _2022_11_, _2022_12_,
            _2023_01_, _2023_02_, _2023_03_, _2023_04_, _2023_05_, _2023_06_,
            _2023_07_, _2023_08_, _2023_09_, _2023_10_, _2023_11_, _2023_12_,
            _2024_01_, _2024_02_, _2024_03_, _2024_04_, _2024_05_, _2024_06_,
            _2024_07_, _2024_08_, _2024_09_, _2024_10_, _2024_11_, _2024_12_,
            _2025_01_, _2025_02_
        )
    )
    -- Filter out zero values that represent missing data
    -- WHERE measurement_value != '0.0'
),

-- Process the date and value after unpivoting
processed_measurements AS (
    SELECT
        metadata,
        -- Clean up column name by removing underscores
        REPLACE(date_column, '_', '') AS clean_date_column,
        -- Keep measurement value as string for now
        measurement_value,
        -- Extract month and year from column name and create a proper date
        DATE(CONCAT(
            SUBSTR(REPLACE(date_column, '_', ''), 1, 4), '-',
            SUBSTR(REPLACE(date_column, '_', ''), 5, 2), '-01'
        )) AS measurement_date,
        -- Create a readable date label (e.g., 'Jan 2018')
        CONCAT(
            FORMAT_DATE('%b', DATE(CONCAT(
                SUBSTR(REPLACE(date_column, '_', ''), 1, 4), '-',
                SUBSTR(REPLACE(date_column, '_', ''), 5, 2), '-01'
            ))),
            ' ',
            SUBSTR(REPLACE(date_column, '_', ''), 1, 4)
        ) AS date_label
    FROM unpivoted
),

metadata_extracted AS (
    SELECT
        -- Extract metadata components
        SPLIT(metadata, ',')[SAFE_OFFSET(0)] AS frequency,
        SPLIT(metadata, ',')[SAFE_OFFSET(1)] AS airpol,
        SPLIT(metadata, ',')[SAFE_OFFSET(2)] AS unit,
        SPLIT(metadata, ',')[SAFE_OFFSET(3)] AS geo_code,
        date_label,
        measurement_date,
        -- Convert measurement value to FLOAT64 here, after unpivoting
        -- Use TRIM to remove any potential whitespace and explicit comparison
        CASE 
            WHEN TRIM(measurement_value) = '0.0' THEN NULL
            ELSE SAFE_CAST(measurement_value AS FLOAT64)
        END AS measurement_value,
        CURRENT_TIMESTAMP() AS load_timestamp
    FROM processed_measurements
),

final AS (

SELECT
    ROW_NUMBER() OVER() AS id,
    frequency,
    airpol,
    unit,
    geo_code,
    date_label,
    measurement_date,
    measurement_value,
    load_timestamp
FROM metadata_extracted
ORDER BY geo_code, measurement_date
)

select * from final;


[0m16:10:33.384234 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m16:10:34.000551 [debug] [Thread-1 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=data-talk-clubs&j=bq:EU:8728a5cd-d54a-4ca1-b4d4-1048c5d36a84&page=queryresults
[0m16:10:34.252080 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '015fc5fe-2f25-489a-9f18-9f37a797ff23', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x12586e850>]}
[0m16:10:34.252597 [info ] [Thread-1 (]: 1 of 1 OK created sql view model eu_emissions_project_staging.stg_emissions_data  [[32mCREATE VIEW (0 processed)[0m in 0.89s]
[0m16:10:34.252930 [debug] [Thread-1 (]: Finished running node model.eu_emissions_project.stg_emissions_data
[0m16:10:34.253772 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m16:10:34.254799 [debug] [MainThread]: Connection 'master' was properly closed.
[0m16:10:34.255006 [debug] [MainThread]: Connection 'model.eu_emissions_project.stg_emissions_data' was properly closed.
[0m16:10:34.255180 [debug] [MainThread]: Connection 'list_data-talk-clubs_eu_emissions_project_staging' was properly closed.
[0m16:10:34.255342 [debug] [MainThread]: Connection 'list_data-talk-clubs_eu_emissions_project_intermediate' was properly closed.
[0m16:10:34.255526 [info ] [MainThread]: 
[0m16:10:34.255716 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 1.44 seconds (1.44s).
[0m16:10:34.256054 [debug] [MainThread]: Command end result
[0m16:10:34.269506 [debug] [MainThread]: Wrote artifact WritableManifest to /Users/timbo/Documents/DataTalks/project/src/target/manifest.json
[0m16:10:34.270777 [debug] [MainThread]: Wrote artifact SemanticManifest to /Users/timbo/Documents/DataTalks/project/src/target/semantic_manifest.json
[0m16:10:34.273557 [debug] [MainThread]: Wrote artifact RunExecutionResult to /Users/timbo/Documents/DataTalks/project/src/target/run_results.json
[0m16:10:34.273762 [info ] [MainThread]: 
[0m16:10:34.273999 [info ] [MainThread]: [32mCompleted successfully[0m
[0m16:10:34.274181 [info ] [MainThread]: 
[0m16:10:34.274371 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m16:10:34.276078 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": true, "command_wall_clock_time": 2.5268342, "process_in_blocks": "0", "process_kernel_time": 0.301459, "process_mem_max_rss": "213745664", "process_out_blocks": "0", "process_user_time": 1.685482}
[0m16:10:34.276425 [debug] [MainThread]: Command `dbt run` succeeded at 16:10:34.276376 after 2.53 seconds
[0m16:10:34.276673 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x100a86110>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x125b37dd0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1109c1f10>]}
[0m16:10:34.276907 [debug] [MainThread]: Flushing usage events
[0m16:10:34.696731 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m16:32:20.326224 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105d6ec90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105dc9790>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105dcbf10>]}


============================== 16:32:20.329598 | aa8afa6d-7b89-4a92-89a1-bbc7794636d5 ==============================
[0m16:32:20.329598 [info ] [MainThread]: Running with dbt=1.9.3
[0m16:32:20.330010 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'fail_fast': 'False', 'debug': 'False', 'log_path': '/Users/timbo/Documents/DataTalks/project/src/logs', 'profiles_dir': '/Users/timbo/.dbt', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'empty': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'invocation_command': 'dbt seed --full-refresh', 'introspect': 'True', 'target_path': 'None', 'log_format': 'default', 'send_anonymous_usage_stats': 'True'}
[0m16:32:21.095503 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'aa8afa6d-7b89-4a92-89a1-bbc7794636d5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x113e50f50>]}
[0m16:32:21.122207 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'aa8afa6d-7b89-4a92-89a1-bbc7794636d5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x102ca0150>]}
[0m16:32:21.122661 [info ] [MainThread]: Registered adapter: bigquery=1.9.1
[0m16:32:21.217560 [debug] [MainThread]: checksum: 5671c00892cdbcef29c3b00cc5ba7510c3d18a35c883caeb9ab9ee266dc29c8f, vars: {}, profile: , target: , version: 1.9.3
[0m16:32:21.332602 [debug] [MainThread]: Partial parsing enabled: 1 files deleted, 2 files added, 2 files changed.
[0m16:32:21.332999 [debug] [MainThread]: Partial parsing: added file: eu_emissions_project://seeds/capitals.csv
[0m16:32:21.333203 [debug] [MainThread]: Partial parsing: added file: eu_emissions_project://models/intermediate/int_dim_capitals.sql
[0m16:32:21.333447 [debug] [MainThread]: Partial parsing: deleted file: eu_emissions_project://models/intermediate/int_emissions_unpivoted.sql
[0m16:32:21.333670 [debug] [MainThread]: Partial parsing: updated file: eu_emissions_project://models/intermediate/int_emissions_cleaned.sql
[0m16:32:21.333856 [debug] [MainThread]: Partial parsing: updated file: eu_emissions_project://models/marts/emissions_analysis.sql
[0m16:32:21.519362 [warn ] [MainThread]: [[33mWARNING[0m]: Did not find matching node for patch with name 'int_emissions_unpivoted' in the 'models' section of file 'models/intermediate/schema.yml'
[0m16:32:21.560671 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'aa8afa6d-7b89-4a92-89a1-bbc7794636d5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1166a5ed0>]}
[0m16:32:21.601237 [debug] [MainThread]: Wrote artifact WritableManifest to /Users/timbo/Documents/DataTalks/project/src/target/manifest.json
[0m16:32:21.603437 [debug] [MainThread]: Wrote artifact SemanticManifest to /Users/timbo/Documents/DataTalks/project/src/target/semantic_manifest.json
[0m16:32:21.616558 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'aa8afa6d-7b89-4a92-89a1-bbc7794636d5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x117282850>]}
[0m16:32:21.616906 [info ] [MainThread]: Found 4 models, 1 seed, 1 source, 491 macros
[0m16:32:21.617118 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'aa8afa6d-7b89-4a92-89a1-bbc7794636d5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11672ff90>]}
[0m16:32:21.617981 [info ] [MainThread]: 
[0m16:32:21.618192 [info ] [MainThread]: Concurrency: 8 threads (target='dev')
[0m16:32:21.618362 [info ] [MainThread]: 
[0m16:32:21.618628 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m16:32:21.619069 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_data-talk-clubs'
[0m16:32:21.619283 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:32:21.875000 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_data-talk-clubs, now list_data-talk-clubs_eu_emissions_project_marts)
[0m16:32:21.875378 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_data-talk-clubs_eu_emissions_project'
[0m16:32:21.875630 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m16:32:21.875885 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_data-talk-clubs_eu_emissions_project_staging'
[0m16:32:21.876067 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:32:21.876306 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_data-talk-clubs_eu_emissions_project_intermediate'
[0m16:32:21.912153 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:32:21.912778 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:32:22.225916 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'aa8afa6d-7b89-4a92-89a1-bbc7794636d5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1171e7010>]}
[0m16:32:22.226317 [debug] [MainThread]: Opening a new connection, currently in state init
[0m16:32:22.229468 [debug] [Thread-1 (]: Began running node seed.eu_emissions_project.capitals
[0m16:32:22.229818 [info ] [Thread-1 (]: 1 of 1 START seed file eu_emissions_project.capitals ........................... [RUN]
[0m16:32:22.230092 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_data-talk-clubs_eu_emissions_project_marts, now seed.eu_emissions_project.capitals)
[0m16:32:22.230303 [debug] [Thread-1 (]: Began compiling node seed.eu_emissions_project.capitals
[0m16:32:22.230503 [debug] [Thread-1 (]: Began executing node seed.eu_emissions_project.capitals
[0m16:32:22.269165 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m16:32:26.413900 [debug] [Thread-1 (]: On seed.eu_emissions_project.capitals: /* {"app": "dbt", "dbt_version": "1.9.3", "profile_name": "big-query", "target_name": "dev", "node_id": "seed.eu_emissions_project.capitals"} */

    alter table `data-talk-clubs`.`eu_emissions_project`.`capitals` set OPTIONS()
  
[0m16:32:26.753170 [debug] [Thread-1 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=data-talk-clubs&j=bq:EU:19695d79-a1a2-479c-a8db-580048fc47bc&page=queryresults
[0m16:32:27.042041 [debug] [Thread-1 (]: Writing runtime SQL for node "seed.eu_emissions_project.capitals"
[0m16:32:27.053117 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'aa8afa6d-7b89-4a92-89a1-bbc7794636d5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1173884d0>]}
[0m16:32:27.053535 [info ] [Thread-1 (]: 1 of 1 OK loaded seed file eu_emissions_project.capitals ....................... [[32mCREATE 32[0m in 4.82s]
[0m16:32:27.053850 [debug] [Thread-1 (]: Finished running node seed.eu_emissions_project.capitals
[0m16:32:27.054723 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m16:32:27.055748 [debug] [MainThread]: Connection 'master' was properly closed.
[0m16:32:27.055963 [debug] [MainThread]: Connection 'seed.eu_emissions_project.capitals' was properly closed.
[0m16:32:27.056140 [debug] [MainThread]: Connection 'list_data-talk-clubs_eu_emissions_project' was properly closed.
[0m16:32:27.056301 [debug] [MainThread]: Connection 'list_data-talk-clubs_eu_emissions_project_staging' was properly closed.
[0m16:32:27.056462 [debug] [MainThread]: Connection 'list_data-talk-clubs_eu_emissions_project_intermediate' was properly closed.
[0m16:32:27.056648 [info ] [MainThread]: 
[0m16:32:27.056839 [info ] [MainThread]: Finished running 1 seed in 0 hours 0 minutes and 5.44 seconds (5.44s).
[0m16:32:27.057288 [debug] [MainThread]: Command end result
[0m16:32:27.069651 [debug] [MainThread]: Wrote artifact WritableManifest to /Users/timbo/Documents/DataTalks/project/src/target/manifest.json
[0m16:32:27.070556 [debug] [MainThread]: Wrote artifact SemanticManifest to /Users/timbo/Documents/DataTalks/project/src/target/semantic_manifest.json
[0m16:32:27.073151 [debug] [MainThread]: Wrote artifact RunExecutionResult to /Users/timbo/Documents/DataTalks/project/src/target/run_results.json
[0m16:32:27.073352 [info ] [MainThread]: 
[0m16:32:27.073591 [info ] [MainThread]: [32mCompleted successfully[0m
[0m16:32:27.073784 [info ] [MainThread]: 
[0m16:32:27.073980 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m16:32:27.075637 [debug] [MainThread]: Resource report: {"command_name": "seed", "command_success": true, "command_wall_clock_time": 6.788782, "process_in_blocks": "0", "process_kernel_time": 0.348057, "process_mem_max_rss": "216498176", "process_out_blocks": "0", "process_user_time": 1.770888}
[0m16:32:27.075887 [debug] [MainThread]: Command `dbt seed` succeeded at 16:32:27.075848 after 6.79 seconds
[0m16:32:27.076108 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x100cd2050>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105defed0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105b7ccd0>]}
[0m16:32:27.076321 [debug] [MainThread]: Flushing usage events
[0m16:32:27.508952 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m16:32:30.593779 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b06ff90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ae72a50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b0caa10>]}


============================== 16:32:30.596036 | 8dc761c6-4787-4132-a57b-b755ca3e56de ==============================
[0m16:32:30.596036 [info ] [MainThread]: Running with dbt=1.9.3
[0m16:32:30.596424 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'version_check': 'True', 'log_path': '/Users/timbo/Documents/DataTalks/project/src/logs', 'profiles_dir': '/Users/timbo/.dbt', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'empty': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt run', 'log_format': 'default', 'static_parser': 'True', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m16:32:31.024301 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '8dc761c6-4787-4132-a57b-b755ca3e56de', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x13d0209d0>]}
[0m16:32:31.051194 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '8dc761c6-4787-4132-a57b-b755ca3e56de', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x106d60110>]}
[0m16:32:31.051700 [info ] [MainThread]: Registered adapter: bigquery=1.9.1
[0m16:32:31.139041 [debug] [MainThread]: checksum: 5671c00892cdbcef29c3b00cc5ba7510c3d18a35c883caeb9ab9ee266dc29c8f, vars: {}, profile: , target: , version: 1.9.3
[0m16:32:31.250456 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m16:32:31.250769 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m16:32:31.274033 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '8dc761c6-4787-4132-a57b-b755ca3e56de', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b0c9bd0>]}
[0m16:32:31.315482 [debug] [MainThread]: Wrote artifact WritableManifest to /Users/timbo/Documents/DataTalks/project/src/target/manifest.json
[0m16:32:31.317369 [debug] [MainThread]: Wrote artifact SemanticManifest to /Users/timbo/Documents/DataTalks/project/src/target/semantic_manifest.json
[0m16:32:31.323874 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '8dc761c6-4787-4132-a57b-b755ca3e56de', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x13da7b210>]}
[0m16:32:31.324171 [info ] [MainThread]: Found 4 models, 1 seed, 1 source, 491 macros
[0m16:32:31.324516 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '8dc761c6-4787-4132-a57b-b755ca3e56de', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x13dab47d0>]}
[0m16:32:31.325638 [info ] [MainThread]: 
[0m16:32:31.325872 [info ] [MainThread]: Concurrency: 8 threads (target='dev')
[0m16:32:31.326096 [info ] [MainThread]: 
[0m16:32:31.326488 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m16:32:31.328510 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_data-talk-clubs'
[0m16:32:31.328840 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:32:31.329093 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_data-talk-clubs'
[0m16:32:31.329404 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_data-talk-clubs'
[0m16:32:31.329669 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:32:31.329876 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:32:31.753289 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_data-talk-clubs, now list_data-talk-clubs_eu_emissions_project)
[0m16:32:31.754175 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_data-talk-clubs, now list_data-talk-clubs_eu_emissions_project_intermediate)
[0m16:32:31.754550 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m16:32:31.754841 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_data-talk-clubs, now list_data-talk-clubs_eu_emissions_project_marts)
[0m16:32:31.755142 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_data-talk-clubs_eu_emissions_project_staging'
[0m16:32:31.755337 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m16:32:31.755600 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m16:32:31.755776 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:32:32.090530 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '8dc761c6-4787-4132-a57b-b755ca3e56de', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x13d625010>]}
[0m16:32:32.090959 [debug] [MainThread]: Opening a new connection, currently in state init
[0m16:32:32.093055 [debug] [Thread-1 (]: Began running node model.eu_emissions_project.int_dim_capitals
[0m16:32:32.093577 [debug] [Thread-2 (]: Began running node model.eu_emissions_project.stg_emissions_data
[0m16:32:32.093391 [info ] [Thread-1 (]: 1 of 4 START sql table model eu_emissions_project_intermediate.int_dim_capitals  [RUN]
[0m16:32:32.093943 [info ] [Thread-2 (]: 2 of 4 START sql view model eu_emissions_project_staging.stg_emissions_data .... [RUN]
[0m16:32:32.094223 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_data-talk-clubs_eu_emissions_project, now model.eu_emissions_project.int_dim_capitals)
[0m16:32:32.094463 [debug] [Thread-2 (]: Re-using an available connection from the pool (formerly list_data-talk-clubs_eu_emissions_project_intermediate, now model.eu_emissions_project.stg_emissions_data)
[0m16:32:32.094682 [debug] [Thread-1 (]: Began compiling node model.eu_emissions_project.int_dim_capitals
[0m16:32:32.094882 [debug] [Thread-2 (]: Began compiling node model.eu_emissions_project.stg_emissions_data
[0m16:32:32.099798 [debug] [Thread-1 (]: Writing injected SQL for node "model.eu_emissions_project.int_dim_capitals"
[0m16:32:32.102565 [debug] [Thread-2 (]: Writing injected SQL for node "model.eu_emissions_project.stg_emissions_data"
[0m16:32:32.103283 [debug] [Thread-2 (]: Began executing node model.eu_emissions_project.stg_emissions_data
[0m16:32:32.109845 [debug] [Thread-1 (]: Began executing node model.eu_emissions_project.int_dim_capitals
[0m16:32:32.118917 [debug] [Thread-2 (]: Writing runtime sql for node "model.eu_emissions_project.stg_emissions_data"
[0m16:32:32.132800 [debug] [Thread-1 (]: Writing runtime sql for node "model.eu_emissions_project.int_dim_capitals"
[0m16:32:32.133346 [debug] [Thread-2 (]: On model.eu_emissions_project.stg_emissions_data: /* {"app": "dbt", "dbt_version": "1.9.3", "profile_name": "big-query", "target_name": "dev", "node_id": "model.eu_emissions_project.stg_emissions_data"} */


  create or replace view `data-talk-clubs`.`eu_emissions_project_staging`.`stg_emissions_data`
  OPTIONS()
  as 

WITH source AS (
    SELECT 
        *
    FROM `data-talk-clubs`.`eu_emissions_project`.`nitrogen_dioxide_data`
),

-- First, prepare the data by converting columns to the right format for unpivoting
preprocessed AS (
    SELECT
        freq_airpol_unit_geo_TIME_PERIOD AS metadata,
        -- All other columns are measurement data columns
        *
    FROM source
),

-- Use UNPIVOT to transform the wide format to long format
unpivoted AS (
    SELECT
        metadata,
        col_name AS date_column,
        CAST(col_value AS STRING) AS measurement_value
    FROM preprocessed
    UNPIVOT(
        col_value FOR col_name IN (
            _2018_01_, _2018_02_, _2018_03_, _2018_04_, _2018_05_, _2018_06_,
            _2018_07_, _2018_08_, _2018_09_, _2018_10_, _2018_11_, _2018_12_,
            _2019_01_, _2019_02_, _2019_03_, _2019_04_, _2019_05_, _2019_06_,
            _2019_07_, _2019_08_, _2019_09_, _2019_10_, _2019_11_, _2019_12_,
            _2020_01_, _2020_02_, _2020_03_, _2020_04_, _2020_05_, _2020_06_,
            _2020_07_, _2020_08_, _2020_09_, _2020_10_, _2020_11_, _2020_12_,
            _2021_01_, _2021_02_, _2021_03_, _2021_04_, _2021_05_, _2021_06_,
            _2021_07_, _2021_08_, _2021_09_, _2021_10_, _2021_11_, _2021_12_,
            _2022_01_, _2022_02_, _2022_03_, _2022_04_, _2022_05_, _2022_06_,
            _2022_07_, _2022_08_, _2022_09_, _2022_10_, _2022_11_, _2022_12_,
            _2023_01_, _2023_02_, _2023_03_, _2023_04_, _2023_05_, _2023_06_,
            _2023_07_, _2023_08_, _2023_09_, _2023_10_, _2023_11_, _2023_12_,
            _2024_01_, _2024_02_, _2024_03_, _2024_04_, _2024_05_, _2024_06_,
            _2024_07_, _2024_08_, _2024_09_, _2024_10_, _2024_11_, _2024_12_,
            _2025_01_, _2025_02_
        )
    )
    -- Filter out zero values that represent missing data
    -- WHERE measurement_value != '0.0'
),

-- Process the date and value after unpivoting
processed_measurements AS (
    SELECT
        metadata,
        -- Clean up column name by removing underscores
        REPLACE(date_column, '_', '') AS clean_date_column,
        -- Keep measurement value as string for now
        measurement_value,
        -- Extract month and year from column name and create a proper date
        DATE(CONCAT(
            SUBSTR(REPLACE(date_column, '_', ''), 1, 4), '-',
            SUBSTR(REPLACE(date_column, '_', ''), 5, 2), '-01'
        )) AS measurement_date,
        -- Create a readable date label (e.g., 'Jan 2018')
        CONCAT(
            FORMAT_DATE('%b', DATE(CONCAT(
                SUBSTR(REPLACE(date_column, '_', ''), 1, 4), '-',
                SUBSTR(REPLACE(date_column, '_', ''), 5, 2), '-01'
            ))),
            ' ',
            SUBSTR(REPLACE(date_column, '_', ''), 1, 4)
        ) AS date_label
    FROM unpivoted
),

metadata_extracted AS (
    SELECT
        -- Extract metadata components
        SPLIT(metadata, ',')[SAFE_OFFSET(0)] AS frequency,
        SPLIT(metadata, ',')[SAFE_OFFSET(1)] AS airpol,
        SPLIT(metadata, ',')[SAFE_OFFSET(2)] AS unit,
        SPLIT(metadata, ',')[SAFE_OFFSET(3)] AS geo_code,
        date_label,
        measurement_date,
        -- Convert measurement value to FLOAT64 here, after unpivoting
        -- Use TRIM to remove any potential whitespace and explicit comparison
        CASE 
            WHEN TRIM(measurement_value) = '0.0' THEN NULL
            ELSE SAFE_CAST(measurement_value AS FLOAT64)
        END AS measurement_value,
        CURRENT_TIMESTAMP() AS load_timestamp
    FROM processed_measurements
),

final AS (

SELECT
    ROW_NUMBER() OVER() AS id,
    frequency,
    airpol,
    unit,
    geo_code,
    date_label,
    measurement_date,
    measurement_value,
    load_timestamp
FROM metadata_extracted
ORDER BY geo_code, measurement_date
)

select * from final;


[0m16:32:32.133750 [debug] [Thread-2 (]: Opening a new connection, currently in state closed
[0m16:32:32.169389 [debug] [Thread-1 (]: On model.eu_emissions_project.int_dim_capitals: /* {"app": "dbt", "dbt_version": "1.9.3", "profile_name": "big-query", "target_name": "dev", "node_id": "model.eu_emissions_project.int_dim_capitals"} */

  
    

    create or replace table `data-talk-clubs`.`eu_emissions_project_intermediate`.`int_dim_capitals`
      
    
    

    OPTIONS()
    as (
      

-- Reference the capitals seed file
SELECT
    geo_code,
    Capital AS capital_city,
    Country AS country_name
FROM `data-talk-clubs`.`eu_emissions_project`.`capitals`
    );
  
[0m16:32:32.169987 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m16:32:32.695101 [debug] [Thread-1 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=data-talk-clubs&j=bq:EU:69acd864-7c59-425c-9051-82cd86101488&page=queryresults
[0m16:32:32.711696 [debug] [Thread-2 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=data-talk-clubs&j=bq:EU:e395cbc1-8905-4101-bdb4-c714ab4a0c94&page=queryresults
[0m16:32:33.028159 [debug] [Thread-2 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '8dc761c6-4787-4132-a57b-b755ca3e56de', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x138756ad0>]}
[0m16:32:33.028598 [info ] [Thread-2 (]: 2 of 4 OK created sql view model eu_emissions_project_staging.stg_emissions_data  [[32mCREATE VIEW (0 processed)[0m in 0.93s]
[0m16:32:33.028920 [debug] [Thread-2 (]: Finished running node model.eu_emissions_project.stg_emissions_data
[0m16:32:33.029296 [debug] [Thread-4 (]: Began running node model.eu_emissions_project.int_emissions_cleaned
[0m16:32:33.029678 [info ] [Thread-4 (]: 3 of 4 START sql view model eu_emissions_project_intermediate.int_emissions_cleaned  [RUN]
[0m16:32:33.029962 [debug] [Thread-4 (]: Re-using an available connection from the pool (formerly list_data-talk-clubs_eu_emissions_project_staging, now model.eu_emissions_project.int_emissions_cleaned)
[0m16:32:33.030178 [debug] [Thread-4 (]: Began compiling node model.eu_emissions_project.int_emissions_cleaned
[0m16:32:33.031851 [debug] [Thread-4 (]: Writing injected SQL for node "model.eu_emissions_project.int_emissions_cleaned"
[0m16:32:33.032293 [debug] [Thread-4 (]: Began executing node model.eu_emissions_project.int_emissions_cleaned
[0m16:32:33.033743 [debug] [Thread-4 (]: Writing runtime sql for node "model.eu_emissions_project.int_emissions_cleaned"
[0m16:32:33.034311 [debug] [Thread-4 (]: On model.eu_emissions_project.int_emissions_cleaned: /* {"app": "dbt", "dbt_version": "1.9.3", "profile_name": "big-query", "target_name": "dev", "node_id": "model.eu_emissions_project.int_emissions_cleaned"} */


  create or replace view `data-talk-clubs`.`eu_emissions_project_intermediate`.`int_emissions_cleaned`
  OPTIONS()
  as 

WITH emissions_data AS (
    SELECT *
    FROM `data-talk-clubs`.`eu_emissions_project_staging`.`stg_emissions_data`
)

SELECT 
    airpol,
    unit,
    geo_code,
    date_label,
    measurement_date,
    IF(measurement_value = 0.0, NULL, measurement_value) AS measurement_value
FROM emissions_data;


[0m16:32:33.034602 [debug] [Thread-4 (]: Opening a new connection, currently in state closed
[0m16:32:33.741606 [debug] [Thread-4 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=data-talk-clubs&j=bq:EU:ee30e013-8059-4c9f-b2eb-854f9a1f807d&page=queryresults
[0m16:32:33.997010 [debug] [Thread-4 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '8dc761c6-4787-4132-a57b-b755ca3e56de', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x13e4231d0>]}
[0m16:32:33.997505 [info ] [Thread-4 (]: 3 of 4 OK created sql view model eu_emissions_project_intermediate.int_emissions_cleaned  [[32mCREATE VIEW (0 processed)[0m in 0.97s]
[0m16:32:33.997832 [debug] [Thread-4 (]: Finished running node model.eu_emissions_project.int_emissions_cleaned
[0m16:32:35.282879 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '8dc761c6-4787-4132-a57b-b755ca3e56de', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x13de5abd0>]}
[0m16:32:35.283600 [info ] [Thread-1 (]: 1 of 4 OK created sql table model eu_emissions_project_intermediate.int_dim_capitals  [[32mCREATE TABLE (32.0 rows, 847.0 Bytes processed)[0m in 3.19s]
[0m16:32:35.283964 [debug] [Thread-1 (]: Finished running node model.eu_emissions_project.int_dim_capitals
[0m16:32:35.284636 [debug] [Thread-6 (]: Began running node model.eu_emissions_project.emissions_analysis
[0m16:32:35.284991 [info ] [Thread-6 (]: 4 of 4 START sql table model eu_emissions_project_marts.emissions_analysis ..... [RUN]
[0m16:32:35.285304 [debug] [Thread-6 (]: Acquiring new bigquery connection 'model.eu_emissions_project.emissions_analysis'
[0m16:32:35.285515 [debug] [Thread-6 (]: Began compiling node model.eu_emissions_project.emissions_analysis
[0m16:32:35.288379 [debug] [Thread-6 (]: Writing injected SQL for node "model.eu_emissions_project.emissions_analysis"
[0m16:32:35.289103 [debug] [Thread-6 (]: Began executing node model.eu_emissions_project.emissions_analysis
[0m16:32:35.291335 [debug] [Thread-6 (]: Writing runtime sql for node "model.eu_emissions_project.emissions_analysis"
[0m16:32:35.291919 [debug] [Thread-6 (]: On model.eu_emissions_project.emissions_analysis: /* {"app": "dbt", "dbt_version": "1.9.3", "profile_name": "big-query", "target_name": "dev", "node_id": "model.eu_emissions_project.emissions_analysis"} */

  
    

    create or replace table `data-talk-clubs`.`eu_emissions_project_marts`.`emissions_analysis`
      
    
    

    OPTIONS()
    as (
      

WITH emissions_data AS (
    SELECT *
    FROM `data-talk-clubs`.`eu_emissions_project_intermediate`.`int_emissions_cleaned`
),

capitals_data AS (
    SELECT *
    FROM `data-talk-clubs`.`eu_emissions_project_intermediate`.`int_dim_capitals`
),

-- Join emissions data with capitals information
emissions_with_location AS (
    SELECT
        e.*,
        c.capital_city,
        c.country_name
    FROM emissions_data e
    LEFT JOIN capitals_data c
        ON e.geo_code = c.geo_code
),

-- Calculate yearly averages by location
yearly_averages AS (
    SELECT
        capital_city,
        country_name,
        geo_code,
        EXTRACT(YEAR FROM measurement_date) AS year,
        airpol,
        unit,
        AVG(measurement_value) AS avg_value,
        MIN(measurement_value) AS min_value,
        MAX(measurement_value) AS max_value,
        COUNT(*) AS measurement_count
    FROM emissions_with_location
    GROUP BY capital_city, country_name, geo_code, EXTRACT(YEAR FROM measurement_date), airpol, unit
),

-- Calculate year-over-year changes
yoy_changes AS (
    SELECT
        current_year.*,
        current_year.avg_value - prev_year.avg_value AS absolute_change,
        CASE 
            WHEN prev_year.avg_value = 0 OR prev_year.avg_value IS NULL THEN NULL
            ELSE (current_year.avg_value - prev_year.avg_value) / prev_year.avg_value * 100 
        END AS percentage_change
    FROM yearly_averages current_year
    LEFT JOIN yearly_averages prev_year
        ON current_year.geo_code = prev_year.geo_code
        AND current_year.year = prev_year.year + 1
        AND current_year.airpol = prev_year.airpol
        AND current_year.unit = prev_year.unit
),

-- Calculate country rankings by year
country_rankings AS (
    SELECT
        year,
        country_name,
        airpol,
        unit,
        avg_value,
        RANK() OVER(PARTITION BY year, airpol, unit ORDER BY avg_value) AS pollution_rank_asc,
        RANK() OVER(PARTITION BY year, airpol, unit ORDER BY avg_value DESC) AS pollution_rank_desc
    FROM yearly_averages
    WHERE country_name IS NOT NULL
)

-- Final analytical model
SELECT 
    y.capital_city,
    y.country_name,
    y.geo_code,
    y.year,
    y.airpol,
    y.unit,
    y.avg_value,
    y.min_value,
    y.max_value,
    y.measurement_count,
    y.absolute_change,
    y.percentage_change,
    -- Add trend indicators
    CASE
        WHEN y.percentage_change < -5 THEN 'Significant Decrease'
        WHEN y.percentage_change BETWEEN -5 AND -0.5 THEN 'Moderate Decrease'
        WHEN y.percentage_change BETWEEN -0.5 AND 0.5 THEN 'Stable'
        WHEN y.percentage_change BETWEEN 0.5 AND 5 THEN 'Moderate Increase'
        WHEN y.percentage_change > 5 THEN 'Significant Increase'
        ELSE 'Insufficient Data'
    END AS trend_category,
    -- Add country rankings
    r.pollution_rank_asc,
    r.pollution_rank_desc,
    -- Calculate percentile within year (lower percentile = lower pollution)
    PERCENT_RANK() OVER(PARTITION BY y.year, y.airpol, y.unit ORDER BY y.avg_value) AS pollution_percentile,
    -- Add a flag for capitals exceeding EU average (if EU27_2020 data exists)
    CASE
        WHEN eu.avg_value IS NULL THEN NULL
        WHEN y.avg_value > eu.avg_value THEN TRUE
        ELSE FALSE
    END AS exceeds_eu_average,
    -- Calculate how much above/below EU average (in percentage)
    CASE
        WHEN eu.avg_value IS NULL OR eu.avg_value = 0 THEN NULL
        ELSE (y.avg_value - eu.avg_value) / eu.avg_value * 100
    END AS percent_diff_from_eu_avg,
    CURRENT_TIMESTAMP() AS analysis_timestamp
FROM yoy_changes y
LEFT JOIN country_rankings r
    ON y.year = r.year
    AND y.country_name = r.country_name
    AND y.airpol = r.airpol
    AND y.unit = r.unit
LEFT JOIN yearly_averages eu
    ON y.year = eu.year
    AND y.airpol = eu.airpol
    AND y.unit = eu.unit
    AND eu.geo_code = 'EU27_2020'
ORDER BY y.country_name, y.year
    );
  
[0m16:32:35.292297 [debug] [Thread-6 (]: Opening a new connection, currently in state init
[0m16:32:36.269853 [debug] [Thread-6 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=data-talk-clubs&j=bq:EU:0357ed16-7b76-4a7f-b8e9-2388e1b4e014&page=queryresults
[0m16:32:39.750707 [debug] [Thread-6 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '8dc761c6-4787-4132-a57b-b755ca3e56de', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x13deb4790>]}
[0m16:32:39.751493 [info ] [Thread-6 (]: 4 of 4 OK created sql table model eu_emissions_project_marts.emissions_analysis  [[32mCREATE TABLE (248.0 rows, 63.4 KiB processed)[0m in 4.47s]
[0m16:32:39.751876 [debug] [Thread-6 (]: Finished running node model.eu_emissions_project.emissions_analysis
[0m16:32:39.753169 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m16:32:39.754230 [debug] [MainThread]: Connection 'master' was properly closed.
[0m16:32:39.754456 [debug] [MainThread]: Connection 'model.eu_emissions_project.int_dim_capitals' was properly closed.
[0m16:32:39.754684 [debug] [MainThread]: Connection 'model.eu_emissions_project.stg_emissions_data' was properly closed.
[0m16:32:39.754884 [debug] [MainThread]: Connection 'list_data-talk-clubs_eu_emissions_project_marts' was properly closed.
[0m16:32:39.755056 [debug] [MainThread]: Connection 'model.eu_emissions_project.int_emissions_cleaned' was properly closed.
[0m16:32:39.755222 [debug] [MainThread]: Connection 'model.eu_emissions_project.emissions_analysis' was properly closed.
[0m16:32:39.755437 [info ] [MainThread]: 
[0m16:32:39.755628 [info ] [MainThread]: Finished running 2 table models, 2 view models in 0 hours 0 minutes and 8.43 seconds (8.43s).
[0m16:32:39.756119 [debug] [MainThread]: Command end result
[0m16:32:39.769086 [debug] [MainThread]: Wrote artifact WritableManifest to /Users/timbo/Documents/DataTalks/project/src/target/manifest.json
[0m16:32:39.770092 [debug] [MainThread]: Wrote artifact SemanticManifest to /Users/timbo/Documents/DataTalks/project/src/target/semantic_manifest.json
[0m16:32:39.772940 [debug] [MainThread]: Wrote artifact RunExecutionResult to /Users/timbo/Documents/DataTalks/project/src/target/run_results.json
[0m16:32:39.773143 [info ] [MainThread]: 
[0m16:32:39.773378 [info ] [MainThread]: [32mCompleted successfully[0m
[0m16:32:39.773565 [info ] [MainThread]: 
[0m16:32:39.773912 [info ] [MainThread]: Done. PASS=4 WARN=0 ERROR=0 SKIP=0 TOTAL=4
[0m16:32:39.775151 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": true, "command_wall_clock_time": 9.214916, "process_in_blocks": "0", "process_kernel_time": 0.252244, "process_mem_max_rss": "211681280", "process_out_blocks": "0", "process_user_time": 1.797759}
[0m16:32:39.775408 [debug] [MainThread]: Command `dbt run` succeeded at 16:32:39.775366 after 9.22 seconds
[0m16:32:39.775637 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10474e090>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1045e0350>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1045f0790>]}
[0m16:32:39.775854 [debug] [MainThread]: Flushing usage events
[0m16:32:40.200979 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m16:39:05.616587 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105d6f350>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105dcb1d0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105dc2cd0>]}


============================== 16:39:05.620129 | 2607b3aa-bb52-455c-832a-1c8d1758fdf3 ==============================
[0m16:39:05.620129 [info ] [MainThread]: Running with dbt=1.9.3
[0m16:39:05.620590 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'fail_fast': 'False', 'version_check': 'True', 'log_path': '/Users/timbo/Documents/DataTalks/project/src/logs', 'profiles_dir': '/Users/timbo/.dbt', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'empty': 'False', 'quiet': 'False', 'no_print': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'log_format': 'default', 'invocation_command': 'dbt run --full-refresh', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m16:39:06.335487 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '2607b3aa-bb52-455c-832a-1c8d1758fdf3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x118044f50>]}
[0m16:39:06.362060 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '2607b3aa-bb52-455c-832a-1c8d1758fdf3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x103262990>]}
[0m16:39:06.362534 [info ] [MainThread]: Registered adapter: bigquery=1.9.1
[0m16:39:06.456121 [debug] [MainThread]: checksum: 5671c00892cdbcef29c3b00cc5ba7510c3d18a35c883caeb9ab9ee266dc29c8f, vars: {}, profile: , target: , version: 1.9.3
[0m16:39:06.580870 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 3 files changed.
[0m16:39:06.581332 [debug] [MainThread]: Partial parsing: updated file: eu_emissions_project://models/intermediate/int_emissions_cleaned.sql
[0m16:39:06.581608 [debug] [MainThread]: Partial parsing: updated file: eu_emissions_project://models/marts/emissions_analysis.sql
[0m16:39:06.581837 [debug] [MainThread]: Partial parsing: updated file: eu_emissions_project://models/intermediate/int_dim_capitals.sql
[0m16:39:06.746032 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '2607b3aa-bb52-455c-832a-1c8d1758fdf3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11d4b6f10>]}
[0m16:39:06.786364 [debug] [MainThread]: Wrote artifact WritableManifest to /Users/timbo/Documents/DataTalks/project/src/target/manifest.json
[0m16:39:06.788511 [debug] [MainThread]: Wrote artifact SemanticManifest to /Users/timbo/Documents/DataTalks/project/src/target/semantic_manifest.json
[0m16:39:06.800425 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '2607b3aa-bb52-455c-832a-1c8d1758fdf3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11d517590>]}
[0m16:39:06.800781 [info ] [MainThread]: Found 4 models, 1 seed, 1 source, 491 macros
[0m16:39:06.800995 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '2607b3aa-bb52-455c-832a-1c8d1758fdf3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11d479b90>]}
[0m16:39:06.801916 [info ] [MainThread]: 
[0m16:39:06.802130 [info ] [MainThread]: Concurrency: 8 threads (target='dev')
[0m16:39:06.802304 [info ] [MainThread]: 
[0m16:39:06.802571 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m16:39:06.804677 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_data-talk-clubs'
[0m16:39:06.805057 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_data-talk-clubs'
[0m16:39:06.805354 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_data-talk-clubs'
[0m16:39:06.805570 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:39:06.805768 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:39:06.805966 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:39:07.298818 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_data-talk-clubs, now list_data-talk-clubs_eu_emissions_project_staging)
[0m16:39:07.299214 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_data-talk-clubs, now list_data-talk-clubs_eu_emissions_project_intermediate)
[0m16:39:07.299626 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_data-talk-clubs, now list_data-talk-clubs_eu_emissions_project_marts)
[0m16:39:07.300081 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_data-talk-clubs_eu_emissions_project'
[0m16:39:07.300291 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m16:39:07.300540 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m16:39:07.300721 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m16:39:07.300946 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:39:07.643837 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '2607b3aa-bb52-455c-832a-1c8d1758fdf3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11d01ebd0>]}
[0m16:39:07.644219 [debug] [MainThread]: Opening a new connection, currently in state init
[0m16:39:07.647172 [debug] [Thread-1 (]: Began running node model.eu_emissions_project.int_dim_capitals
[0m16:39:07.647443 [debug] [Thread-2 (]: Began running node model.eu_emissions_project.stg_emissions_data
[0m16:39:07.647806 [info ] [Thread-1 (]: 1 of 4 START sql table model eu_emissions_project_intermediate.int_dim_capitals  [RUN]
[0m16:39:07.648118 [info ] [Thread-2 (]: 2 of 4 START sql view model eu_emissions_project_staging.stg_emissions_data .... [RUN]
[0m16:39:07.648435 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_data-talk-clubs_eu_emissions_project_staging, now model.eu_emissions_project.int_dim_capitals)
[0m16:39:07.648683 [debug] [Thread-2 (]: Re-using an available connection from the pool (formerly list_data-talk-clubs_eu_emissions_project_intermediate, now model.eu_emissions_project.stg_emissions_data)
[0m16:39:07.648923 [debug] [Thread-1 (]: Began compiling node model.eu_emissions_project.int_dim_capitals
[0m16:39:07.649148 [debug] [Thread-2 (]: Began compiling node model.eu_emissions_project.stg_emissions_data
[0m16:39:07.653554 [debug] [Thread-1 (]: Writing injected SQL for node "model.eu_emissions_project.int_dim_capitals"
[0m16:39:07.655722 [debug] [Thread-2 (]: Writing injected SQL for node "model.eu_emissions_project.stg_emissions_data"
[0m16:39:07.656398 [debug] [Thread-1 (]: Began executing node model.eu_emissions_project.int_dim_capitals
[0m16:39:07.656658 [debug] [Thread-2 (]: Began executing node model.eu_emissions_project.stg_emissions_data
[0m16:39:07.666689 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m16:39:07.681335 [debug] [Thread-2 (]: Writing runtime sql for node "model.eu_emissions_project.stg_emissions_data"
[0m16:39:07.717312 [debug] [Thread-2 (]: On model.eu_emissions_project.stg_emissions_data: /* {"app": "dbt", "dbt_version": "1.9.3", "profile_name": "big-query", "target_name": "dev", "node_id": "model.eu_emissions_project.stg_emissions_data"} */


  create or replace view `data-talk-clubs`.`eu_emissions_project_staging`.`stg_emissions_data`
  OPTIONS()
  as 

WITH source AS (
    SELECT 
        *
    FROM `data-talk-clubs`.`eu_emissions_project`.`nitrogen_dioxide_data`
),

-- First, prepare the data by converting columns to the right format for unpivoting
preprocessed AS (
    SELECT
        freq_airpol_unit_geo_TIME_PERIOD AS metadata,
        -- All other columns are measurement data columns
        *
    FROM source
),

-- Use UNPIVOT to transform the wide format to long format
unpivoted AS (
    SELECT
        metadata,
        col_name AS date_column,
        CAST(col_value AS STRING) AS measurement_value
    FROM preprocessed
    UNPIVOT(
        col_value FOR col_name IN (
            _2018_01_, _2018_02_, _2018_03_, _2018_04_, _2018_05_, _2018_06_,
            _2018_07_, _2018_08_, _2018_09_, _2018_10_, _2018_11_, _2018_12_,
            _2019_01_, _2019_02_, _2019_03_, _2019_04_, _2019_05_, _2019_06_,
            _2019_07_, _2019_08_, _2019_09_, _2019_10_, _2019_11_, _2019_12_,
            _2020_01_, _2020_02_, _2020_03_, _2020_04_, _2020_05_, _2020_06_,
            _2020_07_, _2020_08_, _2020_09_, _2020_10_, _2020_11_, _2020_12_,
            _2021_01_, _2021_02_, _2021_03_, _2021_04_, _2021_05_, _2021_06_,
            _2021_07_, _2021_08_, _2021_09_, _2021_10_, _2021_11_, _2021_12_,
            _2022_01_, _2022_02_, _2022_03_, _2022_04_, _2022_05_, _2022_06_,
            _2022_07_, _2022_08_, _2022_09_, _2022_10_, _2022_11_, _2022_12_,
            _2023_01_, _2023_02_, _2023_03_, _2023_04_, _2023_05_, _2023_06_,
            _2023_07_, _2023_08_, _2023_09_, _2023_10_, _2023_11_, _2023_12_,
            _2024_01_, _2024_02_, _2024_03_, _2024_04_, _2024_05_, _2024_06_,
            _2024_07_, _2024_08_, _2024_09_, _2024_10_, _2024_11_, _2024_12_,
            _2025_01_, _2025_02_
        )
    )
    -- Filter out zero values that represent missing data
    -- WHERE measurement_value != '0.0'
),

-- Process the date and value after unpivoting
processed_measurements AS (
    SELECT
        metadata,
        -- Clean up column name by removing underscores
        REPLACE(date_column, '_', '') AS clean_date_column,
        -- Keep measurement value as string for now
        measurement_value,
        -- Extract month and year from column name and create a proper date
        DATE(CONCAT(
            SUBSTR(REPLACE(date_column, '_', ''), 1, 4), '-',
            SUBSTR(REPLACE(date_column, '_', ''), 5, 2), '-01'
        )) AS measurement_date,
        -- Create a readable date label (e.g., 'Jan 2018')
        CONCAT(
            FORMAT_DATE('%b', DATE(CONCAT(
                SUBSTR(REPLACE(date_column, '_', ''), 1, 4), '-',
                SUBSTR(REPLACE(date_column, '_', ''), 5, 2), '-01'
            ))),
            ' ',
            SUBSTR(REPLACE(date_column, '_', ''), 1, 4)
        ) AS date_label
    FROM unpivoted
),

metadata_extracted AS (
    SELECT
        -- Extract metadata components
        SPLIT(metadata, ',')[SAFE_OFFSET(0)] AS frequency,
        SPLIT(metadata, ',')[SAFE_OFFSET(1)] AS airpol,
        SPLIT(metadata, ',')[SAFE_OFFSET(2)] AS unit,
        SPLIT(metadata, ',')[SAFE_OFFSET(3)] AS geo_code,
        date_label,
        measurement_date,
        -- Convert measurement value to FLOAT64 here, after unpivoting
        -- Use TRIM to remove any potential whitespace and explicit comparison
        CASE 
            WHEN TRIM(measurement_value) = '0.0' THEN NULL
            ELSE SAFE_CAST(measurement_value AS FLOAT64)
        END AS measurement_value,
        CURRENT_TIMESTAMP() AS load_timestamp
    FROM processed_measurements
),

final AS (

SELECT
    ROW_NUMBER() OVER() AS id,
    frequency,
    airpol,
    unit,
    geo_code,
    date_label,
    measurement_date,
    measurement_value,
    load_timestamp
FROM metadata_extracted
ORDER BY geo_code, measurement_date
)

select * from final;


[0m16:39:07.718228 [debug] [Thread-2 (]: Opening a new connection, currently in state closed
[0m16:39:07.945131 [debug] [Thread-1 (]: Writing runtime sql for node "model.eu_emissions_project.int_dim_capitals"
[0m16:39:07.945796 [debug] [Thread-1 (]: On model.eu_emissions_project.int_dim_capitals: /* {"app": "dbt", "dbt_version": "1.9.3", "profile_name": "big-query", "target_name": "dev", "node_id": "model.eu_emissions_project.int_dim_capitals"} */

  
    

    create or replace table `data-talk-clubs`.`eu_emissions_project_intermediate`.`int_dim_capitals`
      
    
    

    OPTIONS()
    as (
      

-- Reference the capitals seed file
dbt run --full-refreshSELECT
    geo_code,
    Capital AS capital_city,
    Country AS country_name
FROM `data-talk-clubs`.`eu_emissions_project`.`capitals`
    );
  
[0m16:39:08.079025 [debug] [Thread-1 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=data-talk-clubs&j=bq:EU:33387b25-dbff-49d8-b1e8-52f4334e58e2&page=queryresults
[0m16:39:08.079500 [error] [Thread-1 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=data-talk-clubs&j=bq:EU:33387b25-dbff-49d8-b1e8-52f4334e58e2&page=queryresults
[0m16:39:08.086700 [debug] [Thread-1 (]: Database Error in model int_dim_capitals (models/intermediate/int_dim_capitals.sql)
  Syntax error: Unexpected identifier "dbt" at [16:1]
  compiled code at target/run/eu_emissions_project/models/intermediate/int_dim_capitals.sql
[0m16:39:08.088041 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '2607b3aa-bb52-455c-832a-1c8d1758fdf3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11d96ed50>]}
[0m16:39:08.088667 [error] [Thread-1 (]: 1 of 4 ERROR creating sql table model eu_emissions_project_intermediate.int_dim_capitals  [[31mERROR[0m in 0.44s]
[0m16:39:08.089032 [debug] [Thread-1 (]: Finished running node model.eu_emissions_project.int_dim_capitals
[0m16:39:08.089406 [debug] [Thread-11 ]: Marking all children of 'model.eu_emissions_project.int_dim_capitals' to be skipped because of status 'error'.  Reason: Database Error in model int_dim_capitals (models/intermediate/int_dim_capitals.sql)
  Syntax error: Unexpected identifier "dbt" at [16:1]
  compiled code at target/run/eu_emissions_project/models/intermediate/int_dim_capitals.sql.
[0m16:39:08.273297 [debug] [Thread-2 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=data-talk-clubs&j=bq:EU:3d9fc954-1f60-407a-a21f-d5d770126919&page=queryresults
[0m16:39:08.598631 [debug] [Thread-2 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '2607b3aa-bb52-455c-832a-1c8d1758fdf3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11dede950>]}
[0m16:39:08.599126 [info ] [Thread-2 (]: 2 of 4 OK created sql view model eu_emissions_project_staging.stg_emissions_data  [[32mCREATE VIEW (0 processed)[0m in 0.95s]
[0m16:39:08.599511 [debug] [Thread-2 (]: Finished running node model.eu_emissions_project.stg_emissions_data
[0m16:39:08.599900 [debug] [Thread-4 (]: Began running node model.eu_emissions_project.int_emissions_cleaned
[0m16:39:08.600248 [info ] [Thread-4 (]: 3 of 4 START sql table model eu_emissions_project_intermediate.int_emissions_cleaned  [RUN]
[0m16:39:08.600513 [debug] [Thread-4 (]: Re-using an available connection from the pool (formerly list_data-talk-clubs_eu_emissions_project, now model.eu_emissions_project.int_emissions_cleaned)
[0m16:39:08.600720 [debug] [Thread-4 (]: Began compiling node model.eu_emissions_project.int_emissions_cleaned
[0m16:39:08.602780 [debug] [Thread-4 (]: Writing injected SQL for node "model.eu_emissions_project.int_emissions_cleaned"
[0m16:39:08.603301 [debug] [Thread-4 (]: Began executing node model.eu_emissions_project.int_emissions_cleaned
[0m16:39:08.604744 [debug] [Thread-4 (]: Opening a new connection, currently in state closed
[0m16:39:08.901328 [debug] [Thread-4 (]: Writing runtime sql for node "model.eu_emissions_project.int_emissions_cleaned"
[0m16:39:08.904253 [debug] [Thread-4 (]: On model.eu_emissions_project.int_emissions_cleaned: /* {"app": "dbt", "dbt_version": "1.9.3", "profile_name": "big-query", "target_name": "dev", "node_id": "model.eu_emissions_project.int_emissions_cleaned"} */

  
    

    create or replace table `data-talk-clubs`.`eu_emissions_project_intermediate`.`int_emissions_cleaned`
      
    partition by date_trunc(measurement_date, month)
    cluster by geo_code

    OPTIONS()
    as (
      

WITH emissions_data AS (
    SELECT *
    FROM `data-talk-clubs`.`eu_emissions_project_staging`.`stg_emissions_data`
)

SELECT 
    airpol,
    unit,
    geo_code,
    date_label,
    measurement_date,
    IF(measurement_value = 0.0, NULL, measurement_value) AS measurement_value
FROM emissions_data
    );
  
[0m16:39:09.675954 [debug] [Thread-4 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=data-talk-clubs&j=bq:EU:76bb5828-e4ee-4fad-b4fc-3e9eac352221&page=queryresults
[0m16:39:34.574348 [debug] [Thread-4 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '2607b3aa-bb52-455c-832a-1c8d1758fdf3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11df01010>]}
[0m16:39:34.574923 [info ] [Thread-4 (]: 3 of 4 OK created sql table model eu_emissions_project_intermediate.int_emissions_cleaned  [[32mCREATE TABLE (2.7k rows, 15.6 KiB processed)[0m in 25.97s]
[0m16:39:34.575449 [debug] [Thread-4 (]: Finished running node model.eu_emissions_project.int_emissions_cleaned
[0m16:39:34.576012 [debug] [Thread-6 (]: Began running node model.eu_emissions_project.emissions_analysis
[0m16:39:34.576390 [info ] [Thread-6 (]: 4 of 4 SKIP relation eu_emissions_project_marts.emissions_analysis ............. [[33mSKIP[0m]
[0m16:39:34.576709 [debug] [Thread-6 (]: Finished running node model.eu_emissions_project.emissions_analysis
[0m16:39:34.577664 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m16:39:34.578624 [debug] [MainThread]: Connection 'master' was properly closed.
[0m16:39:34.578819 [debug] [MainThread]: Connection 'model.eu_emissions_project.int_dim_capitals' was properly closed.
[0m16:39:34.578989 [debug] [MainThread]: Connection 'model.eu_emissions_project.stg_emissions_data' was properly closed.
[0m16:39:34.579146 [debug] [MainThread]: Connection 'list_data-talk-clubs_eu_emissions_project_marts' was properly closed.
[0m16:39:34.579298 [debug] [MainThread]: Connection 'model.eu_emissions_project.int_emissions_cleaned' was properly closed.
[0m16:39:34.579509 [info ] [MainThread]: 
[0m16:39:34.579700 [info ] [MainThread]: Finished running 3 table models, 1 view model in 0 hours 0 minutes and 27.78 seconds (27.78s).
[0m16:39:34.580152 [debug] [MainThread]: Command end result
[0m16:39:34.594232 [debug] [MainThread]: Wrote artifact WritableManifest to /Users/timbo/Documents/DataTalks/project/src/target/manifest.json
[0m16:39:34.595972 [debug] [MainThread]: Wrote artifact SemanticManifest to /Users/timbo/Documents/DataTalks/project/src/target/semantic_manifest.json
[0m16:39:34.599130 [debug] [MainThread]: Wrote artifact RunExecutionResult to /Users/timbo/Documents/DataTalks/project/src/target/run_results.json
[0m16:39:34.599376 [info ] [MainThread]: 
[0m16:39:34.599610 [info ] [MainThread]: [31mCompleted with 1 error, 0 partial successes, and 0 warnings:[0m
[0m16:39:34.599797 [info ] [MainThread]: 
[0m16:39:34.600015 [error] [MainThread]:   Database Error in model int_dim_capitals (models/intermediate/int_dim_capitals.sql)
  Syntax error: Unexpected identifier "dbt" at [16:1]
  compiled code at target/run/eu_emissions_project/models/intermediate/int_dim_capitals.sql
[0m16:39:34.600209 [info ] [MainThread]: 
[0m16:39:34.600403 [info ] [MainThread]: Done. PASS=2 WARN=0 ERROR=1 SKIP=1 TOTAL=4
[0m16:39:34.602534 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": false, "command_wall_clock_time": 29.022547, "process_in_blocks": "0", "process_kernel_time": 0.327279, "process_mem_max_rss": "218955776", "process_out_blocks": "0", "process_user_time": 1.926344}
[0m16:39:34.602857 [debug] [MainThread]: Command `dbt run` failed at 16:39:34.602805 after 29.02 seconds
[0m16:39:34.603128 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105dc2f50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105a7cb90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x100bb0850>]}
[0m16:39:34.603357 [debug] [MainThread]: Flushing usage events
[0m16:39:35.018182 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m16:39:38.003057 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107a6e610>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107ac3690>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107acbed0>]}


============================== 16:39:38.006360 | f1883a08-6ef3-47ab-a13f-8dfc8b97fc25 ==============================
[0m16:39:38.006360 [info ] [MainThread]: Running with dbt=1.9.3
[0m16:39:38.006786 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': '/Users/timbo/.dbt', 'debug': 'False', 'fail_fast': 'False', 'log_path': '/Users/timbo/Documents/DataTalks/project/src/logs', 'version_check': 'True', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'empty': 'False', 'log_format': 'default', 'introspect': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt run --full-refresh', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m16:39:38.656377 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'f1883a08-6ef3-47ab-a13f-8dfc8b97fc25', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x125948210>]}
[0m16:39:38.682963 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'f1883a08-6ef3-47ab-a13f-8dfc8b97fc25', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1053a0bd0>]}
[0m16:39:38.683515 [info ] [MainThread]: Registered adapter: bigquery=1.9.1
[0m16:39:38.799842 [debug] [MainThread]: checksum: 5671c00892cdbcef29c3b00cc5ba7510c3d18a35c883caeb9ab9ee266dc29c8f, vars: {}, profile: , target: , version: 1.9.3
[0m16:39:38.922353 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m16:39:38.922766 [debug] [MainThread]: Partial parsing: updated file: eu_emissions_project://models/intermediate/int_dim_capitals.sql
[0m16:39:39.054185 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'f1883a08-6ef3-47ab-a13f-8dfc8b97fc25', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x125acf450>]}
[0m16:39:39.094672 [debug] [MainThread]: Wrote artifact WritableManifest to /Users/timbo/Documents/DataTalks/project/src/target/manifest.json
[0m16:39:39.096624 [debug] [MainThread]: Wrote artifact SemanticManifest to /Users/timbo/Documents/DataTalks/project/src/target/semantic_manifest.json
[0m16:39:39.110005 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'f1883a08-6ef3-47ab-a13f-8dfc8b97fc25', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x127204350>]}
[0m16:39:39.110377 [info ] [MainThread]: Found 4 models, 1 seed, 1 source, 491 macros
[0m16:39:39.110644 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'f1883a08-6ef3-47ab-a13f-8dfc8b97fc25', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1270b6bd0>]}
[0m16:39:39.111870 [info ] [MainThread]: 
[0m16:39:39.112178 [info ] [MainThread]: Concurrency: 8 threads (target='dev')
[0m16:39:39.112367 [info ] [MainThread]: 
[0m16:39:39.112661 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m16:39:39.114873 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_data-talk-clubs'
[0m16:39:39.115222 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_data-talk-clubs'
[0m16:39:39.115497 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_data-talk-clubs'
[0m16:39:39.115732 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:39:39.115936 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:39:39.116116 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:39:40.012027 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_data-talk-clubs, now list_data-talk-clubs_eu_emissions_project_marts)
[0m16:39:40.012406 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_data-talk-clubs, now list_data-talk-clubs_eu_emissions_project)
[0m16:39:40.012675 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m16:39:40.012926 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_data-talk-clubs, now list_data-talk-clubs_eu_emissions_project_staging)
[0m16:39:40.013122 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m16:39:40.013373 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_data-talk-clubs_eu_emissions_project_intermediate'
[0m16:39:40.069843 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m16:39:40.106803 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:39:40.729066 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'f1883a08-6ef3-47ab-a13f-8dfc8b97fc25', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x125a2a990>]}
[0m16:39:40.729577 [debug] [MainThread]: Opening a new connection, currently in state init
[0m16:39:40.732695 [debug] [Thread-1 (]: Began running node model.eu_emissions_project.int_dim_capitals
[0m16:39:40.732963 [debug] [Thread-2 (]: Began running node model.eu_emissions_project.stg_emissions_data
[0m16:39:40.733243 [info ] [Thread-1 (]: 1 of 4 START sql table model eu_emissions_project_intermediate.int_dim_capitals  [RUN]
[0m16:39:40.733521 [info ] [Thread-2 (]: 2 of 4 START sql view model eu_emissions_project_staging.stg_emissions_data .... [RUN]
[0m16:39:40.733783 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_data-talk-clubs_eu_emissions_project_marts, now model.eu_emissions_project.int_dim_capitals)
[0m16:39:40.733986 [debug] [Thread-2 (]: Re-using an available connection from the pool (formerly list_data-talk-clubs_eu_emissions_project, now model.eu_emissions_project.stg_emissions_data)
[0m16:39:40.734182 [debug] [Thread-1 (]: Began compiling node model.eu_emissions_project.int_dim_capitals
[0m16:39:40.734370 [debug] [Thread-2 (]: Began compiling node model.eu_emissions_project.stg_emissions_data
[0m16:39:40.738724 [debug] [Thread-1 (]: Writing injected SQL for node "model.eu_emissions_project.int_dim_capitals"
[0m16:39:40.740551 [debug] [Thread-2 (]: Writing injected SQL for node "model.eu_emissions_project.stg_emissions_data"
[0m16:39:40.741069 [debug] [Thread-1 (]: Began executing node model.eu_emissions_project.int_dim_capitals
[0m16:39:40.749057 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m16:39:40.749591 [debug] [Thread-2 (]: Began executing node model.eu_emissions_project.stg_emissions_data
[0m16:39:40.800591 [debug] [Thread-2 (]: Writing runtime sql for node "model.eu_emissions_project.stg_emissions_data"
[0m16:39:40.801827 [debug] [Thread-2 (]: On model.eu_emissions_project.stg_emissions_data: /* {"app": "dbt", "dbt_version": "1.9.3", "profile_name": "big-query", "target_name": "dev", "node_id": "model.eu_emissions_project.stg_emissions_data"} */


  create or replace view `data-talk-clubs`.`eu_emissions_project_staging`.`stg_emissions_data`
  OPTIONS()
  as 

WITH source AS (
    SELECT 
        *
    FROM `data-talk-clubs`.`eu_emissions_project`.`nitrogen_dioxide_data`
),

-- First, prepare the data by converting columns to the right format for unpivoting
preprocessed AS (
    SELECT
        freq_airpol_unit_geo_TIME_PERIOD AS metadata,
        -- All other columns are measurement data columns
        *
    FROM source
),

-- Use UNPIVOT to transform the wide format to long format
unpivoted AS (
    SELECT
        metadata,
        col_name AS date_column,
        CAST(col_value AS STRING) AS measurement_value
    FROM preprocessed
    UNPIVOT(
        col_value FOR col_name IN (
            _2018_01_, _2018_02_, _2018_03_, _2018_04_, _2018_05_, _2018_06_,
            _2018_07_, _2018_08_, _2018_09_, _2018_10_, _2018_11_, _2018_12_,
            _2019_01_, _2019_02_, _2019_03_, _2019_04_, _2019_05_, _2019_06_,
            _2019_07_, _2019_08_, _2019_09_, _2019_10_, _2019_11_, _2019_12_,
            _2020_01_, _2020_02_, _2020_03_, _2020_04_, _2020_05_, _2020_06_,
            _2020_07_, _2020_08_, _2020_09_, _2020_10_, _2020_11_, _2020_12_,
            _2021_01_, _2021_02_, _2021_03_, _2021_04_, _2021_05_, _2021_06_,
            _2021_07_, _2021_08_, _2021_09_, _2021_10_, _2021_11_, _2021_12_,
            _2022_01_, _2022_02_, _2022_03_, _2022_04_, _2022_05_, _2022_06_,
            _2022_07_, _2022_08_, _2022_09_, _2022_10_, _2022_11_, _2022_12_,
            _2023_01_, _2023_02_, _2023_03_, _2023_04_, _2023_05_, _2023_06_,
            _2023_07_, _2023_08_, _2023_09_, _2023_10_, _2023_11_, _2023_12_,
            _2024_01_, _2024_02_, _2024_03_, _2024_04_, _2024_05_, _2024_06_,
            _2024_07_, _2024_08_, _2024_09_, _2024_10_, _2024_11_, _2024_12_,
            _2025_01_, _2025_02_
        )
    )
    -- Filter out zero values that represent missing data
    -- WHERE measurement_value != '0.0'
),

-- Process the date and value after unpivoting
processed_measurements AS (
    SELECT
        metadata,
        -- Clean up column name by removing underscores
        REPLACE(date_column, '_', '') AS clean_date_column,
        -- Keep measurement value as string for now
        measurement_value,
        -- Extract month and year from column name and create a proper date
        DATE(CONCAT(
            SUBSTR(REPLACE(date_column, '_', ''), 1, 4), '-',
            SUBSTR(REPLACE(date_column, '_', ''), 5, 2), '-01'
        )) AS measurement_date,
        -- Create a readable date label (e.g., 'Jan 2018')
        CONCAT(
            FORMAT_DATE('%b', DATE(CONCAT(
                SUBSTR(REPLACE(date_column, '_', ''), 1, 4), '-',
                SUBSTR(REPLACE(date_column, '_', ''), 5, 2), '-01'
            ))),
            ' ',
            SUBSTR(REPLACE(date_column, '_', ''), 1, 4)
        ) AS date_label
    FROM unpivoted
),

metadata_extracted AS (
    SELECT
        -- Extract metadata components
        SPLIT(metadata, ',')[SAFE_OFFSET(0)] AS frequency,
        SPLIT(metadata, ',')[SAFE_OFFSET(1)] AS airpol,
        SPLIT(metadata, ',')[SAFE_OFFSET(2)] AS unit,
        SPLIT(metadata, ',')[SAFE_OFFSET(3)] AS geo_code,
        date_label,
        measurement_date,
        -- Convert measurement value to FLOAT64 here, after unpivoting
        -- Use TRIM to remove any potential whitespace and explicit comparison
        CASE 
            WHEN TRIM(measurement_value) = '0.0' THEN NULL
            ELSE SAFE_CAST(measurement_value AS FLOAT64)
        END AS measurement_value,
        CURRENT_TIMESTAMP() AS load_timestamp
    FROM processed_measurements
),

final AS (

SELECT
    ROW_NUMBER() OVER() AS id,
    frequency,
    airpol,
    unit,
    geo_code,
    date_label,
    measurement_date,
    measurement_value,
    load_timestamp
FROM metadata_extracted
ORDER BY geo_code, measurement_date
)

select * from final;


[0m16:39:40.802309 [debug] [Thread-2 (]: Opening a new connection, currently in state closed
[0m16:39:41.024541 [debug] [Thread-1 (]: Writing runtime sql for node "model.eu_emissions_project.int_dim_capitals"
[0m16:39:41.025157 [debug] [Thread-1 (]: On model.eu_emissions_project.int_dim_capitals: /* {"app": "dbt", "dbt_version": "1.9.3", "profile_name": "big-query", "target_name": "dev", "node_id": "model.eu_emissions_project.int_dim_capitals"} */

  
    

    create or replace table `data-talk-clubs`.`eu_emissions_project_intermediate`.`int_dim_capitals`
      
    
    

    OPTIONS()
    as (
      

-- Reference the capitals seed file
SELECT
    geo_code,
    Capital AS capital_city,
    Country AS country_name
FROM `data-talk-clubs`.`eu_emissions_project`.`capitals`
    );
  
[0m16:39:41.306706 [debug] [Thread-1 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=data-talk-clubs&j=bq:EU:7db78184-00a9-4387-aec0-2f51f278b081&page=queryresults
[0m16:39:41.730709 [debug] [Thread-2 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=data-talk-clubs&j=bq:EU:681193a9-944c-4534-9522-1afdaca53b28&page=queryresults
[0m16:39:42.045768 [debug] [Thread-2 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f1883a08-6ef3-47ab-a13f-8dfc8b97fc25', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1270aaad0>]}
[0m16:39:42.046233 [info ] [Thread-2 (]: 2 of 4 OK created sql view model eu_emissions_project_staging.stg_emissions_data  [[32mCREATE VIEW (0 processed)[0m in 1.31s]
[0m16:39:42.046568 [debug] [Thread-2 (]: Finished running node model.eu_emissions_project.stg_emissions_data
[0m16:39:42.046897 [debug] [Thread-4 (]: Began running node model.eu_emissions_project.int_emissions_cleaned
[0m16:39:42.047152 [info ] [Thread-4 (]: 3 of 4 START sql table model eu_emissions_project_intermediate.int_emissions_cleaned  [RUN]
[0m16:39:42.047407 [debug] [Thread-4 (]: Re-using an available connection from the pool (formerly list_data-talk-clubs_eu_emissions_project_intermediate, now model.eu_emissions_project.int_emissions_cleaned)
[0m16:39:42.047614 [debug] [Thread-4 (]: Began compiling node model.eu_emissions_project.int_emissions_cleaned
[0m16:39:42.049500 [debug] [Thread-4 (]: Writing injected SQL for node "model.eu_emissions_project.int_emissions_cleaned"
[0m16:39:42.049915 [debug] [Thread-4 (]: Began executing node model.eu_emissions_project.int_emissions_cleaned
[0m16:39:42.054514 [debug] [Thread-4 (]: Opening a new connection, currently in state closed
[0m16:39:42.263949 [debug] [Thread-4 (]: Writing runtime sql for node "model.eu_emissions_project.int_emissions_cleaned"
[0m16:39:42.265483 [debug] [Thread-4 (]: On model.eu_emissions_project.int_emissions_cleaned: /* {"app": "dbt", "dbt_version": "1.9.3", "profile_name": "big-query", "target_name": "dev", "node_id": "model.eu_emissions_project.int_emissions_cleaned"} */

  
    

    create or replace table `data-talk-clubs`.`eu_emissions_project_intermediate`.`int_emissions_cleaned`
      
    partition by date_trunc(measurement_date, month)
    cluster by geo_code

    OPTIONS()
    as (
      

WITH emissions_data AS (
    SELECT *
    FROM `data-talk-clubs`.`eu_emissions_project_staging`.`stg_emissions_data`
)

SELECT 
    airpol,
    unit,
    geo_code,
    date_label,
    measurement_date,
    IF(measurement_value = 0.0, NULL, measurement_value) AS measurement_value
FROM emissions_data
    );
  
[0m16:39:42.859049 [debug] [Thread-4 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=data-talk-clubs&j=bq:EU:4da35b1c-61e6-4a98-945e-a058d58d549b&page=queryresults
[0m16:39:43.585392 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f1883a08-6ef3-47ab-a13f-8dfc8b97fc25', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1272bb790>]}
[0m16:39:43.586832 [info ] [Thread-1 (]: 1 of 4 OK created sql table model eu_emissions_project_intermediate.int_dim_capitals  [[32mCREATE TABLE (32.0 rows, 847.0 Bytes processed)[0m in 2.85s]
[0m16:39:43.587335 [debug] [Thread-1 (]: Finished running node model.eu_emissions_project.int_dim_capitals
[0m16:39:49.360744 [debug] [Thread-4 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f1883a08-6ef3-47ab-a13f-8dfc8b97fc25', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x127283e50>]}
[0m16:39:49.361362 [info ] [Thread-4 (]: 3 of 4 OK created sql table model eu_emissions_project_intermediate.int_emissions_cleaned  [[32mCREATE TABLE (2.7k rows, 15.6 KiB processed)[0m in 7.31s]
[0m16:39:49.361778 [debug] [Thread-4 (]: Finished running node model.eu_emissions_project.int_emissions_cleaned
[0m16:39:49.362260 [debug] [Thread-6 (]: Began running node model.eu_emissions_project.emissions_analysis
[0m16:39:49.362628 [info ] [Thread-6 (]: 4 of 4 START sql table model eu_emissions_project_marts.emissions_analysis ..... [RUN]
[0m16:39:49.362958 [debug] [Thread-6 (]: Acquiring new bigquery connection 'model.eu_emissions_project.emissions_analysis'
[0m16:39:49.363172 [debug] [Thread-6 (]: Began compiling node model.eu_emissions_project.emissions_analysis
[0m16:39:49.365832 [debug] [Thread-6 (]: Writing injected SQL for node "model.eu_emissions_project.emissions_analysis"
[0m16:39:49.366355 [debug] [Thread-6 (]: Began executing node model.eu_emissions_project.emissions_analysis
[0m16:39:49.367853 [debug] [Thread-6 (]: Opening a new connection, currently in state init
[0m16:39:49.565874 [debug] [Thread-6 (]: Hard refreshing `data-talk-clubs`.`eu_emissions_project_marts`.`emissions_analysis` because it is not replaceable
[0m16:39:49.659786 [debug] [Thread-6 (]: Writing runtime sql for node "model.eu_emissions_project.emissions_analysis"
[0m16:39:49.660601 [debug] [Thread-6 (]: On model.eu_emissions_project.emissions_analysis: /* {"app": "dbt", "dbt_version": "1.9.3", "profile_name": "big-query", "target_name": "dev", "node_id": "model.eu_emissions_project.emissions_analysis"} */

  
    

    create or replace table `data-talk-clubs`.`eu_emissions_project_marts`.`emissions_analysis`
      
    partition by range_bucket(
            year,
            generate_array(2018, 2025, 1)
        )
    cluster by country_name, unit

    OPTIONS()
    as (
      

WITH emissions_data AS (
    SELECT *
    FROM `data-talk-clubs`.`eu_emissions_project_intermediate`.`int_emissions_cleaned`
),

capitals_data AS (
    SELECT *
    FROM `data-talk-clubs`.`eu_emissions_project_intermediate`.`int_dim_capitals`
),

-- Join emissions data with capitals information
emissions_with_location AS (
    SELECT
        e.*,
        c.capital_city,
        c.country_name
    FROM emissions_data e
    LEFT JOIN capitals_data c
        ON e.geo_code = c.geo_code
),

-- Calculate yearly averages by location
yearly_averages AS (
    SELECT
        capital_city,
        country_name,
        geo_code,
        EXTRACT(YEAR FROM measurement_date) AS year,
        airpol,
        unit,
        AVG(measurement_value) AS avg_value,
        MIN(measurement_value) AS min_value,
        MAX(measurement_value) AS max_value,
        COUNT(*) AS measurement_count
    FROM emissions_with_location
    GROUP BY capital_city, country_name, geo_code, EXTRACT(YEAR FROM measurement_date), airpol, unit
),

-- Calculate year-over-year changes
yoy_changes AS (
    SELECT
        current_year.*,
        current_year.avg_value - prev_year.avg_value AS absolute_change,
        CASE 
            WHEN prev_year.avg_value = 0 OR prev_year.avg_value IS NULL THEN NULL
            ELSE (current_year.avg_value - prev_year.avg_value) / prev_year.avg_value * 100 
        END AS percentage_change
    FROM yearly_averages current_year
    LEFT JOIN yearly_averages prev_year
        ON current_year.geo_code = prev_year.geo_code
        AND current_year.year = prev_year.year + 1
        AND current_year.airpol = prev_year.airpol
        AND current_year.unit = prev_year.unit
),

-- Calculate country rankings by year
country_rankings AS (
    SELECT
        year,
        country_name,
        airpol,
        unit,
        avg_value,
        RANK() OVER(PARTITION BY year, airpol, unit ORDER BY avg_value) AS pollution_rank_asc,
        RANK() OVER(PARTITION BY year, airpol, unit ORDER BY avg_value DESC) AS pollution_rank_desc
    FROM yearly_averages
    WHERE country_name IS NOT NULL
)

-- Final analytical model
SELECT 
    y.capital_city,
    y.country_name,
    y.geo_code,
    y.year,
    y.airpol,
    y.unit,
    y.avg_value,
    y.min_value,
    y.max_value,
    y.measurement_count,
    y.absolute_change,
    y.percentage_change,
    -- Add trend indicators
    CASE
        WHEN y.percentage_change < -5 THEN 'Significant Decrease'
        WHEN y.percentage_change BETWEEN -5 AND -0.5 THEN 'Moderate Decrease'
        WHEN y.percentage_change BETWEEN -0.5 AND 0.5 THEN 'Stable'
        WHEN y.percentage_change BETWEEN 0.5 AND 5 THEN 'Moderate Increase'
        WHEN y.percentage_change > 5 THEN 'Significant Increase'
        ELSE 'Insufficient Data'
    END AS trend_category,
    -- Add country rankings
    r.pollution_rank_asc,
    r.pollution_rank_desc,
    -- Calculate percentile within year (lower percentile = lower pollution)
    PERCENT_RANK() OVER(PARTITION BY y.year, y.unit ORDER BY y.avg_value) AS pollution_percentile,
    -- Add a flag for capitals exceeding EU average (if EU27_2020 data exists)
    CASE
        WHEN eu.avg_value IS NULL THEN NULL
        WHEN y.avg_value > eu.avg_value THEN TRUE
        ELSE FALSE
    END AS exceeds_eu_average,
    -- Calculate how much above/below EU average (in percentage)
    CASE
        WHEN eu.avg_value IS NULL OR eu.avg_value = 0 THEN NULL
        ELSE (y.avg_value - eu.avg_value) / eu.avg_value * 100
    END AS percent_diff_from_eu_avg,
    CURRENT_TIMESTAMP() AS analysis_timestamp
FROM yoy_changes y
LEFT JOIN country_rankings r
    ON y.year = r.year
    AND y.country_name = r.country_name
    AND y.unit = r.unit
LEFT JOIN yearly_averages eu
    ON y.year = eu.year
    AND y.unit = eu.unit
    AND eu.geo_code = 'EU27_2020'
ORDER BY y.country_name, y.year
    );
  
[0m16:39:50.118985 [debug] [Thread-6 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=data-talk-clubs&j=bq:EU:176e698f-270b-4755-8460-3849aefa61e1&page=queryresults
[0m16:39:50.276901 [error] [Thread-6 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=data-talk-clubs&j=bq:EU:176e698f-270b-4755-8460-3849aefa61e1&page=queryresults
[0m16:39:50.286198 [debug] [Thread-6 (]: Database Error in model emissions_analysis (models/marts/emissions_analysis.sql)
  Result of ORDER BY queries cannot be partitioned by field 'year'
  compiled code at target/run/eu_emissions_project/models/marts/emissions_analysis.sql
[0m16:39:50.286662 [debug] [Thread-6 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f1883a08-6ef3-47ab-a13f-8dfc8b97fc25', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x127283d50>]}
[0m16:39:50.287047 [error] [Thread-6 (]: 4 of 4 ERROR creating sql table model eu_emissions_project_marts.emissions_analysis  [[31mERROR[0m in 0.92s]
[0m16:39:50.287358 [debug] [Thread-6 (]: Finished running node model.eu_emissions_project.emissions_analysis
[0m16:39:50.287659 [debug] [Thread-11 ]: Marking all children of 'model.eu_emissions_project.emissions_analysis' to be skipped because of status 'error'.  Reason: Database Error in model emissions_analysis (models/marts/emissions_analysis.sql)
  Result of ORDER BY queries cannot be partitioned by field 'year'
  compiled code at target/run/eu_emissions_project/models/marts/emissions_analysis.sql.
[0m16:39:50.288846 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m16:39:50.290085 [debug] [MainThread]: Connection 'master' was properly closed.
[0m16:39:50.290357 [debug] [MainThread]: Connection 'model.eu_emissions_project.int_dim_capitals' was properly closed.
[0m16:39:50.290536 [debug] [MainThread]: Connection 'model.eu_emissions_project.stg_emissions_data' was properly closed.
[0m16:39:50.290706 [debug] [MainThread]: Connection 'list_data-talk-clubs_eu_emissions_project_staging' was properly closed.
[0m16:39:50.290869 [debug] [MainThread]: Connection 'model.eu_emissions_project.int_emissions_cleaned' was properly closed.
[0m16:39:50.291033 [debug] [MainThread]: Connection 'model.eu_emissions_project.emissions_analysis' was properly closed.
[0m16:39:50.291260 [info ] [MainThread]: 
[0m16:39:50.291458 [info ] [MainThread]: Finished running 3 table models, 1 view model in 0 hours 0 minutes and 11.18 seconds (11.18s).
[0m16:39:50.291986 [debug] [MainThread]: Command end result
[0m16:39:50.305688 [debug] [MainThread]: Wrote artifact WritableManifest to /Users/timbo/Documents/DataTalks/project/src/target/manifest.json
[0m16:39:50.306713 [debug] [MainThread]: Wrote artifact SemanticManifest to /Users/timbo/Documents/DataTalks/project/src/target/semantic_manifest.json
[0m16:39:50.310090 [debug] [MainThread]: Wrote artifact RunExecutionResult to /Users/timbo/Documents/DataTalks/project/src/target/run_results.json
[0m16:39:50.310370 [info ] [MainThread]: 
[0m16:39:50.310613 [info ] [MainThread]: [31mCompleted with 1 error, 0 partial successes, and 0 warnings:[0m
[0m16:39:50.310813 [info ] [MainThread]: 
[0m16:39:50.311037 [error] [MainThread]:   Database Error in model emissions_analysis (models/marts/emissions_analysis.sql)
  Result of ORDER BY queries cannot be partitioned by field 'year'
  compiled code at target/run/eu_emissions_project/models/marts/emissions_analysis.sql
[0m16:39:50.311243 [info ] [MainThread]: 
[0m16:39:50.311444 [info ] [MainThread]: Done. PASS=3 WARN=0 ERROR=1 SKIP=0 TOTAL=4
[0m16:39:50.312949 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": false, "command_wall_clock_time": 12.347744, "process_in_blocks": "0", "process_kernel_time": 0.325354, "process_mem_max_rss": "216072192", "process_out_blocks": "0", "process_user_time": 2.013289}
[0m16:39:50.313280 [debug] [MainThread]: Command `dbt run` failed at 16:39:50.313232 after 12.35 seconds
[0m16:39:50.313616 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107796f50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x102c62050>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107ac9d90>]}
[0m16:39:50.313876 [debug] [MainThread]: Flushing usage events
[0m16:39:50.748843 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m16:40:32.786395 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110f6f390>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110e755d0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110fcbe50>]}


============================== 16:40:32.789347 | 67b48e2a-9d70-40fc-b071-94a0f40d9ad2 ==============================
[0m16:40:32.789347 [info ] [MainThread]: Running with dbt=1.9.3
[0m16:40:32.789738 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'version_check': 'True', 'log_path': '/Users/timbo/Documents/DataTalks/project/src/logs', 'fail_fast': 'False', 'profiles_dir': '/Users/timbo/.dbt', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'empty': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'invocation_command': 'dbt run --full-refresh', 'introspect': 'True', 'target_path': 'None', 'log_format': 'default', 'send_anonymous_usage_stats': 'True'}
[0m16:40:33.391701 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '67b48e2a-9d70-40fc-b071-94a0f40d9ad2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x135580c90>]}
[0m16:40:33.418614 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '67b48e2a-9d70-40fc-b071-94a0f40d9ad2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1068a0090>]}
[0m16:40:33.419049 [info ] [MainThread]: Registered adapter: bigquery=1.9.1
[0m16:40:33.511863 [debug] [MainThread]: checksum: 5671c00892cdbcef29c3b00cc5ba7510c3d18a35c883caeb9ab9ee266dc29c8f, vars: {}, profile: , target: , version: 1.9.3
[0m16:40:33.634184 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m16:40:33.634622 [debug] [MainThread]: Partial parsing: updated file: eu_emissions_project://models/marts/emissions_analysis.sql
[0m16:40:33.793654 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '67b48e2a-9d70-40fc-b071-94a0f40d9ad2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x136cb4f50>]}
[0m16:40:33.835152 [debug] [MainThread]: Wrote artifact WritableManifest to /Users/timbo/Documents/DataTalks/project/src/target/manifest.json
[0m16:40:33.837304 [debug] [MainThread]: Wrote artifact SemanticManifest to /Users/timbo/Documents/DataTalks/project/src/target/semantic_manifest.json
[0m16:40:33.855917 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '67b48e2a-9d70-40fc-b071-94a0f40d9ad2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x136d14090>]}
[0m16:40:33.856281 [info ] [MainThread]: Found 4 models, 1 seed, 1 source, 491 macros
[0m16:40:33.856508 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '67b48e2a-9d70-40fc-b071-94a0f40d9ad2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x135535a50>]}
[0m16:40:33.857490 [info ] [MainThread]: 
[0m16:40:33.857756 [info ] [MainThread]: Concurrency: 8 threads (target='dev')
[0m16:40:33.857972 [info ] [MainThread]: 
[0m16:40:33.858493 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m16:40:33.860790 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_data-talk-clubs'
[0m16:40:33.861120 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_data-talk-clubs'
[0m16:40:33.861367 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:40:33.861584 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_data-talk-clubs'
[0m16:40:33.861789 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:40:33.862059 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:40:34.324626 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_data-talk-clubs, now list_data-talk-clubs_eu_emissions_project_staging)
[0m16:40:34.325050 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_data-talk-clubs, now list_data-talk-clubs_eu_emissions_project_marts)
[0m16:40:34.325236 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m16:40:34.325474 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_data-talk-clubs, now list_data-talk-clubs_eu_emissions_project_intermediate)
[0m16:40:34.325784 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_data-talk-clubs_eu_emissions_project'
[0m16:40:34.325995 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m16:40:34.326324 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m16:40:34.361797 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:40:34.640697 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '67b48e2a-9d70-40fc-b071-94a0f40d9ad2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x136ccb890>]}
[0m16:40:34.641116 [debug] [MainThread]: Opening a new connection, currently in state init
[0m16:40:34.644569 [debug] [Thread-1 (]: Began running node model.eu_emissions_project.int_dim_capitals
[0m16:40:34.644842 [debug] [Thread-2 (]: Began running node model.eu_emissions_project.stg_emissions_data
[0m16:40:34.645193 [info ] [Thread-1 (]: 1 of 4 START sql table model eu_emissions_project_intermediate.int_dim_capitals  [RUN]
[0m16:40:34.645531 [info ] [Thread-2 (]: 2 of 4 START sql view model eu_emissions_project_staging.stg_emissions_data .... [RUN]
[0m16:40:34.645894 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_data-talk-clubs_eu_emissions_project_staging, now model.eu_emissions_project.int_dim_capitals)
[0m16:40:34.646151 [debug] [Thread-2 (]: Re-using an available connection from the pool (formerly list_data-talk-clubs_eu_emissions_project_marts, now model.eu_emissions_project.stg_emissions_data)
[0m16:40:34.646370 [debug] [Thread-1 (]: Began compiling node model.eu_emissions_project.int_dim_capitals
[0m16:40:34.646563 [debug] [Thread-2 (]: Began compiling node model.eu_emissions_project.stg_emissions_data
[0m16:40:34.650553 [debug] [Thread-1 (]: Writing injected SQL for node "model.eu_emissions_project.int_dim_capitals"
[0m16:40:34.652503 [debug] [Thread-2 (]: Writing injected SQL for node "model.eu_emissions_project.stg_emissions_data"
[0m16:40:34.653040 [debug] [Thread-1 (]: Began executing node model.eu_emissions_project.int_dim_capitals
[0m16:40:34.659476 [debug] [Thread-2 (]: Began executing node model.eu_emissions_project.stg_emissions_data
[0m16:40:34.660717 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m16:40:34.674768 [debug] [Thread-2 (]: Writing runtime sql for node "model.eu_emissions_project.stg_emissions_data"
[0m16:40:34.710466 [debug] [Thread-2 (]: On model.eu_emissions_project.stg_emissions_data: /* {"app": "dbt", "dbt_version": "1.9.3", "profile_name": "big-query", "target_name": "dev", "node_id": "model.eu_emissions_project.stg_emissions_data"} */


  create or replace view `data-talk-clubs`.`eu_emissions_project_staging`.`stg_emissions_data`
  OPTIONS()
  as 

WITH source AS (
    SELECT 
        *
    FROM `data-talk-clubs`.`eu_emissions_project`.`nitrogen_dioxide_data`
),

-- First, prepare the data by converting columns to the right format for unpivoting
preprocessed AS (
    SELECT
        freq_airpol_unit_geo_TIME_PERIOD AS metadata,
        -- All other columns are measurement data columns
        *
    FROM source
),

-- Use UNPIVOT to transform the wide format to long format
unpivoted AS (
    SELECT
        metadata,
        col_name AS date_column,
        CAST(col_value AS STRING) AS measurement_value
    FROM preprocessed
    UNPIVOT(
        col_value FOR col_name IN (
            _2018_01_, _2018_02_, _2018_03_, _2018_04_, _2018_05_, _2018_06_,
            _2018_07_, _2018_08_, _2018_09_, _2018_10_, _2018_11_, _2018_12_,
            _2019_01_, _2019_02_, _2019_03_, _2019_04_, _2019_05_, _2019_06_,
            _2019_07_, _2019_08_, _2019_09_, _2019_10_, _2019_11_, _2019_12_,
            _2020_01_, _2020_02_, _2020_03_, _2020_04_, _2020_05_, _2020_06_,
            _2020_07_, _2020_08_, _2020_09_, _2020_10_, _2020_11_, _2020_12_,
            _2021_01_, _2021_02_, _2021_03_, _2021_04_, _2021_05_, _2021_06_,
            _2021_07_, _2021_08_, _2021_09_, _2021_10_, _2021_11_, _2021_12_,
            _2022_01_, _2022_02_, _2022_03_, _2022_04_, _2022_05_, _2022_06_,
            _2022_07_, _2022_08_, _2022_09_, _2022_10_, _2022_11_, _2022_12_,
            _2023_01_, _2023_02_, _2023_03_, _2023_04_, _2023_05_, _2023_06_,
            _2023_07_, _2023_08_, _2023_09_, _2023_10_, _2023_11_, _2023_12_,
            _2024_01_, _2024_02_, _2024_03_, _2024_04_, _2024_05_, _2024_06_,
            _2024_07_, _2024_08_, _2024_09_, _2024_10_, _2024_11_, _2024_12_,
            _2025_01_, _2025_02_
        )
    )
    -- Filter out zero values that represent missing data
    -- WHERE measurement_value != '0.0'
),

-- Process the date and value after unpivoting
processed_measurements AS (
    SELECT
        metadata,
        -- Clean up column name by removing underscores
        REPLACE(date_column, '_', '') AS clean_date_column,
        -- Keep measurement value as string for now
        measurement_value,
        -- Extract month and year from column name and create a proper date
        DATE(CONCAT(
            SUBSTR(REPLACE(date_column, '_', ''), 1, 4), '-',
            SUBSTR(REPLACE(date_column, '_', ''), 5, 2), '-01'
        )) AS measurement_date,
        -- Create a readable date label (e.g., 'Jan 2018')
        CONCAT(
            FORMAT_DATE('%b', DATE(CONCAT(
                SUBSTR(REPLACE(date_column, '_', ''), 1, 4), '-',
                SUBSTR(REPLACE(date_column, '_', ''), 5, 2), '-01'
            ))),
            ' ',
            SUBSTR(REPLACE(date_column, '_', ''), 1, 4)
        ) AS date_label
    FROM unpivoted
),

metadata_extracted AS (
    SELECT
        -- Extract metadata components
        SPLIT(metadata, ',')[SAFE_OFFSET(0)] AS frequency,
        SPLIT(metadata, ',')[SAFE_OFFSET(1)] AS airpol,
        SPLIT(metadata, ',')[SAFE_OFFSET(2)] AS unit,
        SPLIT(metadata, ',')[SAFE_OFFSET(3)] AS geo_code,
        date_label,
        measurement_date,
        -- Convert measurement value to FLOAT64 here, after unpivoting
        -- Use TRIM to remove any potential whitespace and explicit comparison
        CASE 
            WHEN TRIM(measurement_value) = '0.0' THEN NULL
            ELSE SAFE_CAST(measurement_value AS FLOAT64)
        END AS measurement_value,
        CURRENT_TIMESTAMP() AS load_timestamp
    FROM processed_measurements
),

final AS (

SELECT
    ROW_NUMBER() OVER() AS id,
    frequency,
    airpol,
    unit,
    geo_code,
    date_label,
    measurement_date,
    measurement_value,
    load_timestamp
FROM metadata_extracted
ORDER BY geo_code, measurement_date
)

select * from final;


[0m16:40:34.711132 [debug] [Thread-2 (]: Opening a new connection, currently in state closed
[0m16:40:34.934667 [debug] [Thread-1 (]: Writing runtime sql for node "model.eu_emissions_project.int_dim_capitals"
[0m16:40:34.935398 [debug] [Thread-1 (]: On model.eu_emissions_project.int_dim_capitals: /* {"app": "dbt", "dbt_version": "1.9.3", "profile_name": "big-query", "target_name": "dev", "node_id": "model.eu_emissions_project.int_dim_capitals"} */

  
    

    create or replace table `data-talk-clubs`.`eu_emissions_project_intermediate`.`int_dim_capitals`
      
    
    

    OPTIONS()
    as (
      

-- Reference the capitals seed file
SELECT
    geo_code,
    Capital AS capital_city,
    Country AS country_name
FROM `data-talk-clubs`.`eu_emissions_project`.`capitals`
    );
  
[0m16:40:35.183153 [debug] [Thread-1 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=data-talk-clubs&j=bq:EU:5ae4f451-a69e-4b77-b2a5-05342149eb61&page=queryresults
[0m16:40:35.221918 [debug] [Thread-2 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=data-talk-clubs&j=bq:EU:ce72ac87-7969-4d19-92e5-a930fcad49b9&page=queryresults
[0m16:40:35.505863 [debug] [Thread-2 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '67b48e2a-9d70-40fc-b071-94a0f40d9ad2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x136fc6710>]}
[0m16:40:35.506394 [info ] [Thread-2 (]: 2 of 4 OK created sql view model eu_emissions_project_staging.stg_emissions_data  [[32mCREATE VIEW (0 processed)[0m in 0.86s]
[0m16:40:35.506829 [debug] [Thread-2 (]: Finished running node model.eu_emissions_project.stg_emissions_data
[0m16:40:35.507242 [debug] [Thread-4 (]: Began running node model.eu_emissions_project.int_emissions_cleaned
[0m16:40:35.507524 [info ] [Thread-4 (]: 3 of 4 START sql table model eu_emissions_project_intermediate.int_emissions_cleaned  [RUN]
[0m16:40:35.507777 [debug] [Thread-4 (]: Re-using an available connection from the pool (formerly list_data-talk-clubs_eu_emissions_project, now model.eu_emissions_project.int_emissions_cleaned)
[0m16:40:35.507985 [debug] [Thread-4 (]: Began compiling node model.eu_emissions_project.int_emissions_cleaned
[0m16:40:35.509837 [debug] [Thread-4 (]: Writing injected SQL for node "model.eu_emissions_project.int_emissions_cleaned"
[0m16:40:35.510228 [debug] [Thread-4 (]: Began executing node model.eu_emissions_project.int_emissions_cleaned
[0m16:40:35.514595 [debug] [Thread-4 (]: Opening a new connection, currently in state closed
[0m16:40:35.703267 [debug] [Thread-4 (]: Writing runtime sql for node "model.eu_emissions_project.int_emissions_cleaned"
[0m16:40:35.703927 [debug] [Thread-4 (]: On model.eu_emissions_project.int_emissions_cleaned: /* {"app": "dbt", "dbt_version": "1.9.3", "profile_name": "big-query", "target_name": "dev", "node_id": "model.eu_emissions_project.int_emissions_cleaned"} */

  
    

    create or replace table `data-talk-clubs`.`eu_emissions_project_intermediate`.`int_emissions_cleaned`
      
    partition by date_trunc(measurement_date, month)
    cluster by geo_code

    OPTIONS()
    as (
      

WITH emissions_data AS (
    SELECT *
    FROM `data-talk-clubs`.`eu_emissions_project_staging`.`stg_emissions_data`
)

SELECT 
    airpol,
    unit,
    geo_code,
    date_label,
    measurement_date,
    IF(measurement_value = 0.0, NULL, measurement_value) AS measurement_value
FROM emissions_data
    );
  
[0m16:40:36.512510 [debug] [Thread-4 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=data-talk-clubs&j=bq:EU:353a3217-4b1b-40d4-b092-30cfd947b1b7&page=queryresults
[0m16:40:37.200709 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '67b48e2a-9d70-40fc-b071-94a0f40d9ad2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x136ecf150>]}
[0m16:40:37.202470 [info ] [Thread-1 (]: 1 of 4 OK created sql table model eu_emissions_project_intermediate.int_dim_capitals  [[32mCREATE TABLE (32.0 rows, 847.0 Bytes processed)[0m in 2.55s]
[0m16:40:37.202836 [debug] [Thread-1 (]: Finished running node model.eu_emissions_project.int_dim_capitals
[0m16:40:42.721217 [debug] [Thread-4 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '67b48e2a-9d70-40fc-b071-94a0f40d9ad2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x136edf4d0>]}
[0m16:40:42.721836 [info ] [Thread-4 (]: 3 of 4 OK created sql table model eu_emissions_project_intermediate.int_emissions_cleaned  [[32mCREATE TABLE (2.7k rows, 15.6 KiB processed)[0m in 7.21s]
[0m16:40:42.722180 [debug] [Thread-4 (]: Finished running node model.eu_emissions_project.int_emissions_cleaned
[0m16:40:42.722609 [debug] [Thread-6 (]: Began running node model.eu_emissions_project.emissions_analysis
[0m16:40:42.723052 [info ] [Thread-6 (]: 4 of 4 START sql table model eu_emissions_project_marts.emissions_analysis ..... [RUN]
[0m16:40:42.723436 [debug] [Thread-6 (]: Acquiring new bigquery connection 'model.eu_emissions_project.emissions_analysis'
[0m16:40:42.723679 [debug] [Thread-6 (]: Began compiling node model.eu_emissions_project.emissions_analysis
[0m16:40:42.726229 [debug] [Thread-6 (]: Writing injected SQL for node "model.eu_emissions_project.emissions_analysis"
[0m16:40:42.726678 [debug] [Thread-6 (]: Began executing node model.eu_emissions_project.emissions_analysis
[0m16:40:42.728515 [debug] [Thread-6 (]: Writing runtime sql for node "model.eu_emissions_project.emissions_analysis"
[0m16:40:42.729128 [debug] [Thread-6 (]: On model.eu_emissions_project.emissions_analysis: /* {"app": "dbt", "dbt_version": "1.9.3", "profile_name": "big-query", "target_name": "dev", "node_id": "model.eu_emissions_project.emissions_analysis"} */

  
    

    create or replace table `data-talk-clubs`.`eu_emissions_project_marts`.`emissions_analysis`
      
    partition by range_bucket(
            year,
            generate_array(2018, 2025, 1)
        )
    cluster by country_name, unit

    OPTIONS()
    as (
      

WITH emissions_data AS (
    SELECT *
    FROM `data-talk-clubs`.`eu_emissions_project_intermediate`.`int_emissions_cleaned`
),

capitals_data AS (
    SELECT *
    FROM `data-talk-clubs`.`eu_emissions_project_intermediate`.`int_dim_capitals`
),

-- Join emissions data with capitals information
emissions_with_location AS (
    SELECT
        e.*,
        c.capital_city,
        c.country_name
    FROM emissions_data e
    LEFT JOIN capitals_data c
        ON e.geo_code = c.geo_code
),

-- Calculate yearly averages by location
yearly_averages AS (
    SELECT
        capital_city,
        country_name,
        geo_code,
        EXTRACT(YEAR FROM measurement_date) AS year,
        airpol,
        unit,
        AVG(measurement_value) AS avg_value,
        MIN(measurement_value) AS min_value,
        MAX(measurement_value) AS max_value,
        COUNT(*) AS measurement_count
    FROM emissions_with_location
    GROUP BY capital_city, country_name, geo_code, EXTRACT(YEAR FROM measurement_date), airpol, unit
),

-- Calculate year-over-year changes
yoy_changes AS (
    SELECT
        current_year.*,
        current_year.avg_value - prev_year.avg_value AS absolute_change,
        CASE 
            WHEN prev_year.avg_value = 0 OR prev_year.avg_value IS NULL THEN NULL
            ELSE (current_year.avg_value - prev_year.avg_value) / prev_year.avg_value * 100 
        END AS percentage_change
    FROM yearly_averages current_year
    LEFT JOIN yearly_averages prev_year
        ON current_year.geo_code = prev_year.geo_code
        AND current_year.year = prev_year.year + 1
        AND current_year.airpol = prev_year.airpol
        AND current_year.unit = prev_year.unit
),

-- Calculate country rankings by year
country_rankings AS (
    SELECT
        year,
        country_name,
        airpol,
        unit,
        avg_value,
        RANK() OVER(PARTITION BY year, airpol, unit ORDER BY avg_value) AS pollution_rank_asc,
        RANK() OVER(PARTITION BY year, airpol, unit ORDER BY avg_value DESC) AS pollution_rank_desc
    FROM yearly_averages
    WHERE country_name IS NOT NULL
)

-- Final analytical model
SELECT 
    y.capital_city,
    y.country_name,
    y.geo_code,
    y.year,
    y.airpol,
    y.unit,
    y.avg_value,
    y.min_value,
    y.max_value,
    y.measurement_count,
    y.absolute_change,
    y.percentage_change,
    -- Add trend indicators
    CASE
        WHEN y.percentage_change < -5 THEN 'Significant Decrease'
        WHEN y.percentage_change BETWEEN -5 AND -0.5 THEN 'Moderate Decrease'
        WHEN y.percentage_change BETWEEN -0.5 AND 0.5 THEN 'Stable'
        WHEN y.percentage_change BETWEEN 0.5 AND 5 THEN 'Moderate Increase'
        WHEN y.percentage_change > 5 THEN 'Significant Increase'
        ELSE 'Insufficient Data'
    END AS trend_category,
    -- Add country rankings
    r.pollution_rank_asc,
    r.pollution_rank_desc,
    -- Calculate percentile within year (lower percentile = lower pollution)
    PERCENT_RANK() OVER(PARTITION BY y.year, y.unit ORDER BY y.avg_value) AS pollution_percentile,
    -- Add a flag for capitals exceeding EU average (if EU27_2020 data exists)
    CASE
        WHEN eu.avg_value IS NULL THEN NULL
        WHEN y.avg_value > eu.avg_value THEN TRUE
        ELSE FALSE
    END AS exceeds_eu_average,
    -- Calculate how much above/below EU average (in percentage)
    CASE
        WHEN eu.avg_value IS NULL OR eu.avg_value = 0 THEN NULL
        ELSE (y.avg_value - eu.avg_value) / eu.avg_value * 100
    END AS percent_diff_from_eu_avg,
    CURRENT_TIMESTAMP() AS analysis_timestamp
FROM yoy_changes y
LEFT JOIN country_rankings r
    ON y.year = r.year
    AND y.country_name = r.country_name
    AND y.unit = r.unit
LEFT JOIN yearly_averages eu
    ON y.year = eu.year
    AND y.unit = eu.unit
    AND eu.geo_code = 'EU27_2020'
    );
  
[0m16:40:42.729509 [debug] [Thread-6 (]: Opening a new connection, currently in state init
[0m16:40:43.245958 [debug] [Thread-6 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=data-talk-clubs&j=bq:EU:c3f29836-b170-4b3c-9cd3-b6e2dd75136e&page=queryresults
[0m16:40:47.097126 [debug] [Thread-6 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '67b48e2a-9d70-40fc-b071-94a0f40d9ad2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1373dfa90>]}
[0m16:40:47.097736 [info ] [Thread-6 (]: 4 of 4 OK created sql table model eu_emissions_project_marts.emissions_analysis  [[32mCREATE TABLE (248.0 rows, 97.2 KiB processed)[0m in 4.37s]
[0m16:40:47.098152 [debug] [Thread-6 (]: Finished running node model.eu_emissions_project.emissions_analysis
[0m16:40:47.099167 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m16:40:47.100115 [debug] [MainThread]: Connection 'master' was properly closed.
[0m16:40:47.100308 [debug] [MainThread]: Connection 'model.eu_emissions_project.int_dim_capitals' was properly closed.
[0m16:40:47.100476 [debug] [MainThread]: Connection 'model.eu_emissions_project.stg_emissions_data' was properly closed.
[0m16:40:47.100636 [debug] [MainThread]: Connection 'list_data-talk-clubs_eu_emissions_project_intermediate' was properly closed.
[0m16:40:47.100792 [debug] [MainThread]: Connection 'model.eu_emissions_project.int_emissions_cleaned' was properly closed.
[0m16:40:47.100947 [debug] [MainThread]: Connection 'model.eu_emissions_project.emissions_analysis' was properly closed.
[0m16:40:47.101162 [info ] [MainThread]: 
[0m16:40:47.101351 [info ] [MainThread]: Finished running 3 table models, 1 view model in 0 hours 0 minutes and 13.24 seconds (13.24s).
[0m16:40:47.101855 [debug] [MainThread]: Command end result
[0m16:40:47.115137 [debug] [MainThread]: Wrote artifact WritableManifest to /Users/timbo/Documents/DataTalks/project/src/target/manifest.json
[0m16:40:47.116440 [debug] [MainThread]: Wrote artifact SemanticManifest to /Users/timbo/Documents/DataTalks/project/src/target/semantic_manifest.json
[0m16:40:47.119332 [debug] [MainThread]: Wrote artifact RunExecutionResult to /Users/timbo/Documents/DataTalks/project/src/target/run_results.json
[0m16:40:47.119542 [info ] [MainThread]: 
[0m16:40:47.119785 [info ] [MainThread]: [32mCompleted successfully[0m
[0m16:40:47.120083 [info ] [MainThread]: 
[0m16:40:47.120297 [info ] [MainThread]: Done. PASS=4 WARN=0 ERROR=0 SKIP=0 TOTAL=4
[0m16:40:47.122047 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": true, "command_wall_clock_time": 14.373028, "process_in_blocks": "0", "process_kernel_time": 0.335055, "process_mem_max_rss": "215384064", "process_out_blocks": "0", "process_user_time": 2.019621}
[0m16:40:47.122405 [debug] [MainThread]: Command `dbt run` succeeded at 16:40:47.122348 after 14.37 seconds
[0m16:40:47.122686 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110fc3dd0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x102e46110>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110c7d510>]}
[0m16:40:47.122970 [debug] [MainThread]: Flushing usage events
[0m16:40:47.552976 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m11:58:37.792376 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108879e90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1088d6dd0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1088d7f90>]}


============================== 11:58:37.795273 | f3329082-d50f-49fb-b30b-189fa4c870bb ==============================
[0m11:58:37.795273 [info ] [MainThread]: Running with dbt=1.9.3
[0m11:58:37.795644 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': '/Users/timbo/.dbt', 'debug': 'False', 'version_check': 'True', 'log_path': '/Users/timbo/Documents/DataTalks/project/src/logs', 'fail_fast': 'False', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'empty': 'False', 'log_format': 'default', 'static_parser': 'True', 'invocation_command': 'dbt run', 'introspect': 'True', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m11:58:40.855818 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'f3329082-d50f-49fb-b30b-189fa4c870bb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107803090>]}
[0m11:58:40.880504 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'f3329082-d50f-49fb-b30b-189fa4c870bb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109091b50>]}
[0m11:58:40.880871 [info ] [MainThread]: Registered adapter: bigquery=1.9.1
[0m11:58:40.984664 [debug] [MainThread]: checksum: 5671c00892cdbcef29c3b00cc5ba7510c3d18a35c883caeb9ab9ee266dc29c8f, vars: {}, profile: , target: , version: 1.9.3
[0m11:58:41.096570 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 1 files added, 1 files changed.
[0m11:58:41.096964 [debug] [MainThread]: Partial parsing: added file: eu_emissions_project://models/marts/emissions_analysis_monthly.sql
[0m11:58:41.097243 [debug] [MainThread]: Partial parsing: updated file: eu_emissions_project://models/marts/schema.yml
[0m11:58:41.244237 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'f3329082-d50f-49fb-b30b-189fa4c870bb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11c1d6210>]}
[0m11:58:41.282154 [debug] [MainThread]: Wrote artifact WritableManifest to /Users/timbo/Documents/DataTalks/project/src/target/manifest.json
[0m11:58:41.284258 [debug] [MainThread]: Wrote artifact SemanticManifest to /Users/timbo/Documents/DataTalks/project/src/target/semantic_manifest.json
[0m11:58:41.295848 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'f3329082-d50f-49fb-b30b-189fa4c870bb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11c3e3390>]}
[0m11:58:41.296153 [info ] [MainThread]: Found 5 models, 1 seed, 1 source, 491 macros
[0m11:58:41.296367 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'f3329082-d50f-49fb-b30b-189fa4c870bb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11c71a650>]}
[0m11:58:41.297248 [info ] [MainThread]: 
[0m11:58:41.297455 [info ] [MainThread]: Concurrency: 8 threads (target='dev')
[0m11:58:41.297628 [info ] [MainThread]: 
[0m11:58:41.297899 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m11:58:41.300038 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_data-talk-clubs'
[0m11:58:41.300325 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_data-talk-clubs'
[0m11:58:41.300565 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m11:58:41.300786 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_data-talk-clubs'
[0m11:58:41.300991 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m11:58:41.301212 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m11:58:41.967745 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_data-talk-clubs, now list_data-talk-clubs_eu_emissions_project)
[0m11:58:41.968173 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_data-talk-clubs, now list_data-talk-clubs_eu_emissions_project_marts)
[0m11:58:41.968459 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_data-talk-clubs, now list_data-talk-clubs_eu_emissions_project_staging)
[0m11:58:41.968780 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_data-talk-clubs_eu_emissions_project_intermediate'
[0m11:58:41.968964 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m11:58:41.969166 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m11:58:41.969370 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m11:58:41.969607 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m11:58:42.313819 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'f3329082-d50f-49fb-b30b-189fa4c870bb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11bbb0b50>]}
[0m11:58:42.314691 [debug] [MainThread]: Opening a new connection, currently in state init
[0m11:58:42.320785 [debug] [Thread-1 (]: Began running node model.eu_emissions_project.int_dim_capitals
[0m11:58:42.321249 [debug] [Thread-2 (]: Began running node model.eu_emissions_project.stg_emissions_data
[0m11:58:42.321817 [info ] [Thread-1 (]: 1 of 5 START sql table model eu_emissions_project_intermediate.int_dim_capitals  [RUN]
[0m11:58:42.322251 [info ] [Thread-2 (]: 2 of 5 START sql view model eu_emissions_project_staging.stg_emissions_data .... [RUN]
[0m11:58:42.322694 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_data-talk-clubs_eu_emissions_project, now model.eu_emissions_project.int_dim_capitals)
[0m11:58:42.323030 [debug] [Thread-2 (]: Re-using an available connection from the pool (formerly list_data-talk-clubs_eu_emissions_project_marts, now model.eu_emissions_project.stg_emissions_data)
[0m11:58:42.323350 [debug] [Thread-1 (]: Began compiling node model.eu_emissions_project.int_dim_capitals
[0m11:58:42.323643 [debug] [Thread-2 (]: Began compiling node model.eu_emissions_project.stg_emissions_data
[0m11:58:42.330725 [debug] [Thread-1 (]: Writing injected SQL for node "model.eu_emissions_project.int_dim_capitals"
[0m11:58:42.333375 [debug] [Thread-2 (]: Writing injected SQL for node "model.eu_emissions_project.stg_emissions_data"
[0m11:58:42.334169 [debug] [Thread-1 (]: Began executing node model.eu_emissions_project.int_dim_capitals
[0m11:58:42.343842 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m11:58:42.344248 [debug] [Thread-2 (]: Began executing node model.eu_emissions_project.stg_emissions_data
[0m11:58:42.361047 [debug] [Thread-2 (]: Writing runtime sql for node "model.eu_emissions_project.stg_emissions_data"
[0m11:58:42.397176 [debug] [Thread-2 (]: On model.eu_emissions_project.stg_emissions_data: /* {"app": "dbt", "dbt_version": "1.9.3", "profile_name": "big-query", "target_name": "dev", "node_id": "model.eu_emissions_project.stg_emissions_data"} */


  create or replace view `data-talk-clubs`.`eu_emissions_project_staging`.`stg_emissions_data`
  OPTIONS()
  as 

WITH source AS (
    SELECT 
        *
    FROM `data-talk-clubs`.`eu_emissions_project`.`nitrogen_dioxide_data`
),

-- First, prepare the data by converting columns to the right format for unpivoting
preprocessed AS (
    SELECT
        freq_airpol_unit_geo_TIME_PERIOD AS metadata,
        -- All other columns are measurement data columns
        *
    FROM source
),

-- Use UNPIVOT to transform the wide format to long format
unpivoted AS (
    SELECT
        metadata,
        col_name AS date_column,
        CAST(col_value AS STRING) AS measurement_value
    FROM preprocessed
    UNPIVOT(
        col_value FOR col_name IN (
            _2018_01_, _2018_02_, _2018_03_, _2018_04_, _2018_05_, _2018_06_,
            _2018_07_, _2018_08_, _2018_09_, _2018_10_, _2018_11_, _2018_12_,
            _2019_01_, _2019_02_, _2019_03_, _2019_04_, _2019_05_, _2019_06_,
            _2019_07_, _2019_08_, _2019_09_, _2019_10_, _2019_11_, _2019_12_,
            _2020_01_, _2020_02_, _2020_03_, _2020_04_, _2020_05_, _2020_06_,
            _2020_07_, _2020_08_, _2020_09_, _2020_10_, _2020_11_, _2020_12_,
            _2021_01_, _2021_02_, _2021_03_, _2021_04_, _2021_05_, _2021_06_,
            _2021_07_, _2021_08_, _2021_09_, _2021_10_, _2021_11_, _2021_12_,
            _2022_01_, _2022_02_, _2022_03_, _2022_04_, _2022_05_, _2022_06_,
            _2022_07_, _2022_08_, _2022_09_, _2022_10_, _2022_11_, _2022_12_,
            _2023_01_, _2023_02_, _2023_03_, _2023_04_, _2023_05_, _2023_06_,
            _2023_07_, _2023_08_, _2023_09_, _2023_10_, _2023_11_, _2023_12_,
            _2024_01_, _2024_02_, _2024_03_, _2024_04_, _2024_05_, _2024_06_,
            _2024_07_, _2024_08_, _2024_09_, _2024_10_, _2024_11_, _2024_12_,
            _2025_01_, _2025_02_
        )
    )
    -- Filter out zero values that represent missing data
    -- WHERE measurement_value != '0.0'
),

-- Process the date and value after unpivoting
processed_measurements AS (
    SELECT
        metadata,
        -- Clean up column name by removing underscores
        REPLACE(date_column, '_', '') AS clean_date_column,
        -- Keep measurement value as string for now
        measurement_value,
        -- Extract month and year from column name and create a proper date
        DATE(CONCAT(
            SUBSTR(REPLACE(date_column, '_', ''), 1, 4), '-',
            SUBSTR(REPLACE(date_column, '_', ''), 5, 2), '-01'
        )) AS measurement_date,
        -- Create a readable date label (e.g., 'Jan 2018')
        CONCAT(
            FORMAT_DATE('%b', DATE(CONCAT(
                SUBSTR(REPLACE(date_column, '_', ''), 1, 4), '-',
                SUBSTR(REPLACE(date_column, '_', ''), 5, 2), '-01'
            ))),
            ' ',
            SUBSTR(REPLACE(date_column, '_', ''), 1, 4)
        ) AS date_label
    FROM unpivoted
),

metadata_extracted AS (
    SELECT
        -- Extract metadata components
        SPLIT(metadata, ',')[SAFE_OFFSET(0)] AS frequency,
        SPLIT(metadata, ',')[SAFE_OFFSET(1)] AS airpol,
        SPLIT(metadata, ',')[SAFE_OFFSET(2)] AS unit,
        SPLIT(metadata, ',')[SAFE_OFFSET(3)] AS geo_code,
        date_label,
        measurement_date,
        -- Convert measurement value to FLOAT64 here, after unpivoting
        -- Use TRIM to remove any potential whitespace and explicit comparison
        CASE 
            WHEN TRIM(measurement_value) = '0.0' THEN NULL
            ELSE SAFE_CAST(measurement_value AS FLOAT64)
        END AS measurement_value,
        CURRENT_TIMESTAMP() AS load_timestamp
    FROM processed_measurements
),

final AS (

SELECT
    ROW_NUMBER() OVER() AS id,
    frequency,
    airpol,
    unit,
    geo_code,
    date_label,
    measurement_date,
    measurement_value,
    load_timestamp
FROM metadata_extracted
ORDER BY geo_code, measurement_date
)

select * from final;


[0m11:58:42.397612 [debug] [Thread-2 (]: Opening a new connection, currently in state closed
[0m11:58:42.643603 [debug] [Thread-1 (]: Writing runtime sql for node "model.eu_emissions_project.int_dim_capitals"
[0m11:58:42.644704 [debug] [Thread-1 (]: On model.eu_emissions_project.int_dim_capitals: /* {"app": "dbt", "dbt_version": "1.9.3", "profile_name": "big-query", "target_name": "dev", "node_id": "model.eu_emissions_project.int_dim_capitals"} */

  
    

    create or replace table `data-talk-clubs`.`eu_emissions_project_intermediate`.`int_dim_capitals`
      
    
    

    OPTIONS()
    as (
      

-- Reference the capitals seed file
SELECT
    geo_code,
    Capital AS capital_city,
    Country AS country_name
FROM `data-talk-clubs`.`eu_emissions_project`.`capitals`
    );
  
[0m11:58:43.095285 [debug] [Thread-2 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=data-talk-clubs&j=bq:EU:8aba0a5e-1a1f-4c46-9240-6c0dcfd2bcf0&page=queryresults
[0m11:58:43.098927 [debug] [Thread-1 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=data-talk-clubs&j=bq:EU:43b7d792-394b-40a0-809f-337c987f8bc3&page=queryresults
[0m11:58:43.332602 [debug] [Thread-2 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f3329082-d50f-49fb-b30b-189fa4c870bb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11c31b6d0>]}
[0m11:58:43.333069 [info ] [Thread-2 (]: 2 of 5 OK created sql view model eu_emissions_project_staging.stg_emissions_data  [[32mCREATE VIEW (0 processed)[0m in 1.01s]
[0m11:58:43.333498 [debug] [Thread-2 (]: Finished running node model.eu_emissions_project.stg_emissions_data
[0m11:58:43.333854 [debug] [Thread-4 (]: Began running node model.eu_emissions_project.int_emissions_cleaned
[0m11:58:43.334121 [info ] [Thread-4 (]: 3 of 5 START sql table model eu_emissions_project_intermediate.int_emissions_cleaned  [RUN]
[0m11:58:43.334383 [debug] [Thread-4 (]: Re-using an available connection from the pool (formerly list_data-talk-clubs_eu_emissions_project_intermediate, now model.eu_emissions_project.int_emissions_cleaned)
[0m11:58:43.334588 [debug] [Thread-4 (]: Began compiling node model.eu_emissions_project.int_emissions_cleaned
[0m11:58:43.336481 [debug] [Thread-4 (]: Writing injected SQL for node "model.eu_emissions_project.int_emissions_cleaned"
[0m11:58:43.336906 [debug] [Thread-4 (]: Began executing node model.eu_emissions_project.int_emissions_cleaned
[0m11:58:43.341743 [debug] [Thread-4 (]: Opening a new connection, currently in state closed
[0m11:58:43.565989 [debug] [Thread-4 (]: Writing runtime sql for node "model.eu_emissions_project.int_emissions_cleaned"
[0m11:58:43.567378 [debug] [Thread-4 (]: On model.eu_emissions_project.int_emissions_cleaned: /* {"app": "dbt", "dbt_version": "1.9.3", "profile_name": "big-query", "target_name": "dev", "node_id": "model.eu_emissions_project.int_emissions_cleaned"} */

  
    

    create or replace table `data-talk-clubs`.`eu_emissions_project_intermediate`.`int_emissions_cleaned`
      
    partition by date_trunc(measurement_date, month)
    cluster by geo_code

    OPTIONS()
    as (
      

WITH emissions_data AS (
    SELECT *
    FROM `data-talk-clubs`.`eu_emissions_project_staging`.`stg_emissions_data`
)

SELECT 
    airpol,
    unit,
    geo_code,
    date_label,
    measurement_date,
    IF(measurement_value = 0.0, NULL, measurement_value) AS measurement_value
FROM emissions_data
    );
  
[0m11:58:44.246293 [debug] [Thread-4 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=data-talk-clubs&j=bq:EU:2002832b-8fad-4dba-b374-fb620076118b&page=queryresults
[0m11:58:49.425821 [debug] [Thread-4 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f3329082-d50f-49fb-b30b-189fa4c870bb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11d001190>]}
[0m11:58:49.427248 [info ] [Thread-4 (]: 3 of 5 OK created sql table model eu_emissions_project_intermediate.int_emissions_cleaned  [[32mCREATE TABLE (2.7k rows, 15.6 KiB processed)[0m in 6.09s]
[0m11:58:49.428113 [debug] [Thread-4 (]: Finished running node model.eu_emissions_project.int_emissions_cleaned
[0m11:59:06.309906 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f3329082-d50f-49fb-b30b-189fa4c870bb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11d08b010>]}
[0m11:59:06.312689 [info ] [Thread-1 (]: 1 of 5 OK created sql table model eu_emissions_project_intermediate.int_dim_capitals  [[32mCREATE TABLE (32.0 rows, 847.0 Bytes processed)[0m in 23.99s]
[0m11:59:06.313675 [debug] [Thread-1 (]: Finished running node model.eu_emissions_project.int_dim_capitals
[0m11:59:06.314945 [debug] [Thread-6 (]: Began running node model.eu_emissions_project.emissions_analysis
[0m11:59:06.315467 [debug] [Thread-7 (]: Began running node model.eu_emissions_project.emissions_analysis_monthly
[0m11:59:06.316168 [info ] [Thread-6 (]: 4 of 5 START sql table model eu_emissions_project_marts.emissions_analysis ..... [RUN]
[0m11:59:06.316865 [info ] [Thread-7 (]: 5 of 5 START sql table model eu_emissions_project_marts.emissions_analysis_monthly  [RUN]
[0m11:59:06.317593 [debug] [Thread-6 (]: Acquiring new bigquery connection 'model.eu_emissions_project.emissions_analysis'
[0m11:59:06.318208 [debug] [Thread-7 (]: Acquiring new bigquery connection 'model.eu_emissions_project.emissions_analysis_monthly'
[0m11:59:06.318717 [debug] [Thread-6 (]: Began compiling node model.eu_emissions_project.emissions_analysis
[0m11:59:06.319302 [debug] [Thread-7 (]: Began compiling node model.eu_emissions_project.emissions_analysis_monthly
[0m11:59:06.325124 [debug] [Thread-6 (]: Writing injected SQL for node "model.eu_emissions_project.emissions_analysis"
[0m11:59:06.329080 [debug] [Thread-7 (]: Writing injected SQL for node "model.eu_emissions_project.emissions_analysis_monthly"
[0m11:59:06.330288 [debug] [Thread-6 (]: Began executing node model.eu_emissions_project.emissions_analysis
[0m11:59:06.330812 [debug] [Thread-7 (]: Began executing node model.eu_emissions_project.emissions_analysis_monthly
[0m11:59:06.333356 [debug] [Thread-6 (]: Opening a new connection, currently in state init
[0m11:59:06.338665 [debug] [Thread-7 (]: Writing runtime sql for node "model.eu_emissions_project.emissions_analysis_monthly"
[0m11:59:06.340052 [debug] [Thread-7 (]: On model.eu_emissions_project.emissions_analysis_monthly: /* {"app": "dbt", "dbt_version": "1.9.3", "profile_name": "big-query", "target_name": "dev", "node_id": "model.eu_emissions_project.emissions_analysis_monthly"} */

  
    

    create or replace table `data-talk-clubs`.`eu_emissions_project_marts`.`emissions_analysis_monthly`
      
    partition by date_trunc(measurement_date, month)
    cluster by country_name, unit

    OPTIONS()
    as (
      

WITH emissions_data AS (
    SELECT *
    FROM `data-talk-clubs`.`eu_emissions_project_intermediate`.`int_emissions_cleaned`
),

capitals_data AS (
    SELECT *
    FROM `data-talk-clubs`.`eu_emissions_project_intermediate`.`int_dim_capitals`
),

-- Join emissions data with capitals information
emissions_with_location AS (
    SELECT
        e.*,
        c.capital_city,
        c.country_name
    FROM emissions_data e
    LEFT JOIN capitals_data c
        ON e.geo_code = c.geo_code
),

-- Monthly data is already available in the cleaned data
-- No need for additional aggregation by month
monthly_data AS (
    SELECT
        capital_city,
        country_name,
        geo_code,
        measurement_date,
        FORMAT_DATE('%Y-%m', measurement_date) AS year_month,
        EXTRACT(YEAR FROM measurement_date) AS year,
        EXTRACT(MONTH FROM measurement_date) AS month,
        airpol,
        unit,
        measurement_value
    FROM emissions_with_location
),

-- Calculate month-over-month changes
mom_changes AS (
    SELECT
        current_month.*,
        current_month.measurement_value - prev_month.measurement_value AS absolute_change,
        CASE 
            WHEN prev_month.measurement_value = 0 OR prev_month.measurement_value IS NULL THEN NULL
            ELSE (current_month.measurement_value - prev_month.measurement_value) / prev_month.measurement_value * 100 
        END AS percentage_change
    FROM monthly_data current_month
    LEFT JOIN monthly_data prev_month
        ON current_month.geo_code = prev_month.geo_code
        AND DATE_SUB(current_month.measurement_date, INTERVAL 1 MONTH) = prev_month.measurement_date
        AND current_month.airpol = prev_month.airpol
        AND current_month.unit = prev_month.unit
),

-- Calculate country rankings by month
country_rankings AS (
    SELECT
        year_month,
        country_name,
        airpol,
        unit,
        measurement_value,
        RANK() OVER(PARTITION BY year_month, airpol, unit ORDER BY measurement_value) AS pollution_rank_asc,
        RANK() OVER(PARTITION BY year_month, airpol, unit ORDER BY measurement_value DESC) AS pollution_rank_desc
    FROM monthly_data
    WHERE country_name IS NOT NULL
)

-- Final analytical model
SELECT 
    m.capital_city,
    m.country_name,
    m.geo_code,
    m.measurement_date,
    m.year,
    m.month,
    m.year_month,
    m.airpol,
    m.unit,
    m.measurement_value,
    m.absolute_change,
    m.percentage_change,
    -- Add trend indicators
    CASE
        WHEN m.percentage_change < -5 THEN 'Significant Decrease'
        WHEN m.percentage_change BETWEEN -5 AND -0.5 THEN 'Moderate Decrease'
        WHEN m.percentage_change BETWEEN -0.5 AND 0.5 THEN 'Stable'
        WHEN m.percentage_change BETWEEN 0.5 AND 5 THEN 'Moderate Increase'
        WHEN m.percentage_change > 5 THEN 'Significant Increase'
        ELSE 'Insufficient Data'
    END AS trend_category,
    -- Add country rankings
    r.pollution_rank_asc,
    r.pollution_rank_desc,
    -- Calculate percentile within month (lower percentile = lower pollution)
    PERCENT_RANK() OVER(PARTITION BY m.year_month, m.unit ORDER BY m.measurement_value) AS pollution_percentile,
    -- Add a flag for capitals exceeding EU average (if EU27_2020 data exists)
    CASE
        WHEN eu.measurement_value IS NULL THEN NULL
        WHEN m.measurement_value > eu.measurement_value THEN TRUE
        ELSE FALSE
    END AS exceeds_eu_average,
    -- Calculate how much above/below EU average (in percentage)
    CASE
        WHEN eu.measurement_value IS NULL OR eu.measurement_value = 0 THEN NULL
        ELSE (m.measurement_value - eu.measurement_value) / eu.measurement_value * 100
    END AS percent_diff_from_eu_avg,
    CURRENT_TIMESTAMP() AS analysis_timestamp
FROM mom_changes m
LEFT JOIN country_rankings r
    ON m.year_month = r.year_month
    AND m.country_name = r.country_name
    AND m.unit = r.unit
LEFT JOIN monthly_data eu
    ON m.year_month = eu.year_month
    AND m.unit = eu.unit
    AND eu.geo_code = 'EU27_2020'
    );
  
[0m11:59:06.342057 [debug] [Thread-7 (]: Opening a new connection, currently in state init
[0m11:59:06.618175 [debug] [Thread-6 (]: Writing runtime sql for node "model.eu_emissions_project.emissions_analysis"
[0m11:59:06.621292 [debug] [Thread-6 (]: On model.eu_emissions_project.emissions_analysis: /* {"app": "dbt", "dbt_version": "1.9.3", "profile_name": "big-query", "target_name": "dev", "node_id": "model.eu_emissions_project.emissions_analysis"} */

  
    

    create or replace table `data-talk-clubs`.`eu_emissions_project_marts`.`emissions_analysis`
      
    partition by range_bucket(
            year,
            generate_array(2018, 2025, 1)
        )
    cluster by country_name, unit

    OPTIONS()
    as (
      

WITH emissions_data AS (
    SELECT *
    FROM `data-talk-clubs`.`eu_emissions_project_intermediate`.`int_emissions_cleaned`
),

capitals_data AS (
    SELECT *
    FROM `data-talk-clubs`.`eu_emissions_project_intermediate`.`int_dim_capitals`
),

-- Join emissions data with capitals information
emissions_with_location AS (
    SELECT
        e.*,
        c.capital_city,
        c.country_name
    FROM emissions_data e
    LEFT JOIN capitals_data c
        ON e.geo_code = c.geo_code
),

-- Calculate yearly averages by location
yearly_averages AS (
    SELECT
        capital_city,
        country_name,
        geo_code,
        EXTRACT(YEAR FROM measurement_date) AS year,
        airpol,
        unit,
        AVG(measurement_value) AS avg_value,
        MIN(measurement_value) AS min_value,
        MAX(measurement_value) AS max_value,
        COUNT(*) AS measurement_count
    FROM emissions_with_location
    GROUP BY capital_city, country_name, geo_code, EXTRACT(YEAR FROM measurement_date), airpol, unit
),

-- Calculate year-over-year changes
yoy_changes AS (
    SELECT
        current_year.*,
        current_year.avg_value - prev_year.avg_value AS absolute_change,
        CASE 
            WHEN prev_year.avg_value = 0 OR prev_year.avg_value IS NULL THEN NULL
            ELSE (current_year.avg_value - prev_year.avg_value) / prev_year.avg_value * 100 
        END AS percentage_change
    FROM yearly_averages current_year
    LEFT JOIN yearly_averages prev_year
        ON current_year.geo_code = prev_year.geo_code
        AND current_year.year = prev_year.year + 1
        AND current_year.airpol = prev_year.airpol
        AND current_year.unit = prev_year.unit
),

-- Calculate country rankings by year
country_rankings AS (
    SELECT
        year,
        country_name,
        airpol,
        unit,
        avg_value,
        RANK() OVER(PARTITION BY year, airpol, unit ORDER BY avg_value) AS pollution_rank_asc,
        RANK() OVER(PARTITION BY year, airpol, unit ORDER BY avg_value DESC) AS pollution_rank_desc
    FROM yearly_averages
    WHERE country_name IS NOT NULL
)

-- Final analytical model
SELECT 
    y.capital_city,
    y.country_name,
    y.geo_code,
    y.year,
    y.airpol,
    y.unit,
    y.avg_value,
    y.min_value,
    y.max_value,
    y.measurement_count,
    y.absolute_change,
    y.percentage_change,
    -- Add trend indicators
    CASE
        WHEN y.percentage_change < -5 THEN 'Significant Decrease'
        WHEN y.percentage_change BETWEEN -5 AND -0.5 THEN 'Moderate Decrease'
        WHEN y.percentage_change BETWEEN -0.5 AND 0.5 THEN 'Stable'
        WHEN y.percentage_change BETWEEN 0.5 AND 5 THEN 'Moderate Increase'
        WHEN y.percentage_change > 5 THEN 'Significant Increase'
        ELSE 'Insufficient Data'
    END AS trend_category,
    -- Add country rankings
    r.pollution_rank_asc,
    r.pollution_rank_desc,
    -- Calculate percentile within year (lower percentile = lower pollution)
    PERCENT_RANK() OVER(PARTITION BY y.year, y.unit ORDER BY y.avg_value) AS pollution_percentile,
    -- Add a flag for capitals exceeding EU average (if EU27_2020 data exists)
    CASE
        WHEN eu.avg_value IS NULL THEN NULL
        WHEN y.avg_value > eu.avg_value THEN TRUE
        ELSE FALSE
    END AS exceeds_eu_average,
    -- Calculate how much above/below EU average (in percentage)
    CASE
        WHEN eu.avg_value IS NULL OR eu.avg_value = 0 THEN NULL
        ELSE (y.avg_value - eu.avg_value) / eu.avg_value * 100
    END AS percent_diff_from_eu_avg,
    CURRENT_TIMESTAMP() AS analysis_timestamp
FROM yoy_changes y
LEFT JOIN country_rankings r
    ON y.year = r.year
    AND y.country_name = r.country_name
    AND y.unit = r.unit
LEFT JOIN yearly_averages eu
    ON y.year = eu.year
    AND y.unit = eu.unit
    AND eu.geo_code = 'EU27_2020'
    );
  
[0m11:59:06.800074 [debug] [Thread-7 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=data-talk-clubs&j=bq:EU:090c2151-1d98-48cf-84e6-b750a62c999a&page=queryresults
[0m11:59:07.211515 [debug] [Thread-6 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=data-talk-clubs&j=bq:EU:6fe37f71-67c1-4596-9f27-8814c6e66c2e&page=queryresults
[0m11:59:10.770570 [debug] [Thread-6 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f3329082-d50f-49fb-b30b-189fa4c870bb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11d4e67d0>]}
[0m11:59:10.771063 [info ] [Thread-6 (]: 4 of 5 OK created sql table model eu_emissions_project_marts.emissions_analysis  [[32mCREATE TABLE (248.0 rows, 97.2 KiB processed)[0m in 4.45s]
[0m11:59:10.771389 [debug] [Thread-6 (]: Finished running node model.eu_emissions_project.emissions_analysis
[0m11:59:13.845613 [debug] [Thread-7 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f3329082-d50f-49fb-b30b-189fa4c870bb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11d3c4b10>]}
[0m11:59:13.847127 [info ] [Thread-7 (]: 5 of 5 OK created sql table model eu_emissions_project_marts.emissions_analysis_monthly  [[32mCREATE TABLE (2.7k rows, 97.2 KiB processed)[0m in 7.53s]
[0m11:59:13.848024 [debug] [Thread-7 (]: Finished running node model.eu_emissions_project.emissions_analysis_monthly
[0m11:59:13.850261 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m11:59:13.852894 [debug] [MainThread]: Connection 'master' was properly closed.
[0m11:59:13.853390 [debug] [MainThread]: Connection 'model.eu_emissions_project.int_dim_capitals' was properly closed.
[0m11:59:13.853769 [debug] [MainThread]: Connection 'model.eu_emissions_project.stg_emissions_data' was properly closed.
[0m11:59:13.854165 [debug] [MainThread]: Connection 'list_data-talk-clubs_eu_emissions_project_staging' was properly closed.
[0m11:59:13.854554 [debug] [MainThread]: Connection 'model.eu_emissions_project.int_emissions_cleaned' was properly closed.
[0m11:59:13.854942 [debug] [MainThread]: Connection 'model.eu_emissions_project.emissions_analysis' was properly closed.
[0m11:59:13.855327 [debug] [MainThread]: Connection 'model.eu_emissions_project.emissions_analysis_monthly' was properly closed.
[0m11:59:13.855878 [info ] [MainThread]: 
[0m11:59:13.856296 [info ] [MainThread]: Finished running 4 table models, 1 view model in 0 hours 0 minutes and 32.56 seconds (32.56s).
[0m11:59:13.857557 [debug] [MainThread]: Command end result
[0m11:59:13.881574 [debug] [MainThread]: Wrote artifact WritableManifest to /Users/timbo/Documents/DataTalks/project/src/target/manifest.json
[0m11:59:13.883330 [debug] [MainThread]: Wrote artifact SemanticManifest to /Users/timbo/Documents/DataTalks/project/src/target/semantic_manifest.json
[0m11:59:13.887533 [debug] [MainThread]: Wrote artifact RunExecutionResult to /Users/timbo/Documents/DataTalks/project/src/target/run_results.json
[0m11:59:13.887892 [info ] [MainThread]: 
[0m11:59:13.888195 [info ] [MainThread]: [32mCompleted successfully[0m
[0m11:59:13.888421 [info ] [MainThread]: 
[0m11:59:13.888743 [info ] [MainThread]: Done. PASS=5 WARN=0 ERROR=0 SKIP=0 TOTAL=5
[0m11:59:13.909038 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": true, "command_wall_clock_time": 36.151196, "process_in_blocks": "0", "process_kernel_time": 0.383242, "process_mem_max_rss": "213860352", "process_out_blocks": "0", "process_user_time": 2.089623}
[0m11:59:13.909495 [debug] [MainThread]: Command `dbt run` succeeded at 11:59:13.909438 after 36.15 seconds
[0m11:59:13.909794 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104badf90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104a403d0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104a50850>]}
[0m11:59:13.910073 [debug] [MainThread]: Flushing usage events
[0m11:59:14.482670 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m12:30:38.949088 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x119e6c9d0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x119ecb450>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x119ecbf90>]}


============================== 12:30:38.952053 | fd7370ef-4a91-42c3-abff-433aff9f60aa ==============================
[0m12:30:38.952053 [info ] [MainThread]: Running with dbt=1.9.3
[0m12:30:38.952427 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'version_check': 'True', 'fail_fast': 'False', 'log_path': '/Users/timbo/Documents/DataTalks/project/src/logs', 'debug': 'False', 'profiles_dir': '/Users/timbo/.dbt', 'use_colors': 'True', 'use_experimental_parser': 'False', 'empty': 'False', 'quiet': 'False', 'no_print': 'None', 'log_format': 'default', 'static_parser': 'True', 'introspect': 'True', 'invocation_command': 'dbt run', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m12:30:39.702542 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'fd7370ef-4a91-42c3-abff-433aff9f60aa', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11f21f450>]}
[0m12:30:39.726592 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'fd7370ef-4a91-42c3-abff-433aff9f60aa', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x106560890>]}
[0m12:30:39.726957 [info ] [MainThread]: Registered adapter: bigquery=1.9.1
[0m12:30:39.819823 [debug] [MainThread]: checksum: 5671c00892cdbcef29c3b00cc5ba7510c3d18a35c883caeb9ab9ee266dc29c8f, vars: {}, profile: , target: , version: 1.9.3
[0m12:30:39.934841 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m12:30:39.935253 [debug] [MainThread]: Partial parsing: updated file: eu_emissions_project://models/marts/emissions_analysis.sql
[0m12:30:40.082168 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'fd7370ef-4a91-42c3-abff-433aff9f60aa', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x12e72a7d0>]}
[0m12:30:40.120495 [debug] [MainThread]: Wrote artifact WritableManifest to /Users/timbo/Documents/DataTalks/project/src/target/manifest.json
[0m12:30:40.122369 [debug] [MainThread]: Wrote artifact SemanticManifest to /Users/timbo/Documents/DataTalks/project/src/target/semantic_manifest.json
[0m12:30:40.134842 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'fd7370ef-4a91-42c3-abff-433aff9f60aa', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x12f2f1390>]}
[0m12:30:40.135177 [info ] [MainThread]: Found 5 models, 1 seed, 1 source, 491 macros
[0m12:30:40.135391 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'fd7370ef-4a91-42c3-abff-433aff9f60aa', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x12f0da290>]}
[0m12:30:40.136289 [info ] [MainThread]: 
[0m12:30:40.136500 [info ] [MainThread]: Concurrency: 8 threads (target='dev')
[0m12:30:40.136661 [info ] [MainThread]: 
[0m12:30:40.136925 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m12:30:40.139013 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_data-talk-clubs'
[0m12:30:40.139430 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_data-talk-clubs'
[0m12:30:40.139653 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m12:30:40.139935 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_data-talk-clubs'
[0m12:30:40.140154 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m12:30:40.140399 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m12:30:40.843941 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_data-talk-clubs, now list_data-talk-clubs_eu_emissions_project_marts)
[0m12:30:40.844995 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_data-talk-clubs, now list_data-talk-clubs_eu_emissions_project)
[0m12:30:40.845849 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m12:30:40.846488 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_data-talk-clubs, now list_data-talk-clubs_eu_emissions_project_staging)
[0m12:30:40.847276 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_data-talk-clubs_eu_emissions_project_intermediate'
[0m12:30:40.847817 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m12:30:40.848409 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m12:30:40.848922 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m12:30:41.208847 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'fd7370ef-4a91-42c3-abff-433aff9f60aa', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x119e8b750>]}
[0m12:30:41.209802 [debug] [MainThread]: Opening a new connection, currently in state init
[0m12:30:41.215592 [debug] [Thread-1 (]: Began running node model.eu_emissions_project.int_dim_capitals
[0m12:30:41.216038 [debug] [Thread-2 (]: Began running node model.eu_emissions_project.stg_emissions_data
[0m12:30:41.216631 [info ] [Thread-1 (]: 1 of 5 START sql table model eu_emissions_project_intermediate.int_dim_capitals  [RUN]
[0m12:30:41.217130 [info ] [Thread-2 (]: 2 of 5 START sql view model eu_emissions_project_staging.stg_emissions_data .... [RUN]
[0m12:30:41.217588 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_data-talk-clubs_eu_emissions_project_marts, now model.eu_emissions_project.int_dim_capitals)
[0m12:30:41.217970 [debug] [Thread-2 (]: Re-using an available connection from the pool (formerly list_data-talk-clubs_eu_emissions_project, now model.eu_emissions_project.stg_emissions_data)
[0m12:30:41.218371 [debug] [Thread-1 (]: Began compiling node model.eu_emissions_project.int_dim_capitals
[0m12:30:41.218728 [debug] [Thread-2 (]: Began compiling node model.eu_emissions_project.stg_emissions_data
[0m12:30:41.225642 [debug] [Thread-1 (]: Writing injected SQL for node "model.eu_emissions_project.int_dim_capitals"
[0m12:30:41.228272 [debug] [Thread-2 (]: Writing injected SQL for node "model.eu_emissions_project.stg_emissions_data"
[0m12:30:41.229231 [debug] [Thread-2 (]: Began executing node model.eu_emissions_project.stg_emissions_data
[0m12:30:41.229603 [debug] [Thread-1 (]: Began executing node model.eu_emissions_project.int_dim_capitals
[0m12:30:41.250641 [debug] [Thread-2 (]: Writing runtime sql for node "model.eu_emissions_project.stg_emissions_data"
[0m12:30:41.256850 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m12:30:41.293116 [debug] [Thread-2 (]: On model.eu_emissions_project.stg_emissions_data: /* {"app": "dbt", "dbt_version": "1.9.3", "profile_name": "big-query", "target_name": "dev", "node_id": "model.eu_emissions_project.stg_emissions_data"} */


  create or replace view `data-talk-clubs`.`eu_emissions_project_staging`.`stg_emissions_data`
  OPTIONS()
  as 

WITH source AS (
    SELECT 
        *
    FROM `data-talk-clubs`.`eu_emissions_project`.`nitrogen_dioxide_data`
),

-- First, prepare the data by converting columns to the right format for unpivoting
preprocessed AS (
    SELECT
        freq_airpol_unit_geo_TIME_PERIOD AS metadata,
        -- All other columns are measurement data columns
        *
    FROM source
),

-- Use UNPIVOT to transform the wide format to long format
unpivoted AS (
    SELECT
        metadata,
        col_name AS date_column,
        CAST(col_value AS STRING) AS measurement_value
    FROM preprocessed
    UNPIVOT(
        col_value FOR col_name IN (
            _2018_01_, _2018_02_, _2018_03_, _2018_04_, _2018_05_, _2018_06_,
            _2018_07_, _2018_08_, _2018_09_, _2018_10_, _2018_11_, _2018_12_,
            _2019_01_, _2019_02_, _2019_03_, _2019_04_, _2019_05_, _2019_06_,
            _2019_07_, _2019_08_, _2019_09_, _2019_10_, _2019_11_, _2019_12_,
            _2020_01_, _2020_02_, _2020_03_, _2020_04_, _2020_05_, _2020_06_,
            _2020_07_, _2020_08_, _2020_09_, _2020_10_, _2020_11_, _2020_12_,
            _2021_01_, _2021_02_, _2021_03_, _2021_04_, _2021_05_, _2021_06_,
            _2021_07_, _2021_08_, _2021_09_, _2021_10_, _2021_11_, _2021_12_,
            _2022_01_, _2022_02_, _2022_03_, _2022_04_, _2022_05_, _2022_06_,
            _2022_07_, _2022_08_, _2022_09_, _2022_10_, _2022_11_, _2022_12_,
            _2023_01_, _2023_02_, _2023_03_, _2023_04_, _2023_05_, _2023_06_,
            _2023_07_, _2023_08_, _2023_09_, _2023_10_, _2023_11_, _2023_12_,
            _2024_01_, _2024_02_, _2024_03_, _2024_04_, _2024_05_, _2024_06_,
            _2024_07_, _2024_08_, _2024_09_, _2024_10_, _2024_11_, _2024_12_,
            _2025_01_, _2025_02_
        )
    )
    -- Filter out zero values that represent missing data
    -- WHERE measurement_value != '0.0'
),

-- Process the date and value after unpivoting
processed_measurements AS (
    SELECT
        metadata,
        -- Clean up column name by removing underscores
        REPLACE(date_column, '_', '') AS clean_date_column,
        -- Keep measurement value as string for now
        measurement_value,
        -- Extract month and year from column name and create a proper date
        DATE(CONCAT(
            SUBSTR(REPLACE(date_column, '_', ''), 1, 4), '-',
            SUBSTR(REPLACE(date_column, '_', ''), 5, 2), '-01'
        )) AS measurement_date,
        -- Create a readable date label (e.g., 'Jan 2018')
        CONCAT(
            FORMAT_DATE('%b', DATE(CONCAT(
                SUBSTR(REPLACE(date_column, '_', ''), 1, 4), '-',
                SUBSTR(REPLACE(date_column, '_', ''), 5, 2), '-01'
            ))),
            ' ',
            SUBSTR(REPLACE(date_column, '_', ''), 1, 4)
        ) AS date_label
    FROM unpivoted
),

metadata_extracted AS (
    SELECT
        -- Extract metadata components
        SPLIT(metadata, ',')[SAFE_OFFSET(0)] AS frequency,
        SPLIT(metadata, ',')[SAFE_OFFSET(1)] AS airpol,
        SPLIT(metadata, ',')[SAFE_OFFSET(2)] AS unit,
        SPLIT(metadata, ',')[SAFE_OFFSET(3)] AS geo_code,
        date_label,
        measurement_date,
        -- Convert measurement value to FLOAT64 here, after unpivoting
        -- Use TRIM to remove any potential whitespace and explicit comparison
        CASE 
            WHEN TRIM(measurement_value) = '0.0' THEN NULL
            ELSE SAFE_CAST(measurement_value AS FLOAT64)
        END AS measurement_value,
        CURRENT_TIMESTAMP() AS load_timestamp
    FROM processed_measurements
),

final AS (

SELECT
    ROW_NUMBER() OVER() AS id,
    frequency,
    airpol,
    unit,
    geo_code,
    date_label,
    measurement_date,
    measurement_value,
    load_timestamp
FROM metadata_extracted
ORDER BY geo_code, measurement_date
)

select * from final;


[0m12:30:41.293589 [debug] [Thread-2 (]: Opening a new connection, currently in state closed
[0m12:30:41.523348 [debug] [Thread-1 (]: Writing runtime sql for node "model.eu_emissions_project.int_dim_capitals"
[0m12:30:41.524204 [debug] [Thread-1 (]: On model.eu_emissions_project.int_dim_capitals: /* {"app": "dbt", "dbt_version": "1.9.3", "profile_name": "big-query", "target_name": "dev", "node_id": "model.eu_emissions_project.int_dim_capitals"} */

  
    

    create or replace table `data-talk-clubs`.`eu_emissions_project_intermediate`.`int_dim_capitals`
      
    
    

    OPTIONS()
    as (
      

-- Reference the capitals seed file
SELECT
    geo_code,
    Capital AS capital_city,
    Country AS country_name
FROM `data-talk-clubs`.`eu_emissions_project`.`capitals`
    );
  
[0m12:30:41.947786 [debug] [Thread-2 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=data-talk-clubs&j=bq:EU:2e7f7a34-e66c-4f8f-81da-b3e4443d00d1&page=queryresults
[0m12:30:42.050139 [debug] [Thread-1 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=data-talk-clubs&j=bq:EU:dc4a4436-52ff-4f56-a7e5-2c027f67a249&page=queryresults
[0m12:30:42.191710 [debug] [Thread-2 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'fd7370ef-4a91-42c3-abff-433aff9f60aa', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x12f3917d0>]}
[0m12:30:42.192292 [info ] [Thread-2 (]: 2 of 5 OK created sql view model eu_emissions_project_staging.stg_emissions_data  [[32mCREATE VIEW (0 processed)[0m in 0.97s]
[0m12:30:42.192714 [debug] [Thread-2 (]: Finished running node model.eu_emissions_project.stg_emissions_data
[0m12:30:42.193241 [debug] [Thread-4 (]: Began running node model.eu_emissions_project.int_emissions_cleaned
[0m12:30:42.193600 [info ] [Thread-4 (]: 3 of 5 START sql table model eu_emissions_project_intermediate.int_emissions_cleaned  [RUN]
[0m12:30:42.193880 [debug] [Thread-4 (]: Re-using an available connection from the pool (formerly list_data-talk-clubs_eu_emissions_project_intermediate, now model.eu_emissions_project.int_emissions_cleaned)
[0m12:30:42.194094 [debug] [Thread-4 (]: Began compiling node model.eu_emissions_project.int_emissions_cleaned
[0m12:30:42.195966 [debug] [Thread-4 (]: Writing injected SQL for node "model.eu_emissions_project.int_emissions_cleaned"
[0m12:30:42.196378 [debug] [Thread-4 (]: Began executing node model.eu_emissions_project.int_emissions_cleaned
[0m12:30:42.200768 [debug] [Thread-4 (]: Opening a new connection, currently in state closed
[0m12:30:42.432370 [debug] [Thread-4 (]: Writing runtime sql for node "model.eu_emissions_project.int_emissions_cleaned"
[0m12:30:42.433804 [debug] [Thread-4 (]: On model.eu_emissions_project.int_emissions_cleaned: /* {"app": "dbt", "dbt_version": "1.9.3", "profile_name": "big-query", "target_name": "dev", "node_id": "model.eu_emissions_project.int_emissions_cleaned"} */

  
    

    create or replace table `data-talk-clubs`.`eu_emissions_project_intermediate`.`int_emissions_cleaned`
      
    partition by date_trunc(measurement_date, month)
    cluster by geo_code

    OPTIONS()
    as (
      

WITH emissions_data AS (
    SELECT *
    FROM `data-talk-clubs`.`eu_emissions_project_staging`.`stg_emissions_data`
)

SELECT 
    airpol,
    unit,
    geo_code,
    date_label,
    measurement_date,
    IF(measurement_value = 0.0, NULL, measurement_value) AS measurement_value
FROM emissions_data
    );
  
[0m12:30:43.073209 [debug] [Thread-4 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=data-talk-clubs&j=bq:EU:cfd2abd2-bbe7-437e-aeab-a9c760335330&page=queryresults
[0m12:30:45.272602 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'fd7370ef-4a91-42c3-abff-433aff9f60aa', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x12f35ce90>]}
[0m12:30:45.273755 [info ] [Thread-1 (]: 1 of 5 OK created sql table model eu_emissions_project_intermediate.int_dim_capitals  [[32mCREATE TABLE (32.0 rows, 847.0 Bytes processed)[0m in 4.05s]
[0m12:30:45.274367 [debug] [Thread-1 (]: Finished running node model.eu_emissions_project.int_dim_capitals
[0m12:30:49.285864 [debug] [Thread-4 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'fd7370ef-4a91-42c3-abff-433aff9f60aa', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x12f38d290>]}
[0m12:30:49.286405 [info ] [Thread-4 (]: 3 of 5 OK created sql table model eu_emissions_project_intermediate.int_emissions_cleaned  [[32mCREATE TABLE (2.7k rows, 15.6 KiB processed)[0m in 7.09s]
[0m12:30:49.286770 [debug] [Thread-4 (]: Finished running node model.eu_emissions_project.int_emissions_cleaned
[0m12:30:49.287376 [debug] [Thread-6 (]: Began running node model.eu_emissions_project.emissions_analysis
[0m12:30:49.287839 [debug] [Thread-7 (]: Began running node model.eu_emissions_project.emissions_analysis_monthly
[0m12:30:49.288223 [info ] [Thread-6 (]: 4 of 5 START sql table model eu_emissions_project_marts.emissions_analysis ..... [RUN]
[0m12:30:49.288594 [info ] [Thread-7 (]: 5 of 5 START sql table model eu_emissions_project_marts.emissions_analysis_monthly  [RUN]
[0m12:30:49.288970 [debug] [Thread-6 (]: Acquiring new bigquery connection 'model.eu_emissions_project.emissions_analysis'
[0m12:30:49.289274 [debug] [Thread-7 (]: Acquiring new bigquery connection 'model.eu_emissions_project.emissions_analysis_monthly'
[0m12:30:49.289515 [debug] [Thread-6 (]: Began compiling node model.eu_emissions_project.emissions_analysis
[0m12:30:49.289751 [debug] [Thread-7 (]: Began compiling node model.eu_emissions_project.emissions_analysis_monthly
[0m12:30:49.293111 [debug] [Thread-6 (]: Writing injected SQL for node "model.eu_emissions_project.emissions_analysis"
[0m12:30:49.295585 [debug] [Thread-7 (]: Writing injected SQL for node "model.eu_emissions_project.emissions_analysis_monthly"
[0m12:30:49.296234 [debug] [Thread-6 (]: Began executing node model.eu_emissions_project.emissions_analysis
[0m12:30:49.296542 [debug] [Thread-7 (]: Began executing node model.eu_emissions_project.emissions_analysis_monthly
[0m12:30:49.298140 [debug] [Thread-6 (]: Opening a new connection, currently in state init
[0m12:30:49.300612 [debug] [Thread-7 (]: Opening a new connection, currently in state init
[0m12:30:49.551213 [debug] [Thread-7 (]: Writing runtime sql for node "model.eu_emissions_project.emissions_analysis_monthly"
[0m12:30:49.552798 [debug] [Thread-6 (]: Writing runtime sql for node "model.eu_emissions_project.emissions_analysis"
[0m12:30:49.553422 [debug] [Thread-7 (]: On model.eu_emissions_project.emissions_analysis_monthly: /* {"app": "dbt", "dbt_version": "1.9.3", "profile_name": "big-query", "target_name": "dev", "node_id": "model.eu_emissions_project.emissions_analysis_monthly"} */

  
    

    create or replace table `data-talk-clubs`.`eu_emissions_project_marts`.`emissions_analysis_monthly`
      
    partition by date_trunc(measurement_date, month)
    cluster by country_name, unit

    OPTIONS()
    as (
      

WITH emissions_data AS (
    SELECT *
    FROM `data-talk-clubs`.`eu_emissions_project_intermediate`.`int_emissions_cleaned`
),

capitals_data AS (
    SELECT *
    FROM `data-talk-clubs`.`eu_emissions_project_intermediate`.`int_dim_capitals`
),

-- Join emissions data with capitals information
emissions_with_location AS (
    SELECT
        e.*,
        c.capital_city,
        c.country_name
    FROM emissions_data e
    LEFT JOIN capitals_data c
        ON e.geo_code = c.geo_code
),

-- Monthly data is already available in the cleaned data
-- No need for additional aggregation by month
monthly_data AS (
    SELECT
        capital_city,
        country_name,
        geo_code,
        measurement_date,
        FORMAT_DATE('%Y-%m', measurement_date) AS year_month,
        EXTRACT(YEAR FROM measurement_date) AS year,
        EXTRACT(MONTH FROM measurement_date) AS month,
        airpol,
        unit,
        measurement_value
    FROM emissions_with_location
),

-- Calculate month-over-month changes
mom_changes AS (
    SELECT
        current_month.*,
        current_month.measurement_value - prev_month.measurement_value AS absolute_change,
        CASE 
            WHEN prev_month.measurement_value = 0 OR prev_month.measurement_value IS NULL THEN NULL
            ELSE (current_month.measurement_value - prev_month.measurement_value) / prev_month.measurement_value * 100 
        END AS percentage_change
    FROM monthly_data current_month
    LEFT JOIN monthly_data prev_month
        ON current_month.geo_code = prev_month.geo_code
        AND DATE_SUB(current_month.measurement_date, INTERVAL 1 MONTH) = prev_month.measurement_date
        AND current_month.airpol = prev_month.airpol
        AND current_month.unit = prev_month.unit
),

-- Calculate country rankings by month
country_rankings AS (
    SELECT
        year_month,
        country_name,
        airpol,
        unit,
        measurement_value,
        RANK() OVER(PARTITION BY year_month, airpol, unit ORDER BY measurement_value) AS pollution_rank_asc,
        RANK() OVER(PARTITION BY year_month, airpol, unit ORDER BY measurement_value DESC) AS pollution_rank_desc
    FROM monthly_data
    WHERE country_name IS NOT NULL
)

-- Final analytical model
SELECT 
    m.capital_city,
    m.country_name,
    m.geo_code,
    m.measurement_date,
    m.year,
    m.month,
    m.year_month,
    m.airpol,
    m.unit,
    m.measurement_value,
    m.absolute_change,
    m.percentage_change,
    -- Add trend indicators
    CASE
        WHEN m.percentage_change < -5 THEN 'Significant Decrease'
        WHEN m.percentage_change BETWEEN -5 AND -0.5 THEN 'Moderate Decrease'
        WHEN m.percentage_change BETWEEN -0.5 AND 0.5 THEN 'Stable'
        WHEN m.percentage_change BETWEEN 0.5 AND 5 THEN 'Moderate Increase'
        WHEN m.percentage_change > 5 THEN 'Significant Increase'
        ELSE 'Insufficient Data'
    END AS trend_category,
    -- Add country rankings
    r.pollution_rank_asc,
    r.pollution_rank_desc,
    -- Calculate percentile within month (lower percentile = lower pollution)
    PERCENT_RANK() OVER(PARTITION BY m.year_month, m.unit ORDER BY m.measurement_value) AS pollution_percentile,
    -- Add a flag for capitals exceeding EU average (if EU27_2020 data exists)
    CASE
        WHEN eu.measurement_value IS NULL THEN NULL
        WHEN m.measurement_value > eu.measurement_value THEN TRUE
        ELSE FALSE
    END AS exceeds_eu_average,
    -- Calculate how much above/below EU average (in percentage)
    CASE
        WHEN eu.measurement_value IS NULL OR eu.measurement_value = 0 THEN NULL
        ELSE (m.measurement_value - eu.measurement_value) / eu.measurement_value * 100
    END AS percent_diff_from_eu_avg,
    CURRENT_TIMESTAMP() AS analysis_timestamp
FROM mom_changes m
LEFT JOIN country_rankings r
    ON m.year_month = r.year_month
    AND m.country_name = r.country_name
    AND m.unit = r.unit
LEFT JOIN monthly_data eu
    ON m.year_month = eu.year_month
    AND m.unit = eu.unit
    AND eu.geo_code = 'EU27_2020'
    );
  
[0m12:30:49.554664 [debug] [Thread-6 (]: On model.eu_emissions_project.emissions_analysis: /* {"app": "dbt", "dbt_version": "1.9.3", "profile_name": "big-query", "target_name": "dev", "node_id": "model.eu_emissions_project.emissions_analysis"} */

  
    

    create or replace table `data-talk-clubs`.`eu_emissions_project_marts`.`emissions_analysis`
      
    partition by range_bucket(
            year,
            generate_array(2018, 2025, 1)
        )
    cluster by country_name, unit

    OPTIONS()
    as (
      

WITH emissions_data AS (
    SELECT *
    FROM `data-talk-clubs`.`eu_emissions_project_intermediate`.`int_emissions_cleaned`
),

capitals_data AS (
    SELECT *
    FROM `data-talk-clubs`.`eu_emissions_project_intermediate`.`int_dim_capitals`
),

-- Join emissions data with capitals information
emissions_with_location AS (
    SELECT
        e.*,
        c.capital_city,
        c.country_name
    FROM emissions_data e
    LEFT JOIN capitals_data c
        ON e.geo_code = c.geo_code
),

-- Calculate yearly averages by location
yearly_averages AS (
    SELECT
        capital_city,
        country_name,
        geo_code,
        EXTRACT(YEAR FROM measurement_date) AS year,
        airpol,
        unit,
        AVG(measurement_value) AS avg_value,
        MIN(measurement_value) AS min_value,
        MAX(measurement_value) AS max_value,
        SUM(measurement_value) AS total_emissions,
        COUNT(*) AS measurement_count
    FROM emissions_with_location
    GROUP BY capital_city, country_name, geo_code, EXTRACT(YEAR FROM measurement_date), airpol, unit
),

-- Calculate year-over-year changes
yoy_changes AS (
    SELECT
        current_year.*,
        current_year.avg_value - prev_year.avg_value AS absolute_change,
        CASE 
            WHEN prev_year.avg_value = 0 OR prev_year.avg_value IS NULL THEN NULL
            ELSE (current_year.avg_value - prev_year.avg_value) / prev_year.avg_value * 100 
        END AS percentage_change
    FROM yearly_averages current_year
    LEFT JOIN yearly_averages prev_year
        ON current_year.geo_code = prev_year.geo_code
        AND current_year.year = prev_year.year + 1
        AND current_year.airpol = prev_year.airpol
        AND current_year.unit = prev_year.unit
),

-- Calculate country rankings by year
country_rankings AS (
    SELECT
        year,
        country_name,
        airpol,
        unit,
        avg_value,
        RANK() OVER(PARTITION BY year, airpol, unit ORDER BY avg_value) AS pollution_rank_asc,
        RANK() OVER(PARTITION BY year, airpol, unit ORDER BY avg_value DESC) AS pollution_rank_desc
    FROM yearly_averages
    WHERE country_name IS NOT NULL
)

-- Final analytical model
SELECT 
    y.capital_city,
    y.country_name,
    y.geo_code,
    y.year,
    y.airpol,
    y.unit,
    y.avg_value,
    y.min_value,
    y.max_value,
    y.total_emissions,
    y.measurement_count,
    y.absolute_change,
    y.percentage_change,
    -- Add trend indicators
    CASE
        WHEN y.percentage_change < -5 THEN 'Significant Decrease'
        WHEN y.percentage_change BETWEEN -5 AND -0.5 THEN 'Moderate Decrease'
        WHEN y.percentage_change BETWEEN -0.5 AND 0.5 THEN 'Stable'
        WHEN y.percentage_change BETWEEN 0.5 AND 5 THEN 'Moderate Increase'
        WHEN y.percentage_change > 5 THEN 'Significant Increase'
        ELSE 'Insufficient Data'
    END AS trend_category,
    -- Add country rankings
    r.pollution_rank_asc,
    r.pollution_rank_desc,
    -- Calculate percentile within year (lower percentile = lower pollution)
    PERCENT_RANK() OVER(PARTITION BY y.year, y.unit ORDER BY y.avg_value) AS pollution_percentile,
    -- Add a flag for capitals exceeding EU average (if EU27_2020 data exists)
    CASE
        WHEN eu.avg_value IS NULL THEN NULL
        WHEN y.avg_value > eu.avg_value THEN TRUE
        ELSE FALSE
    END AS exceeds_eu_average,
    -- Calculate how much above/below EU average (in percentage)
    CASE
        WHEN eu.avg_value IS NULL OR eu.avg_value = 0 THEN NULL
        ELSE (y.avg_value - eu.avg_value) / eu.avg_value * 100
    END AS percent_diff_from_eu_avg,
    CURRENT_TIMESTAMP() AS analysis_timestamp
FROM yoy_changes y
LEFT JOIN country_rankings r
    ON y.year = r.year
    AND y.country_name = r.country_name
    AND y.unit = r.unit
LEFT JOIN yearly_averages eu
    ON y.year = eu.year
    AND y.unit = eu.unit
    AND eu.geo_code = 'EU27_2020'
    );
  
[0m12:30:50.033921 [debug] [Thread-7 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=data-talk-clubs&j=bq:EU:964ede62-8dec-4d8d-a5a8-b591265b2c44&page=queryresults
[0m12:30:50.034580 [debug] [Thread-6 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=data-talk-clubs&j=bq:EU:434321f4-a2a6-4846-b37d-4e624d507f34&page=queryresults
[0m12:30:54.845735 [debug] [Thread-6 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'fd7370ef-4a91-42c3-abff-433aff9f60aa', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1309ee610>]}
[0m12:30:54.847222 [info ] [Thread-6 (]: 4 of 5 OK created sql table model eu_emissions_project_marts.emissions_analysis  [[32mCREATE TABLE (248.0 rows, 97.2 KiB processed)[0m in 5.56s]
[0m12:30:54.847713 [debug] [Thread-6 (]: Finished running node model.eu_emissions_project.emissions_analysis
[0m12:30:58.129088 [debug] [Thread-7 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'fd7370ef-4a91-42c3-abff-433aff9f60aa', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x130a745d0>]}
[0m12:30:58.129655 [info ] [Thread-7 (]: 5 of 5 OK created sql table model eu_emissions_project_marts.emissions_analysis_monthly  [[32mCREATE TABLE (2.7k rows, 97.2 KiB processed)[0m in 8.84s]
[0m12:30:58.130038 [debug] [Thread-7 (]: Finished running node model.eu_emissions_project.emissions_analysis_monthly
[0m12:30:58.130951 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m12:30:58.132081 [debug] [MainThread]: Connection 'master' was properly closed.
[0m12:30:58.132356 [debug] [MainThread]: Connection 'model.eu_emissions_project.int_dim_capitals' was properly closed.
[0m12:30:58.132565 [debug] [MainThread]: Connection 'model.eu_emissions_project.stg_emissions_data' was properly closed.
[0m12:30:58.132759 [debug] [MainThread]: Connection 'list_data-talk-clubs_eu_emissions_project_staging' was properly closed.
[0m12:30:58.132947 [debug] [MainThread]: Connection 'model.eu_emissions_project.int_emissions_cleaned' was properly closed.
[0m12:30:58.133134 [debug] [MainThread]: Connection 'model.eu_emissions_project.emissions_analysis' was properly closed.
[0m12:30:58.133315 [debug] [MainThread]: Connection 'model.eu_emissions_project.emissions_analysis_monthly' was properly closed.
[0m12:30:58.133569 [info ] [MainThread]: 
[0m12:30:58.133792 [info ] [MainThread]: Finished running 4 table models, 1 view model in 0 hours 0 minutes and 18.00 seconds (18.00s).
[0m12:30:58.134446 [debug] [MainThread]: Command end result
[0m12:30:58.149298 [debug] [MainThread]: Wrote artifact WritableManifest to /Users/timbo/Documents/DataTalks/project/src/target/manifest.json
[0m12:30:58.150313 [debug] [MainThread]: Wrote artifact SemanticManifest to /Users/timbo/Documents/DataTalks/project/src/target/semantic_manifest.json
[0m12:30:58.153843 [debug] [MainThread]: Wrote artifact RunExecutionResult to /Users/timbo/Documents/DataTalks/project/src/target/run_results.json
[0m12:30:58.154127 [info ] [MainThread]: 
[0m12:30:58.154369 [info ] [MainThread]: [32mCompleted successfully[0m
[0m12:30:58.154548 [info ] [MainThread]: 
[0m12:30:58.154760 [info ] [MainThread]: Done. PASS=5 WARN=0 ERROR=0 SKIP=0 TOTAL=5
[0m12:30:58.156722 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": true, "command_wall_clock_time": 19.242785, "process_in_blocks": "0", "process_kernel_time": 0.371932, "process_mem_max_rss": "214417408", "process_out_blocks": "0", "process_user_time": 1.992386}
[0m12:30:58.157041 [debug] [MainThread]: Command `dbt run` succeeded at 12:30:58.156993 after 19.24 seconds
[0m12:30:58.157287 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x119c7cd50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x102eba1d0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x102d4c410>]}
[0m12:30:58.157509 [debug] [MainThread]: Flushing usage events
[0m12:31:01.466707 [debug] [MainThread]: An error was encountered while trying to flush usage events
